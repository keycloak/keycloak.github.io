
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Support for Customer Identity and Access Management (CIAM) and Multi-tenancy - Keycloak</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Keycloak is an open source identity and access management solution">
    <meta name="author" content="Keycloak Team">
    <meta name="keywords" content="sso,idm,openid connect,saml,kerberos,ldap">

    

    

    <link href="https://www.keycloak.org/resources/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://www.keycloak.org/resources/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="https://www.keycloak.org/resources/css/keycloak.css" rel="stylesheet">
    <link rel="canonical" href="https://www.keycloak.org/2024/06/announcement-keycloak-organizations">

    <link rel="shortcut icon" href="https://www.keycloak.org/resources/favicon.ico">

    <script src="https://www.keycloak.org/resources/js/ga.js" type="text/javascript"></script>
    <script src="https://www.keycloak.org/resources/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="https://www.keycloak.org/resources/tocbot/dist/tocbot.min.js" type="text/javascript"></script>
</head>
<body>

<header class="navbar navbar-expand-md bg-light shadow-sm">
<nav class="container-xxl flex-wrap flex-md-no-wrap navbar-light">
    <a class="navbar-brand me-3 me-md-4 me-lg-5" href="https://www.keycloak.org/">
        <img class="img-fluid" src="https://www.keycloak.org/resources/images/logo.svg" width="240" alt="Keycloak"/>
    </a>
    <a class="nav-link d-none d-sm-block d-md-none d-lg-block" href="https://github.com/keycloak/keycloak"><img src="https://img.shields.io/github/stars/keycloak/keycloak?label=GitHub%20Stars" style="height: 25px" alt="GitHub stars"/></a>
    <a class="nav-link d-block d-sm-none d-md-block d-lg-none" href="https://github.com/keycloak/keycloak"><img src="https://img.shields.io/github/stars/keycloak/keycloak?label=" style="height: 25px" alt="GitHub stars"/></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="fa fa-bars fa-lg px-1 py-2"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav flex-row flex-wrap bd-navbar-nav pt-2 py-md-0">
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/guides">Guides</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/documentation">Docs</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/downloads">Downloads</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/community">Community</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/blog">Blog</a>
        </li>
      </ul>
    </div>
</nav>
</header>


<div class="container mt-5 kc-article">
    <h1>Support for Customer Identity and Access Management (CIAM) and Multi-tenancy</h1>
    <p class="blog-date text-muted">June 20 2024 by Pedro Igor</p>


<div class="paragraph">
<p>Dear Keycloak community,</p>
</div>
<div class="paragraph">
<p>Thanks to the collaborative work with a lot of folks from the community and Red Hat&#8217;s IT, we are delivering in Keycloak 25 the Keycloak Organizations
feature.</p>
</div>
<div class="paragraph">
<p>We are pleased to announce the beginning of a long journey to support Customer Identity and Access Management (CIAM) and,
to some degree, also support for multi-tenancy when a realm needs to integrate with third parties such as customers and business
partners.</p>
</div>
<div class="paragraph">
<p>Keycloak Organizations is a feature that leverages the existing Identity and Access Management (IAM)
capabilities of Keycloak to address CIAM uses cases like Business-to-Business (B2B) and Business-to-Business-to-Customer (B2B2C)
integrations. By leveraging the existing capabilities available from a realm, the first release of this feature provides
the very core capabilities to allow a realm to integrate with business partners and customers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Manage Organizations</p>
</li>
<li>
<p>Manage Organization Members</p>
</li>
<li>
<p>Onboard members using different strategies such as invitation links and brokering</p>
</li>
<li>
<p>Decorate tokens with additional metadata about the organization that the subject belongs to</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The feature is being delivered initially as a technology preview feature with the ultimate goal to make it supported in Keycloak 26.
There are many more capabilities in the <a href="https://github.com/keycloak/keycloak/issues/30180">roadmap</a> for this feature, and we consider this initial set of capabilities the very
core of the feature that will allow us to build more capabilities on top. For this reason, your feedback is very important
to make sure we are on the right path for solving real use cases around CIAM.</p>
</div>
<div class="paragraph">
<p>Please, consider checking our nightly builds as well to check for the latest updates and what is coming in the next major release.</p>
</div>
<div class="paragraph">
<p>For more details about the feature, consider reading the documentation available at
<a href="https://www.keycloak.org/docs/latest/server_admin/#_managing_organizations">the official documentation</a>.</p>
</div>
<div class="sect1">
<h2 id="_getting_started">Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Keycloak Organizations feature introduces changes on how users authenticate to a realm to identify whether a user is authenticating
in the scope of an organization or the realm.</p>
</div>
<div class="paragraph">
<p>One of the key changes introduced by the feature in terms of authentication is the introduction of an identity-fist login flow whenever
you are authenticating to a realm that has the <strong>Organizations</strong> setting enabled.</p>
</div>
<div class="sect2">
<h3 id="_start_keycloak">Start Keycloak</h3>
<div class="paragraph">
<p>The Keycloak Organization feature is a technology preview feature that needs to be enabled when starting (or building an optimized image of) the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run --name kc-orgs -d -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin -p 8080:8080 quay.io/keycloak/keycloak start-dev --features organization</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you run the command above, make sure you can access the server at <code>http://localhost:8080/</code> and log in into the administration console using the following credentials:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>admin</code></p>
</li>
<li>
<p>Password: <code>admin</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_realm">Create a realm</h3>
<div class="paragraph">
<p>Let us start by creating a new realm called <code>orgdemo</code>. The <code>orgdemo</code> realm is a first-party company that wants to integrate
with third-parties, the <code>organizations</code>, so that their users can have access to protected resources served by client applications available at the <code>orgdemo</code> realm.</p>
</div>
<div class="paragraph">
<p>For that, create a new realm using <code>orgdemo</code> as the name via the administration console.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_users_in_the_orgdemo_realm">Create users in the <code>orgdemo</code> realm</h3>
<div class="paragraph">
<p>You also need some users in the <code>orgdemo</code> realm to authenticate and follow the next steps.</p>
</div>
<div class="paragraph">
<p>The <code>mjane</code> user is a realm user that has an email account that does not match any organization in the realm. We will use this user to represent an existing <strong>realm</strong> user in the <code>orgdemo</code> realm that is not associated with any organization.
For that, create a user as the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>mjane</code></p>
</li>
<li>
<p>Email: <code>mjane@orgdemo.com</code></p>
</li>
<li>
<p>First Name: <code>Mary</code></p>
</li>
<li>
<p>Last Name: <code>Jane</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Make sure to set a password for this user so that you can authenticate to the realm.</p>
</div>
<div class="paragraph">
<p>Now, create the <code>alice@orga.com</code> user. This user will act as an existing realm user that has an email that matches one of the domains set to an organization but is not yet a member of the organization.
This user could have been created through self-registration, or by integrating with a custom identity store,
or even federated from an identity provider available from the realm:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>alice</code></p>
</li>
<li>
<p>Email: <code>alice@orga.com</code></p>
</li>
<li>
<p>First Name: <code>Alice</code></p>
</li>
<li>
<p>Last Name: <code>Chains</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Make sure to set a password for this user so that you can authenticate to the realm.</p>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_the_changes_to_authentication_flows_when_the_feature_is_enabled">Understanding the changes to authentication flows when the feature is enabled</h3>
<div class="paragraph">
<p>When a realm is created, the authentication flows are automatically updated to enable specific steps to authenticate and onboard organization members. The authentication flows updated are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>browser</code></p>
</li>
<li>
<p><code>first broker login</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The main change to the <code>browser</code> flow is that it defaults to an identity-first login so that users are identified before prompting for their credentials.
In regard to the <code>first broker login</code> flow, the main change there is to automatically add the user as an organization member once they authenticate through the identity provider associated with an organization and successfuly complete flow.</p>
</div>
<div class="paragraph">
<p>The decision to whether an identity-first login should happen is based on the availability of any organization in a realm.
If no organizations exist yet, the user will follow the usual steps to authenticate using both username and password, or any other step configured to the <code>browser</code> flow.</p>
</div>
<div class="paragraph">
<p>Try reaching <code>http://localhost:8080/realms/orgdemo/account</code> and you&#8217;ll see the usual login page. From this page, you can authenticate
as usual to the realm using the following credentials:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: mjane</p>
</li>
<li>
<p>Password: &lt;password&gt;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once you submit the login form, you are authenticated to the realm and automatically redirected to the client application acting on behalf of the user.
In this case, the account console.</p>
</div>
</div>
<div class="sect2">
<h3 id="_authenticating_to_a_realm_when_there_are_organizations">Authenticating to a realm when there are organizations</h3>
<div class="paragraph">
<p>Now, let us create an organization in the <code>orgademo</code> realm. For that, we need to enable organizations to the realm by navigating to
the <code>Realm Settings</code> page and enabling the <code>Organizations</code> setting.</p>
</div>
<div class="paragraph">
<p>Once you enable organizations, you can click on the <code>Organizations</code> section in the menu. Click the <code>Create organization</code> button
to create a new organization as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Name: <code>OrgA Inc</code></p>
</li>
<li>
<p>Domains: <code>orga.com</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once the <code>orga</code> organization is created, sign out from the client application and try to log in again. At this time, you should
be present with the identity-first login page.</p>
</div>
<div class="paragraph">
<p>Differently than the previous attempt, the <code>orgdemo</code> realm has an organization and the authentication flow changed to first identify
the user before prompting for any credentials.</p>
</div>
<div class="paragraph">
<p>At the identity-first login page you can still authenticate as the <code>mjane</code> user. However, the user will now authenticate in two steps.
The first step will ask for the username or email only, and then provide the password in a second step.</p>
</div>
</div>
<div class="sect2">
<h3 id="_trying_to_authenticate_as_a_user_that_does_not_exist_using_an_email_domain_that_matches_an_organization">Trying to authenticate as a user that does not exist using an email domain that matches an organization</h3>
<div class="paragraph">
<p>Try to log in again to <code>http://localhost:8080/realms/orgdemo/account/</code> and type <code>bob@orga.com</code>. There is no account associated with that email in the <code>orgdemo</code> realm.</p>
</div>
<div class="paragraph">
<p>If a user that does not exist tries to authenticate using an email domain that matches an organization domain, the identity-first login page will be shown again and indicate
that the username provided is not valid. At this point, there is no reason to ask the user for credentials in a second step.</p>
</div>
<div class="paragraph">
<p>There are several ways to register the user so that he can authenticate to the <code>orgdemo</code> realm and eventually join the <code>orga</code> organization.</p>
</div>
<div class="paragraph">
<p>If the realm has the self-registration setting enabled, the user can click on the <code>Register</code> link at the identity-first login page and create an account at the <code>orgdemo</code> realm. After that,
the administrator can send an invitation link to the user or manually add him as a member of the <code>orga</code> organization.</p>
</div>
<div class="paragraph">
<p>If the organization has an identity provider without a domain set, and they are marked as <code>public</code>, they can also click on the identity provider
link at the identity-first login page to automatically create an account and join the <code>orga</code> organization once they authenticate through the identity provider.</p>
</div>
<div class="paragraph">
<p>Similar to the above, if the organization has an identity provider set with one of the organization domains, the user will be automatically redirected to the identity provider
to authenticate and automatically create an account and join the <code>orga</code> organization once the flow is completed.</p>
</div>
<div class="paragraph">
<p>Look at the
<a href="https://www.keycloak.org/docs/latest/server_admin/#_managing_members_">official documentation</a> for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_authenticating_as_an_existing_user_using_an_email_domain_that_matches_an_organization">Authenticating as an existing user using an email domain that matches an organization</h3>
<div class="paragraph">
<p>Try to log in again to <code>http://localhost:8080/realms/orgdemo/account/</code> and type <code>alice@orga.com</code>.</p>
</div>
<div class="paragraph">
<p>Differently than before, the user is now presented with the second step to provide the credentials.
Given that the user exists in the <code>orgdemo</code> realm, it should be possible to authenticate even though the user is not yet a member of the organization.</p>
</div>
<div class="paragraph">
<p>As an administrator, you can later choose to invite the user to join an organization or manually add it to an organization.</p>
</div>
</div>
<div class="sect2">
<h3 id="_authenticating_as_an_existing_user_using_an_email_domain_that_matches_the_domain_set_to_an_identity_provider_associated_with_an_organization">Authenticating as an existing user using an email domain that matches the domain set to an identity provider associated with an organization</h3>
<div class="paragraph">
<p>The feature allows you to set a domain to an identity provider associated with an organization.
This is useful when you want to make sure that users using a specific email domain always authenticate through the identity provider.</p>
</div>
<div class="paragraph">
<p>Let us create a <code>orga</code> realm to federate users from it using an identity provider at the <code>orgdemo</code> realm,
where the identity provider will be associated to the <code>orga</code> organization.</p>
</div>
<div class="paragraph">
<p>Once you create the <code>orga</code> realm, create a OpenID Connect client at this realm as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client type: <code>OpenID Connect</code></p>
</li>
<li>
<p>Client ID: <code>orgdemo-broker</code></p>
</li>
<li>
<p>Client authentication: <code>ON</code></p>
</li>
<li>
<p>Valid redirect URIs: <code>*</code> (using <code>*</code> for the sake of simplicity, don&#8217;t use in production)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Create a user now so that we can federate this user later using an identity provider from the <code>orgdemo</code> realm:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>jdoe</code></p>
</li>
<li>
<p>Email: <code>jdoe@orga.com</code></p>
</li>
<li>
<p>First Name: <code>John</code></p>
</li>
<li>
<p>Last Name: <code>Doe</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Make sure to set a password for this user so that you can authenticate to the realm.</p>
</div>
<div class="paragraph">
<p>Let us now create an OpenID Connect Identity Provider at the <code>orgdemo</code> realm as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Alias: <code>orga-broker</code></p>
</li>
<li>
<p>Display name: <code>OrgA Inc.</code></p>
</li>
<li>
<p>Discovery endpoint: <code>http://localhost:8080/realms/orga/.well-known/openid-configuration</code></p>
</li>
<li>
<p>Client ID: <code>orgdemo-broker</code></p>
</li>
<li>
<p>Client Secret: &lt;credentials generated when you created the orgdemo-broker client in orga realm&gt;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For last, let us associate the identity provider we just created in <code>orgdemo</code> realm and link it with the <code>orga</code> organization. For that,
click on the <code>Organizations</code> section in the menu and select the <code>OrgA Inc</code> organization. Navigate to the <code>Identity Providers</code> tab and
click the <code>Link identity provider</code> button and provide the following settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Identity provider: <code>orga-broker</code></p>
</li>
<li>
<p>Domain: <code>orga.com</code></p>
</li>
<li>
<p>Redirect when email domain matches: <code>ON</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Try to log in again to <code>http://localhost:8080/realms/orgdemo/account/</code> and type <code>jdoe@orga.com</code>.
The user is now automatically redirected to the <code>orga</code> realm to authenticate.</p>
</div>
<div class="paragraph">
<p>When a user that does not exist yet in the realm tries to authenticate using an email domain that matches an organization domain,
and that domain is also set to the identity provider associated with the organization, the user is automatically redirected to the identity provider.</p>
</div>
<div class="paragraph">
<p>By doing this, you can now authenticate at the <code>orga</code> realm using the following credentials:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>jdoe@orga.com</code></p>
</li>
<li>
<p>Password: &lt;password&gt;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once the user completes the authentication, it will be automatically redirected back to the <code>orgdemo</code> realm to create an account and automatically join the <code>orga</code> organization.</p>
</div>
<div class="paragraph">
<p>The same is true if you re-authenticate as the <code>jdoe@orga.com</code> user. However, this time the user is already linked with the identity provider and will always authenticate through the identity provider.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_organization_metadata_in_bearer_tokens_to_access_protected_resources_from_the_clients_in_a_realm">Using organization metadata in bearer tokens to access protected resources from the clients in a realm</h3>
<div class="paragraph">
<p>So far, we have been using the account console client at the <code>orgdemo</code> realm to authenticate the user. As an OpenID Connect client, an access token is issued as a result of a successful authentication.</p>
</div>
<div class="paragraph">
<p>When authenticating in the context of an organization, the access token is automatically updated with specific claims about the organization the user is a member.</p>
</div>
<div class="paragraph">
<p>To map organization-specific claims into tokens, a client needs to request the <code>organization</code> scope when sending authorization requests to the server.</p>
</div>
<div class="paragraph">
<p>As a result, the token will contain a claim as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"organization": {
    "orga": {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>organization</code> claim can be used by clients (e.g.: from ID Tokens) and resource servers (e.g.: from access tokens) to authorize access to protected resources based on the organization that a user belongs to.</p>
</div>
<div class="paragraph">
<p>The <code>organization</code> scope is a built-in <strong>optional</strong> client scope at the realm. As such, it is added to any client created in the realm, by default.</p>
</div>
</div>
</div>
</div></div>


<div class="container mt-5">
    <footer class="py-3 my-4 border-top">
        <p class="text-center text-muted">Keycloak is a Cloud Native Computing Foundation incubation project</p>
        <div class="text-center">
            <img alt="Cloud Native Computing Foundation" src="https://www.keycloak.org/resources/images/cncf_logo.png"/>
        </div>
        <p class="mt-4 text-center small text-muted">&copy; Keycloak Authors 2024. &copy; 2024 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage page</a>.</p>
    </footer>
</div>

</body>
</html>
