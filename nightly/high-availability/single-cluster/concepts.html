
<!doctype html>
<html lang="en" prefix="og: https://ogp.me/ns#">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0J2P9316N6"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-0J2P9316N6');
</script>
<meta charset="utf-8"/>
<title>Concepts for single-cluster deployments - Keycloak</title>
<meta name="twitter:card" content="summary_large">
<meta name="twitter:site" content="@keycloak">
<meta property="og:site_name" content="Keycloak">
<meta property="og:title" content="Concepts for single-cluster deployments">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" property="og:description" content="Understand single-cluster deployment with synchronous replication.">
<meta name="author" content="Keycloak Team">
<meta name="keywords" content="sso,idm,openid connect,saml,kerberos,ldap">
<meta name="robots" content="noindex">
<link href="https://www.keycloak.org/resources/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://www.keycloak.org/resources/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link href="https://www.keycloak.org/resources/css/keycloak.css" rel="stylesheet">
<link rel="canonical" href="https://www.keycloak.org/nightly/high-availability/single-cluster/concepts">
<meta property="og:url" content="https://www.keycloak.org/nightly/high-availability/single-cluster/concepts">
<link rel="shortcut icon" href="https://www.keycloak.org/resources/favicon.svg"></head>
<body>

<header class="navbar navbar-expand-md bg-light shadow-sm">
<nav class="container-xxl flex-wrap flex-md-no-wrap navbar-light" data-nosnippet>
    <a class="navbar-brand me-3 me-md-4 me-lg-5" href="https://www.keycloak.org/">
        <img style="aspect-ratio: 730/151" class="img-fluid" src="https://www.keycloak.org/resources/images/logo.svg" width="240" alt="Keycloak"/>
    </a>
    <a class="nav-link d-none d-sm-block d-md-none d-lg-block" href="https://github.com/keycloak/keycloak"><img src="https://www.keycloak.org/resources/images/stars-large.svg" style="height: 25px; aspect-ratio: 128/20" alt="GitHub stars"/></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="fa fa-bars fa-lg px-1 py-2"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav flex-row flex-wrap bd-navbar-nav pt-2 py-md-0">
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/guides">Guides</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/documentation">Docs</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/downloads">Downloads</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/community">Community</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/blog">Blog</a>
        </li>
      </ul>
    </div>
    <div class="d-block d-sm-none d-md-block d-lg-none text-center vw-100">
        <a class="nav-link d-inline p-0" href="https://github.com/keycloak/keycloak"><img src="https://www.keycloak.org/resources/images/stars-large.svg" style="height: 25px; aspect-ratio: 128/20" alt="GitHub stars"/></a>
    </div>
</nav>
</header>


<div class="container mt-5 kc-article">
    <div class="row">
        <div class="col-md-9 col-xl-10 col-sm-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="https://www.keycloak.org/nightly/guides">Guides</a></li>
                    <li class="breadcrumb-item"><a href="https://www.keycloak.org/nightly/guides#high-availability">High availability</a></li>
                      <li class="breadcrumb-item"><a href="https://www.keycloak.org/nightly/high-availability/single-cluster/introduction">Single cluster</a></li>
                    <li class="breadcrumb-item active">Concepts for single-cluster deployments</li>
                </ol>
            </nav>

                <div class="mb-4 alert alert-warning" role="alert">
                  <h4 class="no-top-margin">Nightly release</h4>

                  This guide is for the unstable nightly release, for the latest release go <a href="https://www.keycloak.org/guides">here</a>.
                </div>

            <div class="mb-4">
                <h1>Concepts for single-cluster deployments</h1>
                    <span class="text-muted">Understand single-cluster deployment with synchronous replication.</span>
            </div>



            <div class="kc-asciidoc" id="guide-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This topic describes a single-cluster setup and the behavior to expect.
It outlines the requirements of the high availability architecture and describes the benefits and tradeoffs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="single-cluster-when-to-use"><a class="anchor" href="#single-cluster-when-to-use"></a>When to use this setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use this setup to deploy Keycloak to a setup with transparent networking.</p>
</div>
<div class="paragraph">
<p>To provide a more concrete example, the following chapter assumes a deployment contained within a single Kubernetes cluster.
The same concepts could be applied to a set of virtual or physical machines and a manual or scripted deployment.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_single_or_multiple_availability_zones"><a class="anchor" href="#_single_or_multiple_availability_zones"></a>Single or multiple availability-zones</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The behaviour and high-availability guarantees of the Keycloak deployment are ultimately determined by the configuration of
the Kubernetes cluster. Typically, Kubernetes clusters are deployed on a single availability-zone, however in order to
increase fault-tolerance, it is possible to <a href="https://kubernetes.io/docs/setup/best-practices/multiple-zones/">deploy the cluster across multiple availability-zones</a>.</p>
</div>
<div class="paragraph">
<p>The Keycloak Operator defines the following topology spread constraints by default to prefer that Keycloak pods are
deployed on distinct nodes and distinct availability-zones when possible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: "topology.kubernetes.io/zone"
          whenUnsatisfiable: "ScheduleAnyway"
          labelSelector:
            matchLabels:
              app: "keycloak"
              app.kubernetes.io/managed-by: "keycloak-operator"
              app.kubernetes.io/instance: "keycloak"
              app.kubernetes.io/component: "server"
        - maxSkew: 1
          topologyKey: "kubernetes.io/hostname"
          whenUnsatisfiable: "ScheduleAnyway"
          labelSelector:
            matchLabels:
              app: "keycloak"
              app.kubernetes.io/managed-by: "keycloak-operator"
              app.kubernetes.io/instance: "keycloak"
              app.kubernetes.io/component: "server"</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to ensure high-availability with multiple availability-zones, it is crucial that the Database is also able to
withstand zone failures as Keycloak depends on the underlying database to remain available.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_failures_which_this_setup_can_survive"><a class="anchor" href="#_failures_which_this_setup_can_survive"></a>Failures which this setup can survive</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Deploying Keycloak on a single or across multiple availability-zones changes the high-availability characteristics
significantly, therefore we consider these architectures independently.</p>
</div>
<div class="sect2">
<h3 id="_single_zone"><a class="anchor" href="#_single_zone"></a>Single Zone</h3>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Failure</th>
<th class="tableblock halign-left valign-top">Recovery</th>
<th class="tableblock halign-left valign-top">RPO<sup>1</sup></th>
<th class="tableblock halign-left valign-top">RTO<sup>2</sup></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keycloak Pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple Keycloak Pods run in a cluster. If one instance fails some incoming requests might receive an error message or are delayed for some seconds.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data loss</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than 30 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes Node</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple Keycloak Pods run in a cluster. If the host node dies, then all pods on that node will fail and some incoming requests might receive an error message or are delayed for some seconds.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data loss</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than 30 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keycloak Clustering Connectivity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the connectivity between Kubernetes nodes is lost, data cannot be sent between Keycloak pods hosted on those nodes.
Incoming requests might receive an error message or be delayed for some seconds.
The Keycloak will eventually remove the unreachable pods from its local view and will stop sending data to them.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data loss</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds to minutes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Table footnotes:</div>
<p><sup>1</sup> Recovery point objective, assuming all parts of the setup were healthy at the time this occurred.<br>
<sup>2</sup> Recovery time objective.<br></p>
</div>
</div>
<div class="sect2">
<h3 id="_multiple_zones"><a class="anchor" href="#_multiple_zones"></a>Multiple Zones</h3>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Failure</th>
<th class="tableblock halign-left valign-top">Recovery</th>
<th class="tableblock halign-left valign-top">RPO<sup>1</sup></th>
<th class="tableblock halign-left valign-top">RTO<sup>2</sup></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database node<sup>3</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the writer instance fails, the database can promote a reader instance in the same or other zone to be the new writer.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data loss</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds to minutes (depending on the database)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keycloak pod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple Keycloak instances run in a cluster. If one instance fails some incoming requests might receive an error message or are delayed for some seconds.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data loss</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than 30 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes Node</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple Keycloak pods run in a cluster. If the host node dies, then all pods on that node will fail and some incoming requests might receive an error message or are delayed for some seconds.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data loss</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than 30 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Availability zone failure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If an availability-zone fails, all Keycloak pods hosted in that zone will also fail. Deploying at least the same number
of Keycloak replicas as availability-zones should ensure that no data is lost and minimal downtime occurs as there will
be other pods available to service requests.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data loss</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connectivity database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the connectivity between availability-zones is lost, the synchronous replication will fail.
Some requests might receive an error message or be delayed for a few seconds.
Manual operations might be necessary depending on the database.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data loss<sup>3</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds to minutes (depending on the database)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keycloak Clustering Connectivity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the connectivity between Kubernetes nodes is lost, data cannot be sent between Keycloak pods hosted on those nodes.
Incoming requests might receive an error message or be delayed for some seconds.
The Keycloak will eventually remove the unreachable pods from its local view and will stop sending data to them.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data loss</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds to minutes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Table footnotes:</div>
<p><sup>1</sup> Recovery point objective, assuming all parts of the setup were healthy at the time this occurred.<br>
<sup>2</sup> Recovery time objective.<br>
<sup>3</sup> Assumes that the database is also replicated across multiple availability-zones</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_known_limitations"><a class="anchor" href="#_known_limitations"></a>Known limitations</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Downtime during rollouts of Keycloak upgrades</p>
<div class="paragraph">
<p>This can be overcome for patch releases by enabling <a href="https://www.keycloak.org/nightly/server/update-compatibility#rolling-updates-for-patch-releases">Checking if rolling updates are possible</a>.</p>
</div>
</li>
<li>
<p>Multiple node failures can result in a loss of entries from the <code>authenticationSessions</code>, <code>loginFailures</code>
and <code>actionTokens</code> caches if the number of node failures is greater than or equal to the cache&#8217;s configured <code>num_owners</code>,
which by default is 2.</p>
</li>
<li>
<p>Deployments using the default <code>topologySpreadConstraints</code> with <code>whenUnsatisfiable: ScheduleAnyway</code>, may experience
data-loss on node/availability-zone failure if multiple pods are scheduled on the failed node/zone.</p>
<div class="paragraph">
<p>Users can mitigate against this scenario by defining <code>topologySpreadConstraints</code> with <code>whenUnsatisfiable: DoNotSchedule</code>,
to ensure that pods are always evenly scheduled across zones and nodes. However, this can result in some Keycloak
instances not being deployed if the constraints cannot be satisfied.</p>
</div>
<div class="paragraph">
<p>As Infinispan is unaware of the network topology when distributing cache entries, it is still possible for data-loss to
occur on node/availability-zone failure if all <code>num_owner</code> copies of cached data are stored in the failed node/zone.
You can restrict the total number of Keycloak instances to the number of nodes or availability-zones available by
defining a <code>requiredDuringSchedulingIgnoredDuringExecution</code> for nodes and zones. However, this comes at the expense of
scalability as the number of Keycloak instances that can be provisioned will be restricted to the number of
nodes/availability-zones in your Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>See the Operator <a href="https://www.keycloak.org/nightly/operator/advanced-configuration#_scheduling">Advanced configuration</a> details of how to configure custom
anti-affinity <code>topologySpreadConstraints</code> policies.</p>
</div>
</li>
<li>
<p>The Operator does not configure the site&#8217;s name (see <a href="https://www.keycloak.org/nightly/server/caching#cache-topology">Configuring distributed caches</a>) in the Pods as its value is not available via the <a href="https://kubernetes.io/docs/concepts/workloads/pods/downward-api/">Downward API</a>.
The machine name option is configured using the <code>spec.nodeName</code> from the node where the Pod is scheduled.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Continue reading in the <a href="https://www.keycloak.org/nightly/high-availability/single-cluster/building-blocks">Building blocks single-cluster deployments</a> guide to find blueprints for the different building blocks.</p>
</div>
</div>
</div>            </div>
        </div>

        <div class="col-md-3 mt-4 col-xl-2 col-sm-12 bg-light">
            <div class="sticky-top px-2 py-3">
                <div class="mt-2 mb-2 fw-bold">On this page</div>
                <div id="js-toc"></div>
                <div class="mt-4">
                    <a href="https://github.com/keycloak/keycloak/tree/main/docs/guides/high-availability/single-cluster/concepts.adoc" target="_blank"><i class="fa fa-edit"></i> Edit this guide</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.keycloak.org/resources/js/guide.js" type="text/javascript"></script>


<div class="container mt-5" data-nosnippet>
    <footer class="py-3 my-4 border-top">
        <p class="text-center text-muted">Keycloak is a Cloud Native Computing Foundation incubation project</p>
        <div class="text-center">
            <img style="aspect-ratio: 300/48" alt="Cloud Native Computing Foundation" src="https://www.keycloak.org/resources/images/cncf_logo.png" loading="lazy"/>
        </div>
        <p class="mt-4 text-center small text-muted">&copy; Keycloak Authors 2025. &copy; 2025 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage page</a>.</p>
    </footer>
</div>

<script src="https://www.keycloak.org/resources/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
<script src="https://www.keycloak.org/resources/tocbot/dist/tocbot.min.js" type="text/javascript"></script>
</body>
</html>
