
<!doctype html>
<html lang="en" prefix="og: https://ogp.me/ns#">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0J2P9316N6"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-0J2P9316N6');
</script>
<meta charset="utf-8"/>
<title>Managing upgrades - Keycloak</title>
<meta name="twitter:card" content="summary_large">
<meta name="twitter:site" content="@keycloak">
<meta property="og:site_name" content="Keycloak">
<meta property="og:title" content="Managing upgrades">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" property="og:description" content="How to manage multi-cluster upgrades">
<meta name="author" content="Keycloak Team">
<meta name="keywords" content="sso,idm,openid connect,saml,kerberos,ldap">
<meta name="robots" content="noindex">
<link href="https://www.keycloak.org/resources/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://www.keycloak.org/resources/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link href="https://www.keycloak.org/resources/css/keycloak.css" rel="stylesheet">
<link rel="canonical" href="https://www.keycloak.org/nightly/high-availability/multi-cluster/upgrades">
<meta property="og:url" content="https://www.keycloak.org/nightly/high-availability/multi-cluster/upgrades">
<link rel="icon" type="image/x-icon" href="https://www.keycloak.org/resources/favicon.ico">
<link rel="icon" type="image/vnd.microsoft.icon" href="https://www.keycloak.org/resources/favicon.ico">
<link rel="icon" type="image/svg+xml" href="https://www.keycloak.org/resources/favicon.svg"></head>
<body>

<header class="navbar navbar-expand-md bg-light shadow-sm">
<nav class="container-xxl flex-wrap flex-md-no-wrap navbar-light" data-nosnippet>
    <a class="navbar-brand me-3 me-md-4 me-lg-5" href="https://www.keycloak.org/">
        <img style="aspect-ratio: 730/151" class="img-fluid" src="https://www.keycloak.org/resources/images/logo.svg" width="240" alt="Keycloak"/>
    </a>
    <a class="nav-link d-none d-sm-block d-md-none d-lg-block" href="https://github.com/keycloak/keycloak"><img src="https://www.keycloak.org/resources/images/stars-large.svg" style="height: 25px; aspect-ratio: 128/20" alt="GitHub stars"/></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="fa fa-bars fa-lg px-1 py-2"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav flex-row flex-wrap bd-navbar-nav pt-2 py-md-0">
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/guides">Guides</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/documentation">Docs</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/downloads">Downloads</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/community">Community</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/blog">Blog</a>
        </li>
      </ul>
    </div>
    <div class="d-block d-sm-none d-md-block d-lg-none text-center vw-100">
        <a class="nav-link d-inline p-0" href="https://github.com/keycloak/keycloak"><img src="https://www.keycloak.org/resources/images/stars-large.svg" style="height: 25px; aspect-ratio: 128/20" alt="GitHub stars"/></a>
    </div>
</nav>
</header>


<div class="container mt-5 kc-article">
    <div class="row">
        <div class="col-md-9 col-xl-10 col-sm-12">
            <div class="d-flex align-items-center mb-3">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="https://www.keycloak.org/nightly/guides">Guides</a></li>
                        <li class="breadcrumb-item"><a href="https://www.keycloak.org/nightly/guides#high-availability">High availability</a></li>
                          <li class="breadcrumb-item"><a href="https://www.keycloak.org/nightly/high-availability/multi-cluster/introduction">Multi cluster</a></li>
                        <li class="breadcrumb-item active">Managing upgrades</li>
                    </ol>
                </nav>
            </div>

                <div class="mb-4 alert alert-warning" role="alert">
                  <h4 class="no-top-margin">Nightly release</h4>

                  This guide is for the unstable nightly release, for the latest release go <a href="https://www.keycloak.org/high-availability/multi-cluster/upgrades">here</a>.
                </div>

            <div class="mb-4">
                <div data-nosnippet class="me-3 float-end">
                    <select aria-label="Version" onchange="location = this.options[this.selectedIndex].value;" class="form-select">
                        <option value="https://www.keycloak.org/nightly/high-availability/multi-cluster/upgrades" selected="selected">Nightly</option>
                        <option value="https://www.keycloak.org/high-availability/multi-cluster/upgrades" >26.5.3</option>
                    </select>
                </div>

                <h1>Managing upgrades</h1>
                    <span class="text-muted">How to manage multi-cluster upgrades</span>
            </div>



            <div class="kc-asciidoc" id="guide-body">
<div class="sect1">
<h2 id="_keycloak_upgrades"><a class="anchor" href="#_keycloak_upgrades"></a>Keycloak upgrades</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to update to a new major or minor version of Keycloak, it is expected that the Keycloak deployment
on each site is taken offline during the upgrade procedure as described in <a href="https://www.keycloak.org/nightly/high-availability/multi-cluster/operate-site-offline">Taking a site offline</a>.
Deploying different Keycloak major/minor versions on each of the sites is not supported. Neither site should be
exposed to user requests via the load balancer until both Keycloak deployments have been upgraded and their
Infinispan clusters synchronized.</p>
</div>
<div class="paragraph">
<p>Patch upgrades can be deployed with zero-downtime, using the <code>rolling-updates:v2</code> feature. It is technically
possible for upgrades to be rolled out to both sites simultaneously, however we recommend that upgrades be rolled out to one
site at a time in order to simplify monitoring and debugging. For example, all nodes in site A should be upgraded to the
new Keycloak version before the upgrade is rolled out to nodes in site B.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://www.keycloak.org/nightly/operator/rolling-updates">Avoiding downtime with rolling updates</a> guide for more details on how to use the <code>rolling-updates:v2</code> Feature.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_infinispan_upgrades"><a class="anchor" href="#_infinispan_upgrades"></a>Infinispan upgrades</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrading Infinispan to a new major or minor version, requires the Infinispan cluster to be shutdown and redeployed
on both sites. This results in Keycloak downtime, as requests cannot succeed without a Infinispan cluster. The
Keycloak deployments should not be exposed via the load balancer until both Infinispan clusters have been upgraded,
marked as online and synchronized.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As major and minor upgrades of both Keycloak and Infinispan require downtime, we recommend that these upgrades
be performed during the same maintenance window in order to reduce overall service downtime.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Infinispan supports zero-downtime upgrades of patch versions for local clusters, however it does not support running
cross-site clusters with different patch versions on each site. Therefore, in order to upgrade Infinispan patch versions
with zero-downtime, it is necessary for the upgrade to be applied as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Take site B offline</p>
</li>
<li>
<p>Shutdown site B</p>
</li>
<li>
<p>Perform an in-place upgrade of Infinispan on site A and wait for it to complete</p>
</li>
<li>
<p>Deploy the new Infinispan version to site B</p>
</li>
<li>
<p>Bring site B online</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Site B will no longer be able to serve Keycloak requests during steps 1-4, however the load balancer should ensure
these requests are still served by site A, hence downtime is avoided.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://infinispan.org/docs/infinispan-operator/main/operator.html#upgrading-clusters">Infinispan cluster upgrade documentation</a> for more details
on how to perform Infinispan in-place upgrades.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database_upgrades"><a class="anchor" href="#_database_upgrades"></a>Database upgrades</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Database upgrade semantics vary depending on the vendor chosen. In general, it should be possible for Keycloak to
continue to function as expected if the database natively supports zero-downtime upgrades, for example AWS Aurora. If the
database does not support zero-downtime upgrades, then it is necessary for the Keycloak deployment to be shutdown on
both sites before the database is upgraded. Once the database upgrade has completed, it is then possible to redeploy
Keycloak to both sites.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a database upgrade cannot be performed without downtime, it is recommended to also perform Keycloak and
Infinispan major/minor upgrades in the same maintenance window as these also require downtime.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>            </div>
        </div>

        <div class="col-md-3 mt-4 col-xl-2 col-sm-12 bg-light">
            <div class="sticky-top px-2 py-3">
                <div class="mt-2 mb-2 fw-bold">On this page</div>
                <div id="js-toc"></div>
                <div class="mt-4">
                    <a href="https://github.com/keycloak/keycloak/tree/main/docs/guides/high-availability/multi-cluster/upgrades.adoc" target="_blank"><i class="fa fa-edit"></i> Edit this guide</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.keycloak.org/resources/js/guide.js" type="text/javascript"></script>


<div class="container mt-5" data-nosnippet>
    <footer class="py-3 my-4 border-top">
        <p class="text-center text-muted">Keycloak is a Cloud Native Computing Foundation incubation project</p>
        <div class="text-center">
            <img style="aspect-ratio: 300/48" alt="Cloud Native Computing Foundation" src="https://www.keycloak.org/resources/images/cncf_logo.png" loading="lazy"/>
        </div>
        <p class="mt-4 text-center small text-muted">&copy; Keycloak Authors 2025. &copy; 2025 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage page</a>.</p>
    </footer>
</div>

<script src="https://www.keycloak.org/resources/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
<script src="https://www.keycloak.org/resources/tocbot/dist/tocbot.min.js" type="text/javascript"></script>
</body>
</html>
