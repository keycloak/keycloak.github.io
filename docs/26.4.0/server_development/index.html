<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Server Developer Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<style>
/* Top menu */

@media only screen and (min-width: 768px) {
       div.top-menu-guides {
              position: fixed;
              display: inline-block;
              top: 0;
              left: 0;
              z-index: 9999;
       }

       div.top-menu-guides p {
              margin: 0;
              padding: 0;
       }

       div.top-menu-guides .content {
              margin: 0;
              padding: 7px 20px 0 20px;
              background-color: #ededed;
              height: 48px;
              width: 20em;
       }

       @media only screen and (max-width: 1280px) {
              div.top-menu-guides .content {
                     width: 15em;
              }
       }

       div.top-menu-guides .ulist {
              display: none;
              position: absolute;
              background-color: #f9f9f9;
              min-width: 160px;
              box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
              padding: 0px;
              margin-top: 12px;
       }

       div.top-menu-guides .ulist ul {
              list-style: none;
              padding: 5px;
              margin: 0;
       }

       div.top-menu-guides .ulist li {
              padding: 5px 10px;
       }

       div.top-menu-guides:hover .ulist {
           display: block;
       }

       div.top-menu-version {
           position: fixed;
           top: 0;
           z-index: 9999;
       }

       div.top-menu-version .content {
           padding: 0;
           margin: 0;
           background-color: #eee;
           height: 48px;
           padding: 7px;
       }

        div.top-menu-version p {
            margin: 0;
            padding: 2px 5px 2px 10px;
        }

}

/* TOC */

#tocbot a.toc-link.node-name--H1{ font-style: italic }
@media screen{
#tocbot > ul.toc-list{ margin-bottom: 0.5em; margin-left: 0.125em }
#tocbot ul.sectlevel0, #tocbot a.toc-link.node-name--H1 + ul{
  padding-left: 0 }
#tocbot a.toc-link{ height:100% }
.is-collapsible{ max-height:3000px; overflow:hidden; }
.is-collapsed{ max-height:0 }
.is-active-link{ font-weight:700 }
}
@media print{
#tocbot a.toc-link.node-name--H4{ display:none }
}

/* Fix scroll to anchor hides title */
h1::before, h2::before, h3::before, h4::before, h5::before, h6::before {
    display: block;
    content: " ";
    height: 70px;
    margin-top: -70px;
}

h1 {
    border-bottom: none !important
}

#toc.toc2 {
    top: 30px;
    bottom: 0px;
    height: unset;
}

body.toc2 {
    padding-top: 30px;
}

@media only screen and (min-width:768px) {
    #toc.toc2 {
        top: 40px;
    }

    body.toc2 {
        padding-top: 40px;
    }
}

@media only screen and (min-width:1280px) {
    #toc.toc2 {
        top: 48px;
    }

    body.toc2 {
        padding-top: 48px;
    }
}


/* General Changes */

h1, h2, h3, #toctitle, .sidebarblock>.content>.title, h4, h5, h6 {
    color: #444444;
    font-weight: 500;
}

a {
    color: #004670;
    text-decoration: none;
}

a:hover {
    color: #7da1dc;
}

body {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    color: #444444;
}

.subheader, .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    color: #444444;
}

.admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    font-style: normal;
}

span.image img {
    border:1px solid #ccc;
    -webkit-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    -moz-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
}

.sect1+.sect1 {
    border-top: none;
}

.page-links {
    border-bottom: 1px solid #efefed;
    border-top: none;
    background: none;
    position: relative;
    left: 0em;
    width: 100%;
    top: -5em;
    height: 0;
    margin: 0;
    padding: 0;
}

.sect2 .page-links {
    top: -3.5em;
}

.page-links .content {
    background: #f8f8f7;
    border: 1px solid #e0e0dc;
    float: right;
    font-size: 0.8em;
    margin: 0;
    padding: 5px;
}

.page-links a {
    display: block;
    padding: 5px;
}
</style>

</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Server Developer Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#preface">Preface</a></li>
<li><a href="#admin-rest-api">Admin REST API</a>
<ul class="sectlevel2">
<li><a href="#examples-of-using-curl">Examples of using CURL</a>
<ul class="sectlevel3">
<li><a href="#authenticating-with-a-username-and-password">Authenticating with a username and password</a></li>
<li><a href="#authenticating-with-a-service-account">Authenticating with a service account</a></li>
</ul>
</li>
<li><a href="#additional-resources">Additional resources</a></li>
</ul>
</li>
<li><a href="#identity-brokering-apis">Identity Brokering APIs</a>
<ul class="sectlevel2">
<li><a href="#retrieving-external-idp-tokens">Retrieving external IDP tokens</a></li>
<li><a href="#client-initiated-account-linking">Client initiated account linking</a>
<ul class="sectlevel3">
<li><a href="#refreshing-external-tokens">Refreshing external tokens</a></li>
<li><a href="#legacy-client-initiated-account-linking">Legacy client initiated account linking</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_providers">Service Provider Interfaces (SPI)</a>
<ul class="sectlevel2">
<li><a href="#_implementing_spi">Implementing an SPI</a>
<ul class="sectlevel3">
<li><a href="#_override_builtin_providers">Override built-in providers</a></li>
<li><a href="#_providers_admin_console">Show info from your SPI implementation in the Admin Console</a></li>
</ul>
</li>
<li><a href="#_use_available_providers">Use available providers</a></li>
<li><a href="#registering-provider-implementations">Registering provider implementations</a>
<ul class="sectlevel3">
<li><a href="#disabling-a-provider">Disabling a provider</a></li>
</ul>
</li>
<li><a href="#_script_providers">JavaScript providers</a>
<ul class="sectlevel3">
<li><a href="#authenticator">Authenticator</a></li>
<li><a href="#openid-connect-protocol-mapper">OpenID Connect Protocol Mapper</a></li>
<li><a href="#create-a-jar-with-the-scripts-to-deploy">Create a JAR with the scripts to deploy</a></li>
<li><a href="#deploy-the-script-jar">Deploy the script JAR</a></li>
</ul>
</li>
<li><a href="#available-spis">Available SPIs</a></li>
</ul>
</li>
<li><a href="#_extensions">Extending the server</a>
<ul class="sectlevel2">
<li><a href="#_extensions_rest">Add custom REST endpoints</a></li>
<li><a href="#_extensions_spi">Add your own custom SPI</a></li>
<li><a href="#_extensions_jpa">Add custom JPA entities to the Keycloak data model</a></li>
</ul>
</li>
<li><a href="#_auth_spi">Authentication SPI</a>
<ul class="sectlevel2">
<li><a href="#terms">Terms</a></li>
<li><a href="#algorithm-overview">Algorithm overview</a></li>
<li><a href="#_auth_spi_walkthrough">Authenticator SPI walk through</a>
<ul class="sectlevel3">
<li><a href="#packaging-classes-and-deployment">Packaging classes and deployment</a></li>
<li><a href="#extending-the-credentialmodel-class">Extending the CredentialModel class</a></li>
<li><a href="#implementing-a-credentialprovider">Implementing a CredentialProvider</a></li>
<li><a href="#implementing-an-authenticator">Implementing an authenticator</a></li>
<li><a href="#implementing-an-authenticatorfactory">Implementing an AuthenticatorFactory</a></li>
<li><a href="#adding-an-authenticator-form">Adding an authenticator form</a></li>
<li><a href="#_adding_authenticator">Adding an authenticator to a flow</a></li>
</ul>
</li>
<li><a href="#required-action-walkthrough">Required action walkthrough</a>
<ul class="sectlevel3">
<li><a href="#packaging-classes-and-deployment-2">Packaging classes and deployment</a></li>
<li><a href="#implement-the-requiredactionprovider">Implement the RequiredActionProvider</a></li>
<li><a href="#implement-the-requiredactionfactory">Implement the RequiredActionFactory</a></li>
<li><a href="#enable-required-action">Enable required action</a></li>
</ul>
</li>
<li><a href="#modifying-or-extending-the-registration-form">Modifying or extending the registration form</a>
<ul class="sectlevel3">
<li><a href="#implementation-formaction-interface">Implementation FormAction interface</a></li>
<li><a href="#packaging-the-action">Packaging the action</a></li>
<li><a href="#adding-formaction-to-the-registration-flow">Adding FormAction to the registration flow</a></li>
</ul>
</li>
<li><a href="#modifying-forgot-passwordcredential-flow">Modifying forgot password/credential flow</a></li>
<li><a href="#modifying-first-broker-login-flow">Modifying first broker login flow</a></li>
<li><a href="#_client_authentication">Authentication of clients</a>
<ul class="sectlevel3">
<li><a href="#default-implementations">Default implementations</a></li>
<li><a href="#implement-your-own-client-authenticator">Implement your own client authenticator</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_action_token_handler_spi">Action Token Handler SPI</a>
<ul class="sectlevel2">
<li><a href="#_action_token_anatomy">Anatomy of action token</a></li>
<li><a href="#action-token-processing">Action token processing</a></li>
<li><a href="#implement-your-own-action-token-and-its-handler">Implement your own action token and its handler</a>
<ul class="sectlevel3">
<li><a href="#how-to-create-an-action-token">How to create an action token</a></li>
<li><a href="#packaging-classes-and-deployment-3">Packaging classes and deployment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_events">Event Listener SPI</a></li>
<li><a href="#_saml_role_mappings_spi">SAML role mappings SPI</a>
<ul class="sectlevel2">
<li><a href="#implementing-a-custom-role-mappings-provider">Implementing a custom role mappings provider</a></li>
</ul>
</li>
<li><a href="#_user-storage-spi">User Storage SPI</a>
<ul class="sectlevel2">
<li><a href="#accessing-the-new-entity-manager">Accessing the new entity manager</a></li>
<li><a href="#provider-interfaces">Provider interfaces</a></li>
<li><a href="#_provider_capability_interfaces">Provider capability interfaces</a></li>
<li><a href="#model-interfaces">Model interfaces</a>
<ul class="sectlevel3">
<li><a href="#storage-ids">Storage Ids</a></li>
</ul>
</li>
<li><a href="#packaging-and-deployment">Packaging and deployment</a></li>
<li><a href="#simple-read-only-lookup-example">Simple read-only, lookup example</a>
<ul class="sectlevel3">
<li><a href="#provider-class">Provider class</a></li>
<li><a href="#provider-factory-implementation">Provider factory implementation</a></li>
<li><a href="#packaging-and-deployment-2">Packaging and deployment</a></li>
<li><a href="#enabling-the-provider-in-the-admin-console">Enabling the provider in the Admin Console</a></li>
</ul>
</li>
<li><a href="#configuration-techniques">Configuration techniques</a>
<ul class="sectlevel3">
<li><a href="#configuration-example">Configuration example</a></li>
<li><a href="#configuring-the-provider-in-the-admin-console">Configuring the provider in the Admin Console</a></li>
</ul>
</li>
<li><a href="#addremove-user-and-query-capability-interfaces">Add/Remove user and query capability interfaces</a>
<ul class="sectlevel3">
<li><a href="#implementing-userregistrationprovider">Implementing UserRegistrationProvider</a></li>
<li><a href="#implementing-userqueryprovider">Implementing UserQueryProvider</a></li>
</ul>
</li>
<li><a href="#augmenting-external-storage">Augmenting external storage</a>
<ul class="sectlevel3">
<li><a href="#augmentation-example">Augmentation example</a></li>
</ul>
</li>
<li><a href="#import-implementation-strategy">Import implementation strategy</a>
<ul class="sectlevel3">
<li><a href="#importeduservalidation-interface">ImportedUserValidation interface</a></li>
<li><a href="#importsynchronization-interface">ImportSynchronization interface</a></li>
</ul>
</li>
<li><a href="#user-caches">User caches</a>
<ul class="sectlevel3">
<li><a href="#managing-the-user-cache">Managing the user cache</a></li>
<li><a href="#onusercache-callback-interface">OnUserCache callback interface</a></li>
<li><a href="#cache-policies">Cache policies</a></li>
</ul>
</li>
<li><a href="#leveraging-jakarta-ee">Leveraging Jakarta EE</a></li>
<li><a href="#rest-management-api">REST management API</a></li>
<li><a href="#migrating-from-an-earlier-user-federation-spi">Migrating from an earlier user federation SPI</a>
<ul class="sectlevel3">
<li><a href="#import-versus-non-import">Import versus non-import</a></li>
<li><a href="#userfederationprovider-versus-userstorageprovider">UserFederationProvider versus UserStorageProvider</a></li>
<li><a href="#userfederationproviderfactory-versus-userstorageproviderfactory">UserFederationProviderFactory versus UserStorageProviderFactory</a></li>
<li><a href="#upgrading-to-a-new-model">Upgrading to a new model</a></li>
</ul>
</li>
<li><a href="#_stream_based_interfaces">Stream-based interfaces</a></li>
</ul>
</li>
<li><a href="#_vault-spi">Vault SPI</a>
<ul class="sectlevel2">
<li><a href="#vault-provider">Vault provider</a></li>
<li><a href="#consuming-values-from-vault">Consuming values from vault</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="exampleblock top-menu-guides">
<div class="content">
<div class="paragraph">
<p><strong>Server Developer</strong> <span class="icon"><i class="fa fa-angle-down"></i></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.keycloak.org/guides#getting-started">Getting Started</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/guides#securing-apps">Securing applications</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/26.4.0/server_admin/">Server Administration</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/26.4.0/authorization_services/">Authorization Services</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/26.4.0/upgrading/">Upgrading</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/26.4.0/release_notes/">Release Notes</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock top-menu-version">
<div class="content">
<div class="paragraph">
<p>Version <strong>26.4.0</strong></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preface"><a class="anchor" href="#preface"></a>Preface</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/preface.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/preface.adoc&amp;description=%0A%0AFile:%20server_development/topics/preface.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>In some of the example listings, what is meant to be displayed on one line does not fit inside the available page width. These lines have been broken up. A '\' at the end of a line means that a break has been introduced to fit in the page, with the following lines indented.
So:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Let's pretend to have an extremely \
  long line that \
  does not fit
This one is short</code></pre>
</div>
</div>
<div class="paragraph">
<p>Is really:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Let's pretend to have an extremely long line that does not fit
This one is short</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="admin-rest-api"><a class="anchor" href="#admin-rest-api"></a>Admin REST API</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/admin-rest-api.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/admin-rest-api.adoc&amp;description=%0A%0AFile:%20server_development/topics/admin-rest-api.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak comes with a fully functional Admin REST API with all features provided by the Admin Console.</p>
</div>
<div class="paragraph">
<p>To invoke the API you need to obtain an access token with the appropriate permissions. The required permissions are described in the <a href="https://www.keycloak.org/docs/26.4.0/server_admin/">Server Administration Guide</a>.</p>
</div>
<div class="paragraph">
<p>You can obtain a token by enabling authentication for your application using Keycloak; see the Securing Applications and Services Guide. You can also use direct access grant to obtain an access token.</p>
</div>
<div class="sect2">
<h3 id="examples-of-using-curl"><a class="anchor" href="#examples-of-using-curl"></a>Examples of using CURL</h3>
<div class="sect3">
<h4 id="authenticating-with-a-username-and-password"><a class="anchor" href="#authenticating-with-a-username-and-password"></a>Authenticating with a username and password</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The following example assumes that you created the user <code>admin</code> with the password <code>password</code> in the <code>master</code> realm as shown in the <a href="https://www.keycloak.org/guides#getting-started">Getting Started Guide</a> tutorial.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Obtain an access token for the user in the realm <code>master</code> with username <code>admin</code> and password <code>password</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl \
  -d &quot;client_id=admin-cli&quot; \
  -d &quot;username=admin&quot; \
  -d &quot;password=password&quot; \
  -d &quot;grant_type=password&quot; \
  &quot;http://localhost:8080/realms/master/protocol/openid-connect/token&quot;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default this token expires in 1 minute
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The result will be a JSON document.</p>
</div>
</li>
<li>
<p>Invoke the API you need by extracting the value of the <code>access_token</code> property.</p>
</li>
<li>
<p>Invoke the API by including the value in the <code>Authorization</code> header of requests to the API.</p>
<div class="paragraph">
<p>The following example shows how to get the details of the master realm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl \
  -H &quot;Authorization: bearer eyJhbGciOiJSUz...&quot; \
  &quot;http://localhost:8080/admin/realms/master&quot;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="authenticating-with-a-service-account"><a class="anchor" href="#authenticating-with-a-service-account"></a>Authenticating with a service account</h4>
<div class="paragraph">
<p>To authenticate against the Admin REST API using a <code>client_id</code> and a <code>client_secret</code>, perform this procedure.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Make sure the client is configured as follows:</p>
<div class="ulist">
<ul>
<li>
<p><code>client_id</code> is a <strong>confidential</strong> client that belongs to the realm <strong>master</strong></p>
</li>
<li>
<p><code>client_id</code> has <code>Service Accounts Enabled</code> option enabled</p>
</li>
<li>
<p><code>client_id</code> has a custom "Audience" mapper</p>
<div class="ulist">
<ul>
<li>
<p>Included Client Audience: <code>security-admin-console</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Check that <code>client_id</code> has the role 'admin' assigned in the "Service Account Roles" tab.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl \
  -d &quot;client_id=&lt;YOUR_CLIENT_ID&gt;&quot; \
  -d &quot;client_secret=&lt;YOUR_CLIENT_SECRET&gt;&quot; \
  -d &quot;grant_type=client_credentials&quot; \
  &quot;http://localhost:8080/realms/master/protocol/openid-connect/token&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="additional-resources"><a class="anchor" href="#additional-resources"></a>Additional resources</h3>
<div class="ulist _additional-resources">
<ul>
<li>
<p><a href="https://www.keycloak.org/docs/26.4.0/server_admin/">Server Administration Guide</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/26.4.0/api_documentation/">API Documentation</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="identity-brokering-apis"><a class="anchor" href="#identity-brokering-apis"></a>Identity Brokering APIs</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/identity-brokering.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/identity-brokering.adoc&amp;description=%0A%0AFile:%20server_development/topics/identity-brokering.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak can delegate authentication to a parent IDP for login.  A typical example of this is the case
where you want users to be able to log in through a social provider such as Facebook or Google. You can
also link existing accounts to a brokered IDP.  This section describes some APIs that your applications
can use as it pertains to identity brokering.</p>
</div>
<div class="sect2">
<h3 id="retrieving-external-idp-tokens"><a class="anchor" href="#retrieving-external-idp-tokens"></a>Retrieving external IDP tokens</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/identity-brokering/tokens.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/identity-brokering/tokens.adoc&amp;description=%0A%0AFile:%20server_development/topics/identity-brokering/tokens.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak allows you to store tokens and responses from the authentication process with the external IDP.
For that, you can use the <code>Store Token</code> configuration option on the IDP&#8217;s settings page.</p>
</div>
<div class="paragraph">
<p>Application code can retrieve these tokens and responses to pull in extra user information, or to securely invoke requests on the external IDP.
For example, an application might want to use the Google token to invoke on other Google services and REST APIs.
To retrieve a token for a particular identity provider you need to send a request as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>GET /realms/{realm-name}/broker/{provider_alias}/token HTTP/1.1
Host: localhost:8080
Authorization: Bearer &lt;KEYCLOAK ACCESS TOKEN&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An application must have authenticated with Keycloak and have received an access token.  This access token
will need to have the <code>broker</code> client-level role <code>read-token</code> set.  This means that the user must have a role mapping for this role
and the client application must have that role within its scope.
In this case, given that you are accessing a protected service in Keycloak, you need to send the access token issued by Keycloak during the user authentication.
In the broker configuration page you can automatically assign this role to newly imported users by turning on the <code>Stored Tokens Readable</code> switch.</p>
</div>
<div class="paragraph">
<p>These external tokens can be re-established by either logging in again through the provider, or using the client initiated account linking API.</p>
</div>
</div>
<div class="sect2">
<h3 id="client-initiated-account-linking"><a class="anchor" href="#client-initiated-account-linking"></a>Client initiated account linking</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/identity-brokering/account-linking.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/identity-brokering/account-linking.adoc&amp;description=%0A%0AFile:%20server_development/topics/identity-brokering/account-linking.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Some applications want to integrate with social providers like Facebook, but do not want to provide an option to login via
these social providers.  Keycloak offers a browser-based API that applications can use to link an existing
user account to a specific external IDP.  This is called client-initiated account linking. Account linking can only be initiated by OIDC applications.</p>
</div>
<div class="paragraph">
<p>The way it works is that the application forwards the user&#8217;s browser to a URL on the Keycloak server requesting
that it wants to link the user&#8217;s account to a specific external provider (i.e. Facebook).  The server
initiates a login with the external provider.  The browser logs in at the external provider and is redirected
back to the server.  The server establishes the link and redirects back to the application with a confirmation.</p>
</div>
<div class="paragraph">
<p>There are some preconditions that must be met by the client application before it can initiate this protocol:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The desired identity provider must be configured and enabled for the user&#8217;s realm in the admin console.</p>
</li>
<li>
<p>The user must have an <code>account.manage-account</code> or <code>account.manage-account-links</code> role mapping.</p>
</li>
<li>
<p>The application must be granted the scope for those roles within its access token</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The protocol is realized by the <a href="https://www.keycloak.org/docs/26.4.0/server_admin/#con-aia_server_administration_guide">Application-initiated action (AIA)</a>. If you want the user, who is authenticated in your client application, to link
to the identity provider, attach the parameter <code>kc_action</code> with the value <code>idp_link:&lt;identity-provider-alias&gt;</code> to the OIDC authentication URL and redirect the user to this URL. For example,
to request linking to the identity provider with the alias <code>my-oidc-provider</code>, attach the parameter such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>kc_action=idp_link:my-oidc-provider</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="refreshing-external-tokens"><a class="anchor" href="#refreshing-external-tokens"></a>Refreshing external tokens</h4>
<div class="paragraph">
<p>If you use the external token generated by logging into the provider (such as a Facebook or GitHub token), you can refresh this token by re-initiating the account linking API.</p>
</div>
</div>
<div class="sect3">
<h4 id="legacy-client-initiated-account-linking"><a class="anchor" href="#legacy-client-initiated-account-linking"></a>Legacy client initiated account linking</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The legacy client initiated account linking is using a custom protocol that is not based on AIA. If you are use this protocol, consider migrating
your client application to the AIA based protocol described above because legacy client initiated account linking might be removed in the future Keycloak versions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition to the preconditions above, the legacy client initiated account linking has another precondition:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The user account must already be logged in as an existing user via the OIDC protocol</p>
</li>
<li>
<p>The application must have access to its access token as it needs information within it to generate the redirect URL.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To initiate the login, the application must fabricate a URL and redirect the user&#8217;s browser to this URL.  The URL looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/{auth-server-root}/realms/{realm-name}/broker/{provider}/link?client_id={id}&amp;redirect_uri={uri}&amp;nonce={nonce}&amp;hash={hash}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a description of each path and query param:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">provider</dt>
<dd>
<p>This is the provider alias of the external IDP that you defined in the <code>Identity Provider</code> section of the admin console.</p>
</dd>
<dt class="hdlist1">client_id</dt>
<dd>
<p>This is the OIDC client id of your application.  When you registered the application as a client in the admin console,
you had to specify this client id.</p>
</dd>
<dt class="hdlist1">redirect_uri</dt>
<dd>
<p>This is the application callback URL you want to redirect to after the account link is established.  It must be a valid
client redirect URI pattern.  In other words, it must match one of the valid URL patterns you defined when you registered
the client in the admin console.</p>
</dd>
<dt class="hdlist1">nonce</dt>
<dd>
<p>This is a random string that your application must generate</p>
</dd>
<dt class="hdlist1">hash</dt>
<dd>
<p>This is a Base64 URL encoded hash.  This hash is generated by Base64 URL encoding a SHA_256 hash of <code>nonce</code> + <code>token.getSessionState()</code> + <code>token.getIssuedFor()</code> + <code>provider</code>.
The token variable are obtained from the OIDC access token.  Basically you are hashing the random nonce, the user session id, the client id, and the identity
provider alias you want to access.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of Java Servlet code that generates the URL to establish the account link.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   KeycloakSecurityContext session = (KeycloakSecurityContext) httpServletRequest.getAttribute(KeycloakSecurityContext.class.getName());
   AccessToken token = session.getToken();
   <span class="predefined-type">String</span> clientId = token.getIssuedFor();
   <span class="predefined-type">String</span> nonce = <span class="predefined-type">UUID</span>.randomUUID().toString();
   <span class="predefined-type">MessageDigest</span> md = <span class="predefined-constant">null</span>;
   <span class="keyword">try</span> {
      md = <span class="predefined-type">MessageDigest</span>.getInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">SHA-256</span><span class="delimiter">&quot;</span></span>);
   } <span class="keyword">catch</span> (<span class="exception">NoSuchAlgorithmException</span> e) {
      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(e);
   }
   <span class="predefined-type">String</span> input = nonce + token.getSessionState() + clientId + provider;
   <span class="type">byte</span><span class="type">[]</span> check = md.digest(input.getBytes(StandardCharsets.UTF_8));
   <span class="predefined-type">String</span> hash = Base64Url.encode(check);
   request.getSession().setAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">hash</span><span class="delimiter">&quot;</span></span>, hash);
   <span class="predefined-type">String</span> redirectUri = ...;
   <span class="predefined-type">String</span> accountLinkUrl = KeycloakUriBuilder.fromUri(authServerRootUrl)
                    .path(<span class="string"><span class="delimiter">&quot;</span><span class="content">/realms/{realm-name}/broker/{provider}/link</span><span class="delimiter">&quot;</span></span>)
                    .queryParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">nonce</span><span class="delimiter">&quot;</span></span>, nonce)
                    .queryParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">hash</span><span class="delimiter">&quot;</span></span>, hash)
                    .queryParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">client_id</span><span class="delimiter">&quot;</span></span>, clientId)
                    .queryParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">redirect_uri</span><span class="delimiter">&quot;</span></span>, redirectUri).build(realm, provider).toString();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why is this hash included?  We do this so that the auth server is guaranteed to know that the client application initiated the request and no other rogue app
just randomly asked for a user account to be linked to a specific provider.  The auth server will first check to see if the user is logged in by checking the SSO
cookie set at login.  It will then try to regenerate the hash based on the current login and match it up to the hash sent by the application.</p>
</div>
<div class="paragraph">
<p>After the account has been linked, the auth server will redirect back to the <code>redirect_uri</code>.  If there is a problem servicing the link request,
the auth server may or may not redirect back to the <code>redirect_uri</code>.  The browser may just end up at an error page instead of being redirected back
to the application.  If there is an error condition and the auth server deems it safe enough to redirect back to the client app, an additional
<code>error</code> query parameter will be appended to the <code>redirect_uri</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
   While this API guarantees that the application initiated the request, it does not completely prevent CSRF attacks for this operation.  The application
   is still responsible for guarding against CSRF attacks target at itself.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_providers"><a class="anchor" href="#_providers"></a>Service Provider Interfaces (SPI)</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/providers.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/providers.adoc&amp;description=%0A%0AFile:%20server_development/topics/providers.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak is designed to cover most use-cases without requiring custom code, but we also want it to be customizable.
To achieve this Keycloak has a number of Service Provider Interfaces (SPI) for which you can implement your own providers.</p>
</div>
<div class="sect2">
<h3 id="_implementing_spi"><a class="anchor" href="#_implementing_spi"></a>Implementing an SPI</h3>
<div class="paragraph">
<p>To implement an SPI you need to implement its ProviderFactory and Provider interfaces. You also need to create a service configuration file.</p>
</div>
<div class="paragraph">
<p>For example, to implement the Theme Selector SPI you need to implement ThemeSelectorProviderFactory and ThemeSelectorProvider and also provide the file
<code>META-INF/services/org.keycloak.theme.ThemeSelectorProviderFactory</code>.</p>
</div>
<div class="paragraph">
<p>Example ThemeSelectorProviderFactory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.acme.provider</span>;

<span class="keyword">import</span> ...

<span class="include">public</span> <span class="include">class</span> <span class="include">MyThemeSelectorProviderFactory</span> <span class="include">implements</span> <span class="include">ThemeSelectorProviderFactory</span> {

    <span class="annotation">@Override</span>
    <span class="include">public</span> <span class="include">ThemeSelectorProvider</span> <span class="include">create</span>(<span class="include">KeycloakSession</span> <span class="include">session</span>) {
        <span class="include">return</span> <span class="include">new</span> <span class="include">MyThemeSelectorProvider</span>(<span class="include">session</span>);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> init(Config.Scope config) {
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> postInit(KeycloakSessionFactory factory) {
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> close() {
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">myThemeSelector</span><span class="delimiter">&quot;</span></span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is recommended that your provider factory implementation returns unique id by method <code>getId()</code>. However
there can be some exceptions to this rule as mentioned below in the <a href="#_override_builtin_providers">Overriding providers</a> section.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Keycloak creates a single instance of provider factories which makes it possible to store state for multiple requests.
Provider instances are created by calling create on the factory for each request so these should be light-weight object.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Example ThemeSelectorProvider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.acme.provider</span>;

<span class="keyword">import</span> ...

<span class="include">public</span> <span class="include">class</span> <span class="include">MyThemeSelectorProvider</span> <span class="include">implements</span> <span class="include">ThemeSelectorProvider</span> {

    <span class="include">public</span> <span class="include">MyThemeSelectorProvider</span>(<span class="include">KeycloakSession</span> <span class="include">session</span>) {
    }


    <span class="annotation">@Override</span>
    <span class="include">public</span> <span class="include">String</span> <span class="include">getThemeName</span>(<span class="include">Theme.Type</span> <span class="include">type</span>) {
        <span class="include">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">my-theme</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> close() {
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example service configuration file (<code>META-INF/services/org.keycloak.theme.ThemeSelectorProviderFactory</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>org.acme.provider.MyThemeSelectorProviderFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure your provider, see the <a href="https://www.keycloak.org/server/configuration-provider">Configuring Providers</a> guide.</p>
</div>
<div class="paragraph">
<p>For example, to configure a provider you can set options as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bin/kc.[sh|bat] --spi-theme-selector--my-theme-selector--enabled=true --spi-theme-selector--my-theme-selector--theme=my-theme</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can retrieve the config in the <code>ProviderFactory</code> init method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> init(Config.Scope config) {
    <span class="predefined-type">String</span> themeName = config.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">theme</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your provider can also look up other providers if needed. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyThemeSelectorProvider</span> <span class="directive">implements</span> ThemeSelectorProvider {

    <span class="directive">private</span> KeycloakSession session;

    <span class="directive">public</span> MyThemeSelectorProvider(KeycloakSession session) {
        <span class="local-variable">this</span>.session = session;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getThemeName(Theme.Type type) {
        <span class="keyword">return</span> session.getContext().getRealm().getLoginTheme();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The pom.xml file for your SPI requires a <code>dependencyManagement</code> section with an import reference to the Keycloak version that is intended for the SPI. In this example, replace the occurrence of <code>VERSION</code> with 26.4.0, which is the current version of Keycloak.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;project</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;modelVersion&gt;</span>4.0.0<span class="tag">&lt;/modelVersion&gt;</span>

  <span class="tag">&lt;groupId&gt;</span>org.example<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>test-lib<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>

  <span class="tag">&lt;dependencyManagement&gt;</span>
    <span class="tag">&lt;dependencies&gt;</span>
      <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.keycloak<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>keycloak-parent<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>VERSION<span class="tag">&lt;/version&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
        <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
      <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
  <span class="tag">&lt;/dependencyManagement&gt;</span>

  <span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>org.keycloak<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>keycloak-model-jpa<span class="tag">&lt;/artifactId&gt;</span>
      <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
  <span class="tag">&lt;/dependencies&gt;</span>

<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>VERSION</code> with the current version of Keycloak</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_override_builtin_providers"><a class="anchor" href="#_override_builtin_providers"></a>Override built-in providers</h4>
<div class="paragraph">
<p>As mentioned above, it is recommended that your <code>ProviderFactory</code> implementations use unique ID. However at the same time, it can be useful to override one of the Keycloak built-in providers.
The recommended way for this is still ProviderFactory implementation with unique ID and then for instance set the default provider as
specified in the <a href="https://www.keycloak.org/server/configuration-provider">Configuring Providers</a> guide. On the other hand, this may not be always possible.</p>
</div>
<div class="paragraph">
<p>For instance when you need some customizations to default OpenID Connect protocol behaviour and you want to override
default Keycloak implementation of <code>OIDCLoginProtocolFactory</code> you need to preserve same providerId. As for example admin console, OIDC protocol well-known endpoint and various other things rely on
the ID of the protocol factory being <code>openid-connect</code>.</p>
</div>
<div class="paragraph">
<p>For this case, it is highly recommended to implement method <code>order()</code> of your custom implementation and make sure that it has higher order than the built-in implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomOIDCLoginProtocolFactory</span> <span class="directive">extends</span> OIDCLoginProtocolFactory {

    <span class="comment">// Some customizations here</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> order() {
        <span class="keyword">return</span> <span class="integer">1</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case of multiple implementations with same provider ID, only the one with highest order will be used by Keycloak runtime.</p>
</div>
</div>
<div class="sect3">
<h4 id="_providers_admin_console"><a class="anchor" href="#_providers_admin_console"></a>Show info from your SPI implementation in the Admin Console</h4>
<div class="paragraph">
<p>Sometimes it is useful to show additional info about your Provider to a Keycloak administrator. You can show provider build time information (for example, version of
custom provider currently installed), current configuration of the provider (e.g. url of remote system your provider talks to) or some operational info
(average time of response from remote system your provider talks to). Keycloak Admin Console provides Server Info page to show this kind of information.</p>
</div>
<div class="paragraph">
<p>To show info from your provider it is enough to implement <code>org.keycloak.provider.ServerInfoAwareProviderFactory</code> interface in your <code>ProviderFactory</code>.</p>
</div>
<div class="paragraph">
<p>Example implementation for <code>MyThemeSelectorProviderFactory</code> from previous example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.acme.provider</span>;

<span class="keyword">import</span> ...

<span class="include">public</span> <span class="include">class</span> <span class="include">MyThemeSelectorProviderFactory</span> <span class="include">implements</span> <span class="include">ThemeSelectorProviderFactory</span>, <span class="include">ServerInfoAwareProviderFactory</span> {
    ...

    <span class="annotation">@Override</span>
    <span class="include">public</span> <span class="include">Map</span>&lt;<span class="include">String</span>, <span class="include">String</span>&gt; <span class="include">getOperationalInfo</span>() {
        <span class="include">Map</span>&lt;<span class="include">String</span>, <span class="include">String</span>&gt; <span class="include">ret</span> = <span class="include">new</span> <span class="include">LinkedHashMap</span>&lt;&gt;();
        ret.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">theme-name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">my-theme</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> ret;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_use_available_providers"><a class="anchor" href="#_use_available_providers"></a>Use available providers</h3>
<div class="paragraph">
<p>In your provider implementation, you can use other providers available in Keycloak. The existing providers can be typically retrieved with the
usage of the <code>KeycloakSession</code>, which is available to your provider as described in the section <a href="#_implementing_spi">Implementing an SPI</a>.</p>
</div>
<div class="paragraph">
<p>Keycloak has two provider types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Single-implementation provider types</strong> - There can be only a single active implementation of the particular provider type in Keycloak runtime.</p>
<div class="paragraph">
<p>For example <code>HostnameProvider</code> specifies the hostname to be used by Keycloak and that is shared for the whole Keycloak server.
Hence there can be only single implementation of this provider active for the Keycloak server. If there are multiple provider implementations available to the server runtime,
one of them needs to be specified as the default one.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bin/kc.[sh|bat] build --spi-hostname--provider=default</code></pre>
</div>
</div>
<div class="paragraph">
<p>The value <code>default</code> used as the value of <code>default-provider</code> must match the ID returned by the <code>ProviderFactory.getId()</code> of the particular provider factory implementation.
In the code, you can obtain the provider such as <code>keycloakSession.getProvider(HostnameProvider.class)</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Multiple implementation provider types</strong> - Those are provider types, that allow multiple implementations available and working together
in the Keycloak runtime.</p>
<div class="paragraph">
<p>For example <code>EventListener</code> provider allows to have multiple implementations available and registered, which means
that particular event can be sent to all the listeners (jboss-logging, sysout etc). In the code, you can obtain a specified instance of the provider
for example such as <code>session.getProvider(EventListener.class, "jboss-logging")</code> . You need to specify <code>provider_id</code> of the provider as the second argument
as there can be multiple instances of this provider type as described above.</p>
</div>
<div class="paragraph">
<p>The provider ID must match the ID returned by the <code>ProviderFactory.getId()</code> of the
particular provider factory implementation. Some provider types can be retrieved with the usage of <code>ComponentModel</code> as the second argument and some (for example <code>Authenticator</code>) even
need to be retrieved with the usage of <code>KeycloakSessionFactory</code>. It is not recommended to implement your own providers this way as it may be deprecated in the future.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="registering-provider-implementations"><a class="anchor" href="#registering-provider-implementations"></a>Registering provider implementations</h3>
<div class="paragraph">
<p>Providers are registered with the server by simply copying the JAR file to the <code>providers</code> directory.</p>
</div>
<div class="paragraph">
<p>If your provider needs additional dependencies not already provided by Keycloak copy these to the <code>providers</code> directory.</p>
</div>
<div class="paragraph">
<p>After registering new providers or dependencies Keycloak needs to be re-built with a non-optimized start or the <code>kc.[sh|bat] build</code> command.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Provider JARs are not loaded in isolated classloaders, so do not include resources or classes in your provider JARs that conflict with built-in resources or classes.
In particular the inclusion of an application.properties file or overriding the commons-lang3 dependency will cause auto-build to fail if the provider JAR is removed.
If you have included conflicting classes, you may see a split package warning in the start log for the server. Unfortunately not all built-in lib jars are checked by the split package warning logic,
so you&#8217;ll need to check the lib directory JARs before bundling or including a transitive dependency. Should there be a conflict, that can be resolved by removing or repackaging the offending classes.</p>
</div>
<div class="paragraph">
<p>There is no warning if you have conflicting resource files. You should either ensure that your JAR&#8217;s resource files have path names that contain something unique to that provider,
or you can check for the existence of <code>some.file</code> in the JAR contents under the <code>"install root"/lib/lib/main</code> directory with something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">find . -type f -name &quot;*.jar&quot; -exec unzip -l {} \; | grep some.file</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you find that your server will not start due to a <code>NoSuchFileException</code> error related to a removed provider JAR, then run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./kc.sh -Dquarkus.launch.rebuild=true --help</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will force Quarkus to rebuild the classloading related index files. From there you should be able to perform a non-optimized start or build without an exception.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="disabling-a-provider"><a class="anchor" href="#disabling-a-provider"></a>Disabling a provider</h4>
<div class="paragraph">
<p>You can disable a provider by setting the enabled attribute for the provider to false.
For example to disable the Infinispan user cache provider use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bin/kc.[sh|bat] build --spi-user-cache--infinispan--enabled=false</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_script_providers"><a class="anchor" href="#_script_providers"></a>JavaScript providers</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Scripts is
<strong>Preview</strong>
and is not fully supported. This feature is disabled by default.</p>
</div>
<div class="paragraph">
<p>To enable start the server with <code>--features=preview</code>
or <code>--features=scripts</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Keycloak has the ability to execute scripts during runtime in order to allow administrators to customize specific functionalities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authenticator</p>
</li>
<li>
<p>JavaScript Policy</p>
</li>
<li>
<p>OpenID Connect Protocol Mapper</p>
</li>
<li>
<p>SAML Protocol Mapper</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="authenticator"><a class="anchor" href="#authenticator"></a>Authenticator</h4>
<div class="paragraph">
<p>Authentication scripts must provide at least one of the following functions:
<code>authenticate(..)</code>, which is called from <code>Authenticator#authenticate(AuthenticationFlowContext)</code>
<code>action(..)</code>, which is called from <code>Authenticator#action(AuthenticationFlowContext)</code></p>
</div>
<div class="paragraph">
<p>Custom <code>Authenticator</code> should at least provide the <code>authenticate(..)</code> function.
You can use the <code>javax.script.Bindings</code> script within the code.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>script</code></dt>
<dd>
<p>the <code>ScriptModel</code> to access script metadata</p>
</dd>
<dt class="hdlist1"><code>realm</code></dt>
<dd>
<p>the <code>RealmModel</code></p>
</dd>
<dt class="hdlist1"><code>user</code></dt>
<dd>
<p>the current <code>UserModel</code>. Note that <code>user</code> is available when your script authenticator is configured in the authentication flow in a way that is triggered after
another authenticator succeeded in establishing user identity and set the user into the authentication session.</p>
</dd>
<dt class="hdlist1"><code>session</code></dt>
<dd>
<p>the active <code>KeycloakSession</code></p>
</dd>
<dt class="hdlist1"><code>authenticationSession</code></dt>
<dd>
<p>the current <code>AuthenticationSessionModel</code></p>
</dd>
<dt class="hdlist1"><code>httpRequest</code></dt>
<dd>
<p>the current <code>org.jboss.resteasy.spi.HttpRequest</code></p>
</dd>
<dt class="hdlist1"><code>LOG</code></dt>
<dd>
<p>a <code>org.jboss.logging.Logger</code> scoped to <code>ScriptBasedAuthenticator</code></p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can extract additional context information from the <code>context</code> argument passed to the <code>authenticate(context)</code> <code>action(context)</code> function.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">AuthenticationFlowError = Java.type(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.authentication.AuthenticationFlowError</span><span class="delimiter">&quot;</span></span>);

<span class="keyword">function</span> <span class="function">authenticate</span>(context) {

  LOG.info(script.name + <span class="string"><span class="delimiter">&quot;</span><span class="content"> --&gt; trace auth for: </span><span class="delimiter">&quot;</span></span> + user.username);

  <span class="keyword">if</span> (   user.username === <span class="string"><span class="delimiter">&quot;</span><span class="content">tester</span><span class="delimiter">&quot;</span></span>
      &amp;&amp; user.getAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">someAttribute</span><span class="delimiter">&quot;</span></span>)
      &amp;&amp; user.getAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">someAttribute</span><span class="delimiter">&quot;</span></span>).contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">someValue</span><span class="delimiter">&quot;</span></span>)) {

      context.failure(AuthenticationFlowError.INVALID_USER);
      <span class="keyword">return</span>;
  }

  context.success();
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="where-to-add-script-authenticator"><a class="anchor" href="#where-to-add-script-authenticator"></a>Where to add script authenticator</h5>
<div class="paragraph">
<p>A possible use of script authenticator is to do some checks at the end of the authentication. Note that if you want
your script authenticator to be always triggered (even for instance during SSO re-authentication with the identity cookie), you may need to add it as REQUIRED at the end
of the authentication flow and encapsulate the existing authenticators into a separate REQUIRED authentication subflow. This need is because the REQUIRED and ALTERNATIVE executions
should not be at the same level. For example, the authentication flow configuration should appear as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>- User-authentication-subflow REQUIRED
-- Cookie ALTERNATIVE
-- Identity-provider-redirect ALTERNATIVE
...
- Your-Script-Authenticator REQUIRED</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="openid-connect-protocol-mapper"><a class="anchor" href="#openid-connect-protocol-mapper"></a>OpenID Connect Protocol Mapper</h4>
<div class="paragraph">
<p>OpenID Connect Protocol Mapper scripts are javascript script that allow you
to change the content of the ID Token and/or the Access Token.</p>
</div>
<div class="paragraph">
<p>You can use the <code>javax.script.Bindings</code> script within the code.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>user</code></dt>
<dd>
<p>the current <code>UserModel</code></p>
</dd>
<dt class="hdlist1"><code>realm</code></dt>
<dd>
<p>the <code>RealmModel</code></p>
</dd>
<dt class="hdlist1"><code>token</code></dt>
<dd>
<p>the current <code>IDToken</code>. It is available only if the mapper is configured for the ID token.</p>
</dd>
<dt class="hdlist1"><code>tokenResponse</code></dt>
<dd>
<p>the current <code>AccessTokenResponse</code>. It is available only if the mapper is configured for the Access token.</p>
</dd>
<dt class="hdlist1"><code>userSession</code></dt>
<dd>
<p>the active <code>UserSessionModel</code></p>
</dd>
<dt class="hdlist1"><code>keycloakSession</code></dt>
<dd>
<p>the active <code>KeycloakSession</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The exports of the script will be used as the value of the token claim.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// prints can be used to log information for debug purpose.</span>
print(<span class="string"><span class="delimiter">&quot;</span><span class="content">STARTING CUSTOM MAPPER</span><span class="delimiter">&quot;</span></span>);

<span class="keyword">var</span> inputRequest = keycloakSession.getContext().getHttpRequest();
<span class="keyword">var</span> params = inputRequest.getDecodedFormParameters();
<span class="keyword">var</span> output = params.getFirst(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_input</span><span class="delimiter">&quot;</span></span>);
exports = output;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above script allows to retrieve a <code>user_input</code> from the authorization request.
This will be available to map in the <code>Token Claim Name</code> configured in the mapper.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-a-jar-with-the-scripts-to-deploy"><a class="anchor" href="#create-a-jar-with-the-scripts-to-deploy"></a>Create a JAR with the scripts to deploy</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JAR files are regular ZIP files with a <code>.jar</code> extension.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to make your scripts available to Keycloak you need to deploy them to the server. For that, you should create
a <code>JAR</code> file with the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>META-INF/keycloak-scripts.json

my-script-authenticator.js
my-script-policy.js
my-script-mapper.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>META-INF/keycloak-scripts.json</code> is a file descriptor that provides metadata information about the scripts you want to deploy. It is a JSON file with the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">authenticators</span><span class="delimiter">&quot;</span></span>: [
        {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">My Authenticator</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">fileName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">my-script-authenticator.js</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">My Authenticator from a JS file</span><span class="delimiter">&quot;</span></span>
        }
    ],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">policies</span><span class="delimiter">&quot;</span></span>: [
        {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">My Policy</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">fileName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">my-script-policy.js</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">My Policy from a JS file</span><span class="delimiter">&quot;</span></span>
        }
    ],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">mappers</span><span class="delimiter">&quot;</span></span>: [
        {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">My Mapper</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">fileName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">my-script-mapper.js</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">My Mapper from a JS file</span><span class="delimiter">&quot;</span></span>
        }
    ],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">saml-mappers</span><span class="delimiter">&quot;</span></span>: [
        {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">My Mapper</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">fileName</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">my-script-mapper.js</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">My Mapper from a JS file</span><span class="delimiter">&quot;</span></span>
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This file should reference the different types of script providers that you want to deploy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>authenticators</code></p>
<div class="paragraph">
<p>For OpenID Connect Script Authenticators. You can have one or multiple authenticators in the same JAR file</p>
</div>
</li>
<li>
<p><code>policies</code></p>
<div class="paragraph">
<p>For JavaScript Policies when using Keycloak Authorization Services. You can have one or multiple policies in the same JAR file</p>
</div>
</li>
<li>
<p><code>mappers</code></p>
<div class="paragraph">
<p>For OpenID Connect Script Protocol Mappers. You can have one or multiple mappers in the same JAR file</p>
</div>
</li>
<li>
<p><code>saml-mappers</code></p>
<div class="paragraph">
<p>For SAML Script Protocol Mappers. You can have one or multiple mappers in the same JAR file</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For each script file in your <code>JAR</code> file, you need a corresponding entry in <code>META-INF/keycloak-scripts.json</code> that maps your scripts files to a specific provider type. For that you should provide the following properties for each entry:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code></p>
<div class="paragraph">
<p>A friendly name that will be used to show the scripts through the Keycloak Administration Console. If not provided, the name
of the script file will be used instead</p>
</div>
</li>
<li>
<p><code>description</code></p>
<div class="paragraph">
<p>An optional text that better describes the intend of the script file</p>
</div>
</li>
<li>
<p><code>fileName</code></p>
<div class="paragraph">
<p>The name of the script file. This property is <strong>mandatory</strong> and should map to a file within the JAR.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="deploy-the-script-jar"><a class="anchor" href="#deploy-the-script-jar"></a>Deploy the script JAR</h4>
<div class="paragraph">
<p>Once you have a JAR file with a descriptor and the scripts you want to deploy, you just need to copy the JAR to the Keycloak <code>providers/</code> directory, then run <code>bin/kc.[sh|bat] build</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="available-spis"><a class="anchor" href="#available-spis"></a>Available SPIs</h3>
<div class="paragraph">
<p>If you want to see list of all available SPIs at runtime, you can check <code>Provider Info</code> page in Admin Console as described in <a href="#_providers_admin_console">Admin Console</a> section.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extensions"><a class="anchor" href="#_extensions"></a>Extending the server</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/extensions.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/extensions.adoc&amp;description=%0A%0AFile:%20server_development/topics/extensions.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The Keycloak SPI framework offers the possibility to implement or override particular built-in providers. However Keycloak
also provides capabilities to extend its core functionalities and domain. This includes possibilities to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add custom REST endpoints to the Keycloak server</p>
</li>
<li>
<p>Add your own custom SPI</p>
</li>
<li>
<p>Add custom JPA entities to the Keycloak data model</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_extensions_rest"><a class="anchor" href="#_extensions_rest"></a>Add custom REST endpoints</h3>
<div class="paragraph">
<p>This is a very powerful extension, which allows you to deploy your own REST endpoints to the Keycloak server. It enables all kinds of extensions, for example
the possibility to trigger functionality on the Keycloak server, which is not available through the default set of built-in Keycloak REST endpoints.</p>
</div>
<div class="paragraph">
<p>To add a custom REST endpoint, you need to implement the <code>RealmResourceProviderFactory</code> and <code>RealmResourceProvider</code> interfaces. <code>RealmResourceProvider</code> has one important method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Object</span> getResource();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use this method to return an object, which acts as a <a href="https://github.com/jax-rs">JAX-RS Resource</a>.
Your JAX-RS resource is only recognized by the server and registered as a valid endpoint if it includes the following configuration:
- adding an empty file named <code>beans.xml</code> under <code>META-INF</code>
- annotating the JAX-RS class with the annotation <code>jakarta.ws.rs.ext.Provider</code>.</p>
</div>
<div class="paragraph">
<p>For details on how to package and deploy a custom provider, refer to the <a href="#_providers">Service Provider Interfaces</a> chapter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While it is possible to install other JAX-RS components via the providers extension mechanism, such as filters and interceptors, these are not officially supported.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_extensions_spi"><a class="anchor" href="#_extensions_spi"></a>Add your own custom SPI</h3>
<div class="paragraph">
<p>A custom SPI is especially useful with Custom REST endpoints. Use this procedure to add your own SPI</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>implement the interface <code>org.keycloak.provider.Spi</code> and define the ID of your SPI and the <code>ProviderFactory</code> and <code>Provider</code> classes. That looks like this:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ExampleSpi</span> <span class="directive">implements</span> Spi {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> isInternal() {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">example</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Provider</span>&gt; getProviderClass() {
        <span class="keyword">return</span> ExampleService.class;
    }

    <span class="annotation">@Override</span>
    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawtypes</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ProviderFactory&gt; getProviderFactoryClass() {
        <span class="keyword">return</span> ExampleServiceProviderFactory.class;
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>Create the file <code>META-INF/services/org.keycloak.provider.Spi</code> and add the class of your SPI to it. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>ExampleSpi</code></pre>
</div>
</div>
</li>
<li>
<p>Create the interfaces <code>ExampleServiceProviderFactory</code>, which extends from <code>ProviderFactory</code> and <code>ExampleService</code>, which extends from <code>Provider</code>.
The <code>ExampleService</code> will usually contain the business methods you need for your use case. Note that the <code>ExampleServiceProviderFactory</code> instance
is always scoped per application, however <code>ExampleService</code> is scoped per-request (or more accurately per <code>KeycloakSession</code> lifecycle).</p>
</li>
<li>
<p>Finally you need to implement your providers in the same manner as described in the <a href="#_providers">Service Provider Interfaces</a> chapter.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#_extensions_rest">Custom REST endpoints</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_extensions_jpa"><a class="anchor" href="#_extensions_jpa"></a>Add custom JPA entities to the Keycloak data model</h3>
<div class="paragraph">
<p>If the Keycloak data model does not exactly match your desired solution, or if you want to add some core functionality to Keycloak,
or when you have your own REST endpoint, you might want to extend the Keycloak data model. We enable you to add your
own JPA entities to the Keycloak JPA <code>EntityManager</code> .</p>
</div>
<div class="paragraph">
<p>To add your own JPA entities, you need to implement <code>JpaEntityProviderFactory</code> and <code>JpaEntityProvider</code>. The <code>JpaEntityProvider</code>
allows you to return a list of your custom JPA entities and provide the location and id of the Liquibase changelog. An example implementation can look like this:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is an unsupported API, which means you can use it but there is no guarantee that it will not be removed or changed without warning.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ExampleJpaEntityProvider</span> <span class="directive">implements</span> JpaEntityProvider {

    <span class="comment">// List of your JPA entities.</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Class</span>&lt;?&gt;&gt; getEntities() {
        <span class="keyword">return</span> <span class="predefined-type">Collections</span>.&lt;<span class="predefined-type">Class</span>&lt;?&gt;&gt;singletonList(Company.class);
    }

    <span class="comment">// This is used to return the location of the Liquibase changelog file.</span>
    <span class="comment">// You can return null if you don't want Liquibase to create and update the DB schema.</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getChangelogLocation() {
            <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">META-INF/example-changelog.xml</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="comment">// Helper method, which will be used internally by Liquibase.</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getFactoryId() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">sample</span><span class="delimiter">&quot;</span></span>;
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, we added a single JPA entity represented by class <code>Company</code>. In the code of your REST endpoint, you can then use something like
this to retrieve <code>EntityManager</code> and call DB operations on it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = session.getProvider(JpaConnectionProvider.class).getEntityManager();
Company myCompany = em.find(Company.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The methods <code>getChangelogLocation</code> and <code>getFactoryId</code> are important to support automatic updating of your entities by Liquibase. <a href="https://www.liquibase.com/community/contributors">Liquibase</a>
is a framework for updating the database schema, which Keycloak internally uses to create the DB schema and update the DB schema among versions. You may need to use
it as well and create a changelog for your entities. Note that versioning of your own Liquibase changelog is independent
of Keycloak versions. In other words, when you update to a new Keycloak version, you are not forced to update your
schema at the same time. And vice versa, you can update your schema even without updating the Keycloak version. The Liquibase update
is always done at the server startup, so to trigger a DB update of your schema, you just need to add the new changeset to your Liquibase changelog file (in the example above
it&#8217;s the file <code>META-INF/example-changelog.xml</code> which must be packed in same JAR as the JPA entities and <code>ExampleJpaEntityProvider</code>) and then restart server.
The DB schema will be automatically updated at startup.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Don&#8217;t forget to always back up your database before doing any changes in the Liquibase changelog and triggering a DB update.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_auth_spi"><a class="anchor" href="#_auth_spi"></a>Authentication SPI</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/auth-spi.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/auth-spi.adoc&amp;description=%0A%0AFile:%20server_development/topics/auth-spi.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak includes a range of different authentication mechanisms: kerberos, password, otp and others.
These mechanisms may not meet all of your requirements and you may want to plug in your own custom ones.
Keycloak provides an authentication SPI that you can use to write new plugins.
The Admin Console supports applying, ordering, and configuring these new mechanisms.</p>
</div>
<div class="paragraph">
<p>Keycloak also supports a simple registration form.
Different aspects of this form can be enabled and disabled for example
reCAPTCHA support can be turned off and on.
The same authentication SPI can be used to add another page to the registration flow or reimplement it entirely.
There&#8217;s also an additional fine-grained SPI you can use to add specific validations and user extensions to the built-in registration form.</p>
</div>
<div class="paragraph">
<p>A required action in Keycloak is an action that a user has to perform after he authenticates.
After the action is performed successfully, the user doesn&#8217;t have to perform the action again.
Keycloak comes with some built in required actions like "reset password".  This action forces the user to change their password after they have logged in.
You can write and plug in your own required actions.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If your authenticator or required action implementation is using some user attributes as the metadata attributes for linking/establishing the user identity,
then please make sure that users are not able to edit the attributes and the corresponding attributes are read-only. See the details in the <a href="https://www.keycloak.org/docs/26.4.0/server_admin/#read_only_user_attributes">Threat model mitigation chapter</a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="terms"><a class="anchor" href="#terms"></a>Terms</h3>
<div class="paragraph">
<p>To first learn about the Authentication SPI, let&#8217;s go over some of the terms used to describe it.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Authentication Flow</dt>
<dd>
<p>A flow is a container for all authentications that must happen during login or registration.
If you go to the Admin Console authentication page, you can view all the defined flows in the system and what authenticators they are made up of.
Flows can contain other flows.
You can also bind a new different flow for browser login, direct grant access, and registration.</p>
</dd>
<dt class="hdlist1">Authenticator</dt>
<dd>
<p>An authenticator is a pluggable component that hold the logic for performing the authentication or action within a flow.
It is usually a singleton.</p>
</dd>
<dt class="hdlist1">Execution</dt>
<dd>
<p>An execution is an object that binds the authenticator to the flow and the authenticator to the configuration of the authenticator.
Flows contain execution entries.</p>
</dd>
<dt class="hdlist1">Execution Requirement</dt>
<dd>
<p>Each execution defines how an authenticator behaves in a flow.
The requirement defines whether the authenticator is enabled, disabled, conditional, required, or an alternative.
An alternative requirement means that the authenticator is enough to validate the flow it&#8217;s in, but isn&#8217;t necessary.
For example, in the built-in browser flow, cookie authentication, the Identity Provider Redirector, and the set of all authenticators in the
forms subflow are all alternative. As they are executed in a sequential top-to-bottom order, if one of them is successful, the flow is
successful, and any following execution in the flow (or sub-flow) is not evaluated.</p>
</dd>
<dt class="hdlist1">Authenticator Config</dt>
<dd>
<p>This object defines the configuration for the Authenticator for a specific execution within an authentication flow.
Each execution can have a different config.</p>
</dd>
<dt class="hdlist1">Required Action</dt>
<dd>
<p>After authentication completes, the user might have one or more one-time actions he must complete before he is allowed to login.
The user might be required to set up an OTP token generator or reset an expired password or even accept a Terms and Conditions document.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="algorithm-overview"><a class="anchor" href="#algorithm-overview"></a>Algorithm overview</h3>
<div class="paragraph">
<p>Let&#8217;s talk about how this all works for browser login.
Let&#8217;s assume the following flows, executions and sub flows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Cookie - ALTERNATIVE
Kerberos - ALTERNATIVE
Forms subflow - ALTERNATIVE
           Username/Password Form - REQUIRED
           Conditional 2FA subflow - CONDITIONAL
                      Condition - User Configured - REQUIRED
                      OTP Form - REQUIRED</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the top level of the form we have 3 executions of which all are alternatively required.
This means that if any of these are successful, then the others do not have to execute.
The Username/Password form is not executed if there is an SSO Cookie set or a successful Kerberos login.
Let&#8217;s walk through the steps from when a client first redirects to keycloak to authenticate the user.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The OpenID Connect or SAML protocol provider unpacks relevant data, verifies the client and any signatures.
It creates an AuthenticationSessionModel.
It looks up what the browser flow should be, then starts executing the flow.</p>
</li>
<li>
<p>The flow looks at the cookie execution and sees that it is an alternative.
It loads the cookie provider.
It checks to see if the cookie provider requires that a user already be associated with the authentication session.
Cookie provider does not require a user.
If it did, the flow would abort and the user would see an error screen.
Cookie provider then executes.
Its purpose is to see if there is an SSO cookie set.
If there is one set, it is validated and the UserSessionModel is verified and associated with the AuthenticationSessionModel.
The Cookie provider returns a success() status if the SSO cookie exists and is validated.
Since the cookie provider returned success and each execution at this level of the flow is ALTERNATIVE, no other execution is executed and this results in a successful login.
If there is no SSO cookie, the cookie provider returns with a status of attempted().  This means there was no error condition, but no success either.
The provider tried, but the request just wasn&#8217;t set up to handle this authenticator.</p>
</li>
<li>
<p>Next the flow looks at the Kerberos execution.
This is also an alternative.
The kerberos provider also does not require a user to be already set up and associated with the AuthenticationSessionModel so this provider is executed.
Kerberos uses the SPNEGO browser protocol.
This requires a series of challenge/responses between the server and client exchanging negotiation headers.
The kerberos provider does not see any negotiate header, so it assumes that this is the first interaction between the server and client.
It therefore creates an HTTP challenge response to the client and sets a forceChallenge() status.
A forceChallenge() means that this HTTP response cannot be ignored by the flow and must be returned to the client.
If instead the provider returned a challenge() status, the flow would hold the challenge response until all other alternatives are attempted.
So, in this initial phase, the flow would stop and the challenge response would be sent back to the browser.
If the browser then responds with a successful negotiate header, the provider associates the user with the AuthenticationSession and the flow ends because the rest of the executions on this level of the flow are all alternatives.
Otherwise, again, the kerberos provider sets an attempted() status and the flow continues.</p>
</li>
<li>
<p>The next execution is a subflow called Forms.
The executions for this subflow are loaded and the same processing logic occurs.</p>
</li>
<li>
<p>The first execution in the Forms subflow is the UsernamePassword provider.
This provider also does not require for a user to already be associated with the flow.
This provider creates a challenge HTTP response and sets its status to challenge(). This execution is required, so the flow honors this challenge and sends the HTTP response back to the browser.
This response is a rendering of the Username/Password HTML page.
The user enters in their username and password and clicks submit.
This HTTP request is directed to the UsernamePassword provider.
If the user entered an invalid username or password, a new challenge response is created and a status of failureChallenge() is set for this execution.
A failureChallenge() means that there is a challenge, but that the flow should log this as an error in the error log.
This error log can be used to lock accounts or IP Addresses that have had too many login failures.
If the username and password is valid, the provider associated the UserModel with the AuthenticationSessionModel and returns a status of success().</p>
</li>
<li>
<p>The next execution is a subflow called Conditional 2FA. The executions for this subflow are loaded and the same processing logic occurs. Its Requirement is
Conditional. This means that the flow will first evaluate all conditional executors that it contains. Conditional executors are authenticators that
implement <code>ConditionalAuthenticator</code>, and must implement the method <code>boolean matchCondition(AuthenticationFlowContext context)</code>. A conditional subflow will
call the <code>matchCondition</code> method of all conditional executions it contains, and if all of them evaluate to true, it will act as if it was a required subflow. If
not, it will act as if it was a disabled subflow. Conditional authenticators are only used for this purpose, and are not used as authenticators.
This means that even if the conditional authenticator evaluates to "true", then this will not mark a flow or subflow as successful. For example,
a flow containing only a Conditional subflow with only a conditional authenticator will never allow a user to log in.</p>
</li>
<li>
<p>The first execution of the Conditional 2FA subflow is the Condition - User Configured.
This provider requires that a user has been associated with the flow.
This requirement is satisfied because the UsernamePassword provider already associated the user with the flow.
This provider&#8217;s <code>matchCondition</code> method will evaluate the <code>configuredFor</code> method for all other Authenticators in its current subflow. If the subflow contains
executors with their Requirement set to required, then the <code>matchCondition</code> method will only evaluate to true if all the required authenticators' <code>configuredFor</code>
method evaluate to true. Otherwise, the <code>matchCondition</code> method will evaluate to true if any alternative authenticator evaluates to true.</p>
</li>
<li>
<p>The next execution is the OTP Form.
This provider also requires that a user has been associated with the flow.
This requirement is satisfied because the UsernamePassword provider already associated the user with the flow.
Since a user is required for this provider, the provider is also asked if the user is configured to use this provider.
If user is not configured, then the flow will then set up a required action that the user must perform after authentication is complete.
For OTP, this means the OTP setup page. If the user is configured, he will be asked to enter his otp code. In our scenario, because of the conditional
sub-flow, the user will never see the OTP login page, unless the Conditional 2FA subflow is set to Required.</p>
</li>
<li>
<p>After the flow is complete, the authentication processor creates a UserSessionModel and associates it with the AuthenticationSessionModel.
It then checks to see if the user is required to complete any required actions before logging in.</p>
</li>
<li>
<p>First, each required action&#8217;s evaluateTriggers() method is called.
This allows the required action provider to figure out if there is some state that might trigger the action to be fired.
For example, if your realm has a password expiration policy, it might be triggered by this method.</p>
</li>
<li>
<p>Each required action associated with the user that has its requiredActionChallenge() method called.
Here the provider sets up an HTTP response which renders the page for the required action.
This is done by setting a challenge status.</p>
</li>
<li>
<p>If the required action is ultimately successful, then the required action is removed from the user&#8217;s required actions list.</p>
</li>
<li>
<p>After all required actions have been resolved, the user is finally logged in.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_auth_spi_walkthrough"><a class="anchor" href="#_auth_spi_walkthrough"></a>Authenticator SPI walk through</h3>
<div class="paragraph">
<p>In this section, we&#8217;ll take a look at the Authenticator interface.
For this, we are going to implement an authenticator that requires that a user enter in the answer to a secret question like "What is your mother&#8217;s maiden name?".
This example is fully implemented and contained in the <a href="https://github.com/keycloak/keycloak-quickstarts">Keycloak Quickstarts Repository</a> repository under <code>extension/authenticator</code>.</p>
</div>
<div class="paragraph">
<p>To create an authenticator, you must at minimum implement the org.keycloak.authentication.AuthenticatorFactory and Authenticator interfaces.
The Authenticator interface defines the logic. The AuthenticatorFactory is responsible for creating instances of an Authenticator.
They both extend a more generic Provider and ProviderFactory set of interfaces that other Keycloak components like User Federation do.</p>
</div>
<div class="paragraph">
<p>Some authenticators, like the CookieAuthenticator don&#8217;t rely on a Credential that the user has or knows to authenticate the user.
However, some authenticators, such as the PasswordForm authenticator or the OTPFormAuthenticator rely on the user inputting some
information and verifying that information against some information in the
database. For the PasswordForm for example, the authenticator will verify the hash of the password against a hash stored in the database, while the
OTPFormAuthenticator will verify the OTP received against the one generated from the shared secret stored in the database.</p>
</div>
<div class="paragraph">
<p>These types of authenticators are called CredentialValidators, and will require you to implement a few more classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A class that extends org.keycloak.credential.CredentialModel, and that can generate the correct format of the credential in the database</p>
</li>
<li>
<p>A class implementing the org.keycloak.credential.CredentialProvider and interface, and a class implementing its CredentialProviderFactory factory interface.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The SecretQuestionAuthenticator we&#8217;ll see in this walk through is a CredentialValidator, so we&#8217;ll see how to implement all these classes.</p>
</div>
<div class="sect3">
<h4 id="packaging-classes-and-deployment"><a class="anchor" href="#packaging-classes-and-deployment"></a>Packaging classes and deployment</h4>
<div class="paragraph">
<p>You will package your classes within a single jar.
This jar must contain a file named  <code>org.keycloak.authentication.AuthenticatorFactory</code> and must be contained in the <code>META-INF/services/</code> directory of your jar.
This file must list the fully qualified class name of each AuthenticatorFactory implementation you have in the jar.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">org.keycloak.examples.authenticator.SecretQuestionAuthenticatorFactory
org.keycloak.examples.authenticator.AnotherProviderFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>This services/ file is used by Keycloak to scan the providers it has to load into the system.</p>
</div>
<div class="paragraph">
<p>To deploy this jar, just copy it to the providers directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="extending-the-credentialmodel-class"><a class="anchor" href="#extending-the-credentialmodel-class"></a>Extending the CredentialModel class</h4>
<div class="paragraph">
<p>In Keycloak, credentials are stored in the database in the Credentials table. It has the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-----------------------------
| ID                        |
-----------------------------
| user_ID                   |
-----------------------------
| credential_type           |
-----------------------------
| created_date              |
-----------------------------
| user_label                |
-----------------------------
| secret_data               |
-----------------------------
| credential_data           |
-----------------------------
| priority                  |
-----------------------------</pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ID</code> is the primary key of the credential.</p>
</li>
<li>
<p><code>user_ID</code> is the foreign key linking the credential to a user.</p>
</li>
<li>
<p><code>credential_type</code> is a string set during the creation that must reference an existing credential type.</p>
</li>
<li>
<p><code>created_date</code> is the creation timestamp (in long format) of the credential.</p>
</li>
<li>
<p><code>user_label</code> is the editable name of the credential by the user</p>
</li>
<li>
<p><code>secret_data</code> contains a static json with the information that cannot be transmitted outside of Keycloak</p>
</li>
<li>
<p><code>credential_data</code> contains a json with the static information of the credential that can be shared in the Admin Console or via the REST API.</p>
</li>
<li>
<p><code>priority</code> defines how "preferred" a credential is for a user, to determine which credential to present when a user has multiple choices.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As the secret_data and credential_data fields are designed to contain json, it is up to you to determine how to structure, read and write into
these fields, allowing you a lot of flexibility.</p>
</div>
<div class="paragraph">
<p>For this example, we are going to use a very simple credential data, containing only the question asked to the user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
  "question":"aQuestion"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>with an equally simple secret data, containing only the secret answer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
  "answer":"anAnswer"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the answer will be kept in plain text in the database for the sake of simplicity, but it would also be possible to have a salted hash for the answer,
as is the case for passwords in Keycloak. In this case, the secret data would also have to contain a field for the salt, and the credential data information
about the algorithm such as the type of algorithm used and the number of iterations used. For more details you can consult the implementation of the
<code>org.keycloak.models.credential.PasswordCredentialModel</code> class.</p>
</div>
<div class="paragraph">
<p>In our case we create the class <code>SecretQuestionCredentialModel</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SecretQuestionCredentialModel</span> <span class="directive">extends</span> CredentialModel {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TYPE = <span class="string"><span class="delimiter">&quot;</span><span class="content">SECRET_QUESTION</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">private</span> <span class="directive">final</span> SecretQuestionCredentialData credentialData;
    <span class="directive">private</span> <span class="directive">final</span> SecretQuestionSecretData secretData;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>TYPE</code> is the credential_type we write in the database. For consistency, we make sure that this String is always the one referenced when
getting the type for this credential. The classes <code>SecretQuestionCredentialData</code> and <code>SecretQuestionSecretData</code> are used to marshal and unmarshal the json:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SecretQuestionCredentialData</span> {

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> question;

    <span class="annotation">@JsonCreator</span>
    <span class="directive">public</span> SecretQuestionCredentialData(<span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">question</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> question) {
        <span class="local-variable">this</span>.question = question;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getQuestion() {
        <span class="keyword">return</span> question;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SecretQuestionSecretData</span> {

     <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> answer;

    <span class="annotation">@JsonCreator</span>
     <span class="directive">public</span> SecretQuestionSecretData(<span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">answer</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> answer) {
         <span class="local-variable">this</span>.answer = answer;
     }

    <span class="directive">public</span> <span class="predefined-type">String</span> getAnswer() {
        <span class="keyword">return</span> answer;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To be fully usable, the <code>SecretQuestionCredentialModel</code> objects must both contain the raw json data from its parent class,
and the unmarshalled objects in its own attributes. This leads us to create a method which reads from a simple CredentialModel,
such as is created when reading from the database, to make a <code>SecretQuestionCredentialModel</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> SecretQuestionCredentialModel(SecretQuestionCredentialData credentialData, SecretQuestionSecretData secretData) {
    <span class="local-variable">this</span>.credentialData = credentialData;
    <span class="local-variable">this</span>.secretData = secretData;
}

<span class="directive">public</span> <span class="directive">static</span> SecretQuestionCredentialModel createFromCredentialModel(CredentialModel credentialModel){
    <span class="keyword">try</span> {
        SecretQuestionCredentialData credentialData = JsonSerialization.readValue(credentialModel.getCredentialData(), SecretQuestionCredentialData.class);
        SecretQuestionSecretData secretData = JsonSerialization.readValue(credentialModel.getSecretData(), SecretQuestionSecretData.class);

        SecretQuestionCredentialModel secretQuestionCredentialModel = <span class="keyword">new</span> SecretQuestionCredentialModel(credentialData, secretData);
        secretQuestionCredentialModel.setUserLabel(credentialModel.getUserLabel());
        secretQuestionCredentialModel.setCreatedDate(credentialModel.getCreatedDate());
        secretQuestionCredentialModel.setType(TYPE);
        secretQuestionCredentialModel.setId(credentialModel.getId());
        secretQuestionCredentialModel.setSecretData(credentialModel.getSecretData());
        secretQuestionCredentialModel.setCredentialData(credentialModel.getCredentialData());
        <span class="keyword">return</span> secretQuestionCredentialModel;
    } <span class="keyword">catch</span> (<span class="exception">IOException</span> e){
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(e);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And a method to create a <code>SecretQuestionCredentialModel</code> from the question and answer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> SecretQuestionCredentialModel(<span class="predefined-type">String</span> question, <span class="predefined-type">String</span> answer) {
    credentialData = <span class="keyword">new</span> SecretQuestionCredentialData(question);
    secretData = <span class="keyword">new</span> SecretQuestionSecretData(answer);
}

<span class="directive">public</span> <span class="directive">static</span> SecretQuestionCredentialModel createSecretQuestion(<span class="predefined-type">String</span> question, <span class="predefined-type">String</span> answer) {
    SecretQuestionCredentialModel credentialModel = <span class="keyword">new</span> SecretQuestionCredentialModel(question, answer);
    credentialModel.fillCredentialModelFields();
    <span class="keyword">return</span> credentialModel;
}

<span class="directive">private</span> <span class="type">void</span> fillCredentialModelFields(){
    <span class="keyword">try</span> {
        setCredentialData(JsonSerialization.writeValueAsString(credentialData));
        setSecretData(JsonSerialization.writeValueAsString(secretData));
        setType(TYPE);
        setCreatedDate(<span class="predefined-type">Time</span>.currentTimeMillis());
    } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(e);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="implementing-a-credentialprovider"><a class="anchor" href="#implementing-a-credentialprovider"></a>Implementing a CredentialProvider</h4>
<div class="paragraph">
<p>As with all Providers, to allow Keycloak to generate the CredentialProvider, we require a CredentialProviderFactory. For this requirement we create
the SecretQuestionCredentialProviderFactory, whose <code>create</code> method will be called when a SecretQuestionCredentialProvider is asked for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SecretQuestionCredentialProviderFactory</span> <span class="directive">implements</span> CredentialProviderFactory&lt;SecretQuestionCredentialProvider&gt; {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PROVIDER_ID =  <span class="string"><span class="delimiter">&quot;</span><span class="content">secret-question</span><span class="delimiter">&quot;</span></span>;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> PROVIDER_ID;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> CredentialProvider create(KeycloakSession session) {
        <span class="keyword">return</span> <span class="keyword">new</span> SecretQuestionCredentialProvider(session);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The CredentialProvider interface takes a generic parameter that extends a CredentialModel. In our case we to use the SecretQuestionCredentialModel we created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SecretQuestionCredentialProvider</span> <span class="directive">implements</span> CredentialProvider&lt;SecretQuestionCredentialModel&gt;, CredentialInputValidator {
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = <span class="predefined-type">Logger</span>.getLogger(SecretQuestionCredentialProvider.class);

    <span class="directive">protected</span> KeycloakSession session;

    <span class="directive">public</span> SecretQuestionCredentialProvider(KeycloakSession session) {
        <span class="local-variable">this</span>.session = session;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also want to implement the CredentialInputValidator interface, as this allows Keycloak to know that this provider can also be used to validate a
credential for an Authenticator. For the CredentialProvider interface, the first method that needs to be implemented is the <code>getType()</code> method. This will simply
return the `SecretQuestionCredentialModel&#8217;s TYPE String:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">String</span> getType() {
    <span class="keyword">return</span> SecretQuestionCredentialModel.TYPE;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second method is to create a <code>SecretQuestionCredentialModel</code> from a <code>CredentialModel</code>. For this method we simply call the existing static method
from <code>SecretQuestionCredentialModel</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> SecretQuestionCredentialModel getCredentialFromModel(CredentialModel model) {
    <span class="keyword">return</span> SecretQuestionCredentialModel.createFromCredentialModel(model);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we have the methods to create a credential and delete a credential. These methods call the UserModel&#8217;s credential manager, which
is responsible for knowing where to read or write the credential, for example local storage or federated storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> CredentialModel createCredential(RealmModel realm, UserModel user, SecretQuestionCredentialModel credentialModel) {
    <span class="keyword">if</span> (credentialModel.getCreatedDate() == <span class="predefined-constant">null</span>) {
        credentialModel.setCreatedDate(<span class="predefined-type">Time</span>.currentTimeMillis());
    }
    <span class="keyword">return</span> user.credentialManager().createStoredCredential(credentialModel);
}

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">boolean</span> deleteCredential(RealmModel realm, UserModel user, <span class="predefined-type">String</span> credentialId) {
    <span class="keyword">return</span> user.credentialManager().removeStoredCredentialById(credentialId);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the CredentialInputValidator, the main method to implement is the <code>isValid</code>, which tests whether a credential is valid for a
given user in a given realm. This is the method that is called by the Authenticator when it seeks to validate the user&#8217;s input. Here we
simply need to check that the input String is the one recorded in the Credential:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">boolean</span> isValid(RealmModel realm, UserModel user, CredentialInput input) {
    <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> UserCredentialModel)) {
        logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">Expected instance of UserCredentialModel for CredentialInput</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    <span class="keyword">if</span> (!input.getType().equals(getType())) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    <span class="predefined-type">String</span> challengeResponse = input.getChallengeResponse();
    <span class="keyword">if</span> (challengeResponse == <span class="predefined-constant">null</span>) {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    CredentialModel credentialModel = getCredentialStore().getStoredCredentialById(realm, user, input.getCredentialId());
    SecretQuestionCredentialModel sqcm = getCredentialFromModel(credentialModel);
    <span class="keyword">return</span> sqcm.getSecretQuestionSecretData().getAnswer().equals(challengeResponse);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The other two methods to implement are a test if the CredentialProvider supports the given credential type and a test to check
if the credential type is configured for a given user. For our case, the latter test simply means checking if the user has a credential
of the SECRET_QUESTION type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">boolean</span> supportsCredentialType(<span class="predefined-type">String</span> credentialType) {
    <span class="keyword">return</span> getType().equals(credentialType);
}

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">boolean</span> isConfiguredFor(RealmModel realm, UserModel user, <span class="predefined-type">String</span> credentialType) {
    <span class="keyword">if</span> (!supportsCredentialType(credentialType)) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    <span class="keyword">return</span> !getCredentialStore().getStoredCredentialsByType(realm, user, credentialType).isEmpty();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="implementing-an-authenticator"><a class="anchor" href="#implementing-an-authenticator"></a>Implementing an authenticator</h4>
<div class="paragraph">
<p>When implementing an authenticator that uses Credentials to authenticate a user, you should have the authenticator implement
the CredentialValidator interface. This interfaces takes a class extending a CredentialProvider as a parameter, and will
allow Keycloak to directly call the methods from the CredentialProvider. The only method that needs to be implemented is
<code>getCredentialProvider</code> method, which in our example allows the SecretQuestionAuthenticator to retrieve the SecretQuestionCredentialProvider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> SecretQuestionCredentialProvider getCredentialProvider(KeycloakSession session) {
    <span class="keyword">return</span> (SecretQuestionCredentialProvider)session.getProvider(CredentialProvider.class, SecretQuestionCredentialProviderFactory.PROVIDER_ID);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When implementing the Authenticator interface, the first method that needs to be implemented is the requiresUser() method.
For our example, this method must return true as we need to validate the secret question associated with the user.
A provider like kerberos would return false from this method as it can resolve a user from the negotiate header.
This example, however, is validating a specific credential of a specific user.</p>
</div>
<div class="paragraph">
<p>The next method to implement is the configuredFor() method.
This method is responsible for determining if the user is configured for this particular authenticator. In our case,
we can just call the method implemented in the SecretQuestionCredentialProvider</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">boolean</span> configuredFor(KeycloakSession session, RealmModel realm, UserModel user) {
    <span class="keyword">return</span> getCredentialProvider(session).isConfiguredFor(realm, user, getType(session));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next method to implement on the Authenticator is setRequiredActions(). If configuredFor() returns false and our example authenticator
is required within the flow, this method will be called, but only if the associated AuthenticatorFactory&#8217;s <code>isUserSetupAllowed</code> method returns true.
The setRequiredActions() method is responsible for registering any required actions that must be performed by the user.
In our example, we need to register a required action that will force the user to set up the answer to the secret question.
We will implement this required action provider later in this chapter.
Here is the implementation of the setRequiredActions() method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> setRequiredActions(KeycloakSession session, RealmModel realm, UserModel user) {
        user.addRequiredAction(<span class="string"><span class="delimiter">&quot;</span><span class="content">SECRET_QUESTION_CONFIG</span><span class="delimiter">&quot;</span></span>);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are getting into the meat of the Authenticator implementation.
The next method to implement is authenticate().  This is the initial method the flow invokes when the execution is first visited.
What we want is that if a user has answered the secret question already on their browser&#8217;s machine, then the user doesn&#8217;t
have to answer the question again, making that machine "trusted".  The authenticate() method isn&#8217;t responsible for processing the secret question form.
Its sole purpose is to render the page or to continue the flow.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> authenticate(AuthenticationFlowContext context) {
    <span class="keyword">if</span> (hasCookie(context)) {
        context.success();
        <span class="keyword">return</span>;
    }
    Response challenge = context.form()
            .createForm(<span class="string"><span class="delimiter">&quot;</span><span class="content">secret-question.ftl</span><span class="delimiter">&quot;</span></span>);
    context.challenge(challenge);
}

<span class="directive">protected</span> <span class="type">boolean</span> hasCookie(AuthenticationFlowContext context) {
    Cookie cookie = context.getHttpRequest().getHttpHeaders().getCookies().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">SECRET_QUESTION_ANSWERED</span><span class="delimiter">&quot;</span></span>);
    <span class="type">boolean</span> result = cookie != <span class="predefined-constant">null</span>;
    <span class="keyword">if</span> (result) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Bypassing secret question because cookie is set</span><span class="delimiter">&quot;</span></span>);
    }
    <span class="keyword">return</span> result;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The hasCookie() method checks to see if there is already a cookie set on the browser which indicates that the secret question has already been answered.
If that returns true, we just mark this execution&#8217;s status as SUCCESS using the AuthenticationFlowContext.success() method and returning from the authentication() method.</p>
</div>
<div class="paragraph">
<p>If the hasCookie() method returns false, we must return a response that renders the secret question HTML form.
AuthenticationFlowContext has a form() method that initializes a Freemarker page builder with appropriate base information needed to build the form.
This page builder is called <code>org.keycloak.login.LoginFormsProvider</code>. The LoginFormsProvider.createForm() method loads a Freemarker template file from your login theme.
Additionally you can call the LoginFormsProvider.setAttribute() method if you want to pass additional information to the Freemarker template.
We&#8217;ll go over this later.</p>
</div>
<div class="paragraph">
<p>Calling LoginFormsProvider.createForm() returns a JAX-RS Response object.
We then call AuthenticationFlowContext.challenge() passing in this response.
This sets the status of the execution as CHALLENGE and if the execution is Required, this JAX-RS Response object will be sent to the browser.</p>
</div>
<div class="paragraph">
<p>So, the HTML page asking for the answer to a secret question is displayed to the user and the user enters in the answer and clicks submit.
The action URL of the HTML form will send an HTTP request to the flow.
The flow will end up invoking the action() method of our Authenticator implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> action(AuthenticationFlowContext context) {
    <span class="type">boolean</span> validated = validateAnswer(context);
    <span class="keyword">if</span> (!validated) {
        Response challenge =  context.form()
                .setError(<span class="string"><span class="delimiter">&quot;</span><span class="content">badSecret</span><span class="delimiter">&quot;</span></span>)
                .createForm(<span class="string"><span class="delimiter">&quot;</span><span class="content">secret-question.ftl</span><span class="delimiter">&quot;</span></span>);
        context.failureChallenge(AuthenticationFlowError.INVALID_CREDENTIALS, challenge);
        <span class="keyword">return</span>;
    }
    setCookie(context);
    context.success();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the answer is not valid, we rebuild the HTML Form with an additional error message.
We then call AuthenticationFlowContext.failureChallenge() passing in the reason for the value and the JAX-RS response.
failureChallenge() works the same as challenge(), but it also records the failure so it can be analyzed by any attack detection service.</p>
</div>
<div class="paragraph">
<p>If validation is successful, then we set a cookie to remember that the secret question has been answered and we call AuthenticationFlowContext.success().</p>
</div>
<div class="paragraph">
<p>The validation itself gets the data that was received from the form, and calls the isValid method from the SecretQuestionCredentialProvider. You&#8217;ll notice
that there&#8217;s a section of the code concerning getting the credential Id. This is because if Keycloak is configured to allow multiple types of alternative
authenticators, or if the user could record multiple credentials of the SECRET_QUESTION type (for example if we allowed to choose from several questions,
and we allowed the user to have answers for more than one of those questions), then Keycloak needs to know which credential is being used to log the user.
In case there is more than one credential, Keycloak allows the user to choose during the login which credential is being used, and the information is transmitted by
the form to the Authenticator.
In case the form doesn&#8217;t present this information, credential id used is given by the CredentialProvider&#8217;s <code>default getDefaultCredential</code> method, which will
return the "most preferred" credential of the correct type of the user,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">protected</span> <span class="type">boolean</span> validateAnswer(AuthenticationFlowContext context) {
    MultivaluedMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; formData = context.getHttpRequest().getDecodedFormParameters();
    <span class="predefined-type">String</span> secret = formData.getFirst(<span class="string"><span class="delimiter">&quot;</span><span class="content">secret_answer</span><span class="delimiter">&quot;</span></span>);
    <span class="predefined-type">String</span> credentialId = formData.getFirst(<span class="string"><span class="delimiter">&quot;</span><span class="content">credentialId</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">if</span> (credentialId == <span class="predefined-constant">null</span> || credentialId.isEmpty()) {
        credentialId = getCredentialProvider(context.getSession())
                .getDefaultCredential(context.getSession(), context.getRealm(), context.getUser()).getId();
    }

    UserCredentialModel input = <span class="keyword">new</span> UserCredentialModel(credentialId, getType(context.getSession()), secret);
    <span class="keyword">return</span> getCredentialProvider(context.getSession()).isValid(context.getRealm(), context.getUser(), input);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next method is the setCookie().
This is an example of providing configuration for the Authenticator.
In this case we want the max age of the cookie to be configurable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">protected</span> <span class="type">void</span> setCookie(AuthenticationFlowContext context) {
    AuthenticatorConfigModel config = context.getAuthenticatorConfig();
    <span class="type">int</span> maxCookieAge = <span class="integer">60</span> * <span class="integer">60</span> * <span class="integer">24</span> * <span class="integer">30</span>; <span class="comment">// 30 days</span>
    <span class="keyword">if</span> (config != <span class="predefined-constant">null</span>) {
        maxCookieAge = <span class="predefined-type">Integer</span>.valueOf(config.getConfig().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">cookie.max.age</span><span class="delimiter">&quot;</span></span>));

    }
    <span class="predefined-type">URI</span> uri = context.getUriInfo().getBaseUriBuilder().path(<span class="string"><span class="delimiter">&quot;</span><span class="content">realms</span><span class="delimiter">&quot;</span></span>).path(context.getRealm().getName()).build();
    addCookie(context, <span class="string"><span class="delimiter">&quot;</span><span class="content">SECRET_QUESTION_ANSWERED</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>,
            uri.getRawPath(),
            <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>,
            maxCookieAge,
            <span class="predefined-constant">false</span>, <span class="predefined-constant">true</span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We obtain an AuthenticatorConfigModel from the AuthenticationFlowContext.getAuthenticatorConfig() method.
If configuration exists we pull the max age config out of it.
We will see how we can define what should be configured when we talk about the AuthenticatorFactory implementation.
The config values can be defined within the Admin Console if you set up config definitions in your AuthenticatorFactory implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
    <span class="directive">public</span> CredentialTypeMetadata getCredentialTypeMetadata(CredentialTypeMetadataContext metadataContext) {
        <span class="keyword">return</span> CredentialTypeMetadata.builder()
                .type(getType())
                .category(CredentialTypeMetadata.Category.TWO_FACTOR)
                .displayName(SecretQuestionCredentialProviderFactory.PROVIDER_ID)
                .helpText(<span class="string"><span class="delimiter">&quot;</span><span class="content">secret-question-text</span><span class="delimiter">&quot;</span></span>)
                .createAction(SecretQuestionAuthenticatorFactory.PROVIDER_ID)
                .removeable(<span class="predefined-constant">false</span>)
                .build(session);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last method to implement in the SecretQuestionCredentialProvider class is getCredentialTypeMetadata(CredentialTypeMetadataContext metadataContext), which is an abstract method of the CredentialProvider interface. Each Credential provider has to provide and implement this method. The method returns an instance of CredentialTypeMetadata,
which should at least include type and category of authenticator, displayName and removable item. In this example, the builder
takes type of authenticator from method getType(), category is Two Factor (the authenticator can be used as second factor of authentication)
and removable, which is set up to false (user can&#8217;t remove some previously registered credentials).</p>
</div>
<div class="paragraph">
<p>Other items of builder are helpText (will be shown to the user on various screens), createAction (the providerID of the required action,
which can be used by the user to create new credential) or updateAction (same as createAction, but instead of creating the new credential, it will update the credential).</p>
</div>
</div>
<div class="sect3">
<h4 id="implementing-an-authenticatorfactory"><a class="anchor" href="#implementing-an-authenticatorfactory"></a>Implementing an AuthenticatorFactory</h4>
<div class="paragraph">
<p>The next step in this process is to implement an AuthenticatorFactory.
This factory is responsible for instantiating an Authenticator.
It also provides deployment and configuration metadata about the Authenticator.</p>
</div>
<div class="paragraph">
<p>The getId() method is just the unique name of the component.
The create() method is called by the runtime to allocate and process the Authenticator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SecretQuestionAuthenticatorFactory</span> <span class="directive">implements</span> AuthenticatorFactory, ConfigurableAuthenticatorFactory {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PROVIDER_ID = <span class="string"><span class="delimiter">&quot;</span><span class="content">secret-question-authenticator</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> SecretQuestionAuthenticator SINGLETON = <span class="keyword">new</span> SecretQuestionAuthenticator();

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> PROVIDER_ID;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Authenticator</span> create(KeycloakSession session) {
        <span class="keyword">return</span> SINGLETON;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next thing the factory is responsible for is to specify the allowed requirement switches.
While there are four different requirement types:  ALTERNATIVE, REQUIRED, CONDITIONAL, DISABLED, AuthenticatorFactory implementations can limit which
requirement options are shown in the Admin Console when defining a flow. CONDITIONAL should only always be used for subflows, and unless there&#8217;s a good
reason for doing otherwise, the requirement on an authenticator should be REQUIRED, ALTERNATIVE and DISABLED:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">private</span> <span class="directive">static</span> AuthenticationExecutionModel.Requirement<span class="type">[]</span> REQUIREMENT_CHOICES = {
            AuthenticationExecutionModel.Requirement.REQUIRED,
            AuthenticationExecutionModel.Requirement.ALTERNATIVE,
            AuthenticationExecutionModel.Requirement.DISABLED
    };
    <span class="annotation">@Override</span>
    <span class="directive">public</span> AuthenticationExecutionModel.Requirement<span class="type">[]</span> getRequirementChoices() {
        <span class="keyword">return</span> REQUIREMENT_CHOICES;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The AuthenticatorFactory.isUserSetupAllowed() is a flag that tells the flow manager whether or not Authenticator.setRequiredActions() method will be called.
If an Authenticator is not configured for a user, the flow manager checks isUserSetupAllowed().  If it is false, then the flow aborts with an error.
If it returns true, then the flow manager will invoke Authenticator.setRequiredActions().</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> isUserSetupAllowed() {
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next few methods define how the Authenticator can be configured.
The isConfigurable() method is a flag which specifies to the Admin Console on whether the Authenticator can be configured within a flow.
The getConfigProperties() method returns a list of ProviderConfigProperty objects.
These objects define a specific configuration attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;ProviderConfigProperty&gt; getConfigProperties() {
        <span class="keyword">return</span> configProperties;
    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;ProviderConfigProperty&gt; configProperties = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;ProviderConfigProperty&gt;();

    <span class="directive">static</span> {
        ProviderConfigProperty property;
        property = <span class="keyword">new</span> ProviderConfigProperty();
        property.setName(<span class="string"><span class="delimiter">&quot;</span><span class="content">cookie.max.age</span><span class="delimiter">&quot;</span></span>);
        property.setLabel(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cookie Max Age</span><span class="delimiter">&quot;</span></span>);
        property.setType(ProviderConfigProperty.STRING_TYPE);
        property.setHelpText(<span class="string"><span class="delimiter">&quot;</span><span class="content">Max age in seconds of the SECRET_QUESTION_COOKIE.</span><span class="delimiter">&quot;</span></span>);
        configProperties.add(property);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each ProviderConfigProperty defines the name of the config property.
This is the key used in the config map stored in AuthenticatorConfigModel.
The label defines how the config option will be displayed in the Admin Console.
The type defines if it is a String, Boolean, or other type.
The Admin Console will display different UI inputs depending on the type.
The help text is what will be shown in the tooltip for the config attribute in the Admin Console.
Read the javadoc of ProviderConfigProperty for more detail.</p>
</div>
<div class="paragraph">
<p>The rest of the methods are for the Admin Console.
getHelpText() is the tooltip text that will be shown when you are picking the Authenticator you want to bind to an execution.
getDisplayType() is the text that will be shown in the Admin Console when listing the Authenticator.
getReferenceCategory() is just a category the Authenticator belongs to.</p>
</div>
</div>
<div class="sect3">
<h4 id="adding-an-authenticator-form"><a class="anchor" href="#adding-an-authenticator-form"></a>Adding an authenticator form</h4>
<div class="paragraph">
<p>Keycloak comes with a Freemarker <a href="https://www.keycloak.org/ui-customization/themes">theme and template engine</a>.
The createForm() method you called within authenticate() of your Authenticator class, builds an HTML page from a file within your login theme: <code>secret-question.ftl</code>.
This file should be added to the <code>theme-resources/templates</code> in your JAR, see <a href="https://www.keycloak.org/ui-customization/themes">Working with themes: Theme resource provider</a> for more details.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a bigger look at secret-question.ftl  Here&#8217;s a small code snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">        <span class="tag">&lt;form</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kc-totp-login-form</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${properties.kcFormClass!}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${url.loginAction}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${properties.kcFormGroupClass!}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${properties.kcLabelWrapperClass!}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;label</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">totp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${properties.kcLabelClass!}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${msg(&quot;loginSecretQuestion&quot;)}<span class="tag">&lt;/label&gt;</span>
                <span class="tag">&lt;/div&gt;</span>

                <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${properties.kcInputWrapperClass!}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;input</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">totp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret_answer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${properties.kcInputClass!}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/div&gt;</span>
            <span class="tag">&lt;/div&gt;</span>
        <span class="tag">&lt;/form&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Any piece of text enclosed in <code>${}</code> corresponds to an attribute or template function.
If you see the form&#8217;s action, you see it points to <code>${url.loginAction}</code>.
This value is automatically generated when you invoke the AuthenticationFlowContext.form() method.
You can also obtain this value by calling the AuthenticationFlowContext.getActionURL() method in Java code.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll also see <code>${properties.someValue}</code>.
These correspond to properties defined in your theme.properties file of our theme.
 <code>${msg("someValue")}</code> corresponds to the internationalized message bundles (.properties files) included with the login theme messages/ directory.
If you&#8217;re just using english, you can just add the value of the <code>loginSecretQuestion</code>.
This should be the question you want to ask the user.</p>
</div>
<div class="paragraph">
<p>When you call AuthenticationFlowContext.form() this gives you a LoginFormsProvider  instance.
If you called, <code>LoginFormsProvider.setAttribute("foo", "bar")</code>, the value of "foo" would be available for reference in your form as <code>${foo}</code>.
The value of an attribute can be any Java bean as well.</p>
</div>
<div class="paragraph">
<p>If you look at the top of the file, you&#8217;ll see that we are importing a template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="error">&lt;</span>#import &quot;select.ftl&quot; as layout<span class="error">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Importing this template, instead of the standard <code>template.ftl</code> allows Keycloak to display a dropdown box that allows the user to select
a different credential or execution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_adding_authenticator"><a class="anchor" href="#_adding_authenticator"></a>Adding an authenticator to a flow</h4>
<div class="paragraph">
<p>Adding an Authenticator to a flow must be done in the Admin Console.
If you go to the Authentication menu item and go to the Flow tab, you will be able to view the currently defined flows.
You cannot modify built in flows, so, to add the Authenticator we&#8217;ve created you have to copy an existing flow or create your own.
Our hope is that the user interface is sufficiently clear so that you can determine how to create a flow and add the Authenticator. For
more details, see the <code>Authentication Flows</code> chapter in <a href="https://www.keycloak.org/docs/26.4.0/server_admin/">Server Administration Guide</a> .</p>
</div>
<div class="paragraph">
<p>After you&#8217;ve created your flow, you have to bind it to the login action you want to bind it to.
If you go to the Authentication menu and go  to the Bindings tab you will see options to bind a flow to the browser, registration, or direct grant flow.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="required-action-walkthrough"><a class="anchor" href="#required-action-walkthrough"></a>Required action walkthrough</h3>
<div class="paragraph">
<p>In this section we will discuss how to define a required action.
In the Authenticator section you may have wondered, "How will we get the user&#8217;s answer to the secret question entered into the system?".  As we showed in the example, if the answer is not set up, a required action will be triggered.
This section discusses how to implement the required action for the Secret Question Authenticator.</p>
</div>
<div class="sect3">
<h4 id="packaging-classes-and-deployment-2"><a class="anchor" href="#packaging-classes-and-deployment-2"></a>Packaging classes and deployment</h4>
<div class="paragraph">
<p>You will package your classes within a single jar.
This jar does not have to be separate from other provider classes but it must contain a file named  <code>org.keycloak.authentication.RequiredActionFactory</code>                and must be contained in the <code>META-INF/services/</code> directory of your jar.
This file must list the fully qualified classname of each RequiredActionFactory implementation you have in the jar.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">org.keycloak.examples.authenticator.SecretQuestionRequiredActionFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>This services/ file is used by Keycloak to scan the providers it has to load into the system.</p>
</div>
<div class="paragraph">
<p>To deploy this jar, copy it to the <code>providers/</code> directory, then run <code>bin/kc.[sh|bat] build</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="implement-the-requiredactionprovider"><a class="anchor" href="#implement-the-requiredactionprovider"></a>Implement the RequiredActionProvider</h4>
<div class="paragraph">
<p>Required actions must first implement the RequiredActionProvider interface.
The RequiredActionProvider.requiredActionChallenge() is the initial call by the flow manager into the required action.
This method is responsible for rendering the HTML form that will drive the required action.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> requiredActionChallenge(RequiredActionContext context) {
        Response challenge = context.form().createForm(<span class="string"><span class="delimiter">&quot;</span><span class="content">secret_question_config.ftl</span><span class="delimiter">&quot;</span></span>);
        context.challenge(challenge);

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You see that RequiredActionContext has similar methods to AuthenticationFlowContext.
The form() method allows you to render the page from a Freemarker template.
The action URL is preset by the call to this form() method.
You just need to reference it within your HTML form.
I&#8217;ll show you this later.</p>
</div>
<div class="paragraph">
<p>The challenge() method notifies the flow manager that a required action must be executed.</p>
</div>
<div class="paragraph">
<p>The next method is responsible for processing input from the HTML form of the required action.
The action URL of the form will be routed to the RequiredActionProvider.processAction() method</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> processAction(RequiredActionContext context) {
        <span class="predefined-type">String</span> answer = (context.getHttpRequest().getDecodedFormParameters().getFirst(<span class="string"><span class="delimiter">&quot;</span><span class="content">answer</span><span class="delimiter">&quot;</span></span>));
        UserCredentialValueModel model = <span class="keyword">new</span> UserCredentialValueModel();
        model.setValue(answer);
        model.setType(SecretQuestionAuthenticator.CREDENTIAL_TYPE);
        context.getUser().updateCredentialDirectly(model);
        context.success();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The answer is pulled out of the form post.
A UserCredentialValueModel is created and the type and value of the credential are set.
Then UserModel.updateCredentialDirectly() is invoked.
Finally, RequiredActionContext.success() notifies the container that the required action was successful.</p>
</div>
</div>
<div class="sect3">
<h4 id="implement-the-requiredactionfactory"><a class="anchor" href="#implement-the-requiredactionfactory"></a>Implement the RequiredActionFactory</h4>
<div class="paragraph">
<p>This class is really simple.
It is just responsible for creating the required action provider instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SecretQuestionRequiredActionFactory</span> <span class="directive">implements</span> RequiredActionFactory {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> SecretQuestionRequiredAction SINGLETON = <span class="keyword">new</span> SecretQuestionRequiredAction();

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RequiredActionProvider create(KeycloakSession session) {
        <span class="keyword">return</span> SINGLETON;
    }


    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> SecretQuestionRequiredAction.PROVIDER_ID;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getDisplayText() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Secret Question</span><span class="delimiter">&quot;</span></span>;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The getDisplayText() method is just for the Admin Console when it wants to display a friendly name for the required action.</p>
</div>
</div>
<div class="sect3">
<h4 id="enable-required-action"><a class="anchor" href="#enable-required-action"></a>Enable required action</h4>
<div class="paragraph">
<p>The final thing you have to do is go into the Admin Console.
Click on the Authentication left menu.
Click on the Required Actions tab.
Click on the Register button and choose your new Required Action.
Your new required action should now be displayed and enabled in the required actions list.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modifying-or-extending-the-registration-form"><a class="anchor" href="#modifying-or-extending-the-registration-form"></a>Modifying or extending the registration form</h3>
<div class="paragraph">
<p>It is entirely possible for you to implement your own flow with a set of Authenticators to totally change how registration is done in Keycloak.
But what you&#8217;ll usually want to do is just add a bit of validation to the out-of-the-box registration page.
An additional SPI was created to be able to do this.
It basically allows you to add validation of form elements on the page as well as to initialize UserModel attributes and data after the user has been registered.
We&#8217;ll look at both the implementation of the user profile registration processing as well as the registration Google reCAPTCHA Enterprise plugin.</p>
</div>
<div class="sect3">
<h4 id="implementation-formaction-interface"><a class="anchor" href="#implementation-formaction-interface"></a>Implementation FormAction interface</h4>
<div class="paragraph">
<p>The core interface you have to implement is the FormAction interface.
A FormAction is responsible for rendering and processing a portion of the page.
Rendering is done in the buildPage() method, validation is done in the validate() method, post validation operations are done in success().  Let&#8217;s first take a look at buildPage() method of the Recaptcha plugin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> buildPage(FormContext context, LoginFormsProvider form) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; config = context.getAuthenticatorConfig().getConfig();
        <span class="keyword">if</span> (config == <span class="predefined-constant">null</span>
                || Stream.of(PROJECT_ID, SITE_KEY, API_KEY, ACTION)
                        .anyMatch(key -&gt; Strings.isNullOrEmpty(config.get(key)))
                || parseDoubleFromConfig(config, SCORE_THRESHOLD) == <span class="predefined-constant">null</span>) {
            form.addError(<span class="keyword">new</span> FormMessage(<span class="predefined-constant">null</span>, Messages.RECAPTCHA_NOT_CONFIGURED));
            <span class="keyword">return</span>;
        }

        <span class="predefined-type">String</span> userLanguageTag = context.getSession().getContext().resolveLocale(context.getUser())
                .toLanguageTag();
        <span class="type">boolean</span> invisible = <span class="predefined-type">Boolean</span>.parseBoolean(config.getOrDefault(INVISIBLE, <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>));

        form.setAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">recaptchaRequired</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
        form.setAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">recaptchaSiteKey</span><span class="delimiter">&quot;</span></span>, config.get(SITE_KEY));
        form.setAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">recaptchaAction</span><span class="delimiter">&quot;</span></span>, config.get(ACTION));
        form.setAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">recaptchaVisible</span><span class="delimiter">&quot;</span></span>, !invisible);
        form.addScript(<span class="string"><span class="delimiter">&quot;</span><span class="content">https://www.google.com/recaptcha/enterprise.js?hl=</span><span class="delimiter">&quot;</span></span> + userLanguageTag);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Recaptcha buildPage() method is a callback by the form flow to help render the page.
It receives a form parameter which is a LoginFormsProvider.
You can add additional attributes to the form provider so that they can be displayed in the HTML page generated by the registration Freemarker template.</p>
</div>
<div class="paragraph">
<p>The code above is from the registration recaptcha plugin.
Recaptcha requires some specific settings that must be obtained from configuration.
FormActions are configured in the exact same as Authenticators are.
In this example, we pull the Google Recaptcha site key and other options from Recaptcha configuration and add them as attributes to the form provider.
Our registration template file, register.ftl, can now have access to those attributes.</p>
</div>
<div class="paragraph">
<p>Recaptcha also has the requirement of loading a JavaScript script.
You can do this by calling LoginFormsProvider.addScript(), passing in the URL.</p>
</div>
<div class="paragraph">
<p>For user profile processing, there is no additional information that it needs to add to the form, so its buildPage() method is empty.</p>
</div>
<div class="paragraph">
<p>The next meaty part of this interface is the validate() method.
This is called immediately upon receiving a form post.
Let&#8217;s look at the Recaptcha&#8217;s plugin first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> validate(ValidationContext context) {
        MultivaluedMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; formData = context.getHttpRequest().getDecodedFormParameters();
        <span class="predefined-type">String</span> captcha = formData.getFirst(G_RECAPTCHA_RESPONSE);

        <span class="keyword">if</span> (!Validation.isBlank(captcha) &amp;&amp; validateRecaptcha(context, captcha)) {
            context.success();
        } <span class="keyword">else</span> {
            <span class="predefined-type">List</span>&lt;FormMessage&gt; errors = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
            errors.add(<span class="keyword">new</span> FormMessage(<span class="predefined-constant">null</span>, Messages.RECAPTCHA_FAILED));
            formData.remove(G_RECAPTCHA_RESPONSE);
            context.validationError(formData, errors);
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we obtain the form data that the Recaptcha widget adds to the form.
We obtain the Recaptcha secret key from configuration.
We then validate the recaptcha.
If successful, ValidationContext.success() is called.
We clear the captcha token from the form using formData.remove, but keep other form data untouched.
If not, we invoke ValidationContext.validationError() passing in the formData (so the user doesn&#8217;t have to re-enter data), we also specify an error message we want displayed.
The error message must point to a message bundle property in the internationalized message bundles.
For other registration extensions validate() might be validating the format of a form element, for example an alternative email attribute.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s also look at the user profile plugin that is used to validate email address and other user information when registering.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> validate(ValidationContext context) {
        MultivaluedMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; formData = context.getHttpRequest().getDecodedFormParameters();
        context.getEvent().detail(Details.REGISTER_METHOD, <span class="string"><span class="delimiter">&quot;</span><span class="content">form</span><span class="delimiter">&quot;</span></span>);

        UserProfile profile = getOrCreateUserProfile(context, formData);

        <span class="keyword">try</span> {
            profile.validate();
        } <span class="keyword">catch</span> (ValidationException pve) {
            <span class="predefined-type">List</span>&lt;FormMessage&gt; errors = Validation.getFormErrorsFromValidation(pve.getErrors());

            <span class="keyword">if</span> (pve.hasError(Messages.EMAIL_EXISTS, Messages.INVALID_EMAIL)) {
                context.getEvent().detail(Details.EMAIL, profile.getAttributes().getFirstValue(UserModel.EMAIL));
            }

            <span class="keyword">if</span> (pve.hasError(Messages.EMAIL_EXISTS)) {
                context.error(Errors.EMAIL_IN_USE);
            } <span class="keyword">else</span> <span class="keyword">if</span> (pve.hasError(Messages.USERNAME_EXISTS)) {
                context.error(Errors.USERNAME_IN_USE);
            } <span class="keyword">else</span> {
                context.error(Errors.INVALID_REGISTRATION);
            }

            context.validationError(formData, errors);
            <span class="keyword">return</span>;
        }
        context.success();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, this validate() method of user profile processing makes sure that the email and all other attributes are filled in the form.
It delegates to User Profile SPI, which makes sure that email is in the right format and does all other validations.
If any of these validations fail, an error message is queued up for rendering. It would contain the message for every field where the validation failed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As you can see, the user profile makes sure that registration form contains all the needed user profile fields. User profile also makes sure that correct validations
are used, attributes are correctly grouped on the page.  There is a correct type used for each field (such as if a user needs to choose from predefined values), fields
are "conditionally" rendered just for some scopes (Progressive profiling) and others. So usually you will not need to implement new <code>FormAction</code> or registration fields, but
you can just properly configure user-profile to reflect this. For more details, see <a href="https://www.keycloak.org/docs/26.4.0/server_admin/#user-profile">User Profile documentation</a>.
In general, new FormAction might be useful for instance if you want to add new credentials to the registration form (such as ReCaptcha support as mentioned here) rather than new user profile fields.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After all validations have been processed then, the form flow then invokes the FormAction.success() method.
For recaptcha this is a no-op, so we won&#8217;t go over it.
For user profile processing, this method fills in values in the registered user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> success(FormContext context) {
        checkNotOtherUserAuthenticating(context);

        MultivaluedMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; formData = context.getHttpRequest().getDecodedFormParameters();

        <span class="predefined-type">String</span> email = formData.getFirst(UserModel.EMAIL);
        <span class="predefined-type">String</span> username = formData.getFirst(UserModel.USERNAME);

        <span class="keyword">if</span> (context.getRealm().isRegistrationEmailAsUsername()) {
            username = email;
        }

        context.getEvent().detail(Details.USERNAME, username)
                .detail(Details.REGISTER_METHOD, <span class="string"><span class="delimiter">&quot;</span><span class="content">form</span><span class="delimiter">&quot;</span></span>)
                .detail(Details.EMAIL, email);

        UserProfile profile = getOrCreateUserProfile(context, formData);
        UserModel user = profile.create();

        user.setEnabled(<span class="predefined-constant">true</span>);

        <span class="comment">// This means that following actions can retrieve user from the context by context.getUser() method</span>
        context.setUser(user);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new user is created and the UserModel of the newly registered user is added to the FormContext.
The appropriate methods are called to initialize UserModel data. In your own FormAction, you can possibly obtain user by using something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> success(FormContext context) {
        UserModel user = context.getUser();
        <span class="keyword">if</span> (user != <span class="predefined-constant">null</span>) {
            <span class="comment">// Do something useful with the user here ...</span>
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, you are also required to define a FormActionFactory class.
This class is implemented similarly to AuthenticatorFactory, so we won&#8217;t go over it.</p>
</div>
</div>
<div class="sect3">
<h4 id="packaging-the-action"><a class="anchor" href="#packaging-the-action"></a>Packaging the action</h4>
<div class="paragraph">
<p>You will package your classes within a single jar.
This jar must contain a file named  <code>org.keycloak.authentication.FormActionFactory</code>                and must be contained in the <code>META-INF/services/</code> directory of your jar.
This file must list the fully qualified class name of each FormActionFactory implementation you have in the jar.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>org.keycloak.authentication.forms.RegistrationUserCreation
org.keycloak.authentication.forms.RegistrationRecaptcha</code></pre>
</div>
</div>
<div class="paragraph">
<p>This services/ file is used by Keycloak to scan the providers it has to load into the system.</p>
</div>
<div class="paragraph">
<p>To deploy this jar, copy it to the <code>providers/</code> directory, then run <code>bin/kc.[sh|bat] build</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="adding-formaction-to-the-registration-flow"><a class="anchor" href="#adding-formaction-to-the-registration-flow"></a>Adding FormAction to the registration flow</h4>
<div class="paragraph">
<p>Adding a FormAction to a registration page flow must be done in the Admin Console.
If you go to the Authentication menu item and go to the Flow tab, you will be able to view the currently defined flows.
You cannot modify built in flows, so, to add the Authenticator we&#8217;ve created you have to copy an existing flow or create your own.
I&#8217;m hoping the UI is intuitive enough so that you can figure out for yourself how to create a flow and add the FormAction.</p>
</div>
<div class="paragraph">
<p>Basically you&#8217;ll have to copy the registration flow.
Then click Actions menu to the right of the Registration Form, and pick "Add execution" to add a new execution.
You&#8217;ll pick the FormAction from the selection list.
Make sure your FormAction comes after "Registration User Creation" by using the down buttons to move it if your FormAction isn&#8217;t already listed after "Registration User Creation".  You want your FormAction to come after user creation because the success() method of Registration User Creation is responsible for creating the new UserModel.</p>
</div>
<div class="paragraph">
<p>After you&#8217;ve created your flow, you have to bind it to registration.
If you go to the Authentication menu and go  to the Bindings tab you will see options to bind a flow to the browser, registration, or direct grant flow.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modifying-forgot-passwordcredential-flow"><a class="anchor" href="#modifying-forgot-passwordcredential-flow"></a>Modifying forgot password/credential flow</h3>
<div class="paragraph">
<p>Keycloak also has a specific authentication flow for forgot password, or rather credential reset initiated by a user.
If you go to the Admin Console flows page, there is a "reset credentials" flow.
By default, Keycloak asks for the email or username of the user and sends an email to them.
If the user clicks on the link, then they are able to reset both their password and OTP (if an OTP has been set up).  You can disable automatic OTP reset by disabling the "Reset OTP" authenticator in the flow.</p>
</div>
<div class="paragraph">
<p>You can add additional functionality to this flow as well.
For example, many deployments would like for the user to answer one or more secret questions in additional to sending an email with a link.
You could expand on the secret question example that comes with the distro and incorporate it into the reset credential flow.</p>
</div>
<div class="paragraph">
<p>One thing to note if you are extending the reset credentials flow.
The first "authenticator" is just a page to obtain the username or email.
If the username or email exists, then the AuthenticationFlowContext.getUser() will return the located user.
Otherwise this will be null.
This form <strong>WILL NOT</strong> re-ask the user to enter an email or username if the previous email or username did not exist.
You need to prevent attackers from being able to guess valid users.
So, if AuthenticationFlowContext.getUser() returns null, you should proceed with the flow to make it look like a valid user was selected.
I suggest that if you want to add secret questions to this flow, you should ask these questions after the email is sent.
In other words, add your custom authenticator after the "Send Reset Email" authenticator.</p>
</div>
</div>
<div class="sect2">
<h3 id="modifying-first-broker-login-flow"><a class="anchor" href="#modifying-first-broker-login-flow"></a>Modifying first broker login flow</h3>
<div class="paragraph">
<p>First Broker Login flow is used during first login with some identity provider.
Term <code>First Login</code> means that there is not yet existing Keycloak account linked with the particular authenticated identity provider account.</p>
</div>
<div class="ulist _additional-resource">
<div class="title">Additional resources</div>
<ul>
<li>
<p>See the <code>Identity Brokering</code> chapter in <a href="https://www.keycloak.org/docs/26.4.0/server_admin/">Server Administration Guide</a> .</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_client_authentication"><a class="anchor" href="#_client_authentication"></a>Authentication of clients</h3>
<div class="paragraph">
<p>Keycloak actually supports pluggable authentication for <a href="https://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect</a> client applications.
Authentication of client (application) is used under the hood by the Keycloak adapter during sending any backchannel requests
to the Keycloak server (like the request for exchange code to access token after successful authentication or request to refresh token).
But the client authentication can be also used directly by you during <code>Direct Access grants</code> (represented by OAuth2 <code>Resource Owner Password Credentials Flow</code>)
or during <code>Service account</code> authentication (represented by OAuth2 <code>Client Credentials Flow</code>).</p>
</div>
<div class="ulist _additional-resource">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more details about Keycloak adapter and OAuth2 flows see <a href="https://www.keycloak.org/guides#securing-apps">Securing applications Guides</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="default-implementations"><a class="anchor" href="#default-implementations"></a>Default implementations</h4>
<div class="paragraph">
<p>Actually Keycloak has 2 default implementations of client authentication:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Traditional authentication with client_id and client_secret</dt>
<dd>
<p>This is default mechanism mentioned in the <a href="https://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect</a>                                or <a href="https://datatracker.ietf.org/doc/html/rfc6749">OAuth2</a> specification and Keycloak supports it since it&#8217;s early days.
The public client needs to include <code>client_id</code> parameter with its ID in the POST request (so it&#8217;s de facto not authenticated) and the confidential client needs to include <code>Authorization: Basic</code> header with the clientId and clientSecret used as username and password.</p>
</dd>
<dt class="hdlist1">Authentication with signed JWT</dt>
<dd>
<p>This is based on the <a href="https://datatracker.ietf.org/doc/html/rfc7523">JWT Bearer Token Profiles for OAuth 2.0</a> specification.
The client/adapter generates the <a href="https://datatracker.ietf.org/doc/html/rfc7519">JWT</a> and signs it with his private key.
The Keycloak then verifies the signed JWT with the client&#8217;s public key and authenticates client based on it.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>See the demo example and especially the <code>examples/preconfigured-demo/product-app</code> for the example application showing
the application using client authentication with signed JWT.</p>
</div>
</div>
<div class="sect3">
<h4 id="implement-your-own-client-authenticator"><a class="anchor" href="#implement-your-own-client-authenticator"></a>Implement your own client authenticator</h4>
<div class="paragraph">
<p>For plug your own client authenticator, you need to implement few interfaces on both client (adapter) and server side.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Client side</dt>
<dd>
<p>Here you need to implement <code>org.keycloak.adapters.authentication.ClientCredentialsProvider</code> and put the implementation either to:</p>
<div class="ulist">
<ul>
<li>
<p>your WAR file into WEB-INF/classes . But in this case, the implementation can be used just for this single WAR application</p>
</li>
<li>
<p>Some JAR file, which will be added into WEB-INF/lib of your WAR</p>
</li>
<li>
<p>Some JAR file, which will be used as jboss module and configured in jboss-deployment-structure.xml of your WAR.                                In all cases, you also need to create the file <code>META-INF/services/org.keycloak.adapters.authentication.ClientCredentialsProvider</code>                                either in the WAR or in your JAR.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Server side</dt>
<dd>
<p>Here you need to implement <code>org.keycloak.authentication.ClientAuthenticatorFactory</code> and <code>org.keycloak.authentication.ClientAuthenticator</code> . You also need to add the file <code>META-INF/services/org.keycloak.authentication.ClientAuthenticatorFactory</code> with the name of the implementation classes.
See <a href="#_auth_spi_walkthrough">authenticators</a> for more details.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_action_token_handler_spi"><a class="anchor" href="#_action_token_handler_spi"></a>Action Token Handler SPI</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/action-token-handler-spi.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/action-token-handler-spi.adoc&amp;description=%0A%0AFile:%20server_development/topics/action-token-handler-spi.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>An action token is a special instance of Json Web Token (JWT) that permits its bearer to perform some actions, e.g. to
reset a password or validate e-mail address. They are usually sent to users in form of a link that points to an endpoint
processing action tokens for a particular realm.</p>
</div>
<div class="paragraph">
<p>Keycloak offers four basic token types allowing the bearer to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reset credentials</p>
</li>
<li>
<p>Confirm e-mail address</p>
</li>
<li>
<p>Execute required action(s)</p>
</li>
<li>
<p>Confirm linking of an account with account in external identity provider</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to that, it is possible to implement any functionality that initiates or modifies authentication session
using action token handler SPI, details of which are described in the text below.</p>
</div>
<div class="sect2">
<h3 id="_action_token_anatomy"><a class="anchor" href="#_action_token_anatomy"></a>Anatomy of action token</h3>
<div class="paragraph">
<p>Action token is a standard Json Web Token signed with active realm key where the payload contains several fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>typ</code> - Identification of the action (e.g. <code>verify-email</code>)</p>
</li>
<li>
<p><code>iat</code> and <code>exp</code> - Times of token validity</p>
</li>
<li>
<p><code>sub</code> - ID of the user</p>
</li>
<li>
<p><code>azp</code> - Client name</p>
</li>
<li>
<p><code>iss</code> - Issuer - URL of the issuing realm</p>
</li>
<li>
<p><code>aud</code> - Audience - list containing URL of the issuing realm</p>
</li>
<li>
<p><code>asid</code> - ID of the authentication session (<em>optional</em>)</p>
</li>
<li>
<p><code>nonce</code> - Random nonce to guarantee uniqueness of use if the operation can only be executed once (<em>optional</em>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, an action token can contain any number of custom fields serializable into JSON.</p>
</div>
</div>
<div class="sect2">
<h3 id="action-token-processing"><a class="anchor" href="#action-token-processing"></a>Action token processing</h3>
<div class="paragraph">
<p>When an action token is passed to a Keycloak endpoint
<code><em>KEYCLOAK_ROOT</em>/realms/master/login-actions/action-token</code> via <code>key</code> parameter, it is validated and a proper action
token handler is executed. <strong>The processing always takes place in a context of an authentication session</strong>, either a fresh
one or the action token service joins an existing authentication session (details are described below). The action token
handler can perform actions prescribed by the token (often it alters the authentication session) and results into an HTTP
response (e.g. it can continue in authentication or display an information/error page). These steps are detailed below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Basic action token validation.</strong> Signature and time validity is checked, and action token handler is determined based
on <code>typ</code> field.</p>
</li>
<li>
<p><a id="determining-auth-sess"></a><strong>Determining authentication session.</strong> If the action token URL was opened in browser with
existing authentication session, and the token contains authentication session ID matching the authentication session
from the browser, action token validation and handling will attach this ongoing authentication session. Otherwise,
action token handler creates a fresh authentication session that replaces any other authentication session present at
that time in the browser.</p>
</li>
<li>
<p><strong>Token validations specific for token type.</strong> Action token endpoint logic validates that the user (<code>sub</code> field) and
client (<code>azp</code>) from the token exist, are valid and not disabled. Then it validates all custom validations defined in the
action token handler. Furthermore, token handler can request this token be single-use. Already used tokens would then be
rejected by action token endpoint logic.</p>
</li>
<li>
<p><strong>Performing the action.</strong> After all these validations, action token handler code is called that performs the actual
action according to parameters in the token.</p>
</li>
<li>
<p><strong>Invalidation of single-Use tokens.</strong> If the token is set to single-use, once the authentication flow finishes, the
action token is invalidated.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="implement-your-own-action-token-and-its-handler"><a class="anchor" href="#implement-your-own-action-token-and-its-handler"></a>Implement your own action token and its handler</h3>
<div class="sect3">
<h4 id="how-to-create-an-action-token"><a class="anchor" href="#how-to-create-an-action-token"></a>How to create an action token</h4>
<div class="paragraph">
<p>As action token is just a signed JWT with few mandatory fields (see <a href="#_action_token_anatomy">Anatomy of action token</a>
above), it can be serialized and signed as such using Keycloak&#8217;s <code>JWSBuilder</code> class. This way has been already
implemented in <code>serialize(session, realm, uriInfo)</code> method of <code>org.keycloak.authentication.actiontoken.DefaultActionToken</code>
and can be leveraged by implementers by using that class for tokens instead of plain <code>JsonWebToken</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows the implementation of a simple action token. Note that the class must have a private constructor without any arguments.
This is necessary to deserialize the token class from JWT.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.keycloak.authentication.actiontoken.DefaultActionToken</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoActionToken</span> <span class="directive">extends</span> DefaultActionToken {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TOKEN_TYPE = <span class="string"><span class="delimiter">&quot;</span><span class="content">my-demo-token</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> DemoActionToken(<span class="predefined-type">String</span> userId, <span class="type">int</span> absoluteExpirationInSecs, <span class="predefined-type">String</span> compoundAuthenticationSessionId) {
        <span class="local-variable">super</span>(userId, TOKEN_TYPE, absoluteExpirationInSecs, <span class="predefined-constant">null</span>, compoundAuthenticationSessionId);
    }

    <span class="directive">private</span> DemoActionToken() {
        <span class="comment">// Required to deserialize from JWT</span>
        <span class="local-variable">super</span>();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the action token you are implementing contains any custom fields that should be serializabled to JSON fields, you
should consider implementing a descendant of <code>org.keycloak.representations.JsonWebToken</code> class that would implement
<code>org.keycloak.models.ActionTokenKeyModel</code> interface. In that case, you can take advantage of the existing
<code>org.keycloak.authentication.actiontoken.DefaultActionToken</code> class as it already satisfies both these conditions,
and either use it directly or implement its child, the fields of which can be annotated with appropriate Jackson
annotations, e.g. <code>com.fasterxml.jackson.annotation.JsonProperty</code> to serialize them to JSON.</p>
</div>
<div class="paragraph">
<p>The following example extends the <code>DemoActionToken</code> from the previous example with the field <code>demo-id</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonProperty</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.authentication.actiontoken.DefaultActionToken</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DemoActionToken</span> <span class="directive">extends</span> DefaultActionToken {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> TOKEN_TYPE = <span class="string"><span class="delimiter">&quot;</span><span class="content">my-demo-token</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> JSON_FIELD_DEMO_ID = <span class="string"><span class="delimiter">&quot;</span><span class="content">demo-id</span><span class="delimiter">&quot;</span></span>;

    <span class="annotation">@JsonProperty</span>(value = JSON_FIELD_DEMO_ID)
    <span class="directive">private</span> <span class="predefined-type">String</span> demoId;

    <span class="directive">public</span> DemoActionToken(<span class="predefined-type">String</span> userId, <span class="type">int</span> absoluteExpirationInSecs, <span class="predefined-type">String</span> compoundAuthenticationSessionId, <span class="predefined-type">String</span> demoId) {
        <span class="local-variable">super</span>(userId, TOKEN_TYPE, absoluteExpirationInSecs, <span class="predefined-constant">null</span>, compoundAuthenticationSessionId);
        <span class="local-variable">this</span>.demoId =  demoId;
    }

    <span class="directive">private</span> DemoActionToken() {
        <span class="comment">// you must have this private constructor for deserializer</span>
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getDemoId() {
        <span class="keyword">return</span> demoId;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="packaging-classes-and-deployment-3"><a class="anchor" href="#packaging-classes-and-deployment-3"></a>Packaging classes and deployment</h4>
<div class="paragraph">
<p>To plug your own action token and its handler, you need to implement few interfaces on server side:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.keycloak.authentication.actiontoken.ActionTokenHandler</code> - actual handler of action token for a particular
action (i.e. for a given value of <code>typ</code> token field).</p>
<div class="paragraph">
<p>The central method in that interface is <code>handleToken(token, context)</code> which defines actual operation executed upon
receiving the action token. Usually it is some alteration of authentication session notes but generally it can be
arbitrary. This method is only called if all verifiers (including those defined in <code>getVerifiers(context)</code>) have
succeeded, and it is guaranteed that the <code>token</code> would be of the class returned by <code>getTokenClass()</code> method.</p>
</div>
<div class="paragraph">
<p>To be able to determine whether the action token was issued for the current authentication session as described in
<a href="#determining-auth-sess">Item 2 above</a>, method for extracting authentication session ID has to be declared in
<code>getAuthenticationSessionIdFromToken(token, context)</code> method. The implementation in <code>DefaultActionToken</code> returns the
value of <code>asid</code> field from the token if it is defined. Note that you can override that method to return current
authentication session ID regardless of the token - that way you can create tokens that would step into the ongoing
authentication flow before any authentication flow would be started.</p>
</div>
<div class="paragraph">
<p>If the authentication session from the token does not match the current one, the action token handler would be asked to
start a fresh one by calling <code>startFreshAuthenticationSession(token, context)</code>. It can throw a <code>VerificationException</code>
(or better its more descriptive variant <code>ExplainedTokenVerificationException</code>) to signal that would be forbidden.</p>
</div>
<div class="paragraph">
<p>The token handler also determines via method <code>canUseTokenRepeatedly(token, context)</code> whether the token would be
invalidated after it is used and authentication completes. Note that if you would have a flow utilizing multiple action
token, only the last token would be invalidated. In that case, you should use
<code>org.keycloak.models.SingleUseObjectProvider</code> in action token handler to invalidate the used tokens manually.</p>
</div>
<div class="paragraph">
<p>Default implementation of most of the <code>ActionTokenHandler</code> methods is the
<code>org.keycloak.authentication.actiontoken.AbstractActionTokenHandler</code> abstract class in <code>keycloak-services</code> module. The
only method that needs to be implemented is <code>handleToken(token, context)</code> that performs the actual action.</p>
</div>
</li>
<li>
<p><code>org.keycloak.authentication.actiontoken.ActionTokenHandlerFactory</code> - factory that instantiates action token
handler. Implementations have to override <code>getId()</code> to return value that must match precisely the value of <code>typ</code>
field in the action token.</p>
<div class="paragraph">
<p>Note that you have to register the custom <code>ActionTokenHandlerFactory</code> implementation as explained in the
<a href="#_providers">Service Provider Interfaces</a> section of this guide.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_events"><a class="anchor" href="#_events"></a>Event Listener SPI</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/events.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/events.adoc&amp;description=%0A%0AFile:%20server_development/topics/events.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Writing an Event Listener Provider starts by implementing the <code>EventListenerProvider</code> and <code>EventListenerProviderFactory</code> interfaces. Please see the Javadoc
and examples for complete details on how to do this.</p>
</div>
<div class="paragraph">
<p>For details on how to package and deploy a custom provider refer to the <a href="#_providers">Service Provider Interfaces</a> chapter.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_saml_role_mappings_spi"><a class="anchor" href="#_saml_role_mappings_spi"></a>SAML role mappings SPI</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/saml-role-mappings-spi.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/saml-role-mappings-spi.adoc&amp;description=%0A%0AFile:%20server_development/topics/saml-role-mappings-spi.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak defines an SPI for mapping SAML roles into roles that exist in the SP environment. The roles returned by
a third-party IDP might not always correspond to the roles that were defined for the SP application so there is a need for a
mechanism that allows mapping the SAML roles into different roles. It is used by the SAML adapter after it extracts the roles
from the SAML assertion to set up the container&#8217;s security context.</p>
</div>
<div class="paragraph">
<p>The <code>org.keycloak.adapters.saml.RoleMappingsProvider</code> SPI doesn&#8217;t impose any restrictions on the mappings that can be performed.
Implementations can not only map roles into other roles but also add or remove roles (and thus augment or reduce the set of
roles assigned to the SAML principal) depending on the use case.</p>
</div>
<div class="paragraph">
<p>For details about the configuration of the role mappings provider for the SAML adapter as well as a description of the default
implementations available see the <a href="https://www.keycloak.org/guides#securing-apps">Securing applications Guides</a>.</p>
</div>
<div class="sect2">
<h3 id="implementing-a-custom-role-mappings-provider"><a class="anchor" href="#implementing-a-custom-role-mappings-provider"></a>Implementing a custom role mappings provider</h3>
<div class="paragraph">
<p>To implement a custom role mappings provider one first needs to implement the <code>org.keycloak.adapters.saml.RoleMappingsProvider</code>
interface. Then, a <code>META-INF/services/org.keycloak.adapters.saml.RoleMappingsProvider</code> file containing the fully qualified name
of the custom implementation must be added to the archive that also contains the implementation class. This archive can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The SP application WAR file where the provider class is included in WEB-INF/classes;</p>
</li>
<li>
<p>A custom JAR file which will be added into WEB-INF/lib of the SP application WAR;</p>
</li>
<li>
<p>(WildFly/JBoss EAP only) A custom JAR file configured as a <code>jboss module</code> and referenced in <code>jboss-deployment-structure.xml</code>
of the SP application WAR.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the SP application is deployed, the role mappings provider that will be used is selected by the id that was set in
<code>keycloak-saml.xml</code> or in the <code>keycloak-saml</code> subsystem. So to enable your custom provider simply make sure that its id is
properly set in the adapter configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user-storage-spi"><a class="anchor" href="#_user-storage-spi"></a>User Storage SPI</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can use the User Storage SPI to write extensions to Keycloak to connect to external user databases and credential stores. The built-in LDAP and ActiveDirectory support is an implementation of this SPI in action. Out of the box, Keycloak uses its local database to create, update, and look up users and validate credentials. Often though, organizations have existing external proprietary user databases that they cannot migrate to Keycloak&#8217;s data model. For those situations, application developers can write implementations of the User Storage SPI to bridge the external user store and the internal user object model that Keycloak uses to log in users and manage them.</p>
</div>
<div class="paragraph">
<p>When the Keycloak runtime needs to look up a user, such as when a user is logging in, it performs a number of steps to locate the user. It first looks to see if the user is in the user cache; if the user is found it uses that in-memory representation. Then it looks for the user within the Keycloak local database. If the user is not found, it then loops through User Storage SPI provider implementations to perform the user query until one of them returns the user the runtime is looking for. The provider queries the external user store for the user and maps the external data representation of the user to Keycloak&#8217;s user metamodel.</p>
</div>
<div class="paragraph">
<p>User Storage SPI provider implementations can also perform complex criteria queries, perform CRUD operations on users, validate and manage credentials, or perform bulk updates of many users at once. It depends on the capabilities of the external store.</p>
</div>
<div class="paragraph">
<p>User Storage SPI provider implementations are packaged and deployed similarly to (and often are) Jakarta EE components. They are not enabled by default, but instead must be enabled and configured per realm under the <code>User Federation</code> tab in the administration console.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If your user provider implementation is using some user attributes as the metadata attributes for linking/establishing the user identity,
then please make sure that users are not able to edit the attributes and the corresponding attributes are read-only. The example is the <code>LDAP_ID</code> attribute, which the built-in Keycloak
LDAP provider is using for to store the ID of the user on the LDAP server side. See the details in the <a href="https://www.keycloak.org/docs/26.4.0/server_admin/#read_only_user_attributes">Threat model mitigation chapter</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are two sample projects in <a href="https://github.com/keycloak/keycloak-quickstarts">Keycloak Quickstarts Repository</a>. Each quickstart has a <code>README</code> file with instructions on how to build, deploy, and test the sample project. The following table provides a brief description of the available User Storage SPI quickstarts:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. User Storage SPI Quickstarts</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/keycloak/keycloak-quickstarts/tree/main/extension/user-storage-jpa">user-storage-jpa</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Demonstrates implementing a user storage provider using JPA.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/keycloak/keycloak-quickstarts/tree/main/extension/user-storage-simple">user-storage-simple</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Demonstrates implementing a user storage provider using a simple properties file that contains username/password key pairs.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In order to connect to the external database, you should use the Keycloak properties for the additional datasources described in the <a href="https://www.keycloak.org/server/db#configure-multiple-datasources">Configure multiple datasources</a> guide.</p>
</div>
<div class="sect2">
<h3 id="accessing-the-new-entity-manager"><a class="anchor" href="#accessing-the-new-entity-manager"></a>Accessing the new entity manager</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/entity-manager.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/entity-manager.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/entity-manager.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>In order to simply access your data in your Keycloak extension, you can obtain the <a href="https://jakarta.ee/specifications/persistence/3.2/apidocs/jakarta.persistence/jakarta/persistence/entitymanager">EntityManager</a> for the additional datasources used in these quickstarts.
It helps you to interact with entities specified for your datasource, as it provides some kind of bridge between your JPA entities and the database.</p>
</div>
<div class="paragraph">
<p>You can use the new entity manager (for the <code>user-store</code> datasource) as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = session.getProvider(JpaConnectionProvider.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">user-store</span><span class="delimiter">&quot;</span></span>).getEntityManager();
var user = em.find(org.your.extension.UserEntity.class, <span class="integer">123L</span>);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="provider-interfaces"><a class="anchor" href="#provider-interfaces"></a>Provider interfaces</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/provider-interfaces.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/provider-interfaces.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/provider-interfaces.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When building an implementation of the User Storage SPI you have to define a provider class and a provider factory.
Provider class instances are created per transaction by provider factories.
Provider classes do all the heavy lifting of user lookup and other user operations.  They must implement the
<code>org.keycloak.storage.UserStorageProvider</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.keycloak.storage</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserStorageProvider</span> <span class="directive">extends</span> <span class="predefined-type">Provider</span> {


    <span class="comment">/**
     * Callback when a realm is removed.  Implement this if, for example, you want to do some
     * cleanup in your user storage when a realm is removed
     *
     * @param realm
     */</span>
    <span class="keyword">default</span>
    <span class="type">void</span> preRemove(RealmModel realm) {

    }

    <span class="comment">/**
     * Callback when a group is removed.  Allows you to do things like remove a user
     * group mapping in your external store if appropriate
     *
     * @param realm
     * @param group
     */</span>
    <span class="keyword">default</span>
    <span class="type">void</span> preRemove(RealmModel realm, GroupModel group) {

    }

    <span class="comment">/**
     * Callback when a role is removed.  Allows you to do things like remove a user
     * role mapping in your external store if appropriate

     * @param realm
     * @param role
     */</span>
    <span class="keyword">default</span>
    <span class="type">void</span> preRemove(RealmModel realm, RoleModel role) {

    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may be thinking that the <code>UserStorageProvider</code> interface is pretty sparse? You&#8217;ll see later in this chapter that there are other mix-in interfaces your provider class may implement to support the meat of user integration.</p>
</div>
<div class="paragraph">
<p><code>UserStorageProvider</code> instances are created once per transaction. When the transaction is complete, the <code>UserStorageProvider.close()</code> method is invoked and the instance is then garbage collected. Instances are created by provider factories. Provider factories implement the <code>org.keycloak.storage.UserStorageProviderFactory</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.keycloak.storage</span>;

<span class="comment">/**
 * @author &lt;a href=&quot;mailto:bill@burkecentral.com&quot;&gt;Bill Burke&lt;/a&gt;
 * @version $Revision: 1 $
 */</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserStorageProviderFactory</span>&lt;T <span class="directive">extends</span> UserStorageProvider&gt; <span class="directive">extends</span> ComponentFactory&lt;T, UserStorageProvider&gt; {

    <span class="comment">/**
     * This is the name of the provider and will be shown in the admin console as an option.
     *
     * @return
     */</span>
    <span class="annotation">@Override</span>
    <span class="predefined-type">String</span> getId();

    <span class="comment">/**
     * called per Keycloak transaction.
     *
     * @param session
     * @param model
     * @return
     */</span>
    T create(KeycloakSession session, ComponentModel model);
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Provider factory classes must specify the concrete provider class as a template parameter when implementing the
<code>UserStorageProviderFactory</code>.  This is a must as the runtime will introspect this class to scan for its capabilities
(the other interfaces it implements).  So for example, if your provider class is named <code>FileProvider</code>, then the
factory class should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">FileProviderFactory</span> <span class="directive">implements</span> UserStorageProviderFactory&lt;FileProvider&gt; {

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() { <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">file-provider</span><span class="delimiter">&quot;</span></span>; }

    <span class="directive">public</span> FileProvider create(KeycloakSession session, ComponentModel model) {
       ...
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>getId()</code> method returns the name of the User Storage provider.  This id will be displayed in the admin console&#8217;s
User Federation page when you want to enable the provider for a specific realm.</p>
</div>
<div class="paragraph">
<p>The <code>create()</code> method is responsible for allocating an instance of the provider class.  It takes a <code>org.keycloak.models.KeycloakSession</code>
parameter.  This object can be used to look up other information and metadata as well as provide access to various other
components within the runtime.  The <code>ComponentModel</code> parameter represents how the provider was enabled and configured within
a specific realm.  It contains the instance id of the enabled provider as well as any configuration you may have specified
for it when you enabled through the admin console.</p>
</div>
<div class="paragraph">
<p>The <code>UserStorageProviderFactory</code> has other capabilities as well which we will go over later in this chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_provider_capability_interfaces"><a class="anchor" href="#_provider_capability_interfaces"></a>Provider capability interfaces</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/provider-capability-interfaces.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/provider-capability-interfaces.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/provider-capability-interfaces.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If you have examined the <code>UserStorageProvider</code> interface closely you might notice that it does not define any methods for locating or managing users. These methods are actually defined in other <em>capability interfaces</em> depending on what scope of capabilities your external user store can provide and execute on. For example, some external stores are read-only and can only do simple queries and credential validation. You will only be required to implement the <em>capability interfaces</em> for the features you are able to. You can implement these interfaces:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SPI</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.storage.user.UserLookupProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This interface is required if you want to be able to log in with users from this external store. Most (all?) providers implement this interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.storage.user.UserQueryMethodsProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines complex queries that are used to locate one or more users. You must implement this interface if you want to view and manage users from the administration console.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.storage.user.UserCountMethodsProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement this interface if your provider supports count queries.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.storage.user.UserQueryProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This interface is combined capability of <code>UserQueryMethodsProvider</code> and <code>UserCountMethodsProvider</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.storage.user.UserRegistrationProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement this interface if your provider supports adding and removing users.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.storage.user.UserBulkUpdateProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement this interface if your provider supports bulk update of a set of users.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.credential.CredentialInputValidator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement this interface if your provider can validate one or more different credential types (for example, if your provider can validate a password).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.credential.CredentialInputUpdater</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement this interface if your provider supports updating one or more different credential types.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="model-interfaces"><a class="anchor" href="#model-interfaces"></a>Model interfaces</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/model-interfaces.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/model-interfaces.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/model-interfaces.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Most of the methods defined in the <em>capability</em> <em>interfaces</em> either return or are passed in representations of a user. These representations are defined by the <code>org.keycloak.models.UserModel</code> interface. App developers are required to implement this interface. It provides a mapping between the external user store and the user metamodel that Keycloak uses.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.keycloak.models</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserModel</span> <span class="directive">extends</span> RoleMapperModel {
    <span class="predefined-type">String</span> getId();

    <span class="predefined-type">String</span> getUsername();
    <span class="type">void</span> setUsername(<span class="predefined-type">String</span> username);

    <span class="predefined-type">String</span> getFirstName();
    <span class="type">void</span> setFirstName(<span class="predefined-type">String</span> firstName);

    <span class="predefined-type">String</span> getLastName();
    <span class="type">void</span> setLastName(<span class="predefined-type">String</span> lastName);

    <span class="predefined-type">String</span> getEmail();
    <span class="type">void</span> setEmail(<span class="predefined-type">String</span> email);
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>UserModel</code> implementations provide access to read and update metadata about the user including things like username, name, email, role and group mappings, as well as other arbitrary attributes.</p>
</div>
<div class="paragraph">
<p>There are other model classes within the <code>org.keycloak.models</code> package that represent other parts of the Keycloak metamodel: <code>RealmModel</code>, <code>RoleModel</code>, <code>GroupModel</code>, and <code>ClientModel</code>.</p>
</div>
<div class="sect3">
<h4 id="storage-ids"><a class="anchor" href="#storage-ids"></a>Storage Ids</h4>
<div class="paragraph">
<p>One important method of <code>UserModel</code> is the <code>getId()</code> method. When implementing <code>UserModel</code> developers must be aware of the user id format. The format must be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"f:" + component id + ":" + external id</pre>
</div>
</div>
<div class="paragraph">
<p>The Keycloak runtime often has to look up users by their user id. The user id contains enough information so that the runtime does not have to query every single <code>UserStorageProvider</code> in the system to find the user.</p>
</div>
<div class="paragraph">
<p>The component id is the id returned from <code>ComponentModel.getId()</code>. The <code>ComponentModel</code> is passed in as a parameter when creating the provider class so you can get it from there. The external id is information your provider class needs to find the user in the external store. This is often a username or a uid. For example, it might look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>f:332a234e31234:wburke</pre>
</div>
</div>
<div class="paragraph">
<p>When the runtime does a lookup by id, the id is parsed to obtain the component id. The component id is used to locate the <code>UserStorageProvider</code> that was originally used to load the user. That provider is then passed the id. The provider again parses the id to obtain the external id and it will use to locate the user in external user storage.</p>
</div>
<div class="paragraph">
<p>This format has the drawback that it can generate long IDs for the external storage users. This is specially important when combined with the <a href="https://www.keycloak.org/docs/26.4.0/server_admin/#webauthn_server_administration_guide">WebAuthn authentication</a>, which limits the user handle ID to 64 bytes. For that reason, if the storage users are going to use WebAuthn authentication, it is important to limit the full storage ID to 64 characters. The method <code>validateConfiguration</code> can be used to assign a short ID for the provider component on creation, giving some space to the user IDs within the 64 byte limitation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="type">void</span> validateConfiguration(KeycloakSession session, RealmModel realm, ComponentModel model)
            <span class="directive">throws</span> ComponentValidationException
    {
        <span class="comment">// ...</span>
        <span class="keyword">if</span> (model.getId() == <span class="predefined-constant">null</span>) {
            <span class="comment">// On creation use short UUID of 22 chars, 40 chars left for the user ID</span>
            model.setId(KeycloakModelUtils.generateShortId());
        }
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="packaging-and-deployment"><a class="anchor" href="#packaging-and-deployment"></a>Packaging and deployment</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/packaging.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/packaging.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/packaging.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>In order for Keycloak to recognize the provider, you need to add a file to the JAR: <code>META-INF/services/org.keycloak.storage.UserStorageProviderFactory</code>. This file must contain a line-separated list of fully qualified classnames of the <code>UserStorageProviderFactory</code> implementations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>org.keycloak.examples.federation.properties.ClasspathPropertiesStorageFactory
org.keycloak.examples.federation.properties.FilePropertiesStorageFactory</pre>
</div>
</div>
<div class="paragraph">
<p>To deploy this jar, copy it to the <code>providers/</code> directory, then run <code>bin/kc.[sh|bat] build</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="simple-read-only-lookup-example"><a class="anchor" href="#simple-read-only-lookup-example"></a>Simple read-only, lookup example</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/simple-example.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/simple-example.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/simple-example.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>To illustrate the basics of implementing the User Storage SPI let&#8217;s walk through a simple example. In this chapter you&#8217;ll see the implementation of a simple <code>UserStorageProvider</code> that looks up users in a simple property file. The property file contains username and password definitions and is hardcoded to a specific location on the classpath. The provider will be able to look up the user by ID and username and also be able to validate passwords. Users that originate from this provider will be read-only.</p>
</div>
<div class="sect3">
<h4 id="provider-class"><a class="anchor" href="#provider-class"></a>Provider class</h4>
<div class="paragraph">
<p>The first thing we will walk through is the <code>UserStorageProvider</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PropertyFileUserStorageProvider</span> <span class="directive">implements</span>
        UserStorageProvider,
        UserLookupProvider,
        CredentialInputValidator,
        CredentialInputUpdater
{
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our provider class, <code>PropertyFileUserStorageProvider</code>, implements many interfaces. It implements the <code>UserStorageProvider</code> as that is a base requirement of the SPI. It implements the <code>UserLookupProvider</code> interface because we want to be able to log in with users stored by this provider. It implements the <code>CredentialInputValidator</code> interface because we want to be able to validate passwords entered in using the login screen. Our property file is read-only. We implement the <code>CredentialInputUpdater</code> because we want to post an error condition when the user attempts to update his password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">protected</span> KeycloakSession session;
    <span class="directive">protected</span> <span class="predefined-type">Properties</span> properties;
    <span class="directive">protected</span> ComponentModel model;
    <span class="comment">// map of loaded users in this transaction</span>
    <span class="directive">protected</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, UserModel&gt; loadedUsers = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

    <span class="directive">public</span> PropertyFileUserStorageProvider(KeycloakSession session, ComponentModel model, <span class="predefined-type">Properties</span> properties) {
        <span class="local-variable">this</span>.session = session;
        <span class="local-variable">this</span>.model = model;
        <span class="local-variable">this</span>.properties = properties;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The constructor for this provider class is going to store the reference to the <code>KeycloakSession</code>, <code>ComponentModel</code>, and property file. We&#8217;ll use all of these later. Also notice that there is a map of loaded users. Whenever we find a user we will store it in this map so that we avoid re-creating it again within the same transaction. This is a good practice to follow as many providers will need to do this (that is, any provider that integrates with JPA). Remember also that provider class instances are created once per transaction and are closed after the transaction completes.</p>
</div>
<div class="sect4">
<h5 id="userlookupprovider-implementation"><a class="anchor" href="#userlookupprovider-implementation"></a>UserLookupProvider implementation</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> UserModel getUserByUsername(RealmModel realm, <span class="predefined-type">String</span> username) {
        UserModel adapter = loadedUsers.get(username);
        <span class="keyword">if</span> (adapter == <span class="predefined-constant">null</span>) {
            <span class="predefined-type">String</span> password = properties.getProperty(username);
            <span class="keyword">if</span> (password != <span class="predefined-constant">null</span>) {
                adapter = createAdapter(realm, username);
                loadedUsers.put(username, adapter);
            }
        }
        <span class="keyword">return</span> adapter;
    }

    <span class="directive">protected</span> UserModel createAdapter(RealmModel realm, <span class="predefined-type">String</span> username) {
        <span class="keyword">return</span> <span class="keyword">new</span> AbstractUserAdapter(session, realm, model) {
            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="predefined-type">String</span> getUsername() {
                <span class="keyword">return</span> username;
            }
        };
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> UserModel getUserById(RealmModel realm, <span class="predefined-type">String</span> id) {
        StorageId storageId = <span class="keyword">new</span> StorageId(id);
        <span class="predefined-type">String</span> username = storageId.getExternalId();
        <span class="keyword">return</span> getUserByUsername(realm, username);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> UserModel getUserByEmail(RealmModel realm, <span class="predefined-type">String</span> email) {
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>getUserByUsername()</code> method is invoked by the Keycloak login page when a user logs in. In our implementation we first check the <code>loadedUsers</code> map to see if the user has already been loaded within this transaction. If it hasn&#8217;t been loaded we look in the property file for the username. If it exists we create an implementation of <code>UserModel</code>, store it in <code>loadedUsers</code> for future reference, and return this instance.</p>
</div>
<div class="paragraph">
<p>The <code>createAdapter()</code> method uses the helper class <code>org.keycloak.storage.adapter.AbstractUserAdapter</code>. This provides a base implementation for <code>UserModel</code>. It automatically generates a user id based on the required storage id format using the username of the user as the external id.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>"f:" + component id + ":" + username</pre>
</div>
</div>
<div class="paragraph">
<p>Every get method of <code>AbstractUserAdapter</code> either returns null or empty collections. However, methods that return role and group mappings will return the default roles and groups configured for the realm for every user.  Every set method of <code>AbstractUserAdapter</code> will throw a <code>org.keycloak.storage.ReadOnlyException</code>. So if you attempt to modify the user in the Admin Console, you will get an error.</p>
</div>
<div class="paragraph">
<p>The <code>getUserById()</code> method parses the <code>id</code> parameter using the <code>org.keycloak.storage.StorageId</code> helper class. The <code>StorageId.getExternalId()</code> method is invoked to obtain the username embedded in the <code>id</code> parameter. The method then delegates to <code>getUserByUsername()</code>.</p>
</div>
<div class="paragraph">
<p>Emails are not stored, so the <code>getUserByEmail()</code> method returns null.</p>
</div>
</div>
<div class="sect4">
<h5 id="credentialinputvalidator-implementation"><a class="anchor" href="#credentialinputvalidator-implementation"></a>CredentialInputValidator implementation</h5>
<div class="paragraph">
<p>Next let&#8217;s look at the method implementations for <code>CredentialInputValidator</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> isConfiguredFor(RealmModel realm, UserModel user, <span class="predefined-type">String</span> credentialType) {
        <span class="predefined-type">String</span> password = properties.getProperty(user.getUsername());
        <span class="keyword">return</span> credentialType.equals(PasswordCredentialModel.TYPE) &amp;&amp; password != <span class="predefined-constant">null</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> supportsCredentialType(<span class="predefined-type">String</span> credentialType) {
        <span class="keyword">return</span> credentialType.equals(PasswordCredentialModel.TYPE);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> isValid(RealmModel realm, UserModel user, CredentialInput input) {
        <span class="keyword">if</span> (!supportsCredentialType(input.getType())) <span class="keyword">return</span> <span class="predefined-constant">false</span>;

        <span class="predefined-type">String</span> password = properties.getProperty(user.getUsername());
        <span class="keyword">if</span> (password == <span class="predefined-constant">null</span>) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        <span class="keyword">return</span> password.equals(input.getChallengeResponse());
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>isConfiguredFor()</code> method is called by the runtime to determine if a specific credential type is configured for the user. This method checks to see that the password is set for the user.</p>
</div>
<div class="paragraph">
<p>The <code>supportsCredentialType()</code> method returns whether validation is supported for a specific credential type. We check to see if the credential type is <code>password</code>.</p>
</div>
<div class="paragraph">
<p>The <code>isValid()</code> method is responsible for validating passwords. The <code>CredentialInput</code> parameter is really just an abstract interface for all credential types. We make sure that we support the credential type and also that it is an instance of <code>UserCredentialModel</code>. When a user logs in through the login page, the plain text of the password input is put into an instance of <code>UserCredentialModel</code>. The <code>isValid()</code> method checks this value against the plain text password stored in the properties file. A return value of <code>true</code> means the password is valid.</p>
</div>
</div>
<div class="sect4">
<h5 id="credentialinputupdater-implementation"><a class="anchor" href="#credentialinputupdater-implementation"></a>CredentialInputUpdater implementation</h5>
<div class="paragraph">
<p>As noted before, the only reason we implement the <code>CredentialInputUpdater</code> interface in this example is to forbid modifications of user passwords. The reason we have to do this is because otherwise the runtime would allow the password to be overridden in Keycloak local storage. We&#8217;ll talk more about this later in this chapter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> updateCredential(RealmModel realm, UserModel user, CredentialInput input) {
        <span class="keyword">if</span> (input.getType().equals(PasswordCredentialModel.TYPE)) <span class="keyword">throw</span> <span class="keyword">new</span> ReadOnlyException(<span class="string"><span class="delimiter">&quot;</span><span class="content">user is read only for this update</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> disableCredentialType(RealmModel realm, UserModel user, <span class="predefined-type">String</span> credentialType) {

    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Stream&lt;<span class="predefined-type">String</span>&gt; getDisableableCredentialTypesStream(RealmModel realm, UserModel user) {
        <span class="keyword">return</span> Stream.empty();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>updateCredential()</code> method just checks to see if the credential type is password.  If it is, a <code>ReadOnlyException</code> is thrown.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="provider-factory-implementation"><a class="anchor" href="#provider-factory-implementation"></a>Provider factory implementation</h4>
<div class="paragraph">
<p>Now that the provider class is complete, we now turn our attention to the provider factory class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PropertyFileUserStorageProviderFactory</span>
                 <span class="directive">implements</span> UserStorageProviderFactory&lt;PropertyFileUserStorageProvider&gt; {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PROVIDER_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">readonly-property-file</span><span class="delimiter">&quot;</span></span>;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> PROVIDER_NAME;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>First thing to notice is that when implementing the <code>UserStorageProviderFactory</code> class, you must pass in the concrete provider class implementation as a template parameter. Here we specify the provider class we defined before: <code>PropertyFileUserStorageProvider</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you do not specify the template parameter, your provider will not function. The runtime does class introspection
         to determine the <em>capability interfaces</em> that the provider implements.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>getId()</code> method identifies the factory in the runtime and will also be the string shown in the admin console when you want to enable a user storage provider for the realm.</p>
</div>
<div class="sect4">
<h5 id="initialization"><a class="anchor" href="#initialization"></a>Initialization</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = <span class="predefined-type">Logger</span>.getLogger(PropertyFileUserStorageProviderFactory.class);
    <span class="directive">protected</span> <span class="predefined-type">Properties</span> properties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> init(Config.Scope config) {
        <span class="predefined-type">InputStream</span> is = getClass().getClassLoader().getResourceAsStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users.properties</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">if</span> (is == <span class="predefined-constant">null</span>) {
            logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Could not find users.properties in classpath</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">else</span> {
            <span class="keyword">try</span> {
                properties.load(is);
            } <span class="keyword">catch</span> (<span class="exception">IOException</span> ex) {
                logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to load users.properties file</span><span class="delimiter">&quot;</span></span>, ex);
            }
        }
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> PropertyFileUserStorageProvider create(KeycloakSession session, ComponentModel model) {
        <span class="keyword">return</span> <span class="keyword">new</span> PropertyFileUserStorageProvider(session, model, properties);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>UserStorageProviderFactory</code> interface has an optional <code>init()</code> method you can implement. When Keycloak boots up, only one instance of each provider factory is created. Also at boot time, the <code>init()</code> method is called on each of these factory instances. There&#8217;s also a <code>postInit()</code> method you can implement as well. After each factory&#8217;s <code>init()</code> method is invoked, their <code>postInit()</code> methods are called.</p>
</div>
<div class="paragraph">
<p>In our <code>init()</code> method implementation, we find the property file containing our user declarations from the classpath. We then load the <code>properties</code> field with the username and password combinations stored there.</p>
</div>
<div class="paragraph">
<p>The <code>Config.Scope</code> parameter is factory configuration that configured through server configuration.</p>
</div>
<div class="paragraph">
<p>For example, by running the server with the following argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kc.[sh|bat] start --spi-storage--readonly-property-file--path=/other-users.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can specify the classpath of the user property file instead of hardcoding it. Then you can retrieve the configuration in the <code>PropertyFileUserStorageProviderFactory.init()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> init(Config.Scope config) {
    <span class="predefined-type">String</span> path = config.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>);
    <span class="predefined-type">InputStream</span> is = getClass().getClassLoader().getResourceAsStream(path);

    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="create-method"><a class="anchor" href="#create-method"></a>Create method</h5>
<div class="paragraph">
<p>Our last step in creating the provider factory is the <code>create()</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> PropertyFileUserStorageProvider create(KeycloakSession session, ComponentModel model) {
        <span class="keyword">return</span> <span class="keyword">new</span> PropertyFileUserStorageProvider(session, model, properties);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We simply allocate the <code>PropertyFileUserStorageProvider</code> class.  This create method will be called once per transaction.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="packaging-and-deployment-2"><a class="anchor" href="#packaging-and-deployment-2"></a>Packaging and deployment</h4>
<div class="paragraph">
<p>The class files for our provider implementation should be placed in a jar.  You also have to declare the provider factory class within the <code>META-INF/services/org.keycloak.storage.UserStorageProviderFactory</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>org.keycloak.examples.federation.properties.FilePropertiesStorageFactory</pre>
</div>
</div>
<div class="paragraph">
<p>To deploy this jar, copy it to the <code>providers/</code> directory, then run <code>bin/kc.[sh|bat] build</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="enabling-the-provider-in-the-admin-console"><a class="anchor" href="#enabling-the-provider-in-the-admin-console"></a>Enabling the provider in the Admin Console</h4>
<div class="paragraph">
<p>You enable user storage providers per realm within the <strong>User Federation</strong> page in the Admin Console.</p>
</div>
<div class="paragraph">
<div class="title">User Federation</div>
<p><span class="image"><img src="./images/empty-user-federation-page.png" alt="empty user federation page"></span></p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Select the provider we just created from the list: <code>readonly-property-file</code>.</p>
<div class="paragraph">
<p>The configuration page for our provider displays.</p>
</div>
</li>
<li>
<p>Click <strong>Save</strong> because we have nothing to configure.</p>
<div class="paragraph">
<div class="title">Configured Provider</div>
<p><span class="image"><img src="./images/storage-provider-created.png" alt="storage provider created"></span></p>
</div>
</li>
<li>
<p>Return to the main <strong>User Federation</strong> page</p>
<div class="paragraph">
<p>You now see your provider listed.</p>
</div>
<div class="paragraph">
<div class="title">User Federation</div>
<p><span class="image"><img src="./images/user-federation-page.png" alt="user federation page"></span></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You will now be able to log in with a user declared in the <code>users.properties</code> file. This user will only be able to view the account page after logging in.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-techniques"><a class="anchor" href="#configuration-techniques"></a>Configuration techniques</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/configuration.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/configuration.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/configuration.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Our <code>PropertyFileUserStorageProvider</code> example is a bit contrived. It is hardcoded to a property file that is embedded in the jar of the provider, which is not terribly useful. We might want to make the location of this file configurable per instance of the provider. In other words, we might want to reuse this provider multiple times in multiple different realms and point to completely different user property files. We&#8217;ll also want to perform this configuration within the Admin Console UI.</p>
</div>
<div class="paragraph">
<p>The <code>UserStorageProviderFactory</code> has additional methods you can implement that handle provider configuration. You describe the variables you want to configure per provider and the Admin Console automatically renders a generic input page to gather this configuration. When implemented, callback methods also validate the configuration before it is saved, when a provider is created for the first time, and when it is updated. <code>UserStorageProviderFactory</code> inherits these methods from the <code>org.keycloak.component.ComponentFactory</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="predefined-type">List</span>&lt;ProviderConfigProperty&gt; getConfigProperties();

    <span class="keyword">default</span>
    <span class="type">void</span> validateConfiguration(KeycloakSession session, RealmModel realm, ComponentModel model)
            <span class="directive">throws</span> ComponentValidationException
    {

    }

    <span class="keyword">default</span>
    <span class="type">void</span> onCreate(KeycloakSession session, RealmModel realm, ComponentModel model) {

    }

    <span class="keyword">default</span>
    <span class="type">void</span> onUpdate(KeycloakSession session, RealmModel realm, ComponentModel model) {

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ComponentFactory.getConfigProperties()</code> method returns a list of <code>org.keycloak.provider.ProviderConfigProperty</code> instances. These instances declare metadata that is needed to render and store each configuration variable of the provider.</p>
</div>
<div class="sect3">
<h4 id="configuration-example"><a class="anchor" href="#configuration-example"></a>Configuration example</h4>
<div class="paragraph">
<p>Let&#8217;s expand our <code>PropertyFileUserStorageProviderFactory</code> example to allow you to point a provider instance to a specific file on disk.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProviderFactory</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PropertyFileUserStorageProviderFactory</span>
                  <span class="directive">implements</span> UserStorageProviderFactory&lt;PropertyFileUserStorageProvider&gt; {

    <span class="directive">protected</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;ProviderConfigProperty&gt; configMetadata;

    <span class="directive">static</span> {
        configMetadata = ProviderConfigurationBuilder.create()
                .property().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>)
                .type(ProviderConfigProperty.STRING_TYPE)
                .label(<span class="string"><span class="delimiter">&quot;</span><span class="content">Path</span><span class="delimiter">&quot;</span></span>)
                .defaultValue(<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.server.config.dir}/example-users.properties</span><span class="delimiter">&quot;</span></span>)
                .helpText(<span class="string"><span class="delimiter">&quot;</span><span class="content">File path to properties file</span><span class="delimiter">&quot;</span></span>)
                .add().build();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;ProviderConfigProperty&gt; getConfigProperties() {
        <span class="keyword">return</span> configMetadata;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ProviderConfigurationBuilder</code> class is a great helper class to create a list of configuration properties. Here we specify a variable named <code>path</code> that is a String type. On the Admin Console configuration page for this provider, this configuration variable is labeled as <code>Path</code> and has a default value of <code>${jboss.server.config.dir}/example-users.properties</code>. When you hover over the tooltip of this configuration option, it displays the help text, <code>File path to properties file</code>.</p>
</div>
<div class="paragraph">
<p>The next thing we want to do is to verify that this file exists on disk. We do not want to enable an instance of this provider in the realm unless it points to a valid user property file. To do this, we implement the <code>validateConfiguration()</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> validateConfiguration(KeycloakSession session, RealmModel realm, ComponentModel config)
                   <span class="directive">throws</span> ComponentValidationException {
        <span class="predefined-type">String</span> fp = config.getConfig().getFirst(<span class="string"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (fp == <span class="predefined-constant">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ComponentValidationException(<span class="string"><span class="delimiter">&quot;</span><span class="content">user property file does not exist</span><span class="delimiter">&quot;</span></span>);
        fp = EnvUtil.replace(fp);
        <span class="predefined-type">File</span> file = <span class="keyword">new</span> <span class="predefined-type">File</span>(fp);
        <span class="keyword">if</span> (!file.exists()) {
            <span class="keyword">throw</span> <span class="keyword">new</span> ComponentValidationException(<span class="string"><span class="delimiter">&quot;</span><span class="content">user property file does not exist</span><span class="delimiter">&quot;</span></span>);
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>validateConfiguration()</code> method provides the configuration variable from the <code>ComponentModel</code> to verify if that file exists on disk.
Notice that the use of the <code>org.keycloak.common.util.EnvUtil.replace()</code> method. With this method any string that includes <code>${}</code> will replace that value with a system property value.
The <code>${jboss.server.config.dir}</code> string corresponds to the <code>conf/</code> directory of our server and is really useful for this example.</p>
</div>
<div class="paragraph">
<p>Next thing we have to do is remove the old <code>init()</code> method. We do this because user property files are going to be unique per provider instance. We move this logic to the <code>create()</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> PropertyFileUserStorageProvider create(KeycloakSession session, ComponentModel model) {
        <span class="predefined-type">String</span> path = model.getConfig().getFirst(<span class="string"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>);

        <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
        <span class="keyword">try</span> {
            <span class="predefined-type">InputStream</span> is = <span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(path);
            props.load(is);
            is.close();
        } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(e);
        }

        <span class="keyword">return</span> <span class="keyword">new</span> PropertyFileUserStorageProvider(session, model, props);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This logic is, of course, inefficient as every transaction reads the entire user property file from disk, but hopefully this illustrates, in a simple way, how to hook in configuration variables.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-the-provider-in-the-admin-console"><a class="anchor" href="#configuring-the-provider-in-the-admin-console"></a>Configuring the provider in the Admin Console</h4>
<div class="paragraph">
<p>Now that the configuration is enabled, you can set the <code>path</code> variable when you configure the provider in the Admin Console.</p>
</div>
<div class="paragraph">
<div class="title">Configured Provider</div>
<p><span class="image"><img src="./images/readonly-user-storage-provider-with-config.png" alt="readonly user storage provider with config"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="addremove-user-and-query-capability-interfaces"><a class="anchor" href="#addremove-user-and-query-capability-interfaces"></a>Add/Remove user and query capability interfaces</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/registration-query.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/registration-query.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/registration-query.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>One thing we have not done with our example is allow it to add and remove users or change passwords. Users defined in our example are
also not queryable or viewable in the Admin Console. To add these enhancements, our example provider must implement
the <code>UserQueryMethodsProvider</code> (or <code>UserQueryProvider</code>) and <code>UserRegistrationProvider</code> interfaces.</p>
</div>
<div class="sect3">
<h4 id="implementing-userregistrationprovider"><a class="anchor" href="#implementing-userregistrationprovider"></a>Implementing UserRegistrationProvider</h4>
<div class="paragraph">
<p>Use this procedure to implement adding and removing users from the particular store, we first have to be able to save our properties
file to disk.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">public</span> <span class="type">void</span> save() {
        <span class="predefined-type">String</span> path = model.getConfig().getFirst(<span class="string"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>);
        path = EnvUtil.replace(path);
        <span class="keyword">try</span> {
            <span class="predefined-type">FileOutputStream</span> fos = <span class="keyword">new</span> <span class="predefined-type">FileOutputStream</span>(path);
            properties.store(fos, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>);
            fos.close();
        } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(e);
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, the implementation of the <code>addUser()</code> and <code>removeUser()</code> methods becomes simple.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> UNSET_PASSWORD=<span class="string"><span class="delimiter">&quot;</span><span class="content">#$!-UNSET-PASSWORD</span><span class="delimiter">&quot;</span></span>;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> UserModel addUser(RealmModel realm, <span class="predefined-type">String</span> username) {
        <span class="directive">synchronized</span> (properties) {
            properties.setProperty(username, UNSET_PASSWORD);
            save();
        }
        <span class="keyword">return</span> createAdapter(realm, username);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> removeUser(RealmModel realm, UserModel user) {
        <span class="directive">synchronized</span> (properties) {
            <span class="keyword">if</span> (properties.remove(user.getUsername()) == <span class="predefined-constant">null</span>) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
            save();
            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that when adding a user we set the password value of the property map to be <code>UNSET_PASSWORD</code>.  We do this as
we can&#8217;t have null values for a property in the property value. We also have to modify the <code>CredentialInputValidator</code>
methods to reflect this.</p>
</div>
<div class="paragraph">
<p>The <code>addUser()</code> method will be called if the provider implements the <code>UserRegistrationProvider</code> interface. If your provider has
a configuration switch to turn off adding a user, returning <code>null</code> from this method will skip the provider and call
the next one.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> isValid(RealmModel realm, UserModel user, CredentialInput input) {
        <span class="keyword">if</span> (!supportsCredentialType(input.getType()) || !(input <span class="keyword">instanceof</span> UserCredentialModel)) <span class="keyword">return</span> <span class="predefined-constant">false</span>;

        UserCredentialModel cred = (UserCredentialModel)input;
        <span class="predefined-type">String</span> password = properties.getProperty(user.getUsername());
        <span class="keyword">if</span> (password == <span class="predefined-constant">null</span> || UNSET_PASSWORD.equals(password)) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        <span class="keyword">return</span> password.equals(cred.getValue());
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we can now save our property file, it also makes sense to allow password updates.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> updateCredential(RealmModel realm, UserModel user, CredentialInput input) {
        <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> UserCredentialModel)) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        <span class="keyword">if</span> (!input.getType().equals(PasswordCredentialModel.TYPE)) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        UserCredentialModel cred = (UserCredentialModel)input;
        <span class="directive">synchronized</span> (properties) {
            properties.setProperty(user.getUsername(), cred.getValue());
            save();
        }
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now also implement disabling a password.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> disableCredentialType(RealmModel realm, UserModel user, <span class="predefined-type">String</span> credentialType) {
        <span class="keyword">if</span> (!credentialType.equals(PasswordCredentialModel.TYPE)) <span class="keyword">return</span>;
        <span class="directive">synchronized</span> (properties) {
            properties.setProperty(user.getUsername(), UNSET_PASSWORD);
            save();
        }

    }

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; disableableTypes = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;();

    <span class="directive">static</span> {
        disableableTypes.add(PasswordCredentialModel.TYPE);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Stream&lt;<span class="predefined-type">String</span>&gt; getDisableableCredentialTypes(RealmModel realm, UserModel user) {

        <span class="keyword">return</span> disableableTypes.stream();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>With these methods implemented, you&#8217;ll now be able to change and disable the password for the user in the Admin Console.</p>
</div>
</div>
<div class="sect3">
<h4 id="implementing-userqueryprovider"><a class="anchor" href="#implementing-userqueryprovider"></a>Implementing UserQueryProvider</h4>
<div class="paragraph">
<p><code>UserQueryProvider</code> is combination of <code>UserQueryMethodsProvider</code> and <code>UserCountMethodsProvider</code>. Without implementing <code>UserQueryMethodsProvider</code> the Admin Console would not be able to view and manage users that were loaded
by our example provider. Let&#8217;s look at implementing this interface.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> getUsersCount(RealmModel realm) {
        <span class="keyword">return</span> properties.size();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Stream&lt;UserModel&gt; searchForUserStream(RealmModel realm, <span class="predefined-type">String</span> search, <span class="predefined-type">Integer</span> firstResult, <span class="predefined-type">Integer</span> maxResults) {
        <span class="predefined-type">Predicate</span>&lt;<span class="predefined-type">String</span>&gt; predicate = <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>.equals(search) ? username -&gt; <span class="predefined-constant">true</span> : username -&gt; username.contains(search);
        <span class="keyword">return</span> properties.keySet().stream()
                .map(<span class="predefined-type">String</span>.class::cast)
                .filter(predicate)
                .skip(firstResult)
                .map(username -&gt; getUserByUsername(realm, username))
                .limit(maxResults);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first declaration of <code>searchForUserStream()</code> takes a <code>String</code> parameter. In this example, the parameter represents a username that you want to search by. This string can be a substring, which explains the choice of  the <code>String.contains()</code>
method when doing the search. Notice the use of <code>*</code> to indicate to request a list of all users.
The method iterates over the key set of the property file, delegating to <code>getUserByUsername()</code> to load a user.
Notice that we are indexing this call based on the <code>firstResult</code> and <code>maxResults</code> parameter. If your external store does not support pagination, you will have to do similar logic.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> Stream&lt;UserModel&gt; searchForUserStream(RealmModel realm, <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; params, <span class="predefined-type">Integer</span> firstResult, <span class="predefined-type">Integer</span> maxResults) {
        <span class="comment">// only support searching by username</span>
        <span class="predefined-type">String</span> usernameSearchString = params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (usernameSearchString != <span class="predefined-constant">null</span>)
            <span class="keyword">return</span> searchForUserStream(realm, usernameSearchString, firstResult, maxResults);

        <span class="comment">// if we are not searching by username, return all users</span>
        <span class="keyword">return</span> searchForUserStream(realm, <span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span>, firstResult, maxResults);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>searchForUserStream()</code> method that takes a <code>Map</code> parameter can search for a user based on first, last name, username, and email.
Only usernames are stored, so the search is based only on usernames except when the <code>Map</code> parameter does not contain the <code>username</code> attribute.
In this case, all users are returned. In that situation, the <code>searchForUserStream(realm, search, firstResult, maxResults)</code> is used.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Override</span>
    <span class="directive">public</span> Stream&lt;UserModel&gt; getGroupMembersStream(RealmModel realm, GroupModel group, <span class="predefined-type">Integer</span> firstResult, <span class="predefined-type">Integer</span> maxResults) {
        <span class="keyword">return</span> Stream.empty();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Stream&lt;UserModel&gt; searchForUserByUserAttributeStream(RealmModel realm, <span class="predefined-type">String</span> attrName, <span class="predefined-type">String</span> attrValue) {
        <span class="keyword">return</span> Stream.empty();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Groups or attributes are not stored, so the other methods return an empty stream.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="augmenting-external-storage"><a class="anchor" href="#augmenting-external-storage"></a>Augmenting external storage</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/augmenting.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/augmenting.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/augmenting.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The <code>PropertyFileUserStorageProvider</code> example is really limited.  While we will be able to log in with users stored
in a property file, we won&#8217;t be able to do much else.  If users loaded by this provider need special role or group
mappings to fully access particular applications there is no way for us to add additional role mappings to these users.
You also can&#8217;t modify or add additional important attributes like email, first and last name.</p>
</div>
<div class="paragraph">
<p>For these types of situations, Keycloak allows you to augment your external store by storing extra information
in Keycloak&#8217;s database.  This is called federated user storage and is encapsulated within the
<code>org.keycloak.storage.federated.UserFederatedStorageProvider</code> class.</p>
</div>
<div class="listingblock">
<div class="title">UserFederatedStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.keycloak.storage.federated</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserFederatedStorageProvider</span> <span class="directive">extends</span> <span class="predefined-type">Provider</span>,
        UserAttributeFederatedStorage,
        UserBrokerLinkFederatedStorage,
        UserConsentFederatedStorage,
        UserNotBeforeFederatedStorage,
        UserGroupMembershipFederatedStorage,
        UserRequiredActionsFederatedStorage,
        UserRoleMappingsFederatedStorage,
        UserFederatedUserCredentialStore {
    ...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>UserFederatedStorageProvider</code> instance is available on the <code>UserStorageUtil.userFederatedStorage(KeycloakSession)</code> method.
It has all different kinds of methods for storing attributes, group and role mappings, different credential types,
and required actions.  If your external store&#8217;s datamodel  cannot support the full Keycloak feature
set, then this service can fill in the gaps.</p>
</div>
<div class="paragraph">
<p>Keycloak comes with a helper class <code>org.keycloak.storage.adapter.AbstractUserAdapterFederatedStorage</code>
that will delegate every single <code>UserModel</code> method except get/set of username to user federated storage.  Override
the methods you need to override to delegate to your external storage representations.  It is strongly
suggested you read the javadoc of this class as it has smaller protected methods you may want to override.  Specifically
surrounding group membership and role mappings.</p>
</div>
<div class="sect3">
<h4 id="augmentation-example"><a class="anchor" href="#augmentation-example"></a>Augmentation example</h4>
<div class="paragraph">
<p>In our <code>PropertyFileUserStorageProvider</code> example, we just need a simple change to our provider to use the
<code>AbstractUserAdapterFederatedStorage</code>.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">protected</span> UserModel createAdapter(RealmModel realm, <span class="predefined-type">String</span> username) {
        <span class="keyword">return</span> <span class="keyword">new</span> AbstractUserAdapterFederatedStorage(session, realm, model) {
            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="predefined-type">String</span> getUsername() {
                <span class="keyword">return</span> username;
            }

            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> setUsername(<span class="predefined-type">String</span> username) {
                <span class="predefined-type">String</span> pw = (<span class="predefined-type">String</span>)properties.remove(username);
                <span class="keyword">if</span> (pw != <span class="predefined-constant">null</span>) {
                    properties.put(username, pw);
                    save();
                }
            }
        };
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We instead define an anonymous class implementation of  <code>AbstractUserAdapterFederatedStorage</code>.  The <code>setUsername()</code>
method makes changes to the properties file and saves it.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="import-implementation-strategy"><a class="anchor" href="#import-implementation-strategy"></a>Import implementation strategy</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/import.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/import.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/import.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When implementing a user storage provider, there&#8217;s another strategy you can take. Instead of using user federated storage,
you can create a user locally in the Keycloak built-in user database and copy attributes from your external
store into this local copy. There are many advantages to this approach.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keycloak basically becomes a persistence user cache for your external store. Once the user is imported
you&#8217;ll no longer hit the external store thus taking load off of it.</p>
</li>
<li>
<p>If you are moving to Keycloak as your official user store and deprecating the old external store, you
can slowly migrate applications to use Keycloak. When all applications have been migrated, unlink the
imported user, and retire the old legacy external store.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are some obvious disadvantages though to using an import strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Looking up a user for the first time will require multiple updates to Keycloak database. This can
be a big performance loss under load and put a lot of strain on the Keycloak database. The user federated
storage approach will only store extra data as needed and may never be used depending on the capabilities of your external store.</p>
</li>
<li>
<p>With the import approach, you have to keep local Keycloak storage and external storage in sync. The User Storage SPI
has capability interfaces that you can implement to support synchronization, but this can quickly become painful and messy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To implement the import strategy you simply check to see first if the user has been imported locally. If so return the
local user, if not create the user locally and import data from the external store. You can also proxy the local user
so that most changes are automatically synchronized.</p>
</div>
<div class="paragraph">
<p>This will be a bit contrived, but we can extend our <code>PropertyFileUserStorageProvider</code> to take this approach. We
begin first by modifying the <code>createAdapter()</code> method.</p>
</div>
<div class="listingblock">
<div class="title">PropertyFileUserStorageProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">protected</span> UserModel createAdapter(RealmModel realm, <span class="predefined-type">String</span> username) {
        UserModel local = UserStoragePrivateUtil.userLocalStorage(session).getUserByUsername(realm, username);
        <span class="keyword">if</span> (local == <span class="predefined-constant">null</span>) {
            local = UserStoragePrivateUtil.userLocalStorage(session).addUser(realm, username);
            local.setFederationLink(model.getId());
        }
        <span class="keyword">return</span> <span class="keyword">new</span> UserModelDelegate(local) {
            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="type">void</span> setUsername(<span class="predefined-type">String</span> username) {
                <span class="predefined-type">String</span> pw = (<span class="predefined-type">String</span>)properties.remove(username);
                <span class="keyword">if</span> (pw != <span class="predefined-constant">null</span>) {
                    properties.put(username, pw);
                    save();
                }
                <span class="local-variable">super</span>.setUsername(username);
            }
        };
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this method we call the <code>UserStoragePrivateUtil.userLocalStorage(session)</code> method to obtain a reference to local Keycloak
user storage. We see if the user is stored locally, if not, we add it locally. Do not set the <code>id</code> of the local user.
Let Keycloak automatically generate the <code>id</code>.  Also note that we call
<code>UserModel.setFederationLink()</code> and pass in the ID of the <code>ComponentModel</code> of our provider. This sets a link between
the provider and the imported user.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When a user storage provider is removed, any user imported by it will also be removed.  This is one of the
      purposes of calling <code>UserModel.setFederationLink()</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Another thing to note is that if a local user is linked, your storage provider will still be delegated to for methods
that it implements from the <code>CredentialInputValidator</code> and <code>CredentialInputUpdater</code> interfaces. Returning <code>false</code>
from a validation or update will just result in Keycloak seeing if it can validate or update using
local storage.</p>
</div>
<div class="paragraph">
<p>Also notice that we are proxying the local user using the <code>org.keycloak.models.utils.UserModelDelegate</code> class.
This class is an implementation of <code>UserModel</code>. Every method just delegates to the <code>UserModel</code> it was instantiated with.
We override the <code>setUsername()</code> method of this delegate class to synchronize automatically with the property file.
For your providers, you can use this to <em>intercept</em> other methods on the local <code>UserModel</code> to perform synchronization
with your external store.  For example, get methods could make sure that the local store is in sync. Set methods
keep the external store in sync with the local one.  One thing to note is that the <code>getId()</code> method should always return
 the id that was auto generated when you created the user locally.  You should not return a federated id as shown in
the other non-import examples.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your provider is implementing the <code>UserRegistrationProvider</code> interface, your <code>removeUser()</code> method does not
      need to remove the user from local storage.  The runtime will automatically perform this operation.  Also
      note that <code>removeUser()</code> will be invoked before it is removed from local storage.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="importeduservalidation-interface"><a class="anchor" href="#importeduservalidation-interface"></a>ImportedUserValidation interface</h4>
<div class="paragraph">
<p>If you remember earlier in this chapter, we discussed how querying for a user worked.  Local storage is queried first,
if the user is found there, then the query ends.  This is a problem for our above implementation as we want
to proxy the local <code>UserModel</code> so that we can keep usernames in sync.  The User Storage SPI has a callback for whenever
a linked local user is loaded from the local database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.keycloak.storage.user</span>;
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ImportedUserValidation</span> {
    <span class="comment">/**
     * If this method returns null, then the user in local storage will be removed
     *
     * @param realm
     * @param user
     * @return null if user no longer valid
     */</span>
    UserModel validate(RealmModel realm, UserModel user);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whenever a linked local user is loaded, if the user storage provider class implements this interface, then the
<code>validate()</code> method is called. Here you can proxy the local user passed in as a parameter and return it. That
new <code>UserModel</code> will be used. You can also optionally do a check to see if the user still exists in the external store.
If <code>validate()</code> returns <code>null</code>, then the local user will be removed from the database.</p>
</div>
</div>
<div class="sect3">
<h4 id="importsynchronization-interface"><a class="anchor" href="#importsynchronization-interface"></a>ImportSynchronization interface</h4>
<div class="paragraph">
<p>With the import strategy you can see that it is possible for the local user copy to get out of sync with
external storage. For example, maybe a user has been removed from the external store. The User Storage SPI has
an additional interface you can implement to deal with this, <code>org.keycloak.storage.user.ImportSynchronization</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.keycloak.storage.user</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">ImportSynchronization</span> {
    SynchronizationResult sync(KeycloakSessionFactory sessionFactory, <span class="predefined-type">String</span> realmId, UserStorageProviderModel model);
    SynchronizationResult syncSince(<span class="predefined-type">Date</span> lastSync, KeycloakSessionFactory sessionFactory, <span class="predefined-type">String</span> realmId, UserStorageProviderModel model);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This interface is implemented by the provider factory. Once this interface is implemented by the provider factory, the administration console management page for the provider shows additional options. You can manually force a synchronization by clicking a button. This invokes the <code>ImportSynchronization.sync()</code> method. Also, additional configuration options are displayed that allow you to automatically schedule a synchronization. Automatic synchronizations invoke the <code>syncSince()</code> method.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="user-caches"><a class="anchor" href="#user-caches"></a>User caches</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/cache.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/cache.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/cache.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When a user object is loaded by ID, username, or email queries it is cached. When a user object is being cached, it iterates through
the entire <code>UserModel</code> interface and pulls this information to a local in-memory-only cache. In a cluster, this cache
is still local, but it becomes an invalidation cache. When a user object is modified, it is evicted. This eviction event
is propagated to the entire cluster so that the other nodes' user cache is also invalidated.</p>
</div>
<div class="sect3">
<h4 id="managing-the-user-cache"><a class="anchor" href="#managing-the-user-cache"></a>Managing the user cache</h4>
<div class="paragraph">
<p>You can access the user cache by calling <code>KeycloakSession.getProvider(UserCache.class)</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * All these methods effect an entire cluster of Keycloak instances.
 *
 * @author &lt;a href=&quot;mailto:bill@burkecentral.com&quot;&gt;Bill Burke&lt;/a&gt;
 * @version $Revision: 1 $
 */</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserCache</span> <span class="directive">extends</span> UserProvider {
    <span class="comment">/**
     * Evict user from cache.
     *
     * @param user
     */</span>
    <span class="type">void</span> evict(RealmModel realm, UserModel user);

    <span class="comment">/**
     * Evict users of a specific realm
     *
     * @param realm
     */</span>
    <span class="type">void</span> evict(RealmModel realm);

    <span class="comment">/**
     * Clear cache entirely.
     *
     */</span>
    <span class="type">void</span> clear();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are methods for evicting specific users, users contained in a specific realm, or the entire cache.</p>
</div>
</div>
<div class="sect3">
<h4 id="onusercache-callback-interface"><a class="anchor" href="#onusercache-callback-interface"></a>OnUserCache callback interface</h4>
<div class="paragraph">
<p>You might want to cache additional information that is specific to your provider implementation. The User Storage SPI
has a callback whenever a user is cached: <code>org.keycloak.models.cache.OnUserCache</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">OnUserCache</span> {
    <span class="type">void</span> onCache(RealmModel realm, CachedUserModel user, UserModel delegate);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your provider class should implement this interface if it wants this callback. The <code>UserModel</code> delegate parameter
is the <code>UserModel</code> instance returned by your provider. The <code>CachedUserModel</code> is an expanded <code>UserModel</code> interface.
This is the instance that is cached locally in local storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CachedUserModel</span> <span class="directive">extends</span> UserModel {

    <span class="comment">/**
     * Invalidates the cache for this user and returns a delegate that represents the actual data provider
     *
     * @return
     */</span>
    UserModel getDelegateForUpdate();

    <span class="type">boolean</span> isMarkedForEviction();

    <span class="comment">/**
     * Invalidate the cache for this model
     *
     */</span>
    <span class="type">void</span> invalidate();

    <span class="comment">/**
     * When was the model was loaded from database.
     *
     * @return
     */</span>
    <span class="type">long</span> getCacheTimestamp();

    <span class="comment">/**
     * Returns a map that contains custom things that are cached along with this model.  You can write to this map.
     *
     * @return
     */</span>
    <span class="predefined-type">ConcurrentHashMap</span> getCachedWith();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>CachedUserModel</code> interface allows you to evict the user from the cache and get the provider <code>UserModel</code> instance.
The <code>getCachedWith()</code> method returns a map that allows you to cache additional information pertaining to the user. For example, credentials are not part of the <code>UserModel</code> interface. If you wanted to cache credentials in memory, you would implement <code>OnUserCache</code> and cache your user&#8217;s credentials using the <code>getCachedWith()</code> method.</p>
</div>
</div>
<div class="sect3">
<h4 id="cache-policies"><a class="anchor" href="#cache-policies"></a>Cache policies</h4>
<div class="paragraph">
<p>On the administration console management page for your user storage provider, you can specify a unique cache policy.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="leveraging-jakarta-ee"><a class="anchor" href="#leveraging-jakarta-ee"></a>Leveraging Jakarta EE</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/javaee.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/javaee.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/javaee.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Since version 20, Keycloak relies only on Quarkus. Unlike WildFly, Quarkus is not an Application Server.
For more detail, see <a href="https://www.keycloak.org/migration/migrating-to-quarkus#_quarkus_is_not_an_application_server" class="bare">https://www.keycloak.org/migration/migrating-to-quarkus#_quarkus_is_not_an_application_server</a>.</p>
</div>
<div class="paragraph">
<p>Therefore, the User Storage Providers cannot be packaged within any Jakarta EE component or make it an EJB as was the case when Keycloak ran over WildFly in previous versions.</p>
</div>
<div class="paragraph">
<p>Providers implementations are required to be plain java objects which implement the suitable User Storage SPI interfaces, as was explained in the previous sections. They must be packaged and deployed as stated in the Migration Guide.
See <a href="https://www.keycloak.org/migration/migrating-to-quarkus#_migrating_custom_providers">Migrating custom providers</a>.</p>
</div>
<div class="paragraph">
<p>You can still implement your custom <code>UserStorageProvider</code> class, which is able to integrate an external database by JPA Entity Manager, as shown in this example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/keycloak/keycloak-quickstarts/tree/main/extension/user-storage-jpa" class="bare">https://github.com/keycloak/keycloak-quickstarts/tree/main/extension/user-storage-jpa</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>CDI is not supported.</p>
</div>
</div>
<div class="sect2">
<h3 id="rest-management-api"><a class="anchor" href="#rest-management-api"></a>REST management API</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/rest.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/rest.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/rest.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can create, remove, and update your user storage provider deployments through the administrator REST API. The User Storage SPI
is built on top of a generic component interface so you will be using that generic API to manage your providers.</p>
</div>
<div class="paragraph">
<p>The REST Component API lives under your realm admin resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/admin/realms/{realm-name}/components</pre>
</div>
</div>
<div class="paragraph">
<p>We will only show this REST API interaction with the Java client. Hopefully you can extract how to do this from <code>curl</code> from this API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ComponentsResource</span> {
    <span class="annotation">@GET</span>
    <span class="annotation">@Produces</span>(MediaType.APPLICATION_JSON)
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;ComponentRepresentation&gt; query();

    <span class="annotation">@GET</span>
    <span class="annotation">@Produces</span>(MediaType.APPLICATION_JSON)
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;ComponentRepresentation&gt; query(<span class="annotation">@QueryParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">parent</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> parent);

    <span class="annotation">@GET</span>
    <span class="annotation">@Produces</span>(MediaType.APPLICATION_JSON)
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;ComponentRepresentation&gt; query(<span class="annotation">@QueryParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">parent</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> parent, <span class="annotation">@QueryParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> type);

    <span class="annotation">@GET</span>
    <span class="annotation">@Produces</span>(MediaType.APPLICATION_JSON)
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;ComponentRepresentation&gt; query(<span class="annotation">@QueryParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">parent</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> parent,
                                               <span class="annotation">@QueryParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> type,
                                               <span class="annotation">@QueryParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name);

    <span class="annotation">@POST</span>
    <span class="annotation">@Consumes</span>(MediaType.APPLICATION_JSON)
    Response add(ComponentRepresentation rep);

    <span class="annotation">@Path</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">{id}</span><span class="delimiter">&quot;</span></span>)
    ComponentResource component(<span class="annotation">@PathParam</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id);
}

<span class="directive">public</span> <span class="type">interface</span> <span class="class">ComponentResource</span> {
    <span class="annotation">@GET</span>
    <span class="directive">public</span> ComponentRepresentation toRepresentation();

    <span class="annotation">@PUT</span>
    <span class="annotation">@Consumes</span>(MediaType.APPLICATION_JSON)
    <span class="directive">public</span> <span class="type">void</span> update(ComponentRepresentation rep);

    <span class="annotation">@DELETE</span>
    <span class="directive">public</span> <span class="type">void</span> remove();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a user storage provider, you must specify the provider id, a provider type of the string <code>org.keycloak.storage.UserStorageProvider</code>,
as well as the configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.keycloak.admin.client.Keycloak</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.representations.idm.RealmRepresentation</span>;
...

Keycloak keycloak = Keycloak.getInstance(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">master</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">admin-cli</span><span class="delimiter">&quot;</span></span>);
RealmResource realmResource = keycloak.realm(<span class="string"><span class="delimiter">&quot;</span><span class="content">master</span><span class="delimiter">&quot;</span></span>);
RealmRepresentation realm = realmResource.toRepresentation();

ComponentRepresentation component = <span class="keyword">new</span> ComponentRepresentation();
component.setName(<span class="string"><span class="delimiter">&quot;</span><span class="content">home</span><span class="delimiter">&quot;</span></span>);
component.setProviderId(<span class="string"><span class="delimiter">&quot;</span><span class="content">readonly-property-file</span><span class="delimiter">&quot;</span></span>);
component.setProviderType(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.storage.UserStorageProvider</span><span class="delimiter">&quot;</span></span>);
component.setParentId(realm.getId());
component.setConfig(<span class="keyword">new</span> MultivaluedHashMap());
component.getConfig().putSingle(<span class="string"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">~/users.properties</span><span class="delimiter">&quot;</span></span>);

realmResource.components().add(component);

<span class="comment">// retrieve a component</span>

<span class="predefined-type">List</span>&lt;ComponentRepresentation&gt; components = realmResource.components().query(realm.getId(),
                                                                    <span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.storage.UserStorageProvider</span><span class="delimiter">&quot;</span></span>,
                                                                    <span class="string"><span class="delimiter">&quot;</span><span class="content">home</span><span class="delimiter">&quot;</span></span>);
component = components.get(<span class="integer">0</span>);

<span class="comment">// Update a component</span>

component.getConfig().putSingle(<span class="string"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">~/my-users.properties</span><span class="delimiter">&quot;</span></span>);
realmResource.components().component(component.getId()).update(component);

<span class="comment">// Remove a component</span>

realmREsource.components().component(component.getId()).remove();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="migrating-from-an-earlier-user-federation-spi"><a class="anchor" href="#migrating-from-an-earlier-user-federation-spi"></a>Migrating from an earlier user federation SPI</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/migration.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/migration.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/migration.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This chapter is only applicable if you have implemented a provider using the earlier (and now removed)
       User Federation SPI.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Keycloak version 2.4.0 and earlier there was a User Federation SPI. Red Hat Single Sign-On version 7.0, although unsupported, had
this earlier SPI available as well. This earlier User Federation SPI has been removed from Keycloak version 2.5.0 and Red Hat Single Sign-On version 7.1.
However, if you have written a provider with this earlier SPI, this chapter discusses some strategies you can use to port it.</p>
</div>
<div class="sect3">
<h4 id="import-versus-non-import"><a class="anchor" href="#import-versus-non-import"></a>Import versus non-import</h4>
<div class="paragraph">
<p>The earlier User Federation SPI required you to create a local copy of a user in the Keycloak&#8217;s database
and import information from your external store to the local copy. However, this is no longer a requirement. You can still
port your earlier provider as-is, but you should consider whether a non-import strategy might be a better approach.</p>
</div>
<div class="paragraph">
<p>Advantages of the import strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keycloak basically becomes a persistence user cache for your external store. Once the user is imported
you&#8217;ll no longer hit the external store, thus taking load off of it.</p>
</li>
<li>
<p>If you are moving to Keycloak as your official user store and deprecating the earlier external store, you
can slowly migrate applications to use Keycloak. When all applications have been migrated, unlink the
imported user, and retire the earlier legacy external store.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are some obvious disadvantages though to using an import strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Looking up a user for the first time will require multiple updates to Keycloak database. This can
be a big performance loss under load and put a lot of strain on the Keycloak database. The user federated
storage approach will only store extra data as needed and might never be used depending on the capabilities of your external store.</p>
</li>
<li>
<p>With the import approach, you have to keep local Keycloak storage and external storage in sync. The User Storage SPI
has capability interfaces that you can implement to support synchronization, but this can quickly become painful and messy.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="userfederationprovider-versus-userstorageprovider"><a class="anchor" href="#userfederationprovider-versus-userstorageprovider"></a>UserFederationProvider versus UserStorageProvider</h4>
<div class="paragraph">
<p>The first thing to notice is that <code>UserFederationProvider</code> was a complete interface. You implemented every method in this interface. However, <code>UserStorageProvider</code> has instead broken up this interface into multiple capability interfaces that you implement as needed.</p>
</div>
<div class="paragraph">
<p><code>UserFederationProvider.getUserByUsername()</code> and <code>getUserByEmail()</code> have exact equivalents in the new SPI. The difference between the two is how you import. If you are going to continue with an import strategy, you no longer call <code>KeycloakSession.userStorage().addUser()</code> to create the user locally. Instead you call <code>KeycloakSession.userLocalStorage().addUser()</code>.
The <code>userStorage()</code> method no longer exists.</p>
</div>
<div class="paragraph">
<p>The <code>UserFederationProvider.validateAndProxy()</code> method has been moved to an optional capability interface, <code>ImportedUserValidation</code>.
You want to implement this interface if you are porting your earlier provider as-is.
Also note that in the earlier SPI, this method was called every time the user was accessed, even if the local user is in the cache.
In the later SPI, this method is only called when the local user is loaded from local storage. If the local user is cached,
then the <code>ImportedUserValidation.validate()</code> method is not called at all.</p>
</div>
<div class="paragraph">
<p>The <code>UserFederationProvider.isValid()</code> method no longer exists in the later SPI.</p>
</div>
<div class="paragraph">
<p>The <code>UserFederationProvider</code> methods <code>synchronizeRegistrations()</code>, <code>registerUser()</code>, and <code>removeUser()</code> have been
moved to the <code>UserRegistrationProvider</code> capability interface. This new interface is optional to implement so if your
provider does not support creating and removing users, you don&#8217;t have to implement it. If your earlier provider had switch
to toggle support for registering new users, this is supported in the new SPI, returning <code>null</code> from
<code>UserRegistrationProvider.addUser()</code> if the provider doesn&#8217;t support adding users.</p>
</div>
<div class="paragraph">
<p>The earlier <code>UserFederationProvider</code> methods centered around credentials are now encapsulated in the <code>CredentialInputValidator</code>
and <code>CredentialInputUpdater</code> interfaces, which are also optional to implement depending on if you support validating or
updating credentials.  Credential management used to exist in <code>UserModel</code> methods. These also have been moved to the
<code>CredentialInputValidator</code> and <code>CredentialInputUpdater</code> interfaces.
One thing to note that if you do not implement the <code>CredentialInputUpdater</code> interface, then
any credentials provided by your provider can be overridden locally in Keycloak storage. So if you want
your credentials to be read-only, implement the <code>CredentialInputUpdater.updateCredential()</code> method and
return a <code>ReadOnlyException</code>.</p>
</div>
<div class="paragraph">
<p>The <code>UserFederationProvider</code> query methods such as <code>searchByAttributes()</code> and <code>getGroupMembers()</code> are now encapsulated
in an optional interface <code>UserQueryProvider</code>. If you do not implement this interface, then users will not be viewable
in the admin console.  You&#8217;ll still be able to log in though.</p>
</div>
</div>
<div class="sect3">
<h4 id="userfederationproviderfactory-versus-userstorageproviderfactory"><a class="anchor" href="#userfederationproviderfactory-versus-userstorageproviderfactory"></a>UserFederationProviderFactory versus UserStorageProviderFactory</h4>
<div class="paragraph">
<p>The synchronization methods in the earlier SPI are now encapsulated within an optional <code>ImportSynchronization</code> interface.
If you have implemented synchronization logic, then have your new <code>UserStorageProviderFactory</code> implement the
<code>ImportSynchronization</code> interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="upgrading-to-a-new-model"><a class="anchor" href="#upgrading-to-a-new-model"></a>Upgrading to a new model</h4>
<div class="paragraph">
<p>The User Storage SPI instances are stored in a different set of relational tables. Keycloak
automatically runs a migration script. If any earlier User Federation providers are deployed for a realm, they are converted
to the later storage model as is, including the <code>id</code> of the data. This migration will only happen if a User Storage provider exists
with the same provider ID (i.e., "ldap", "kerberos") as the earlier User Federation provider.</p>
</div>
<div class="paragraph">
<p>So, knowing this there are different approaches you can take.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You can remove the earlier provider in your earlier Keycloak deployment. This will remove the local linked copies
of all users you imported.  Then, when you upgrade Keycloak, just deploy and configure your new provider for your realm.</p>
</li>
<li>
<p>The second option is to write your new provider making sure it has the same provider ID: <code>UserStorageProviderFactory.getId()</code>.
Make sure this provider is deployed to the server.  Boot the server, and have
the built-in migration script convert from the earlier data model to the later data model. In this case all your earlier linked imported
users will work and be the same.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you have decided to get rid of the import strategy and rewrite your User Storage provider, we suggest that you remove the earlier provider
before upgrading Keycloak. This will remove linked local imported copies of any user you imported.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stream_based_interfaces"><a class="anchor" href="#_stream_based_interfaces"></a>Stream-based interfaces</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/user-storage/stream-interfaces.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/user-storage/stream-interfaces.adoc&amp;description=%0A%0AFile:%20server_development/topics/user-storage/stream-interfaces.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Many of the user storage interfaces in Keycloak contain query methods that can return potentially large sets of objects,
which might lead to significant impacts in terms of memory consumption and processing time. This is especially true when only
a small subset of the objects' internal state is used in the query method&#8217;s logic.</p>
</div>
<div class="paragraph">
<p>To provide developers with a more efficient alternative to process large data sets in these query methods, a <code>Streams</code>
sub-interface has been added to user storage interfaces. These <code>Streams</code> sub-interfaces replace the original collection-based
methods in the super-interfaces with stream-based variants, making the collection-based methods default. The default implementation
of a collection-based query method invokes its <code>Stream</code> counterpart and collects the result into the proper collection type.</p>
</div>
<div class="paragraph">
<p>The <code>Streams</code> sub-interfaces allow for implementations to focus on the stream-based approach for processing sets of data and
benefit from the potential memory and performance optimizations of that approach. The interfaces that offer a <code>Streams</code>
sub-interface to be implemented include a few <em><a href="#_provider_capability_interfaces">capability interfaces</a></em>, all interfaces in the <code>org.keycloak.storage.federated</code>
package and a few others that might be implemented depending on the scope of the custom storage implementation.</p>
</div>
<div class="paragraph">
<p>See this list of the interfaces that offer a <code>Streams</code> sub-interface to developers.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Classes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.credential</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CredentialInputUpdater</code>(*), <code>UserCredentialStore</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.models</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GroupModel</code>, <code>RoleMapperModel</code>, <code>UserCredentialManager</code>, <code>UserModel</code>, <code>UserProvider</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.models.cache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CachedUserModel</code>, <code>UserCache</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.storage.federated</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All interfaces</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.keycloak.storage.user</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UserQueryProvider</code>(*)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>(*) indicates the interface is a <em><a href="#_provider_capability_interfaces">capability interface</a></em></p>
</div>
<div class="paragraph">
<p>Custom user storage implementation that want to benefit from the streams approach should simply implement the <code>Streams</code>
sub-interfaces instead of the original interfaces. For example, the following code uses the <code>Streams</code> variant of the <code>UserQueryProvider</code>
interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomQueryProvider</span> <span class="directive">extends</span> UserQueryProvider.Streams {
...
    <span class="annotation">@Override</span>
    Stream&lt;UserModel&gt; getUsersStream(RealmModel realm, <span class="predefined-type">Integer</span> firstResult, <span class="predefined-type">Integer</span> maxResults) {
        <span class="comment">// custom logic here</span>
    }

    <span class="annotation">@Override</span>
    Stream&lt;UserModel&gt; searchForUserStream(<span class="predefined-type">String</span> search, RealmModel realm) {
        <span class="comment">// custom logic here</span>
    }
...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vault-spi"><a class="anchor" href="#_vault-spi"></a>Vault SPI</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/server_development/topics/vault.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20server_development/topics/vault.adoc&amp;description=%0A%0AFile:%20server_development/topics/vault.adoc&amp;version=26.4.0&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="sect2">
<h3 id="vault-provider"><a class="anchor" href="#vault-provider"></a>Vault provider</h3>
<div class="paragraph">
<p>You can use a vault SPI from <code>org.keycloak.vault</code> package to write custom extension for Keycloak to connect to arbitrary vault implementation.</p>
</div>
<div class="paragraph">
<p>The built-in <code>files-plaintext</code> provider is an example of the implementation of this SPI. In general the following rules apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To prevent a secret from leaking across realms, you may want to isolate or limit the secrets that can be retrieved by a realm.
In that case, your provider should take into account the realm name when looking up secrets, for example by prefixing
entries with the realm name. For example, an expression <code>${vault.key}</code> would then evaluate generally to different entry
names, depending on whether it was used in a realm <em>A</em> or realm <em>B</em>. To differentiate between realms, the realm needs to
be passed to the created <code>VaultProvider</code> instance from <code>VaultProviderFactory.create()</code> method where it is available from the
<code>KeycloakSession</code> parameter.</p>
</li>
<li>
<p>The vault provider needs to implement a single method <code>obtainSecret</code> that returns a <code>VaultRawSecret</code> for the given secret name. That class holds the representation of the secret either in <code>byte[]</code> or <code>ByteBuffer</code> and is expected to convert between the two upon demand. Note that this buffer would be discarded after usage as explained below.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Regarding realm separation, all built-in vault provider factories allow the configuration of one or more key resolvers. Represented
by the <code>VaultKeyResolver</code> interface, a key resolver essentially implements the algorithm or strategy for combining the realm name
with the key (as obtained from the <code>${vault.key}</code> expression) into the final entry name that will be used to retrieve the
secret from the vault. The code that handles this configuration has been extracted into abstract vault provider and vault
provider factory classes, so custom implementations that want to offer support for key resolvers may extend these abstract classes
instead of the implementing SPI interfaces to inherit the ability to configure the key resolvers that should be tried when retrieving a secret.</p>
</div>
<div class="paragraph">
<p>For details on how to package and deploy a custom provider refer to the <a href="#_providers">Service Provider Interfaces</a> chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="consuming-values-from-vault"><a class="anchor" href="#consuming-values-from-vault"></a>Consuming values from vault</h3>
<div class="paragraph">
<p>The vault contains sensitive data and Keycloak treats the secrets accordingly. When accessing a secret, the secret is obtained from the vault and retained in JVM memory only for the necessary time. Then all possible attempts to discard its content from JVM memory is done. This is achieved by using the vault secrets only within <code>try</code>-with-resources statement as outlined below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="type">char</span><span class="type">[]</span> c;
    <span class="keyword">try</span> (VaultCharSecret cSecret = session.vault().getCharSecret(SECRET_NAME)) {
        <span class="comment">// ... use cSecret</span>
        c = cSecret.getAsArray().orElse(<span class="predefined-constant">null</span>);
        <span class="comment">// if c != null, it now contains password</span>
    }

    <span class="comment">// if c != null, it now contains garbage</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The example uses <code>KeycloakSession.vault()</code> as the entrypoint for accessing
the secrets. Using the <code>VaultProvider.obtainSecret</code> method directly is indeed
also possible. However the <code>vault()</code> method has the benefit of ability
to interpret the raw secret (which is generally a byte array)
as a character array (via <code>vault().getCharSecret()</code>) or a <code>String</code>
(via <code>vault().getStringSecret()</code>) in addition to obtaining the original
uninterpreted value (via <code>vault().getRawSecret()</code> method).</p>
</div>
<div class="paragraph">
<p>Note that since <code>String</code> objects are immutable, their content cannot be discarded
by overriding with random garbage. Even though measures have been taken in the default
<code>VaultStringSecret</code> implementation to prevent internalizing <code>String</code>s, the secrets
stored in <code>String</code> objects would live at least to the next GC round. Thus using
plain byte and character arrays and buffers is preferable.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-09-30 11:33:53 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.js"></script>

<script>
    const oldtoc = document.getElementById('toctitle').nextElementSibling;
    const newtoc = document.createElement('div');
    newtoc.setAttribute('id', 'tocbot');
    newtoc.setAttribute('class', 'js-toc');
    oldtoc.parentNode.replaceChild(newtoc, oldtoc);
    tocbot.init({ contentSelector: '#content',
        headingSelector: 'h2, h3, h4',
        smoothScroll: false
    });
    const handleTocOnResize = function() {
        const width = window.innerWidth
                    || document.documentElement.clientWidth
                    || document.body.clientWidth;
        if (width < 768) {
            tocbot.refresh({
                contentSelector: '#content',
                headingSelector: 'h2, h3, h4',
                collapseDepth: 6,
                activeLinkClass: 'ignoreactive',
                throttleTimeout: 1000,
                smoothScroll: false
            });
        }
        else {
            tocbot.refresh({
                contentSelector: '#content',
                headingSelector: 'h2, h3, h4',
                smoothScroll: false
            });
        }
    };
    window.addEventListener('resize', handleTocOnResize);
    handleTocOnResize();
</script>
</body>
</html>