<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Server Administration Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<style>
/* Top menu */

@media only screen and (min-width: 768px) {
       div.top-menu-guides {
              position: fixed;
              display: inline-block;
              top: 0;
              left: 0;
              z-index: 9999;
       }

       div.top-menu-guides p {
              margin: 0;
              padding: 0;
       }

       div.top-menu-guides .content {
              margin: 0;
              padding: 7px 20px 0 20px;
              background-color: #ededed;
              height: 48px;
              width: 20em;
       }

       @media only screen and (max-width: 1280px) {
              div.top-menu-guides .content {
                     width: 15em;
              }
       }

       div.top-menu-guides .ulist {
              display: none;
              position: absolute;
              background-color: #f9f9f9;
              min-width: 160px;
              box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
              padding: 0px;
              margin-top: 12px;
       }

       div.top-menu-guides .ulist ul {
              list-style: none;
              padding: 5px;
              margin: 0;
       }

       div.top-menu-guides .ulist li {
              padding: 5px 10px;
       }

       div.top-menu-guides:hover .ulist {
           display: block;
       }

       div.top-menu-version {
           position: fixed;
           top: 0;
           z-index: 9999;
       }

       div.top-menu-version .content {
           padding: 0;
           margin: 0;
           background-color: #eee;
           height: 48px;
           padding: 7px;
       }

       .versionarchive {
           display: inline-block;
       }

       .versionarchive p {
           margin: 0;
           padding: 2px 5px 2px 10px;
       }

       .versionarchive a {
           background-color: #ffdd57;
           padding: 0 5px;
           font-style: normal;
           border-radius: 5px;
           margin-left: 10px;
       }

       .versionlatest {
           display: inline-block;
       }

       .versionlatest p {
           background-color: #eee;
           border-radius: 5px;
           margin: 0;
           padding: 2px 5px 2px 10px;
       }

       .versionlatest em {
           background-color: #23d160;
           padding: 0 5px;
           font-style: normal;
           border-radius: 5px;
           margin-left: 10px;
       }
}

/* TOC */

#tocbot a.toc-link.node-name--H1{ font-style: italic }
@media screen{
#tocbot > ul.toc-list{ margin-bottom: 0.5em; margin-left: 0.125em }
#tocbot ul.sectlevel0, #tocbot a.toc-link.node-name--H1 + ul{
  padding-left: 0 }
#tocbot a.toc-link{ height:100% }
.is-collapsible{ max-height:3000px; overflow:hidden; }
.is-collapsed{ max-height:0 }
.is-active-link{ font-weight:700 }
}
@media print{
#tocbot a.toc-link.node-name--H4{ display:none }
}

/* Fix scroll to anchor hides title */
h1::before, h2::before, h3::before, h4::before, h5::before, h6::before {
    display: block;
    content: " ";
    height: 70px;
    margin-top: -70px;
}

h1 {
    border-bottom: none !important
}

#toc.toc2 {
    top: 30px;
    bottom: 0px;
    height: unset;
}

body.toc2 {
    padding-top: 30px;
}

@media only screen and (min-width:768px) {
    #toc.toc2 {
        top: 40px;
    }

    body.toc2 {
        padding-top: 40px;
    }
}

@media only screen and (min-width:1280px) {
    #toc.toc2 {
        top: 48px;
    }

    body.toc2 {
        padding-top: 48px;
    }
}


/* General Changes */

h1, h2, h3, #toctitle, .sidebarblock>.content>.title, h4, h5, h6 {
    color: #444444;
    font-weight: 500;
}

a {
    color: #004670;
    text-decoration: none;
}

a:hover {
    color: #7da1dc;
}

body {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    color: #444444;
}

.subheader, .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    color: #444444;
}

.admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    font-style: normal;
}

span.image img {
    border:1px solid #ccc;
    -webkit-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    -moz-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
}

.sect1+.sect1 {
    border-top: none;
}

.page-links {
    border-bottom: 1px solid #efefed;
    border-top: none;
    background: none;
    position: relative;
    left: 0em;
    width: 100%;
    top: -5em;
    height: 0;
    margin: 0;
    padding: 0;
}

.sect2 .page-links {
    top: -3.5em;
}

.page-links .content {
    background: #f8f8f7;
    border: 1px solid #e0e0dc;
    float: right;
    font-size: 0.8em;
    margin: 0;
    padding: 5px;
}

.page-links a {
    display: block;
    padding: 5px;
}
</style>

</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Server Administration Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#overview">Overview</a>
<ul class="sectlevel2">
<li><a href="#features">Features</a></li>
<li><a href="#how-does-security-work">How Does Security Work?</a></li>
<li><a href="#core-concepts-and-terms">Core Concepts and Terms</a></li>
</ul>
</li>
<li><a href="#server-initialization">Server Initialization</a></li>
<li><a href="#admin-console">Admin Console</a>
<ul class="sectlevel2">
<li><a href="#the-master-realm">The Master Realm</a></li>
<li><a href="#_create-realm">Create a New Realm</a></li>
<li><a href="#_ssl_modes">SSL Mode</a></li>
<li><a href="#_clear-cache">Clearing Server Caches</a></li>
<li><a href="#_email">Email Settings</a></li>
<li><a href="#_themes">Themes and Internationalization</a>
<ul class="sectlevel3">
<li><a href="#internationalization">Internationalization</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#user-management">User Management</a>
<ul class="sectlevel2">
<li><a href="#searching-for-users">Searching For Users</a></li>
<li><a href="#_create-new-user">Creating New Users</a></li>
<li><a href="#_delete-user">Deleting Users</a></li>
<li><a href="#_user-attributes">User Attributes</a></li>
<li><a href="#_user-credentials">User Credentials</a>
<ul class="sectlevel3">
<li><a href="#creating-a-password-for-the-user">Creating a Password for the User</a></li>
<li><a href="#creating-other-credentials">Creating other credentials</a></li>
</ul>
</li>
<li><a href="#required-actions">Required Actions</a>
<ul class="sectlevel3">
<li><a href="#default-required-actions">Default Required Actions</a></li>
<li><a href="#terms-and-conditions">Terms and Conditions</a></li>
</ul>
</li>
<li><a href="#impersonation">Impersonation</a></li>
<li><a href="#_user-registration">User Registration</a>
<ul class="sectlevel3">
<li><a href="#_recaptcha">reCAPTCHA Support</a></li>
</ul>
</li>
<li><a href="#_personal_data">Personal data collected by Keycloak</a></li>
<li><a href="#enabling-account-deletion-by-users">Enabling account deletion by users</a></li>
<li><a href="#deleting-a-user-in-action">Deleting a user in action</a></li>
</ul>
</li>
<li><a href="#login-page-settings">Login Page Settings</a>
<ul class="sectlevel2">
<li><a href="#forgot-password">Forgot Password</a></li>
<li><a href="#remember-me">Remember Me</a></li>
</ul>
</li>
<li><a href="#authentication">Authentication</a>
<ul class="sectlevel2">
<li><a href="#_password-policies">Password Policies</a>
<ul class="sectlevel3">
<li><a href="#password-policy-types">Password Policy Types</a></li>
</ul>
</li>
<li><a href="#otp-policies">OTP Policies</a>
<ul class="sectlevel3">
<li><a href="#totp-vs-hotp">TOTP vs. HOTP</a></li>
<li><a href="#totp-configuration-options">TOTP Configuration Options</a></li>
<li><a href="#hotp-configuration-options">HOTP Configuration Options</a></li>
</ul>
</li>
<li><a href="#_authentication-flows">Authentication Flows</a>
<ul class="sectlevel3">
<li><a href="#built-in-flows">Built-in flows</a></li>
<li><a href="#creating-flows">Creating flows</a></li>
<li><a href="#creating-a-password-less-browser-login-flow">Creating a password-less browser login flow</a></li>
</ul>
</li>
<li><a href="#script-authenticator">Script Authenticator</a></li>
<li><a href="#_kerberos">Kerberos</a>
<ul class="sectlevel3">
<li><a href="#setup-of-kerberos-server">Setup of Kerberos server</a></li>
<li><a href="#setup-and-configuration-of-keycloak-server">Setup and configuration of Keycloak server</a></li>
<li><a href="#setup-and-configuration-of-client-machines">Setup and configuration of client machines</a></li>
<li><a href="#example-setups">Example setups</a></li>
<li><a href="#credential-delegation">Credential Delegation</a></li>
<li><a href="#cross-realm-trust">Cross-realm trust</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_x509">X.509 Client Certificate User Authentication</a>
<ul class="sectlevel3">
<li><a href="#features-2">Features</a></li>
<li><a href="#enable-x-509-client-certificate-user-authentication">Enable X.509 Client Certificate User Authentication</a></li>
<li><a href="#adding-x-509-client-certificate-authentication-to-a-browser-flow">Adding X.509 Client Certificate Authentication to a Browser Flow</a></li>
<li><a href="#adding-x-509-client-certificate-authentication-to-a-direct-grant-flow">Adding X.509 Client Certificate Authentication to a Direct Grant Flow</a></li>
<li><a href="#client-certificate-lookup">Client certificate lookup</a></li>
<li><a href="#troubleshooting-2">Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_webauthn">W3C Web Authentication (WebAuthn)</a>
<ul class="sectlevel3">
<li><a href="#setup">Setup</a></li>
<li><a href="#authenticate-with-webauthn-authenticator">Authenticate with WebAuthn Authenticator</a></li>
<li><a href="#managing-webauthn-as-an-administrator">Managing WebAuthn as an administrator</a></li>
<li><a href="#attestation-statement-verification">Attestation Statement Verification</a></li>
<li><a href="#managing-webauthn-credentials-as-a-user">Managing WebAuthn credentials as a user</a></li>
<li><a href="#passwordless-webauthn-together-with-two-factor">Passwordless WebAuthn together with Two-Factor</a></li>
</ul>
</li>
<li><a href="#conditions-in-conditional-flows">Conditions in Conditional flows</a>
<ul class="sectlevel3">
<li><a href="#available-conditions">Available Conditions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sso-protocols">SSO Protocols</a>
<ul class="sectlevel2">
<li><a href="#_oidc">OpenID Connect</a>
<ul class="sectlevel3">
<li><a href="#_oidc-auth-flows">OIDC Auth Flows</a></li>
<li><a href="#_oidc-endpoints">Keycloak Server OIDC URI Endpoints</a></li>
</ul>
</li>
<li><a href="#_saml">SAML</a>
<ul class="sectlevel3">
<li><a href="#saml-bindings">SAML Bindings</a></li>
<li><a href="#keycloak-server-saml-uri-endpoints">Keycloak Server SAML URI Endpoints</a></li>
</ul>
</li>
<li><a href="#openid-connect-vs-saml">OpenID Connect vs. SAML</a></li>
<li><a href="#_docker">Docker Registry v2 Authentication</a>
<ul class="sectlevel3">
<li><a href="#docker-auth-flow">Docker Auth Flow</a></li>
<li><a href="#keycloak-docker-registry-v2-authentication-server-uri-endpoints">Keycloak Docker Registry v2 Authentication Server URI Endpoints</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_clients">Managing Clients</a>
<ul class="sectlevel2">
<li><a href="#oidc-clients">OIDC Clients</a>
<ul class="sectlevel3">
<li><a href="#advanced-settings">Advanced Settings</a></li>
<li><a href="#_client-credentials">Confidential Client Credentials</a></li>
<li><a href="#_service_accounts">Service Accounts</a></li>
<li><a href="#_audience">Audience Support</a></li>
</ul>
</li>
<li><a href="#saml-clients">SAML Clients</a>
<ul class="sectlevel3">
<li><a href="#idp-initiated-login">IDP Initiated Login</a></li>
<li><a href="#saml-entity-descriptors">SAML Entity Descriptors</a></li>
</ul>
</li>
<li><a href="#client-links">Client Links</a></li>
<li><a href="#_protocol-mappers">OIDC Token and SAML Assertion Mappings</a>
<ul class="sectlevel3">
<li><a href="#priority-order">Priority order</a></li>
<li><a href="#_protocol-mappers_oidc-user-session-note-mappers">OIDC User Session Note Mappers</a></li>
<li><a href="#script-mapper">Script Mapper</a></li>
</ul>
</li>
<li><a href="#_client_installation">Generating Client Adapter Config</a></li>
<li><a href="#_client_scopes">Client Scopes</a>
<ul class="sectlevel3">
<li><a href="#protocol">Protocol</a></li>
<li><a href="#consent-related-settings">Consent related settings</a></li>
<li><a href="#_client_scopes_linking">Link Client Scope with the Client</a></li>
<li><a href="#_client_scopes_evaluate">Evaluating Client Scopes</a></li>
<li><a href="#client-scopes-permissions">Client Scopes Permissions</a></li>
<li><a href="#realm-default-client-scopes">Realm Default Client Scopes</a></li>
<li><a href="#scopes-explained">Scopes explained</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#roles">Roles</a>
<ul class="sectlevel2">
<li><a href="#realm-roles">Realm Roles</a></li>
<li><a href="#client-roles">Client Roles</a></li>
<li><a href="#_composite-roles">Composite Roles</a></li>
<li><a href="#user-role-mappings">User Role Mappings</a>
<ul class="sectlevel3">
<li><a href="#_default_roles">Default Roles</a></li>
</ul>
</li>
<li><a href="#_role_scope_mappings">Role Scope Mappings</a></li>
</ul>
</li>
<li><a href="#groups">Groups</a>
<ul class="sectlevel2">
<li><a href="#groups-vs-roles">Groups vs. Roles</a></li>
<li><a href="#default-groups">Default Groups</a></li>
</ul>
</li>
<li><a href="#_admin_permissions">Admin Console Access Control and Permissions</a>
<ul class="sectlevel2">
<li><a href="#master-realm-access-control">Master Realm Access Control</a>
<ul class="sectlevel3">
<li><a href="#global-roles">Global Roles</a></li>
<li><a href="#realm-specific-roles">Realm Specific Roles</a></li>
</ul>
</li>
<li><a href="#_per_realm_admin_permissions">Dedicated Realm Admin Consoles</a></li>
<li><a href="#_fine_grain_permissions">Fine Grain Admin Permissions</a>
<ul class="sectlevel3">
<li><a href="#managing-one-specific-client">Managing One Specific Client</a></li>
<li><a href="#restrict-user-role-mapping">Restrict User Role Mapping</a></li>
<li><a href="#full-list-of-permissions">Full List of Permissions</a></li>
</ul>
</li>
<li><a href="#realm_keys">Realm Keys</a>
<ul class="sectlevel3">
<li><a href="#rotating-keys">Rotating keys</a></li>
<li><a href="#adding-a-generated-keypair">Adding a generated keypair</a></li>
<li><a href="#adding-an-existing-keypair-and-certificate">Adding an existing keypair and certificate</a></li>
<li><a href="#loading-keys-from-a-java-keystore">Loading keys from a Java Keystore</a></li>
<li><a href="#making-keys-passive">Making keys passive</a></li>
<li><a href="#disabling-keys">Disabling keys</a></li>
<li><a href="#compromised-keys">Compromised keys</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_identity_broker">Identity Brokering</a>
<ul class="sectlevel2">
<li><a href="#_identity_broker_overview">Brokering Overview</a></li>
<li><a href="#default_identity_provider">Default Identity Provider</a></li>
<li><a href="#_general-idp-config">General Configuration</a></li>
<li><a href="#social-identity-providers">Social Identity Providers</a>
<ul class="sectlevel3">
<li><a href="#bitbucket">Bitbucket</a></li>
<li><a href="#facebook">Facebook</a></li>
<li><a href="#github">GitHub</a></li>
<li><a href="#gitlab">GitLab</a></li>
<li><a href="#google">Google</a></li>
<li><a href="#linkedin">LinkedIn</a></li>
<li><a href="#microsoft">Microsoft</a></li>
<li><a href="#openshift-3">OpenShift 3</a></li>
<li><a href="#openshift-4">OpenShift 4</a></li>
<li><a href="#paypal">PayPal</a></li>
<li><a href="#stack-overflow">Stack Overflow</a></li>
<li><a href="#twitter">Twitter</a></li>
<li><a href="#instagram">Instagram</a></li>
</ul>
</li>
<li><a href="#_identity_broker_oidc">OpenID Connect v1.0 Identity Providers</a></li>
<li><a href="#saml-v2-0-identity-providers">SAML v2.0 Identity Providers</a>
<ul class="sectlevel3">
<li><a href="#_identity_broker_saml_requested_authncontext">Requesting specific AuthnContexts</a></li>
<li><a href="#_identity_broker_saml_sp_descriptor">SP Descriptor</a></li>
<li><a href="#_identity_broker_saml_login_hint">Send Subject in SAML requests</a></li>
</ul>
</li>
<li><a href="#_client_suggested_idp">Client-suggested Identity Provider</a></li>
<li><a href="#_mappers">Mapping Claims and Assertions</a></li>
<li><a href="#available-user-session-data">Available User Session Data</a></li>
<li><a href="#_identity_broker_first_login">First Login Flow</a>
<ul class="sectlevel3">
<li><a href="#default-first-login-flow">Default First Login Flow</a></li>
<li><a href="#automatically-link-existing-first-login-flow">Automatically Link Existing First Login Flow</a></li>
<li><a href="#_disabling_automatic_user_creation">Disabling Automatic User Creation</a></li>
</ul>
</li>
<li><a href="#retrieving-external-idp-tokens">Retrieving External IDP Tokens</a></li>
<li><a href="#identity-broker-logout">Identity broker logout</a></li>
</ul>
</li>
<li><a href="#user-session-management">User Session Management</a>
<ul class="sectlevel2">
<li><a href="#administering-sessions">Administering Sessions</a>
<ul class="sectlevel3">
<li><a href="#limitations-of-the-code-logout-all-code-operation">Limitations of the <code>Logout all</code> Operation</a></li>
<li><a href="#application-drilldown">Application Drilldown</a></li>
<li><a href="#user-drilldown">User Drilldown</a></li>
</ul>
</li>
<li><a href="#_revocation-policy">Revocation Policies</a></li>
<li><a href="#_timeouts">Session and Token Timeouts</a></li>
<li><a href="#_offline-access">Offline Access</a></li>
<li><a href="#_transient-session">Transient sessions</a></li>
</ul>
</li>
<li><a href="#_user-storage-federation">User Storage Federation</a>
<ul class="sectlevel2">
<li><a href="#adding-a-provider">Adding a Provider</a></li>
<li><a href="#dealing-with-provider-failures">Dealing with Provider Failures</a></li>
<li><a href="#_ldap">LDAP and Active Directory</a>
<ul class="sectlevel3">
<li><a href="#storage-mode">Storage Mode</a></li>
<li><a href="#edit-mode">Edit Mode</a></li>
<li><a href="#other-config-options">Other config options</a></li>
<li><a href="#connect-to-ldap-over-ssl">Connect to LDAP over SSL</a></li>
<li><a href="#sync-of-ldap-users-to-keycloak">Sync of LDAP users to Keycloak</a></li>
<li><a href="#_ldap_mappers">LDAP Mappers</a></li>
<li><a href="#_ldap_password_hashing">Password Hashing</a></li>
</ul>
</li>
<li><a href="#_sssd">SSSD and FreeIPA Identity Management Integration</a>
<ul class="sectlevel3">
<li><a href="#freeipa-idm-server">FreeIPA/IdM Server</a></li>
<li><a href="#sssd-and-d-bus">SSSD and D-Bus</a></li>
<li><a href="#enabling-the-sssd-federation-provider">Enabling the SSSD Federation Provider</a></li>
</ul>
</li>
<li><a href="#configuring-a-federated-sssd-store">Configuring a Federated SSSD Store</a></li>
<li><a href="#custom-providers">Custom Providers</a></li>
</ul>
</li>
<li><a href="#auditing-and-events">Auditing and Events</a>
<ul class="sectlevel2">
<li><a href="#login-events">Login Events</a>
<ul class="sectlevel3">
<li><a href="#event-types">Event Types</a></li>
<li><a href="#event-listener">Event Listener</a></li>
</ul>
</li>
<li><a href="#admin-events">Admin Events</a></li>
</ul>
</li>
<li><a href="#_export_import">Export and Import</a>
<ul class="sectlevel2">
<li><a href="#admin-console-export-import">Admin console export/import</a></li>
</ul>
</li>
<li><a href="#_vault-administration">Using Vault to Obtain Secrets</a>
<ul class="sectlevel2">
<li><a href="#kubernetes-openshift-files-plaintext-vault-provider">Kubernetes / OpenShift Files Plaintext Vault Provider</a></li>
<li><a href="#elytron-credential-store-vault-provider">Elytron Credential Store Vault Provider</a></li>
<li><a href="#key-resolvers">Key Resolvers</a></li>
</ul>
</li>
<li><a href="#_account-service">User Account Service</a>
<ul class="sectlevel2">
<li><a href="#themeable">Themeable</a></li>
</ul>
</li>
<li><a href="#threat-model-mitigation">Threat Model Mitigation</a>
<ul class="sectlevel2">
<li><a href="#host">Host</a></li>
<li><a href="#admin-endpoints-and-console">Admin Endpoints and Console</a>
<ul class="sectlevel3">
<li><a href="#ip-restriction">IP Restriction</a></li>
<li><a href="#port-restriction">Port Restriction</a></li>
</ul>
</li>
<li><a href="#password-guess-brute-force-attacks">Password guess: brute force attacks</a>
<ul class="sectlevel3">
<li><a href="#password-policies">Password Policies</a></li>
</ul>
</li>
<li><a href="#_read_only_user_attributes">Read-only User Attributes</a></li>
<li><a href="#clickjacking">Clickjacking</a></li>
<li><a href="#ssl-https-requirement">SSL/HTTPS Requirement</a></li>
<li><a href="#csrf-attacks">CSRF Attacks</a></li>
<li><a href="#_unspecific-redirect-uris">Unspecific Redirect URIs</a></li>
<li><a href="#compromised-access-and-refresh-tokens">Compromised Access and Refresh Tokens</a></li>
<li><a href="#compromised-authorization-code">Compromised Authorization Code</a></li>
<li><a href="#open-redirectors">Open redirectors</a></li>
<li><a href="#password-database-compromised">Password database compromised</a></li>
<li><a href="#limiting-scope">Limiting Scope</a></li>
<li><a href="#limit-token-audience">Limit Token Audience</a></li>
<li><a href="#sql-injection-attacks">SQL Injection Attacks</a></li>
</ul>
</li>
<li><a href="#the-admin-cli">The Admin CLI</a>
<ul class="sectlevel2">
<li><a href="#installing-the-admin-cli">Installing the Admin CLI</a></li>
<li><a href="#using-the-admin-cli">Using the Admin CLI</a></li>
<li><a href="#authenticating">Authenticating</a></li>
<li><a href="#_working_with_alternative_configurations">Working with alternative configurations</a></li>
<li><a href="#basic-operations-and-resource-uris">Basic operations and resource URIs</a></li>
<li><a href="#realm-operations">Realm operations</a></li>
<li><a href="#role-operations">Role operations</a></li>
<li><a href="#client-operations">Client operations</a></li>
<li><a href="#user-operations">User operations</a></li>
<li><a href="#_group_operations">Group operations</a></li>
<li><a href="#identity-provider-operations">Identity provider operations</a></li>
<li><a href="#storage-provider-operations">Storage provider operations</a></li>
<li><a href="#adding-mappers">Adding mappers</a></li>
<li><a href="#authentication-operations">Authentication operations</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="exampleblock top-menu-guides">
<div class="content">
<div class="paragraph">
<p><strong>Server Administration</strong> <span class="icon"><i class="fa fa-angle-down"></i></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.keycloak.org/docs/12.0/getting_started/">Getting Started</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/12.0/server_installation/">Server Installation</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/12.0/securing_apps/">Securing Apps</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/12.0/authorization_services/">Authorization Services</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/12.0/upgrading/">Upgrading</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/12.0/release_notes/">Release Notes</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock top-menu-version">
<div class="content">
<div class="paragraph versionarchive">
<p>Version <strong>12.0.4</strong> <em><a href="https://www.keycloak.org/docs/latest/server_admin/">Click here for latest</a></em></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/overview.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/overview.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak is a single sign on solution for web apps and RESTful web services.  The goal of Keycloak
is to make security simple so that it is easy for application developers to secure the apps and services they have deployed
in their organization.  Security features that developers normally have to write for themselves are provided out of the box
and are easily tailorable to the individual requirements of your organization.  Keycloak provides customizable
user interfaces for login, registration, administration, and account management.  You can also use Keycloak as an
integration platform to hook it into existing LDAP and Active Directory servers.  You can also delegate authentication to third
party identity providers like Facebook and Google.</p>
</div>
<div class="sect2">
<h3 id="features"><a class="anchor" href="#features"></a>Features</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/overview/features.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/overview/features.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Single-Sign On and Single-Sign Out for browser applications.</p>
</li>
<li>
<p>OpenID Connect support.</p>
</li>
<li>
<p>OAuth 2.0 support.</p>
</li>
<li>
<p>SAML support.</p>
</li>
<li>
<p>Identity Brokering - Authenticate with external OpenID Connect or SAML Identity Providers.</p>
</li>
<li>
<p>Social Login - Enable login with Google, GitHub, Facebook, Twitter, and other social networks.</p>
</li>
<li>
<p>User Federation - Sync users from LDAP and Active Directory servers.</p>
</li>
<li>
<p>Kerberos bridge - Automatically authenticate users that are logged-in to a Kerberos server.</p>
</li>
<li>
<p>Admin Console for central management of users, roles, role mappings, clients and configuration.</p>
</li>
<li>
<p>Account Management console that allows users to centrally manage their account.</p>
</li>
<li>
<p>Theme support - Customize all user facing pages to integrate with your applications and branding.</p>
</li>
<li>
<p>Two-factor Authentication - Support for TOTP/HOTP via Google Authenticator or FreeOTP.</p>
</li>
<li>
<p>Login flows - optional user self-registration, recover password, verify email, require password update, etc.</p>
</li>
<li>
<p>Session management - Admins and users themselves can view and manage user sessions.</p>
</li>
<li>
<p>Token mappers - Map user attributes, roles, etc. how you want into tokens and statements.</p>
</li>
<li>
<p>Not-before revocation policies per realm, application and user.</p>
</li>
<li>
<p>CORS support - Client adapters have built-in support for CORS.</p>
</li>
<li>
<p>Service Provider Interfaces (SPI) - A number of SPIs to enable customizing various aspects of the server. Authentication flows, user federation providers,
protocol mappers and many more.</p>
</li>
<li>
<p>Client adapters for JavaScript applications, WildFly, JBoss EAP, Fuse, Tomcat, Jetty, Spring, etc.</p>
</li>
<li>
<p>Supports any platform/language that has an OpenID Connect Relying Party library or SAML 2.0 Service Provider library.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="how-does-security-work"><a class="anchor" href="#how-does-security-work"></a>How Does Security Work?</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/overview/how.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/overview/how.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak is a separate server that you manage on your network.  Applications are configured to point to and
be secured by this server.  Keycloak uses open protocol standards like <a href="https://openid.net/connect/">OpenID Connect</a>
or <a href="http://saml.xml.org/saml-specifications">SAML 2.0</a> to secure
your applications.  Browser applications redirect a user&#8217;s browser from the application to the Keycloak authentication
server where they enter their credentials.  This is important because users are completely isolated from applications and
applications never see a user&#8217;s credentials.  Applications instead are given an identity token or assertion that is cryptographically
signed.  These tokens can have identity information like username, address, email, and other profile data.  They can also
hold permission data so that applications can make authorization decisions.  These tokens can also be used to make secure
invocations on REST-based services.</p>
</div>
</div>
<div class="sect2">
<h3 id="core-concepts-and-terms"><a class="anchor" href="#core-concepts-and-terms"></a>Core Concepts and Terms</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/overview/concepts.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/overview/concepts.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are some key concepts and terms you should be aware of before attempting to use Keycloak to secure your web applications
and REST services.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">users</dt>
<dd>
<p>Users are entities that are able to log into your system.  They can have attributes associated with themselves like email,
username, address, phone number, and birth day.  They can be assigned group membership and have specific roles assigned to them.</p>
</dd>
<dt class="hdlist1">authentication</dt>
<dd>
<p>The process of identifying and validating a user.</p>
</dd>
<dt class="hdlist1">authorization</dt>
<dd>
<p>The process of granting access to a user.</p>
</dd>
<dt class="hdlist1">credentials</dt>
<dd>
<p>Credentials are pieces of data that Keycloak uses to verify the identity of a user.  Some examples are passwords,
one-time-passwords, digital certificates, or even fingerprints.</p>
</dd>
<dt class="hdlist1">roles</dt>
<dd>
<p>Roles identify a type or category of user.  <code>Admin</code>, <code>user</code>, <code>manager</code>, and <code>employee</code> are all typical roles that may exist
in an organization.  Applications often assign access and permissions to specific roles rather than individual users as dealing
with users can be too fine grained and hard to manage.</p>
</dd>
<dt class="hdlist1">user role mapping</dt>
<dd>
<p>A user role mapping defines a mapping between a role and a user.  A user can be associated with zero or more roles.  This
role mapping information can be encapsulated into tokens and assertions so that applications can decide access permissions on
various resources they manage.</p>
</dd>
<dt class="hdlist1">composite roles</dt>
<dd>
<p>A composite role is a role that can be associated with other roles.  For example a <code>superuser</code> composite role could be associated with the
<code>sales-admin</code> and <code>order-entry-admin</code> roles.  If a user is mapped to the <code>superuser</code> role they also inherit the <code>sales-admin</code> and <code>order-entry-admin</code> roles.</p>
</dd>
<dt class="hdlist1">groups</dt>
<dd>
<p>Groups manage groups of users.  Attributes can be defined for a group.  You can map roles to a group as well.  Users that become members of a group
inherit the attributes and role mappings that group defines.</p>
</dd>
<dt class="hdlist1">realms</dt>
<dd>
<p>A realm manages a set of users, credentials, roles, and groups.  A user belongs to and logs into a realm.  Realms are isolated from one another
and can only manage and authenticate the users that they control.</p>
</dd>
<dt class="hdlist1">clients</dt>
<dd>
<p>Clients are entities that can request Keycloak to authenticate a user.  Most often, clients are applications and services that
want to use Keycloak to secure themselves and provide a single sign-on solution.  Clients can also be entities that just want to request
identity information or an access token so that they can securely invoke other services on the network that are secured by Keycloak.</p>
</dd>
<dt class="hdlist1">client adapters</dt>
<dd>
<p>Client adapters are plugins that you install into your application environment to be able to communicate and be secured by Keycloak.  Keycloak
has a number of adapters for different platforms that you can download.  There are also third-party adapters you can get for environments that we don&#8217;t cover.</p>
</dd>
<dt class="hdlist1">consent</dt>
<dd>
<p>Consent is when you as an admin want a user to give permission to a client before that client can participate in the authentication process.
After a user provides their credentials, Keycloak will pop up a screen identifying the client requesting a login and what identity
information is requested of the user.  User can decide whether or not to grant the request.</p>
</dd>
<dt class="hdlist1">client scopes</dt>
<dd>
<p>When a client is registered, you must define protocol mappers and role scope mappings for that client. It is often useful to store
a client scope, to make creating new clients easier by sharing some common settings. This is also useful for requesting some
claims or roles to be conditionally based on the value of <code>scope</code> parameter. Keycloak provides the concept of a client scope for this.</p>
</dd>
<dt class="hdlist1">client role</dt>
<dd>
<p>Clients can define roles that are specific to them.  This is basically a role namespace dedicated to the client.</p>
</dd>
<dt class="hdlist1">identity token</dt>
<dd>
<p>A token that provides identity information about the user.  Part of the OpenID Connect specification.</p>
</dd>
<dt class="hdlist1">access token</dt>
<dd>
<p>A token that can be provided as part of an HTTP request that grants access to the service being invoked on.  This is part of
the OpenID Connect and OAuth 2.0 specification.</p>
</dd>
<dt class="hdlist1">assertion</dt>
<dd>
<p>Information about a user.  This usually pertains to an XML blob that is included in a SAML authentication response that
provided identity metadata about an authenticated user.</p>
</dd>
<dt class="hdlist1">service account</dt>
<dd>
<p>Each client has a built-in service account which allows it to obtain an access token.</p>
</dd>
<dt class="hdlist1">direct grant</dt>
<dd>
<p>A way for a client to obtain an access token on behalf of a user via a REST invocation.</p>
</dd>
<dt class="hdlist1">protocol mappers</dt>
<dd>
<p>For each client you can tailor what claims and assertions are stored in the OIDC token or SAML assertion.  You do this per client by creating and configuring
protocol mappers.</p>
</dd>
<dt class="hdlist1">session</dt>
<dd>
<p>When a user logs in, a session is created to manage the login session.  A session contains information like when the user logged in and what
applications have participated within single-sign on during that session.  Both admins and users can view session information.</p>
</dd>
<dt class="hdlist1">user federation provider</dt>
<dd>
<p>Keycloak can store and manage users.  Often, companies already have LDAP or Active Directory services that store user and credential
information.  You can point Keycloak to validate credentials from those external stores and pull in identity information.</p>
</dd>
<dt class="hdlist1">identity provider</dt>
<dd>
<p>An identity provider (IDP) is a service that can authenticate a user.  Keycloak is an IDP.</p>
</dd>
<dt class="hdlist1">identity provider federation</dt>
<dd>
<p>Keycloak can be configured to delegate authentication to one or more IDPs.  Social login via
Facebook or Google+ is an example of identity provider federation.  You can also hook Keycloak to delegate
authentication to any other OpenID Connect or SAML 2.0 IDP.</p>
</dd>
<dt class="hdlist1">identity provider mappers</dt>
<dd>
<p>When doing IDP federation you can map incoming tokens and assertions to user and session attributes.  This helps you propagate identity information from the external IDP
to your client requesting authentication.</p>
</dd>
<dt class="hdlist1">required actions</dt>
<dd>
<p>Required actions are actions a user must perform during the authentication process.  A user will not be able to complete the authentication process until these actions
are complete.  For example, an admin may schedule users to reset their passwords every month.  An <code>update password</code> required action would be set for all these
users.</p>
</dd>
<dt class="hdlist1">authentication flows</dt>
<dd>
<p>Authentication flows are work flows a user must perform when interacting with certain aspects of the system.  A login flow can define
what credential types are required.  A registration flow defines what profile information a user must enter and whether something like reCAPTCHA
must be used to filter out bots.  Credential reset flow defines what actions a user must do before they can reset their password.</p>
</dd>
<dt class="hdlist1">events</dt>
<dd>
<p>Events are audit streams that admins can view and hook into.</p>
</dd>
<dt class="hdlist1">themes</dt>
<dd>
<p>Every screen provided by Keycloak is backed by a theme.  Themes define HTML templates and stylesheets which you can override as needed.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server-initialization"><a class="anchor" href="#server-initialization"></a>Server Initialization</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/initialization.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/initialization.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>After performing all the installation and configuration tasks defined in the <a href="https://www.keycloak.org/docs/12.0/server_installation/">Server Installation and Configuration Guide</a>,
you will need to create an initial admin account.
Keycloak does not have any configured admin account out of the box.
This account will allow you to create an admin that can log into the <em>master</em> realm&#8217;s administration console so that
you can start creating realms, users and registering applications to be secured by Keycloak.</p>
</div>
<div class="paragraph">
<p>If your
server is accessible from <code>localhost</code>, you can boot it up and create this admin user by going to the <a href="http://localhost:8080/auth" class="bare">http://localhost:8080/auth</a> URL.</p>
</div>
<div class="paragraph">
<div class="title">Welcome Page</div>
<p><span class="image"><img src="./keycloak-images/initial-welcome-page.png" alt="initial welcome page"></span></p>
</div>
<div class="paragraph">
<p>Simply specify the username and password you want for this initial admin.</p>
</div>
<div class="paragraph">
<p>If you cannot access the server via a <code>localhost</code> address, or just want to provision Keycloak from the command line
you can do this with the <code>&#8230;&#8203;/bin/add-user-keycloak</code> script.</p>
</div>
<div class="paragraph">
<div class="title">add-user-keycloak script</div>
<p><span class="image"><img src="./keycloak-images/add-user-script.png" alt="add user script"></span></p>
</div>
<div class="paragraph">
<p>The parameters are a little different depending if you are using the standalone operation mode or domain operation mode.  For
standalone mode, here is how you use the script.</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/add-user-keycloak.sh -r master -u &lt;username&gt; -p &lt;password&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\add-user-keycloak.bat -r master -u &lt;username&gt; -p &lt;password&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For domain mode, you have to point the script to one of your server hosts using the <code>-sc</code> switch.</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/add-user-keycloak.sh --sc domain/servers/server-one/configuration -r master -u &lt;username&gt; -p &lt;password&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\add-user-keycloak.bat --sc domain/servers/server-one/configuration -r master -u &lt;username&gt; -p &lt;password&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="admin-console"><a class="anchor" href="#admin-console"></a>Admin Console</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/admin-console.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/admin-console.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The bulk of your administrative tasks will be done through the Keycloak Admin Console.
You can go to the console url directly at <a href="http://localhost:8080/auth/admin/" class="bare">http://localhost:8080/auth/admin/</a></p>
</div>
<div class="paragraph">
<div class="title">Login Page</div>
<p><span class="image"><img src="./keycloak-images/login-page.png" alt="login page"></span></p>
</div>
<div class="paragraph">
<p>Enter the username and password you created on the Welcome Page or the <code>add-user-keycloak</code> script in the bin directory.
This will bring you to the Keycloak Admin Console.</p>
</div>
<div class="paragraph">
<div class="title">Admin Console</div>
<p><span class="image"><img src="./keycloak-images/admin-console.png" alt="admin console"></span></p>
</div>
<div class="paragraph">
<p>The left drop down menu allows you to pick a realm you want to manage or to create a new one.  The right drop down menu allows you to view your user account or logout.
If you are curious about a certain feature, button, or field within the Admin Console, simply hover your mouse
over any question mark <code>?</code> icon.  This will pop up tooltip text to describe the area of the console you are interested in.
The image above shows the tooltip in action.</p>
</div>
<div class="sect2">
<h3 id="the-master-realm"><a class="anchor" href="#the-master-realm"></a>The Master Realm</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/realms/master.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/realms/master.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When you boot Keycloak for the first time Keycloak creates a
pre-defined realm for you. This initial realm is the <em>master</em> realm. It is the
highest level in the hierarchy of realms. Admin accounts in this realm have
permissions to view and manage any other realm created on the server instance.
When you define your initial admin account, you create an account in the
<em>master</em> realm. Your initial login to the admin console will also be via the
<em>master</em> realm.</p>
</div>
<div class="paragraph">
<p>We recommend that you do not use the <em>master</em> realm to manage the users
and applications in your organization. Reserve use of the <em>master</em> realm for
<em>super</em> admins to create and manage the realms in your system. Following this
security model helps prevent accidental changes and follows the tradition
of permitting user accounts access to only those privileges and powers necessary
for the successful completion of their current task.</p>
</div>
<div class="paragraph">
<p>It is possible to disable the <em>master</em> realm and define admin accounts within
each individual new realm you create. Each realm has its own dedicated Admin
Console that you can log into with local accounts. This guide talks more about
this in the <a href="#_per_realm_admin_permissions">Dedicated Realm Admin Consoles</a>
chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create-realm"><a class="anchor" href="#_create-realm"></a>Create a New Realm</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/realms/create.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/realms/create.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Creating a new realm is very simple.
Mouse over the top left corner drop down menu that is titled with <code>Master</code>.  If you are logged in the master realm
this drop down menu lists all the realms created.  The last entry of this drop down menu is always <code>Add Realm</code>.  Click
this to add a realm.</p>
</div>
<div class="paragraph">
<div class="title">Add Realm Menu</div>
<p><span class="image"><img src="./keycloak-images/add-realm-menu.png" alt="add realm menu"></span></p>
</div>
<div class="paragraph">
<p>This menu option will bring you to the <code>Add Realm</code> page.  Specify the realm name you want to define and click the <code>Create</code> button.
Alternatively you can import a JSON document that defines your new realm.  We&#8217;ll go over this in more detail in the
<a href="#_export_import">Export and Import</a> chapter.</p>
</div>
<div class="paragraph">
<div class="title">Create Realm</div>
<p><span class="image"><img src="./keycloak-images/create-realm.png" alt="create realm"></span></p>
</div>
<div class="paragraph">
<p>After creating the realm you are brought back to the main Admin Console page. The current realm will now be set to
the realm you just created.  You can switch between managing different realms by doing a mouse over on the
top left corner drop down menu.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ssl_modes"><a class="anchor" href="#_ssl_modes"></a>SSL Mode</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/realms/ssl.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/realms/ssl.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Each realm has an SSL Mode associated with it.  The SSL Mode defines the SSL/HTTPS requirements for interacting with the realm.
Browsers and applications that interact with the realm must honor the SSL/HTTPS requirements defined by the SSL Mode or they
will not be allowed to interact with the server.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Keycloak generates a self-signed certificate the first time it runs.  Please note that self-signed certificates are not secure, and should only be used for testing purposes.  It is highly recommended that you install a CA-signed certificate on the Keycloak server itself or on a reverse proxy in front of the Keycloak server.  See the <a href="https://www.keycloak.org/docs/12.0/server_installation/">Server Installation and Configuration Guide</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure the SSL Mode of your realm, you need to click on the <code>Realm Settings</code> left menu item and go to the <code>Login</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Login Tab</div>
<p><span class="image"><img src="./keycloak-images/login-tab.png" alt="login tab"></span></p>
</div>
<div class="paragraph">
<p>The <code>Require SSL</code> option allows you to pick the SSL Mode you want.  Here is an explanation of each mode:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">external requests</dt>
<dd>
<p>Users can interact with Keycloak without SSL so long as they stick to private IP addresses like <code>localhost</code>, <code>127.0.0.1</code>, <code>10.x.x.x</code>, <code>192.168.x.x</code>, and <code>172.16.x.x</code>.
If you try to access Keycloak without SSL from a non-private IP address you will get an error.</p>
</dd>
<dt class="hdlist1">none</dt>
<dd>
<p>Keycloak does not require SSL.  This should really only be used in development when you are playing around with things and don&#8217;t want to bother
configuring SSL on your server.</p>
</dd>
<dt class="hdlist1">all requests</dt>
<dd>
<p>Keycloak requires SSL for all IP addresses.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_clear-cache"><a class="anchor" href="#_clear-cache"></a>Clearing Server Caches</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/realms/cache.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/realms/cache.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak will cache everything it can in memory within the limits of your JVM and/or the limits you&#8217;ve configured
it for.  If the Keycloak database is modified by a third party (i.e. a DBA) outside the scope of the server&#8217;s REST APIs or Admin Console
there&#8217;s a chance parts of the in-memory cache may be stale.  You can clear the realm cache, user cache or cache of external public keys (Public keys of
 external clients or Identity providers, which Keycloak usually uses to verify signatures of particular external entity) from the Admin Console by going
to the <code>Realm Settings</code> left menu item and the <code>Cache</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Cache tab</div>
<p><span class="image"><img src="./keycloak-images/cache-tab.png" alt="cache tab"></span></p>
</div>
<div class="paragraph">
<p>Just click the <code>clear</code> button on the cache you want to evict.</p>
</div>
</div>
<div class="sect2">
<h3 id="_email"><a class="anchor" href="#_email"></a>Email Settings</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/realms/email.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/realms/email.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak sends emails to users to verify their email address, when they forget their passwords, or when an admin needs to
receive notifications about a server event.
To enable Keycloak to send emails you need to provide Keycloak with your SMTP server settings.
This is configured per realm.  Go to the <code>Realm Settings</code> left menu
item and click the <code>Email</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Email Tab</div>
<p><span class="image"><img src="./keycloak-images/email-tab.png" alt="email tab"></span></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Host</dt>
<dd>
<p><code>Host</code> denotes the SMTP server hostname used for sending emails.</p>
</dd>
<dt class="hdlist1">Port</dt>
<dd>
<p><code>Port</code> denotes the SMTP server port.</p>
</dd>
<dt class="hdlist1">From</dt>
<dd>
<p><code>From</code> denotes the address used for the <code>From</code> SMTP-Header for the emails sent.</p>
</dd>
<dt class="hdlist1">From Display Name</dt>
<dd>
<p><code>From Display Name</code> allows to configure a user friendly email address aliases (optional). If not set the plain <code>From</code> email address will be displayed in email clients.</p>
</dd>
<dt class="hdlist1">Reply To</dt>
<dd>
<p><code>Reply To</code> denotes the address used for the <code>Reply-To</code> SMTP-Header for the mails sent (optional). If not set the plain <code>From</code> email address will be used.</p>
</dd>
<dt class="hdlist1">Reply To Display Name</dt>
<dd>
<p><code>Reply To Display Name</code> allows to configure a user friendly email address aliases (optional). If not set the plain <code>Reply To</code> email address will be displayed.</p>
</dd>
<dt class="hdlist1">Envelope From</dt>
<dd>
<p><code>Envelope From</code> denotes the <a href="https://en.wikipedia.org/wiki/Bounce_address">Bounce Address</a> used for the <code>Return-Path</code> SMTP-Header for the mails sent (optional).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>As emails are used for recovering usernames and passwords it&#8217;s recommended to use SSL or TLS, especially if the SMTP server is on an external network.
To enable SSL click on <code>Enable SSL</code> or to enable TLS click on <code>Enable TLS</code>.
You will most likely also need to change the <code>Port</code> (the default port for SSL/TLS is 465).</p>
</div>
<div class="paragraph">
<p>If your SMTP server requires authentication click on <code>Enable Authentication</code> and insert the <code>Username</code> and <code>Password</code>. The value of the <code>Password</code> field can refer a value from an external <a href="#_vault-administration">vault</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_themes"><a class="anchor" href="#_themes"></a>Themes and Internationalization</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/realms/themes.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/realms/themes.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Themes allow you to change the look and feel of any UI in Keycloak.  Themes are configured per realm.  To change
a theme go to the <code>Realm Settings</code> left menu item and click on the <code>Themes</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Themes Tab</div>
<p><span class="image"><img src="./keycloak-images/themes-tab.png" alt="themes tab"></span></p>
</div>
<div class="paragraph">
<p>Pick the theme you want for each UI category and click <code>Save</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Login Theme</dt>
<dd>
<p>Username password entry, OTP entry, new user registration, and other similar screens related to login.</p>
</dd>
<dt class="hdlist1">Account Theme</dt>
<dd>
<p>Each user has an User Account Management UI.</p>
</dd>
<dt class="hdlist1">Admin Console Theme</dt>
<dd>
<p>The skin of the Keycloak Admin Console.</p>
</dd>
<dt class="hdlist1">Email Theme</dt>
<dd>
<p>Whenever Keycloak has to send out an email, it uses templates defined in this theme to craft the email.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> goes into how to create a new themes or modify existing ones.</p>
</div>
<div class="sect3">
<h4 id="internationalization"><a class="anchor" href="#internationalization"></a>Internationalization</h4>
<div class="paragraph">
<p>Every UI screen is internationalized in Keycloak.  The default language is English, but if you turn on the
<code>Internationalization</code> switch on the <code>Theme</code> tab you can choose which locales you want to support and what the default locale
will be.  The next time a user logs in, they will be able to choose a language on the login page to use for the login screens,
User Account Management UI, and Admin Console.  The <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> explains
how you can offer additional languages. All internationalized texts which are provided by the theme can be overwritten
by realm-specific texts on the <code>Localization</code> tab.</p>
</div>
<div class="sect4">
<h5 id="_user_locale_selection"><a class="anchor" href="#_user_locale_selection"></a>User Locale selection</h5>
<div class="paragraph">
<p>In order to select the best possible locale for a user there is a locale selector provider that handles deciding what
is the best locale on the information available. One thing to note here is that it is not always known who the user is.
For this reason the previously authenticated users locale is remembered in a persisted cookie.</p>
</div>
<div class="paragraph">
<p>The logic for selecting the locale uses the first of the following that is available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User selected - when the user has selected a locale using the drop-down locale selector</p>
</li>
<li>
<p>User profile - when there is an authenticated user and the user has a preferred locale set</p>
</li>
<li>
<p>Client selected - passed by the client using for example ui_locales parameter</p>
</li>
<li>
<p>Cookie - last locale selected on the browser</p>
</li>
<li>
<p>Accepted language - locale from <code>Accept-Language</code> header</p>
</li>
<li>
<p>Realm default</p>
</li>
<li>
<p>If none of the above, fallback to English</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a user is authenticated an action is triggered to update the locale in the persisted cookie mentioned earlier. If the
user has actively switched the locale through the locale selector on the login pages the users locale is also updated at
this point.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user-management"><a class="anchor" href="#user-management"></a>User Management</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This section describes the administration functions for managing users.</p>
</div>
<div class="sect2">
<h3 id="searching-for-users"><a class="anchor" href="#searching-for-users"></a>Searching For Users</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/viewing.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/viewing.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If you need to manage a specific user, click on <code>Users</code> in the left menu bar.</p>
</div>
<div class="paragraph">
<div class="title">Users</div>
<p><span class="image"><img src="./keycloak-images/users.png" alt="users"></span></p>
</div>
<div class="paragraph">
<p>This menu option brings you to the user list page.  In the search box you can type in a full name, last name, or email address
you want to search for in the user database.  The query will bring up all users that match your criteria.  The <code>View all users</code> button
will list every user in the system.  This will search just local Keycloak database and not the federated database (ie. LDAP)
because some backends like LDAP don&#8217;t have a way to page through users. So if you want the users from federated backend to be synced into Keycloak
database you need to either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adjust search criteria. That will sync just the backend users matching the criteria into Keycloak database.</p>
</li>
<li>
<p>Go to <code>User Federation</code> tab and click <code>Sync all users</code> or <code>Sync changed users</code> in the page with your federation provider.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="#_user-storage-federation">User Federation</a> for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create-new-user"><a class="anchor" href="#_create-new-user"></a>Creating New Users</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/create-user.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/create-user.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>To create a user click on <code>Users</code> in the left menu bar.</p>
</div>
<div class="paragraph">
<div class="title">Users</div>
<p><span class="image"><img src="./keycloak-images/users.png" alt="users"></span></p>
</div>
<div class="paragraph">
<p>This menu option brings you to the user list page.  On the right side of the empty user list, you should see an <code>Add User</code>
button.  Click that to start creating your new user.</p>
</div>
<div class="paragraph">
<div class="title">Add User</div>
<p><span class="image"><img src="./keycloak-images/add-user.png" alt="add user"></span></p>
</div>
<div class="paragraph">
<p>The only required field is <code>Username</code>.  Click save.  This will bring you to the management page for your new user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_delete-user"><a class="anchor" href="#_delete-user"></a>Deleting Users</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/delete-user.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/delete-user.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>To delete a user click on <code>Users</code> in the left menu bar.</p>
</div>
<div class="paragraph">
<div class="title">Users</div>
<p><span class="image"><img src="./keycloak-images/users.png" alt="users"></span></p>
</div>
<div class="paragraph">
<p>This menu option brings you to the user list page. Click <code>View all users</code> or search to find the user you intend to delete.</p>
</div>
<div class="paragraph">
<div class="title">View All Users</div>
<p><span class="image"><img src="./keycloak-images/delete-user.png" alt="delete user"></span></p>
</div>
<div class="paragraph">
<p>In the list of users, click <code>Delete</code> next to the user you want to remove. You will be asked to confirm that you are sure you want to delete this user. Click <code>Delete</code> in the confirmation box to confirm.</p>
</div>
</div>
<div class="sect2">
<h3 id="_user-attributes"><a class="anchor" href="#_user-attributes"></a>User Attributes</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/attributes.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/attributes.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Beyond basic user metadata like name and email, you can store arbitrary user attributes.  Choose a user to manage
then click on the <code>Attributes</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Users</div>
<p><span class="image"><img src="./keycloak-images/user-attributes.png" alt="user attributes"></span></p>
</div>
<div class="paragraph">
<p>Enter in the attribute name and value in the empty fields and click the <code>Add</code> button next to it to add a new field.
Note that any edits you make on this page will not be stored until you hit the <code>Save</code> button.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some attributes that are read-only and are not supposed to be updated by the administrators. This includes attributes, which are read-only
by design like for example <code>LDAP_ID</code>, which is filled automatically by the LDAP provider. Some other attributes should be read-only for
typical user administrators due to security reasons. See the details in the <a href="#_read_only_user_attributes">Threat model mitigation chapter</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_user-credentials"><a class="anchor" href="#_user-credentials"></a>User Credentials</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/credentials.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/credentials.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When viewing a user if you go to the <code>Credentials</code> tab you can manage a user&#8217;s credentials.</p>
</div>
<div class="paragraph">
<div class="title">Credential Management</div>
<p><span class="image"><img src="./keycloak-images/user-credentials.png" alt="user credentials"></span></p>
</div>
<div class="paragraph">
<p>The credentials are listed in a table, which has the following fields:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Position</dt>
<dd>
<p>The arrow buttons in this column allows you to shift the priority of the credential for the user, with the topmost credential having the highest priority.
This priority determines which credential will be shown first to a user in case of a choice during login. The highest priority of those available to the
user will be the one selected.</p>
</dd>
<dt class="hdlist1">Type</dt>
<dd>
<p>This shows the type of the credential, for example <code>password</code> or <code>otp</code>.</p>
</dd>
<dt class="hdlist1">User Label</dt>
<dd>
<p>This is an assignable label to recognise the credential when presented as a selection option during login. It can be set to any value to describe the
credential.</p>
</dd>
<dt class="hdlist1">Data</dt>
<dd>
<p>This shows the non-confidential technical information about the credential. It is originally hidden, but you can press <code>Show data&#8230;&#8203;</code> to reveal it for a
credential.</p>
</dd>
<dt class="hdlist1">Actions</dt>
<dd>
<p>This column has two buttons. <code>Save</code> records the value of the User Label, while <code>Delete</code> will remove the credential.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="creating-a-password-for-the-user"><a class="anchor" href="#creating-a-password-for-the-user"></a>Creating a Password for the User</h4>
<div class="paragraph">
<p>If a user doesn&#8217;t have a password, or if the password has been deleted, the <code>Set Password</code> section will be shown on the page.</p>
</div>
<div class="paragraph">
<div class="title">Credential Management - Set Password</div>
<p><span class="image"><img src="./images/user-credentials-set-password.png" alt="user credentials set password"></span></p>
</div>
<div class="paragraph">
<p>To create a password for a user, type in a new one. Click on the <code>Set Password</code> button after you&#8217;ve typed everything in.
If the <code>Temporary</code> switch is on, this new password can only be used once and the user will be asked to change their password after they have
logged in.</p>
</div>
<div class="paragraph">
<p>If a user already has a password, it can be reset in the <code>Reset Password</code> section.</p>
</div>
<div class="paragraph">
<p>Alternatively, if you have <a href="#_email">email</a> set up, you can send an email to the user that asks
them to reset their password.  Choose <code>Update Password</code> from the <code>Reset Actions</code> list box and click <code>Send Email</code>. You can optionally
set the validity of the e-mail link which defaults to the one preset in <code>Tokens</code> tab in the realm settings.
The sent email contains a link that will bring the user to the update password screen.</p>
</div>
<div class="paragraph">
<p>Note that a user can only have a single credential of type password.</p>
</div>
</div>
<div class="sect3">
<h4 id="creating-other-credentials"><a class="anchor" href="#creating-other-credentials"></a>Creating other credentials</h4>
<div class="paragraph">
<p>You cannot configure other types of credentials for a specific user within the Admin Console. This is the responsibility of the user.
You can only delete credentials for a user on the <code>Credentials</code> tab, for example if the user has lost an OTP device, or if a credential
has been compromised.</p>
</div>
<div class="sect4">
<h5 id="creating-an-otp"><a class="anchor" href="#creating-an-otp"></a>Creating an OTP</h5>
<div class="paragraph">
<p>If OTP is conditional in your realm, the user will have to go to the User Account Management service to re-configure a new
OTP generator. If OTP is required, then the user will be asked
to re-configure a new OTP generator when they log in.</p>
</div>
<div class="paragraph">
<p>Like passwords, you can alternatively send an email to the user that will ask them to reset their OTP generator.  Choose
<code>Configure OTP</code> in the <code>Reset Actions</code> list box and click the <code>Send Email</code> button.  The sent email
contains a link that will bring the user to the OTP setup screen. You can use this method even if the user already has an OTP credential,
and would like to set up some more.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="required-actions"><a class="anchor" href="#required-actions"></a>Required Actions</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/required-actions.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/required-actions.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Required Actions are tasks that a user must finish before they are allowed to log in.  A user must provide their credentials before required actions are executed.  Once a required action is completed, the user will not have
to perform the action again.
Here are explanations of some of the built-in required action types:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Update Password</dt>
<dd>
<p>When set, a user must change their password.</p>
</dd>
<dt class="hdlist1">Configure OTP</dt>
<dd>
<p>When set, a user must configure a one-time password generator on their mobile device using either the Free OTP or Google Authenticator application.</p>
</dd>
<dt class="hdlist1">Verify Email</dt>
<dd>
<p>When set, a user must verify that they have a valid email account.  An email will be sent to the user with a link they have to click.  Once this workflow
is successfully completed, they will be allowed to log in.</p>
</dd>
<dt class="hdlist1">Update Profile</dt>
<dd>
<p>This required action asks the user to update their profile information, i.e. their name, address, email, and/or phone number.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Admins can add required actions for each individual user within the user&#8217;s <code>Details</code> tab in the Admin Console.</p>
</div>
<div class="paragraph">
<div class="title">Setting Required Action</div>
<p><span class="image"><img src="./keycloak-images/user-required-action.png" alt="user required action"></span></p>
</div>
<div class="paragraph">
<p>In the <code>Required User Actions</code> list box, select all the actions you want to add to the account.  If you want to remove one, click the <code>X</code> next to the
action name.  Also remember to click the <code>Save</code> button after you&#8217;ve decided what actions to add.</p>
</div>
<div class="sect3">
<h4 id="default-required-actions"><a class="anchor" href="#default-required-actions"></a>Default Required Actions</h4>
<div class="paragraph">
<p>You can also specify required actions that will be added to an account whenever a new user is created, i.e. through the <code>Add User</code> button the user
list screen, or via the <a href="#_user-registration">user registration</a> link on the login page.  To specify
the default required actions go to the <code>Authentication</code> left menu item and click on the <code>Required Actions</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Default Required Actions</div>
<p><span class="image"><img src="./keycloak-images/default-required-actions.png" alt="default required actions"></span></p>
</div>
<div class="paragraph">
<p>Simply click the checkbox in the <code>Default Action</code> column of the required actions that you want to be executed when a brand new user logs in.</p>
</div>
</div>
<div class="sect3">
<h4 id="terms-and-conditions"><a class="anchor" href="#terms-and-conditions"></a>Terms and Conditions</h4>
<div class="paragraph">
<p>Many organizations have a requirement that when a new user logs in for the first time, they need to agree to the terms and conditions
of the website.  Keycloak has this functionality implemented as a required action, but it requires some configuration.  For one, you
have to go to the <code>Required Actions</code> tab described earlier and enable the <code>Terms and Conditions</code> action.  You must also edit the
<em>terms.ftl</em> file in the <em>base</em> login theme.  See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for more information on extending and
creating themes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="impersonation"><a class="anchor" href="#impersonation"></a>Impersonation</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/impersonation.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/impersonation.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>It is often useful for an admin to impersonate a user.  For example, a user may be experiencing a bug in one of your applications and
an admin may want to impersonate the user to see if they can duplicate the problem.  Admins with the appropriate permission
can impersonate a user.  There are two locations an admin can initiate impersonation.  The first is on the <code>Users</code> list tab.</p>
</div>
<div class="paragraph">
<div class="title">Users</div>
<p><span class="image"><img src="./keycloak-images/user-search.png" alt="user search"></span></p>
</div>
<div class="paragraph">
<p>You can see here that the admin has searched for <code>john</code>.  Next to John&#8217;s account you can see an impersonate button.  Click that
to impersonate the user.</p>
</div>
<div class="paragraph">
<p>Also, you can impersonate the user from the user <code>Details</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">User Details</div>
<p><span class="image"><img src="./keycloak-images/user-details.png" alt="user details"></span></p>
</div>
<div class="paragraph">
<p>Near the bottom of the page you can see the <code>Impersonate</code> button.  Click that to impersonate the user.</p>
</div>
<div class="paragraph">
<p>When impersonating, if the admin and the user are in the same realm, then the admin will be logged out and automatically logged
in as the user being impersonated.  If the admin and user are not in the same realm, the admin will remain logged in, but additionally
be logged in as the user in that user&#8217;s realm.  In both cases, the browser will be redirected to the impersonated user&#8217;s User Account Management
page.</p>
</div>
<div class="paragraph">
<p>Any user with the realm&#8217;s <code>impersonation</code> role can impersonate a user.  Please see the <a href="#_admin_permissions">Admin Console Access Control</a> chapter
for more details on assigning administration permissions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_user-registration"><a class="anchor" href="#_user-registration"></a>User Registration</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/user-registration.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/user-registration.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can enable Keycloak to allow user self registration.  When enabled, the login page has a registration
link the user can click on to create their new account.</p>
</div>
<div class="paragraph">
<p>When user self registration is enabled it is possible to use the registration form to detect valid usernames and emails.
It is also possible to enable <a href="#_recaptcha">reCAPTCHA Support</a>.</p>
</div>
<div class="paragraph">
<p>Enabling registration is pretty simple.  Go to the
<code>Realm Settings</code> left menu and click it.  Then go to the <code>Login</code> tab.  There is a <code>User Registration</code> switch on this
tab.  Turn it on, then click the <code>Save</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Login Tab</div>
<p><span class="image"><img src="./keycloak-images/login-tab.png" alt="login tab"></span></p>
</div>
<div class="paragraph">
<p>After you enable this setting, a <code>Register</code> link should show up on the login page.</p>
</div>
<div class="paragraph">
<div class="title">Registration Link</div>
<p><span class="image"><img src="./keycloak-images/registration-link.png" alt="registration link"></span></p>
</div>
<div class="paragraph">
<p>Clicking on this link will bring the user to the registration page where they have to enter in some user profile information
and a new password.</p>
</div>
<div class="paragraph">
<div class="title">Registration Form</div>
<p><span class="image"><img src="./keycloak-images/registration-form.png" alt="registration form"></span></p>
</div>
<div class="paragraph">
<p>You can change the look and feel of the registration form as well as removing or adding additional fields that must be entered.
See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for more information.</p>
</div>
<div class="sect3">
<h4 id="_recaptcha"><a class="anchor" href="#_recaptcha"></a>reCAPTCHA Support</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/recaptcha.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/recaptcha.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>To safeguard registration against bots, Keycloak has integration with Google reCAPTCHA.
To enable this you need to first go to <a href="https://developers.google.com/recaptcha/">Google Recaptcha Website</a>
and create an API key so that you can get your reCAPTCHA site key and secret.
(FYI, localhost works by default so you don&#8217;t have to specify a domain).</p>
</div>
<div class="paragraph">
<p>Next, there are a few steps you need to perform in the Keycloak Admin Console.
Click the <code>Authentication</code> left menu item and go to the <code>Flows</code> tab.  Select the <code>Registration</code> flow from the drop down
list on this page.</p>
</div>
<div class="paragraph">
<div class="title">Registration Flow</div>
<p><span class="image"><img src="./keycloak-images/registration-flow.png" alt="registration flow"></span></p>
</div>
<div class="paragraph">
<p>Set the 'reCAPTCHA' requirement to <code>Required</code> by clicking the appropriate radio button.  This will enable
reCAPTCHA on the screen.  Next, you have to enter in the reCAPTCHA site key and secret that you generated at the Google reCAPTCHA Website.
Click on the 'Actions' button that is to the right of the reCAPTCHA flow entry, then "Config" link, and enter in the reCAPTCHA site key and secret on this config page.</p>
</div>
<div class="paragraph">
<div class="title">Recaptcha Config Page</div>
<p><span class="image"><img src="./keycloak-images/recaptcha-config.png" alt="recaptcha config"></span></p>
</div>
<div class="paragraph">
<p>The final step you have to do is to change some default HTTP response headers that Keycloak sets.  Keycloak
will prevent a website from including any login page within an iframe.  This is to prevent clickjacking attacks.  You need to
authorize Google to use the registration page within an iframe.  Go to
the <code>Realm Settings</code> left menu item and then go to the <code>Security Defenses</code> tab.  You will need to add <code>https://www.google.com</code> to the
values of both the <code>X-Frame-Options</code> and <code>Content-Security-Policy</code> headers.</p>
</div>
<div class="paragraph">
<div class="title">Authorizing Iframes</div>
<p><span class="image"><img src="./keycloak-images/security-headers.png" alt="security headers"></span></p>
</div>
<div class="paragraph">
<p>Once you do this, reCAPTCHA should show up on your registration page.  You may want to edit <em>register.ftl</em> in your login
theme to muck around with the placement and styling of the reCAPTCHA button.  See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a>
for more information on extending and creating themes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_personal_data"><a class="anchor" href="#_personal_data"></a>Personal data collected by Keycloak</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/personal_data.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/personal_data.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>By default, Keycloak collects the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Basic user profile, such as email, firstname, and lastname</p>
</li>
<li>
<p>Basic user profile used for social accounts and references to the social account when using a social login</p>
</li>
<li>
<p>Device information collected for audit and security purposes, such as the IP address, operating system name, and browser name</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The information collected in Keycloak is highly customizable.  Be aware of the following guidelines when making customizations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Registration and account forms could contain custom fields, such as birthday, gender, and nationality.  An administrator could configure Keycloak to retrieve that data from a social provider or a user storage provider such as LDAP.</p>
</li>
<li>
<p>Keycloak collects user credentials, such as password, OTP codes, and WebAuthn public keys. This information is encrypted and saved in a database, so it is not visible to Keycloak administrators. However, each type of credential can include non-confidential metadata that is visible to administrators such as the algorithm that is used to hash the password and the number of hash iterations used to hash the password.</p>
</li>
<li>
<p>With authorization services and UMA support enabled, Keycloak can hold information about some objects for which a particular user is the owner. For example, Keycloak can track that the user <strong>john</strong> is the owner of a photoalbum <strong>album with animals</strong> and a few photos called <strong>lion picture</strong> and <strong>cow picture</strong> in this album.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="enabling-account-deletion-by-users"><a class="anchor" href="#enabling-account-deletion-by-users"></a>Enabling account deletion by users</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/users/allow-user-to-delete-account.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/users/allow-user-to-delete-account.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak can allow applications end users to delete their account through the Account Console. The functionality is not enabled by default. To enable it, the following steps needs be taken:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enabling the "Delete Account" Required Action</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Allowing the user to delete their account is done through an AIA (Application Initiated Action). You need first of all to enable the action from the admin console. In the Authentication menu, go to the Required Actions tab and tick the enabled checkbox for the "Delete Account" action.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/enable-delete-account-action.png" alt="enable delete account action"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Making sure the user has the "delete-account" as a client role:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The delete account functionality is enabled on a per user basis. The second requirement to enable the delete account functionality is to make sure the user has the <code>delete-account</code> as a client role.</p>
</div>
<div class="paragraph">
<p>To enable the delete account role for a user, go to the Users menu, and find the user for which the delete account functionality is to be enabled. In the "Role Mappings" Tab, select the "account" client from "Clients Role" list.</p>
</div>
<div class="paragraph">
<p>Finally, select <code>delete-account</code> and click on add selected.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/delete-account-client-role.png" alt="delete account client role"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="deleting-a-user-in-action"><a class="anchor" href="#deleting-a-user-in-action"></a>Deleting a user in action</h3>
<div class="paragraph">
<p>Once the functionlity is enabled, the user will see a new section named "Delete Account" appear in the bottom of the "Personal Info" page</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/delete-account-landing-screen.png" alt="delete account landing screen"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/delete-account-page.png" alt="delete account page"></span></p>
</div>
<div class="paragraph">
<p>As stated by the warning message, this action is irreversible, and it implies the deletion of all the user&#8217;s data in Keycloak.</p>
</div>
<div class="paragraph">
<p>Once the user clicks on Delete, he will be prompted to enter his credentials again and redirected to the final confirmation step:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/delete-account-confirm.png" alt="delete account confirm"></span></p>
</div>
<div class="paragraph">
<p>After confirming, the user&#8217;s account will be deleted.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="login-page-settings"><a class="anchor" href="#login-page-settings"></a>Login Page Settings</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/login-settings.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/login-settings.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are several nice built-in login page features you can enable if you need the functionality.</p>
</div>
<div class="sect2">
<h3 id="forgot-password"><a class="anchor" href="#forgot-password"></a>Forgot Password</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/login-settings/forgot-password.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/login-settings/forgot-password.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If you enable it, users are able to reset their credentials if they forget their password or lose their OTP generator.
Go to the <code>Realm Settings</code> left menu item, and click on the <code>Login</code> tab.  Switch on the <code>Forgot Password</code> switch.</p>
</div>
<div class="paragraph">
<div class="title">Login Tab</div>
<p><span class="image"><img src="./keycloak-images/login-tab.png" alt="login tab"></span></p>
</div>
<div class="paragraph">
<p>A <code>forgot password</code> link will now show up on your login pages.</p>
</div>
<div class="paragraph">
<div class="title">Forgot Password Link</div>
<p><span class="image"><img src="./keycloak-images/forgot-password-link.png" alt="forgot password link"></span></p>
</div>
<div class="paragraph">
<p>Clicking on this link will bring the user
to a page where they can enter in their username or email and receive an email with a link to reset their credentials.</p>
</div>
<div class="paragraph">
<div class="title">Forgot Password Page</div>
<p><span class="image"><img src="./keycloak-images/forgot-password-page.png" alt="forgot password page"></span></p>
</div>
<div class="paragraph">
<p>The text sent in the email is completely configurable. You just need to extend or edit the theme associated with it.
See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for more information.</p>
</div>
<div class="paragraph">
<p>When the user clicks on the email link, they will be asked to update their password, and, if they have an OTP generator
set up, they will also be asked to reconfigure this as well.  Depending on the security requirements of your organization
you may not want users to be able to reset their OTP generator through email.  You can change this behavior by
going to the <code>Authentication</code> left menu item, clicking on the <code>Flows</code> tab, and selecting the <code>Reset Credentials</code> flow:</p>
</div>
<div class="paragraph">
<div class="title">Reset Credentials Flow</div>
<p><span class="image"><img src="./keycloak-images/reset-credentials-flow.png" alt="reset credentials flow"></span></p>
</div>
<div class="paragraph">
<p>If you do not want OTP reset, then just chose the <code>disabled</code> radio button to the right of <code>Reset OTP</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Be sure to leave Update Password enabled on the Required Actions tab.  Otherwise, Forgot Password does not work.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="remember-me"><a class="anchor" href="#remember-me"></a>Remember Me</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/login-settings/remember-me.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/login-settings/remember-me.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If a logged in user closes their browser, their session is destroyed and they will have to log in again.  You can set things
up so that if a user checks a <em>remember me</em> checkbox, they will remain logged in even if the browser is closed.  This basically
turns the login cookie from a session-only cookie to a persistence cookie.</p>
</div>
<div class="paragraph">
<p>To enable this feature go to <code>Realm Settings</code> left menu item and click on the <code>Login</code> tab and turn on the <code>Remember Me</code> switch:</p>
</div>
<div class="paragraph">
<div class="title">Login Tab</div>
<p><span class="image"><img src="./keycloak-images/login-tab.png" alt="login tab"></span></p>
</div>
<div class="paragraph">
<p>Once you save this setting, a <code>remember me</code> checkbox will be displayed on the realm&#8217;s login page.</p>
</div>
<div class="paragraph">
<div class="title">Remember Me</div>
<p><span class="image"><img src="./keycloak-images/remember-me.png" alt="remember me"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentication"><a class="anchor" href="#authentication"></a>Authentication</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/authentication.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/authentication.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a few features you should be aware of when configuring authentication for your realm.  Many organizations
have strict password and OTP policies that you can enforce via settings in the Admin Console.  You may or may not
want to require different credential types for authentication.  You may want to give users the option to login via
Kerberos or disable or enable various built-in credential types.  This chapter covers all of these topics.</p>
</div>
<div class="sect2">
<h3 id="_password-policies"><a class="anchor" href="#_password-policies"></a>Password Policies</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/authentication/password-policies.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/authentication/password-policies.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Each new realm created has no password policies associated with it.  Users can have as short, as long, as complex,
as insecure a password, as they want.  Simple settings are fine for development or learning Keycloak,
but unacceptable in production environments.  Keycloak has a rich set of password policies you can enable
through the Admin Console.</p>
</div>
<div class="paragraph">
<p>Click on the <code>Authentication</code> left menu item and go to the <code>Password Policy</code> tab.  Choose the policy you want to add in the
right side drop down list box.  This will add the policy in the table on the screen.  Choose the parameters for the policy.
Hit the <code>Save</code> button to store your changes.</p>
</div>
<div class="paragraph">
<div class="title">Password Policy</div>
<p><span class="image"><img src="./keycloak-images/password-policy.png" alt="password policy"></span></p>
</div>
<div class="paragraph">
<p>After saving your policy, user registration and the Update Password required action will enforce your new policy.  An example of a user
failing the policy check:</p>
</div>
<div class="paragraph">
<div class="title">Failed Password Policy</div>
<p><span class="image"><img src="./keycloak-images/failed-password-policy.png" alt="failed password policy"></span></p>
</div>
<div class="paragraph">
<p>If the password policy is updated, an Update Password action must be set for every user. An automatic trigger is scheduled as a future enhancement.</p>
</div>
<div class="sect3">
<h4 id="password-policy-types"><a class="anchor" href="#password-policy-types"></a>Password Policy Types</h4>
<div class="paragraph">
<p>Here&#8217;s an explanation of each policy type:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">HashAlgorithm</dt>
<dd>
<p>Passwords are not stored as clear text. Instead they are hashed using standard hashing algorithms before they are stored or validated.
The only built-in and default algorithm available is PBKDF2. See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a>
on how to plug in your own algorithm. Note that if you do change the algorithm, password hashes will not change in storage until
the next time the user logs in.</p>
</dd>
<dt class="hdlist1">Hashing Iterations</dt>
<dd>
<p>This value specifies the number of times a password will be hashed before it is stored or verified. The default value is 27,500.
This hashing is done in the rare case that a hacker gets access to your password database. Once they have access to the database,
they can reverse engineer user passwords.
The industry recommended value for this parameter changes every year as CPU power improves. A higher hashing iteration value takes more CPU power for hashing,
and can impact performance. You&#8217;ll have to weigh what is more important to you: performance or protecting your passwords stores.
There may be more cost effective ways of protecting your password stores.</p>
</dd>
<dt class="hdlist1">Digits</dt>
<dd>
<p>The number of digits required to be in the password string.</p>
</dd>
<dt class="hdlist1">Lowercase Characters</dt>
<dd>
<p>The number of lower case letters required to be in the password string.</p>
</dd>
<dt class="hdlist1">Uppercase Characters</dt>
<dd>
<p>The number of upper case letters required to be in the password string.</p>
</dd>
<dt class="hdlist1">Special Characters</dt>
<dd>
<p>The number of special characters like '?!#%$' required to be in the password string.</p>
</dd>
<dt class="hdlist1">Not Username</dt>
<dd>
<p>When set, the password is not allowed to be the same as the username.</p>
</dd>
<dt class="hdlist1">Not Email</dt>
<dd>
<p>When set, the password is not allowed to be the same as the email address.</p>
</dd>
<dt class="hdlist1">Regular Expression</dt>
<dd>
<p>Define one or more regular expression patterns (defined in <code>java.util.regex.Pattern</code>) that passwords must match.</p>
</dd>
<dt class="hdlist1">Expire Password</dt>
<dd>
<p>The number of days for which the password is valid. After the number of days has expired, the user is required to change their password.</p>
</dd>
<dt class="hdlist1">Not Recently Used</dt>
<dd>
<p>This policy saves a history of previous passwords. The number of old passwords stored is configurable. When a user changes their password
they cannot use any stored passwords.</p>
</dd>
<dt class="hdlist1">Password Blacklist</dt>
<dd>
<p>This policy checks if a given password (converted to lowercase) is contained in a blacklist file, which is potentially a very large file.
Password blacklists are UTF-8 plain-text files with Unix line endings where every line represents a blacklisted password.
All passwords in the blacklist must be lowercased to facilitate case-insensitive comparison.
The file name of the blacklist file must be provided as the password policy value, e.g. <code>10_million_password_list_top_1000000.txt</code>.
Blacklist files are resolved against <code>${jboss.server.data.dir}/password-blacklists/</code> by default.
This path can be customized via the <code>keycloak.password.blacklists.path</code> system property,
or the <code>blacklistsPath</code> property of the <code>passwordBlacklist</code> policy SPI configuration.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="otp-policies"><a class="anchor" href="#otp-policies"></a>OTP Policies</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/authentication/otp-policies.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/authentication/otp-policies.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak has a number of policies you can set up for your FreeOTP or Google Authenticator One-Time Password
generator.  Click on the <code>Authentication</code> left menu item and go to the <code>OTP Policy</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">OTP Policy</div>
<p><span class="image"><img src="./keycloak-images/otp-policy.png" alt="otp policy"></span></p>
</div>
<div class="paragraph">
<p>Any policies you set here will be used to validate one-time passwords.  When configuring OTP, FreeOTP and Google Authenticator
can scan a QR code that is generated on the OTP set up page that Keycloak has.  The bar code is also
generated from information configured on the <code>OTP Policy</code> tab.</p>
</div>
<div class="sect3">
<h4 id="totp-vs-hotp"><a class="anchor" href="#totp-vs-hotp"></a>TOTP vs. HOTP</h4>
<div class="paragraph">
<p>There are two different algorithms to choose from for your OTP generators.  Time Based (TOTP) and Counter Based (HOTP).
For TOTP, your token generator will hash the current time and a shared secret.  The server validates the OTP by comparing
all the hashes within a certain window of time to the submitted value.  So, TOTPs are valid only for a short window of time (usually 30 seconds).
For HOTP a shared counter is used instead of the current time.  The server increments the counter with each successful OTP login.  So, valid OTPs only
change after a successful login.</p>
</div>
<div class="paragraph">
<p>TOTP is considered a little more secure because the matchable OTP is only valid for a short window of time while the OTP for HOTP can
be valid for an indeterminate amount of time.  HOTP is much more user friendly as the user won&#8217;t have to hurry to enter in their
OTP before the time interval is up.  With the way Keycloak has implemented TOTP this distinction becomes a little more
blurry.  HOTP requires a database update every time the server wants to increment the counter.  This can be a performance drain
on the authentication server when there is heavy load.  So, to provide a more efficient alternative, TOTP does not remember passwords
used.  This bypasses the need to do any DB updates, but the downside is that TOTPs can be re-used in the valid time interval.  For future
versions of Keycloak it is planned that you will be able to configure whether TOTP checks older OTPs in the time interval.</p>
</div>
</div>
<div class="sect3">
<h4 id="totp-configuration-options"><a class="anchor" href="#totp-configuration-options"></a>TOTP Configuration Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">OTP Hash Algorithm</dt>
<dd>
<p>Default is SHA1, more secure options are SHA256 and SHA512.</p>
</dd>
<dt class="hdlist1">Number of Digits</dt>
<dd>
<p>How many characters is the OTP?  Short means more user friendly as it is less the user has to type.  More means more security.</p>
</dd>
<dt class="hdlist1">Look Ahead Window</dt>
<dd>
<p>How many intervals ahead should the server try and match the hash?  This exists so just in case the clock of the TOTP generator
or authentication server get out of sync.  The default value of 1 is usually good enough.  For example, if the time interval
for a new token is every 30 seconds, the default value of 1 means that it will only accept valid tokens in that 30 second window.
Each increment of this config value will increase the valid window by 30 seconds.</p>
</dd>
<dt class="hdlist1">OTP Token Period</dt>
<dd>
<p>Time interval in seconds during which the server will match a hash. Each time the interval passes, a new TOTP will be generated by the token generator.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="hotp-configuration-options"><a class="anchor" href="#hotp-configuration-options"></a>HOTP Configuration Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">OTP Hash Algorithm</dt>
<dd>
<p>Default is SHA1, more secure options are SHA256 and SHA512.</p>
</dd>
<dt class="hdlist1">Number of Digits</dt>
<dd>
<p>How many characters is the OTP?  Short means more user friendly as it is less the user has to type.  More means more security.</p>
</dd>
<dt class="hdlist1">Look Ahead Window</dt>
<dd>
<p>How many counters ahead should the server try and match the hash?  The default value is 1.  This exists to cover the case
where the user&#8217;s counter gets ahead of the server&#8217;s.  This can often happen as users often increment the counter
manually too many times by accident.  This value really should be increased to a value of 10 or so.</p>
</dd>
<dt class="hdlist1">Initial Counter</dt>
<dd>
<p>What is the value of the initial counter?</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_authentication-flows"><a class="anchor" href="#_authentication-flows"></a>Authentication Flows</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/authentication/flows.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/authentication/flows.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>An <em>authentication flow</em> is a container for all authentications, screens, and actions that must happen during login, registration, and other
Keycloak workflows.
If you go to the admin console <code>Authentication</code> left menu item and go to the <code>Flows</code> tab, you can view all the defined flows
in the system and what actions and checks each flow requires.</p>
</div>
<div class="sect3">
<h4 id="built-in-flows"><a class="anchor" href="#built-in-flows"></a>Built-in flows</h4>
<div class="paragraph">
<p>Keycloak comes with a certain number of built-in flows. These flows cannot be modified, but the requirements can be modified to
suit your needs.</p>
</div>
<div class="paragraph">
<p>This section does a walk-through of the built-in browser login flow.  In the
left drop-down list select <code>browser</code> to come to the screen shown below:</p>
</div>
<div class="paragraph">
<div class="title">Browser Flow</div>
<p><span class="image"><img src="./keycloak-images/browser-flow.png" alt="browser flow"></span></p>
</div>
<div class="paragraph">
<p>If you hover over the tooltip (the tiny question mark) to the right of the flow selection list, this will describe what the
flow is and does.</p>
</div>
<div class="paragraph">
<p>The <code>Auth Type</code> column is the name of authentication or action that will be executed.  If an authentication is indented
this means it is in a sub-flow and may or may not be executed depending on the behavior of its parent. The <code>Requirement</code>
column is a set of radio buttons which define whether or not the action will execute. Let&#8217;s describe what each radio
button means in this context.</p>
</div>
<div class="sect4">
<h5 id="_execution-requirements"><a class="anchor" href="#_execution-requirements"></a>Execution requirements</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">Required</dt>
<dd>
<p>For a flow to be evaluated as successful, all required elements in the flow must evaluate as successful. This means that all <em>Required</em> elements in the flow
must be sequentially executed, from top to bottom, unless one of the elements causes the flow to fail. However, this is only true for the current flow.
Any <em>Required</em> element within a sub-flow is only processed if that sub-flow is entered.</p>
</dd>
<dt class="hdlist1">Alternative</dt>
<dd>
<p>When a flow contains only <em>Alternative</em> elements, only a single element must evaluate as successful for the flow to evaluate as successful.
Because the <em>Required</em> flow elements within a flow are sufficient to mark a flow as successful, any <em>Alternative</em> flow element within a flow
that contains <em>Required</em> flow elements will never be executed. In this case, they are functionally <em>Disabled</em>.</p>
</dd>
<dt class="hdlist1">Disabled</dt>
<dd>
<p>Any <em>Disabled</em> element is not evaluated and does not count to mark a flow as successful.</p>
</dd>
<dt class="hdlist1">Conditional</dt>
<dd>
<p>This requirement type can only be set on sub-flows. A <em>Conditional</em> sub-flow can contain a "Condition" execution. These "Condition" executions must evaluate as
logical statements. If all "Condition" executions evaluate as <em>true</em> then the <em>Conditional</em> sub-flow acts as <em>Required</em>. If not, the <em>Conditional</em> sub-flow
acts as <em>Disabled</em>. If no "Condition" execution is set, the <em>Conditional</em> sub-flow acts as <em>Disabled</em>. If a flow contains "Condition" executions and is not set to
<em>Conditional</em>, the "Condition" executions are not evaluated, and can be considered functionally <em>Disabled</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This is better described in an example.  Let&#8217;s walk through the <code>browser</code> authentication flow.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The first authentication type is <code>Cookie</code>.  When a user successfully logs in for the first time, a session cookie is set.
If this cookie has already been set, then this authentication type is successful. In this case,
since the cookie provider returned success and each execution at this level of the flow is <em>alternative</em>, no other execution is executed and this results in a successful login.</p>
</li>
<li>
<p>The second execution of the flow looks at the <code>Kerberos</code> execution.  This authenticator is disabled by default and will be skipped.</p>
</li>
<li>
<p>The third execution is the <code>Identity Provider Redirector</code>. It can be configured through the <code>Actions</code> &gt; <code>Config</code> link to automatically redirect to another IdP for <a href="#_identity_broker">identity brokering</a>.</p>
</li>
<li>
<p>The next execution is a sub-flow called <code>Forms</code>.  Since this sub-flow is marked as <em>alternative</em> it will not be executed if the <code>Cookie</code> authentication type passed.
This sub-flow contains additional authentication type that needs to be executed.
The executions for this sub-flow are loaded and the same processing logic occurs.</p>
</li>
<li>
<p>The first execution in the Forms sub-flow is the <code>Username Password Form</code>.  This authentication type renders the username and password page.
It is marked as <em>required</em> so the user must enter in a valid username and password.</p>
</li>
<li>
<p>The second execution in the Forms sub-flow is a new sub-flow: the <code>Browser - Conditional OTP</code> sub-flow. Since this sub-flow is <em>conditional</em>, whether it is executed depends on the result of the
evaluation of the <code>Condition - User Configured</code> execution. If it is, the executions for this sub-flow are loaded and the same processing logic occurs</p>
</li>
<li>
<p>The next execution is the <code>Condition - User Configured</code>. This checks if the other executions in the flow are configured for the user.
Meaning that the <code>Browser - Conditional OTP</code> sub-flow will only be executed if the user has an OTP credential configured.</p>
</li>
<li>
<p>The final execution is the <code>OTP Form</code>. This is marked as <em>required</em>, but because of the setup in the <em>conditional</em> subflow, it will only be run if the user
has an OTP credential set up. If he doesn&#8217;t, the user will not see an OTP form.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="creating-flows"><a class="anchor" href="#creating-flows"></a>Creating flows</h4>
<div class="paragraph">
<p>This section explains in greater depth how flows work, and how to create your own flows. Note that there are important functionality and security
considerations when designing your own flow. A badly created flow could either let no one log in, let users in with less verification than you would
like, or simply result in an error.</p>
</div>
<div class="paragraph">
<p>To create a flow, you can either:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy and then modify an existing flow. To do this select an existing flow (for example the <code>Browser</code> flow), and press the <code>Copy</code> button.
This will then ask you to set a name for the new flow, before creating it.</p>
</li>
<li>
<p>Create a new flow from scratch. To do this press the <code>New</code> button. Since this is the more general case, we will use this for our example.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When creating a new flow, you will have to create a top level flow</p>
</div>
<div class="paragraph">
<div class="title">Create a top level flow</div>
<p><span class="image"><img src="./keycloak-images/Create-top-level-flow.png" alt="Create top level flow"></span></p>
</div>
<div class="paragraph">
<p>With the following options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Alias</dt>
<dd>
<p>The name of the flow.</p>
</dd>
<dt class="hdlist1">Description</dt>
<dd>
<p>The description you can set to the flow.</p>
</dd>
<dt class="hdlist1">Top Level Flow Type</dt>
<dd>
<p>The type of flow. The type <code>client</code> is used only for the authentication of clients (applications). For all other cases choose <code>generic</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Once the flow is created, in addition to the <code>New</code> and <code>Copy</code> buttons, you now have, <code>Delete</code>, <code>Add execution</code> and <code>Add flow</code>.</p>
</div>
<div class="paragraph">
<div class="title">An empty new flow</div>
<p><span class="image"><img src="./keycloak-images/New-flow.png" alt="New flow"></span></p>
</div>
<div class="paragraph">
<p>What a flow finally does is determined by the structure of the flow and sub-flows, the executions in those flows, and the requirements set on the
sub-flows and the executions.</p>
</div>
<div class="paragraph">
<p>Executions can be added with the <code>Add execution</code> button. Executions can have a wide variety of actions, from sending a reset email to validating an OTP. If you hover over the
tooltip (the tiny question mark) next to <code>Provider</code>, this will describe what the execution does.</p>
</div>
<div class="paragraph">
<div class="title">Adding an authentication execution</div>
<p><span class="image"><img src="./keycloak-images/Create-authentication-execution.png" alt="Create authentication execution"></span></p>
</div>
<div class="paragraph">
<p>These can be divided into <em>automatic executions</em> and <em>interactive executions</em>. <em>Automatic executions</em> are similar to the <code>Cookie</code> execution, and will automatically
perform their action when they are encountered in the flow. <em>Interactive executions</em> will halt the flow, usually to get some user input. Executions that execute
successfully will get the <em>success</em> status. This is important, because this is part of whether a flow is successful or not. For example, an empty <code>Browser</code> flow
would not allow anyone to log in. For that it would need at least one execution that successfully evaluates, for example a <code>Username Password Form</code> that is correctly
filled and submitted.</p>
</div>
<div class="paragraph">
<p>Sub-flows can be added in top level flow with the <code>Add flow</code> button, which opens a <code>Create Execution Flow</code> page that is very similar to the <code>Create Top Level Form</code>
page. The only difference is that the <code>Flow Type</code> can be either <code>generic</code> (like before), or <code>form</code>. The <code>form</code> type is used to construct a sub-flow that generates
a single form for the user, like what is done for the built-in <code>Registration</code> flow. Sub-flows are a special type of execution that evaluate as successful
depending on how the executions they contain evaluate (and this includes the evaluation of their contained sub-flows). And the logic of this evaluation
depends on the Requirement of each execution and sub-flow.</p>
</div>
<div class="paragraph">
<p>Fully understanding this requires a more complete explanation of how requirements work when evaluating a flow, and this also applies to sub-flows.
Refer to the <a href="#_execution-requirements">execution requirements section</a> above for more details.</p>
</div>
<div class="paragraph">
<p>Note that after adding an execution, you should check that the Requirement is set to the correct value. Even if there is only a single possible Requirement, it
can happen that it is not set.</p>
</div>
<div class="paragraph">
<p>When constructing a flow, all elements added to the flow will have an <code>Actions</code> menu on the right-hand side. All elements added to the flow have a <code>Delete</code>
option in this menu to remove it from the flow. Executions can contain a <code>Config</code> menu option to configure the execution, as is the case for the
<code>Identity Provider Redirector</code>. Sub-flows can also have executions and sub-flows added to them, with their <code>Add execution</code> and <code>Add flow</code> menu options.</p>
</div>
<div class="paragraph">
<p>Finally, since the order of execution is important, you can move executions and sub-flows up and down within their respective flows with the up and down buttons
that are set to left of their name.</p>
</div>
</div>
<div class="sect3">
<h4 id="creating-a-password-less-browser-login-flow"><a class="anchor" href="#creating-a-password-less-browser-login-flow"></a>Creating a password-less browser login flow</h4>
<div class="paragraph">
<p>To illustrate the creation of flows, this section describes the creation of a more advanced browser login flow. The purpose of this flow is to allow a
user to choose between logging in in a password-less manner using <a href="#_webauthn">WebAuthn</a>, and a two-factor authentication with password and OTP.
The flow to create is similar to the standard browser login, but diverges when reaching the username selection. Instead of copying the flow however, you&#8217;ll be
creating the flow from the start:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Select a realm, click on Authentication link</p>
</li>
<li>
<p>Select "new", and give the new flow a distinctive Alias, i.e. "Browser Password-less"</p>
</li>
<li>
<p>Select "Add execution", and using the drop-down select "Cookie". After pressing "Save", set its Requirement to <em>Alternative</em>.</p>
</li>
<li>
<p>Select "Add execution", and using the drop-down select "Kerberos".</p>
</li>
<li>
<p>Select "Add execution", and using the drop-down select "Identity Provider Redirector". After pressing "Save", set its Requirement to <em>Alternative</em>.</p>
</li>
<li>
<p>Select "Add flow", and choose an representative Alias, e.g. "Forms". After pressing "Save", set its Requirement to <em>Alternative</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">The common part with the browser flow</div>
<p><span class="image"><img src="./images/Passwordless-browser-login-common.png" alt="Passwordless browser login common"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the <code>Actions</code> menu on the right-hand side of the "Forms" subflow, select "Add execution". Using the drop-down select
"Username Form". After pressing "Save", set its Requirement to <em>Required</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Username form is similar to "Browser" flow&#8217;s Username Password Form, but only asks for a username, allowing a user to perform a password-less login.
However, note that this inevitably allows a user enumeration attack on your Keycloak server. This is an unavoidable security risk for the convenience,
so the flow should make sure that an attacker cannot just have to guess a password to be able to enter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the <code>Actions</code> menu on the right-hand side of the "Forms" subflow, select "Add flow". Choose an representative Alias, e.g. "Authentication".
After pressing "Save", set its Requirement to <em>Required</em>.</p>
</li>
<li>
<p>Using the <code>Actions</code> menu on the right-hand side of the "Authentication" subflow, select "Add execution". Using the drop-down select
"Webauthn Passwordless Authenticator". After pressing "Save", set its Requirement to <em>Alternative</em>.</p>
</li>
<li>
<p>Using the <code>Actions</code> menu on the right-hand side of the "Authentication" subflow, select "Add flow". Choose an representative Alias, e.g. "Password with OTP".
After pressing "Save", set its Requirement to <em>Alternative</em>.</p>
</li>
<li>
<p>Using the <code>Actions</code> menu on the right-hand side of the "Password with OTP" subflow, select "Add execution". Using the drop-down select
"Password Form". After pressing "Save", set its Requirement to Required.</p>
</li>
<li>
<p>Using the <code>Actions</code> menu on the right-hand side of the "Password with OTP" subflow, select "Add execution". Using the drop-down select
"OTP Form". After pressing "Save", set its Requirement to Required.</p>
</li>
<li>
<p>In the "Bindings" menu, change the browser flow from "Browser" to "Browser Password-less"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The final flow that is produced is the following:</p>
</div>
<div class="paragraph">
<div class="title">A password-less browser login</div>
<p><span class="image"><img src="./images/Passwordless-browser-login.png" alt="Passwordless browser login"></span></p>
</div>
<div class="paragraph">
<p>After entering the username, the way this flow works is the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the user has any WebAuthn passwordless credentials recorded, that user will be able to use any of them to log in directly. This is the password-less login.
The user can instead select "Password with OTP". The user can do this because the "WebAuthn Passwordless" execution and the "Password with OTP"
flow are set to <em>Alternative</em>. Were they set to <em>Required</em> the user would have to enter WebAuthn, password, and OTP.</p>
</li>
<li>
<p>If the user selects <code>Try another way</code> link on the screen with "WebAuthn passwordless" authentication, the user can choose between "Password" and
"Security Key" (WebAuthn passwordless). When selecting the password, the user will need to continue and log in with the assigned OTP as well.
If the user has no WebAuthn credentials, he will have to first enter his
password, and then his OTP. If the user has no OTP credential, he will be asked to record one.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is important to note that since the WebAuthn Passwordless execution is set to <em>Alternative</em> instead of <em>Required</em>, this flow will never ask the user to register a WebAuthn credential. For a user
to have a Webauthn credential, that user must have a required action added by an administrator. This is done first by making sure that the <code>Webauthn Register Passwordless</code>
required action is enabled in the realm (see the <a href="#_webauthn">WebAuthn</a> documentation), and then by setting the required action by using the <code>Credential Reset</code> part of a
user&#8217;s <a href="#_user-credentials">Credentials</a> management menu.</p>
</div>
<div class="paragraph">
<p>Creating a more advanced flow such as this one can have some subtle side effects. For example, if you were to enable the ability to reset the password
for the user, then this would be accessible from the password form. In the default "Reset Credentials" flow, the user has to enter his username. Since
he&#8217;s already entered his username earlier in the "Browser Password-less" flow, this would be unnecessary for Keycloak, and a sub-optimal in terms of user
experience. To correct this, you could:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Copy the "Reset Credentials" flow, setting its name to, for example "Reset Credentials for password-less"</p>
</li>
<li>
<p>Use the <code>Actions</code> menu on the right-hand side of the "Choose user" execution, select "Delete"</p>
</li>
<li>
<p>In the "Bindings" menu, change the reset credential flow from "Reset Credentials" to "Reset Credentials for password-less"</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="script-authenticator"><a class="anchor" href="#script-authenticator"></a>Script Authenticator</h3>
<div class="paragraph">
<p>Ability to upload scripts through the Admin Console and REST endpoints is deprecated.</p>
</div>
<div class="paragraph">
<p>For more details see <a href="https://www.keycloak.org/docs/12.0/server_development/#_script_providers">JavaScript Providers</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kerberos"><a class="anchor" href="#_kerberos"></a>Kerberos</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/authentication/kerberos.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/authentication/kerberos.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak supports login with a Kerberos ticket through the SPNEGO protocol.
SPNEGO (Simple and Protected GSSAPI Negotiation Mechanism) is used to authenticate transparently through the web browser after the user
has been authenticated when logging-in his session.
For non-web cases or when ticket is not available during login, Keycloak also supports login with Kerberos username/password.</p>
</div>
<div class="paragraph">
<p>A typical use case for web authentication is the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User logs into his desktop (Such as a Windows machine in Active Directory domain or Linux machine with Kerberos integration enabled).</p>
</li>
<li>
<p>User then uses his browser (IE/Firefox/Chrome) to access a web application secured by Keycloak.</p>
</li>
<li>
<p>Application redirects to Keycloak login.</p>
</li>
<li>
<p>Keycloak renders HTML login screen together with status 401 and HTTP header <code>WWW-Authenticate: Negotiate</code></p>
</li>
<li>
<p>In case that the browser has Kerberos ticket from desktop login, it transfers the desktop sign on information to the Keycloak
in header <code>Authorization: Negotiate 'spnego-token'</code> . Otherwise it just displays the login screen.</p>
</li>
<li>
<p>Keycloak validates token from the browser and authenticates the user.
It provisions user data from LDAP (in case of LDAPFederationProvider with Kerberos authentication support) or let user
to update his profile and prefill data (in case of KerberosFederationProvider).</p>
</li>
<li>
<p>Keycloak returns back to the application.
Communication between Keycloak and application happens through OpenID Connect or SAML messages.
The fact that Keycloak was authenticated through Kerberos is hidden from the application.
So Keycloak acts as broker to Kerberos/SPNEGO login.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For setup there are 3 main parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setup and configuration of Kerberos server (KDC)</p>
</li>
<li>
<p>Setup and configuration of Keycloak server</p>
</li>
<li>
<p>Setup and configuration of client machines</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="setup-of-kerberos-server"><a class="anchor" href="#setup-of-kerberos-server"></a>Setup of Kerberos server</h4>
<div class="paragraph">
<p>This is platform dependent.
Exact steps depend on your OS and the Kerberos vendor you&#8217;re going to use.
Consult Windows Active Directory, MIT Kerberos and your OS documentation for how exactly to setup and configure Kerberos server.</p>
</div>
<div class="paragraph">
<p>At least you will need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add some user principals to your Kerberos database.
You can also integrate your Kerberos with LDAP, which means that user accounts will be provisioned from LDAP server.</p>
</li>
<li>
<p>Add service principal for "HTTP" service.
For example if your Keycloak server will be running on <code>www.mydomain.org</code> you may need to add principal <code>HTTP/www.mydomain.org@MYDOMAIN.ORG</code>
assuming that MYDOMAIN.ORG will be your Kerberos realm.</p>
<div class="paragraph">
<p>For example on MIT Kerberos you can run a "kadmin" session.
If you are on the same machine where is MIT Kerberos, you can simply use the command:</p>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo kadmin.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add HTTP principal and export his key to a keytab file with the commands like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>addprinc -randkey HTTP/www.mydomain.org@MYDOMAIN.ORG
ktadd -k /tmp/http.keytab HTTP/www.mydomain.org@MYDOMAIN.ORG</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Keytab file <code>/tmp/http.keytab</code> will need to be accessible on the host where Keycloak server will be running.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-and-configuration-of-keycloak-server"><a class="anchor" href="#setup-and-configuration-of-keycloak-server"></a>Setup and configuration of Keycloak server</h4>
<div class="paragraph">
<p>You need to install a kerberos client on your machine.  This is also platform dependent.
If you are on Fedora, Ubuntu or RHEL, you can install the package <code>freeipa-client</code>, which contains a Kerberos client and several other utilities.
Configure the kerberos client (on Linux it&#8217;s in file <code>/etc/krb5.conf</code> ). You need to put your Kerberos realm and at least configure the HTTP domains your server will be running on.
For the example realm MYDOMAIN.ORG you may configure the <code>domain_realm</code> section like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[domain_realm]
  .mydomain.org = MYDOMAIN.ORG
  mydomain.org = MYDOMAIN.ORG</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next you need to export the keytab file with the HTTP principal and make sure the file is accessible to the process under which Keycloak server is running.
For production, it&#8217;s ideal if it&#8217;s readable just by this process and not by someone else.
For the MIT Kerberos example above, we already exported keytab to <code>/tmp/http.keytab</code> . If your KDC and Keycloak are running on same host,
you have that file already available.</p>
</div>
<div class="sect4">
<h5 id="enable-spnego-processing"><a class="anchor" href="#enable-spnego-processing"></a>Enable SPNEGO Processing</h5>
<div class="paragraph">
<p>Keycloak does not have the SPNEGO protocol support turned on by default.  So, you have to go to the <a href="#_authentication-flows">browser flow</a>
and enable <code>Kerberos</code>.</p>
</div>
<div class="paragraph">
<div class="title">Browser Flow</div>
<p><span class="image"><img src="./keycloak-images/browser-flow.png" alt="browser flow"></span></p>
</div>
<div class="paragraph">
<p>Switch the <code>Kerberos</code> requirement from <em>disabled</em> to either <em>alternative</em> or <em>required</em>.  <em>Alternative</em> basically means that Kerberos is optional.  If
the user&#8217;s browser hasn&#8217;t been configured to work with SPNEGO/Kerberos, then Keycloak will fall back to the regular login screens.  If you set the requirement
to <em>required</em> then all users must have Kerberos enabled for their browser.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-kerberos-user-storage-federation-provider"><a class="anchor" href="#configure-kerberos-user-storage-federation-provider"></a>Configure Kerberos User Storage Federation Provider</h5>
<div class="paragraph">
<p>Now that the SPNEGO protocol is turned on at the authentication server, you&#8217;ll need to configure how Keycloak interprets the Kerberos ticket.
This is done through <a href="#_user-storage-federation">User Storage Federation</a>. We have 2 different federation providers with Kerberos authentication support.</p>
</div>
<div class="paragraph">
<p>If you want to authenticate with Kerberos backed by an LDAP server, you have to first configure the <a href="#_ldap">LDAP Federation Provider</a>.
If you look at the configuration page for your LDAP provider you&#8217;ll see a <code>Kerberos Integration</code> section.</p>
</div>
<div class="paragraph">
<div class="title">LDAP Kerberos Integration</div>
<p><span class="image"><img src="./keycloak-images/ldap-kerberos.png" alt="ldap kerberos"></span></p>
</div>
<div class="paragraph">
<p>Turning on the switch <code>Allow Kerberos authentication</code> will make Keycloak use the Kerberos principal to lookup information about the user so that it can
be imported into the Keycloak environment.</p>
</div>
<div class="paragraph">
<p>If your Kerberos solution is not backed by an LDAP server, you have to use the <code>Kerberos</code> User Storage Federation Provider.  Go to the <code>User Federation</code>
left menu item and select <code>Kerberos</code> from the <code>Add provider</code> select box.</p>
</div>
<div class="paragraph">
<div class="title">Kerberos User Storage Provider</div>
<p><span class="image"><img src="./keycloak-images/kerberos-provider.png" alt="kerberos provider"></span></p>
</div>
<div class="paragraph">
<p>This provider parses the Kerberos ticket for simple principal information and does a small import into the local Keycloak database.
User profile information like first name, last name, and email are not provisioned.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup-and-configuration-of-client-machines"><a class="anchor" href="#setup-and-configuration-of-client-machines"></a>Setup and configuration of client machines</h4>
<div class="paragraph">
<p>Clients need to install kerberos client and setup krb5.conf as described above.
Additionally they need to enable SPNEGO login support in their browser.
See <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/configuring_applications_for_sso">configuring Firefox for Kerberos</a> if you are using that browser.
URI <code>.mydomain.org</code> must be allowed in the <code>network.negotiate-auth.trusted-uris</code> config option.</p>
</div>
<div class="paragraph">
<p>In a Windows domain, clients usually don&#8217;t need to configure anything special as IE is already able to participate in SPNEGO authentication for the Windows domain.</p>
</div>
</div>
<div class="sect3">
<h4 id="example-setups"><a class="anchor" href="#example-setups"></a>Example setups</h4>
<div class="paragraph">
<p>For easier testing with Kerberos, we provided some example setups to test.</p>
</div>
<div class="sect4">
<h5 id="keycloak-and-freeipa-docker-image"><a class="anchor" href="#keycloak-and-freeipa-docker-image"></a>Keycloak and FreeIPA docker image</h5>
<div class="paragraph">
<p>Once you install <a href="https://www.docker.com/">docker</a>, you can run docker image with FreeIPA server installed.
FreeIPA provides integrated security solution with MIT Kerberos and 389 LDAP server among other things . The image provides also Keycloak
server configured with LDAP Federation provider and enabled SPNEGO/Kerberos authentication against the FreeIPA server.
See details <a href="https://github.com/mposolda/keycloak-freeipa-docker/blob/master/README.md">here</a> .</p>
</div>
</div>
<div class="sect4">
<h5 id="apacheds-testing-kerberos-server"><a class="anchor" href="#apacheds-testing-kerberos-server"></a>ApacheDS testing Kerberos server</h5>
<div class="paragraph">
<p>For quick testing and unit tests, we use a very simple <a href="http://directory.apache.org/apacheds/">ApacheDS</a> Kerberos server.
You need to build Keycloak from sources and then run the Kerberos server with maven-exec-plugin from our testsuite.
See details <a href="https://github.com/keycloak/keycloak/blob/master/docs/tests.md#kerberos-server">here</a> .</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="credential-delegation"><a class="anchor" href="#credential-delegation"></a>Credential Delegation</h4>
<div class="paragraph">
<p>Kerberos 5 supports the concept of credential delegation.  In this scenario, your applications may want access to the Kerberos ticket so that
they can re-use it to interact with other services secured by Kerberos.  Since the SPNEGO protocol is processed in the Keycloak server,
you have to propagate the GSS credential to your application
within the  OpenID Connect token claim or a SAML assertion attribute that is transmitted to your application from the Keycloak server.
To have this claim inserted into the token or assertion, each application will need to enable the built-in protocol mapper called <code>gss delegation credential</code>.
This is enabled in the <code>Mappers</code> tab of the application&#8217;s
client page.  See <a href="#_protocol-mappers">Protocol Mappers</a> chapter for more details.</p>
</div>
<div class="paragraph">
<p>Applications will need to deserialize the claim it receives from Keycloak before it can use it to make GSS calls against other services.
Once you deserialize the credential from the access token to the GSSCredential object, the GSSContext will need to be created with this credential
passed to the method <code>GSSManager.createContext</code> for example like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Obtain accessToken in your application.</span>
KeycloakPrincipal keycloakPrincipal = (KeycloakPrincipal) servletReq.getUserPrincipal();
AccessToken accessToken = keycloakPrincipal.getKeycloakSecurityContext().getToken();

<span class="comment">// Retrieve kerberos credential from accessToken and deserialize it</span>
<span class="predefined-type">String</span> serializedGssCredential = (<span class="predefined-type">String</span>) accessToken.getOtherClaims().
    get(org.keycloak.common.constants.KerberosConstants.GSS_DELEGATION_CREDENTIAL);

GSSCredential deserializedGssCredential = org.keycloak.common.util.KerberosSerializationUtils.
    deserializeCredential(serializedGssCredential);

<span class="comment">// Create GSSContext to call other kerberos-secured services</span>
GSSContext context = gssManager.createContext(serviceName, krb5Oid,
    deserializedGssCredential, GSSContext.DEFAULT_LIFETIME);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have an example, that shows this in detail.
It&#8217;s in <code>examples/kerberos</code> in the Keycloak example distribution or demo distribution download.
You can also check the example sources directly <a href="https://github.com/keycloak/keycloak/tree/master/examples/kerberos">here</a> .</p>
</div>
<div class="paragraph">
<p>Note that you also need to configure <code>forwardable</code> kerberos tickets in <code>krb5.conf</code> file and add support for delegated credentials to your browser.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Credential delegation has some security implications so only use it if you really need it.
         It&#8217;s highly recommended to use it together with HTTPS.
         See for example <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/configuring_applications_for_sso">this article</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cross-realm-trust"><a class="anchor" href="#cross-realm-trust"></a>Cross-realm trust</h4>
<div class="paragraph">
<p>In the Kerberos V5 protocol, the <code>realm</code> is a set of Kerberos principals defined in the Kerberos database (typically LDAP server).
The Kerberos protocol has a concept of cross-realm trust. For example, if there are 2 kerberos realms A and B, the cross-realm trust
will allow the users from realm A to access resources (services) of realm B. This means that realm B trusts the realm A.</p>
</div>
<div class="paragraph">
<div class="title">Kerberos cross-realm trust</div>
<p><span class="image"><img src="./images/kerberos-trust-basic.png" alt="kerberos trust basic"></span></p>
</div>
<div class="paragraph">
<p>The Keycloak server has support for cross-realm trust. There are few things which need to be done to achieve this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure the Kerberos servers for the cross-realm trust. This step is dependent on the concrete Kerberos server implementations used.
In general, it is needed to add the Kerberos principal <code>krbtgt/B@A</code> to both Kerberos databases of realm A and B. It is needed that
this principal has same keys on both Kerberos realms. This is usually achieved when the principals have same password, key version number
and there are same ciphers used in both realms. It is recommended to consult the Kerberos server documentation for more details.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The cross-realm trust is unidirectional by default. If you want bidirectional trust to have realm A also trust realm B,
you must also add the principal <code>krbtgt/A@B</code> to both Kerberos databases. However, trust is transitive by default. If realm B
trusts realm A and realm C trusts realm B, then realm C automatically trusts realm A without a need to have principal <code>krbtgt/C@A</code>
available. Some additional configuration (for example <code>capaths</code>) may be needed to configure on Kerberos client side, so that
the clients are able to find the trust path. Consult the Kerberos documentation for more details.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure Keycloak server</p>
<div class="ulist">
<ul>
<li>
<p>If you use an LDAP storage provider with Kerberos support, you need to configure the server principal for realm B as in this
example: <code>HTTP/mydomain.com@B</code>. The LDAP server must be able to find the users from realm A if you want users from realm A to
successfully authenticate to Keycloak, as Keycloak server must be able to do SPNEGO flow and then find the users.
For example, kerberos principal user <code>john@A</code> must be available as a user in the LDAP under an LDAP DN
such as <code>uid=john,ou=People,dc=example,dc=com</code>. If you want both users from realm A and B to authenticate, you need to ensure
that LDAP is able to find users from both realms A and B. We want to improve this limitation in future versions, so you can
potentially create more separate LDAP providers for separate realms and ensure that SPNEGO works for both of them.</p>
</li>
<li>
<p>If you use a Kerberos user storage provider (typically the Kerberos without LDAP integration), you need to configure the
server principal as <code>HTTP/mydomain.com@B</code> and users from both Kerberos realms A and B should be able to authenticate.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
For the Kerberos user storage provider, it is recommended that there are no conflicting users among kerberos realms. If
conflicting users exist, they will be mapped to the same Keycloak user. This is also something, which we want to improve in
future versions and provide some more flexible mappings from Kerberos principals to Keycloak usernames.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>Troubleshooting</h4>
<div class="paragraph">
<p>If you have issues, we recommend that you enable additional logging to debug the problem:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable <code>Debug</code> flag in admin console for Kerberos or LDAP federation providers</p>
</li>
<li>
<p>Enable TRACE logging for category <code>org.keycloak</code> in logging section of <code>standalone/configuration/standalone.xml</code> to receive more info <code>standalone/log/server.log</code></p>
</li>
<li>
<p>Add system properties <code>-Dsun.security.krb5.debug=true</code> and <code>-Dsun.security.spnego.debug=true</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_x509"><a class="anchor" href="#_x509"></a>X.509 Client Certificate User Authentication</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/authentication/x509.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/authentication/x509.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak supports login with a X.509 client certificate if the server is configured for mutual SSL authentication.</p>
</div>
<div class="paragraph">
<p>A typical workflow is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A client sends an authentication request over SSL/TLS channel</p>
</li>
<li>
<p>During SSL/TLS handshake, the server and the client exchange their x.509/v3 certificates</p>
</li>
<li>
<p>The container (WildFly) validates the certificate PKIX path and the certificate expiration</p>
</li>
<li>
<p>The x.509 client certificate authenticator validates the client certificate as follows:</p>
<div class="ulist">
<ul>
<li>
<p>Optionally checks the certificate revocation status using CRL and/or CRL Distribution Points</p>
</li>
<li>
<p>Optionally checks the Certificate revocation status using OCSP (Online Certificate Status Protocol)</p>
</li>
<li>
<p>Optionally validates whether the key usage in the certificate matches the expected key usage</p>
</li>
<li>
<p>Optionally validates whether the extended key usage in the certificate matches the expected extended key usage</p>
</li>
</ul>
</div>
</li>
<li>
<p>If any of the above checks fails, the x.509 authentication fails</p>
</li>
<li>
<p>Otherwise, the authenticator extracts the certificate identity and maps it to an existing user</p>
</li>
<li>
<p>Once the certificate is mapped to an existing user, the behavior diverges depending on the authentication flow:</p>
<div class="ulist">
<ul>
<li>
<p>In the Browser Flow, the server prompts the user to confirm identity or to ignore it and instead sign in with username/password</p>
</li>
<li>
<p>In the case of the Direct Grant Flow, the server signs in the user</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="features-2"><a class="anchor" href="#features-2"></a>Features</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Supported Certificate Identity Sources</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Match SubjectDN using regular expression</p>
</li>
<li>
<p>X500 Subject&#8217;s e-mail attribute</p>
</li>
<li>
<p>X500 Subject&#8217;s e-mail from Subject Alternative Name Extension (RFC822Name General Name)</p>
</li>
<li>
<p>X500 Subject&#8217;s other name from Subject Alternative Name Extension. This is typically UPN (User Principal Name)</p>
</li>
<li>
<p>X500 Subject&#8217;s Common Name attribute</p>
</li>
<li>
<p>Match IssuerDN using regular expression</p>
</li>
<li>
<p>Certificate Serial Number</p>
</li>
<li>
<p>Certificate Serial Number and IssuerDN</p>
</li>
<li>
<p>SHA-256 Certificate thumbprint</p>
</li>
<li>
<p>Full certificate in PEM format</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Regular Expressions</dt>
<dd>
<p>The certificate identity can be extracted from either Subject DN or Issuer DN using a regular expression as a filter. For example, the regular expression below will match the e-mail attribute:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>emailAddress=(.*?)(?:,|$)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The regular expression filtering is applicable only if the <code>Identity Source</code> is set to either <code>Match SubjectDN using regular expression</code> or <code>Match IssuerDN using regular expression</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Mapping certificate identity to an existing user</dt>
<dd>
<p>The certificate identity mapping can be configured to map the extracted user identity to an existing user&#8217;s username or e-mail or to a custom attribute which value matches the certificate identity. For example, setting the <code>Identity source</code> to <em>Subject&#8217;s e-mail</em> and <code>User mapping method</code> to <em>Username or email</em> will have the X.509 client certificate authenticator use the e-mail attribute in the certificate&#8217;s Subject DN  as a search criteria to look up an existing user by username or by e-mail.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please notice that if we disable <code>Login with email</code> at realm settings, the same rules will be applied to certificate authentication. In other words, users won&#8217;t be able to log in using e-mail attribute.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Usage of <code>Certificate Serial Number and IssuerDN</code> as an identity source requires two custom attributes - one for serial number and the other for IssuerDN.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<code>SHA-256 Certificate thumbprint</code> is lowercase hexadecimal representation of SHA-256 certificate thumbprint.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Usage of <code>Full certificate in PEM format</code> as an identity source is limited to custom attributes mapped to external federation sources like LDAP. You must enable <code>Always Read Value From LDAP</code> in this case, because certificates cannot be stored in Keycloak database due to a length limitation.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Other Features: Extended Certificate Validation</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Revocation status checking using CRL</p>
</li>
<li>
<p>Revocation status checking using CRL/Distribution Point</p>
</li>
<li>
<p>Revocation status checking using OCSP/Responder URI</p>
</li>
<li>
<p>Certificate KeyUsage validation</p>
</li>
<li>
<p>Certificate ExtendedKeyUsage validation</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="enable-x-509-client-certificate-user-authentication"><a class="anchor" href="#enable-x-509-client-certificate-user-authentication"></a>Enable X.509 Client Certificate User Authentication</h4>
<div class="paragraph">
<p>The following sections describe how to configure WildFly/Undertow and the Keycloak Server to enable X.509 client certificate authentication.</p>
</div>
<div id="_enable-mtls-wildfly" class="dlist">
<dl>
<dt class="hdlist1">Enable mutual SSL in WildFly</dt>
<dd>
<p>See <a href="https://docs.wildfly.org/19/Admin_Guide.html#enable-ssl">Enable SSL</a> for the instructions how to enable SSL in WildFly.</p>
<div class="ulist">
<ul>
<li>
<p>Open KEYCLOAK_HOME/standalone/configuration/standalone.xml and add a new realm:</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;security-realms&gt;</span>
    <span class="tag">&lt;security-realm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ssl-realm</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;server-identities&gt;</span>
            <span class="tag">&lt;ssl&gt;</span>
                <span class="tag">&lt;keystore</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">servercert.jks</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">relative-to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jboss.server.config.dir</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">keystore-password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">servercert password</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/ssl&gt;</span>
        <span class="tag">&lt;/server-identities&gt;</span>
        <span class="tag">&lt;authentication&gt;</span>
            <span class="tag">&lt;truststore</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">truststore.jks</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">relative-to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jboss.server.config.dir</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">keystore-password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">truststore password</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/authentication&gt;</span>
    <span class="tag">&lt;/security-realm&gt;</span>
<span class="tag">&lt;/security-realms&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>ssl/keystore</code></dt>
<dd>
<p>The <code>ssl</code> element contains the <code>keystore</code> element that defines how to load the server public key pair from a JKS keystore</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/path</code></dt>
<dd>
<p>A path to a JKS keystore</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/relative-to</code></dt>
<dd>
<p>Defines a path the keystore path is relative to</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/keystore-password</code></dt>
<dd>
<p>The password to open the keystore</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/alias</code> (optional)</dt>
<dd>
<p>The alias of the entry in the keystore. Set it if the keystore contains multiple entries</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/key-password</code> (optional)</dt>
<dd>
<p>The private key password, if different from the keystore password.</p>
</dd>
<dt class="hdlist1"><code>authentication/truststore</code></dt>
<dd>
<p>Defines how to load a trust store to verify the certificate presented by the remote side of the inbound/outgoing connection. Typically, the truststore contains a collection of trusted CA certificates.</p>
</dd>
<dt class="hdlist1"><code>authentication/truststore/path</code></dt>
<dd>
<p>A path to a JKS keystore that contains the certificates of the trusted CAs (certificate authorities)</p>
</dd>
<dt class="hdlist1"><code>authentication/truststore/relative-to</code></dt>
<dd>
<p>Defines a path the truststore path is relative to</p>
</dd>
<dt class="hdlist1"><code>authentication/truststore/keystore-password</code></dt>
<dd>
<p>The password to open the truststore</p>
</dd>
<dt class="hdlist1">Enable https listener</dt>
<dd>
<p>See <a href="https://docs.wildfly.org/19/Admin_Guide.html#https-listener">HTTPS Listener</a> for the instructions how to enable HTTPS in WildFly.</p>
<div class="ulist">
<ul>
<li>
<p>Add the &lt;https-listener&gt; element as shown below:</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:11.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ....
    <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;https-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ssl-realm</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">verify-client</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REQUESTED</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/server&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>https-listener/security-realm</code></dt>
<dd>
<p>The value must match the name of the realm from the previous section</p>
</dd>
<dt class="hdlist1"><code>https-listener/verify-client</code></dt>
<dd>
<p>If set to <code>REQUESTED</code>, the server will optionally ask for a client certificate. Setting the attribute to <code>REQUIRED</code> will have the server to refuse inbound connections if no client certificate has been provided.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="adding-x-509-client-certificate-authentication-to-a-browser-flow"><a class="anchor" href="#adding-x-509-client-certificate-authentication-to-a-browser-flow"></a>Adding X.509 Client Certificate Authentication to a Browser Flow</h4>
<div class="ulist">
<ul>
<li>
<p>Select a realm, click on Authentication link, select the "Browser" flow</p>
</li>
<li>
<p>Make a copy of the built-in "Browser" flow. You may want to give the new flow a distinctive name, i.e. "X.509 Browser"</p>
</li>
<li>
<p>Using the drop down, select the copied flow, and click on "Add execution"</p>
</li>
<li>
<p>Select "X509/Validate Username Form" using the drop down and click on "Save"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-execution.png" alt="x509 execution"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the up/down arrows, change the order of the "X509/Validate Username Form" by moving it above the "Browser Forms" execution, and set the requirement to "ALTERNATIVE"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-browser-flow.png" alt="x509 browser flow"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Select the "Bindings" tab, find the drop down for "Browser Flow". Select the newly created X509 browser flow from the drop down and click on "Save".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-browser-flow-bindings.png" alt="x509 browser flow bindings"></span></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Configuring X.509 Client Certificate Authentication</dt>
<dd>
<p><span class="image"><img src="./images/x509-configuration.png" alt="x509 configuration"></span></p>
</dd>
<dt class="hdlist1"><code>User Identity Source</code></dt>
<dd>
<p>Defines how to extract the user identity from a client certificate.</p>
</dd>
<dt class="hdlist1"><code>Canonical DN representation enabled</code> (optional)</dt>
<dd>
<p>Defines whether to use the canonical format to determine a distinguished name.
The format is described in detail in the official <a href="https://docs.oracle.com/javase/8/docs/api/javax/security/auth/x500/X500Principal.html#getName-java.lang.String-">Java API documentation</a> .
This option only affects the two User Identity Sources <em>Match SubjectDN using regular expression</em> and <em>Match IssuerDN using regular expression</em>.
If you setup a new Keycloak instance it is recommended to enable this option. Leave this option disabled to remain beckward compatible with existing Keycloak instances.</p>
</dd>
<dt class="hdlist1"><code>Enable Serial Number hexadecimal representation</code> (optional)</dt>
<dd>
<p>An option to use hexadecimal representation of the Serial Number. See <a href="https://tools.ietf.org/html/rfc5280#section-4.1.2.2">RFC5280, Section-4.1.2.2</a>. Serial Number with sign bit set to 1 should be left padded with 00 octet. E.g. Serial number with decimal value <em>161</em>, or <em>a1</em> in hexadecimal representation according to RFC5280 must be encoded as <em>00a1</em>. More details can be found: <a href="https://tools.ietf.org/html/rfc5280#appendix-B">RFC5280, appendix-B</a>.</p>
</dd>
<dt class="hdlist1"><code>A regular expression</code> (optional)</dt>
<dd>
<p>Defines a regular expression to use as a filter to extract the certificate identity. The regular expression must contain a single group.</p>
</dd>
<dt class="hdlist1"><code>User Mapping Method</code></dt>
<dd>
<p>Defines how to match the certificate identity to an existing user. <em>Username or e-mail</em> will search for an existing user by username or e-mail. <em>Custom Attribute Mapper</em> will  search for an existing user with a custom attribute which value matches the certificate identity. The name of the custom attribute is configurable.</p>
</dd>
<dt class="hdlist1"><code>A name of user attribute</code> (optional)</dt>
<dd>
<p>A custom attribute which value will be matched against the certificate identity. Multiple custom attributes are relevant when attribute mapping is related to multiple values, e.g. 'Certificate Serial Number and IssuerDN'.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It is highly recommended that attribute used here is read-only for the users. By default, only the <code>usercertificate</code> attribute is read-only by Keycloak.
If you use a different attribute name, you may need to add it to the list of read-only attributes. See the details in the <a href="#_read_only_user_attributes">Threat model mitigation chapter</a>.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>CRL Checking Enabled</code> (optional)</dt>
<dd>
<p>Defines whether to check the revocation status of the certificate using Certificate Revocation List.</p>
</dd>
<dt class="hdlist1"><code>Enable CRL Distribution Point to check certificate revocation status</code> (optional)</dt>
<dd>
<p>Defines whether to use CDP to check the certificate revocation status. Most PKI authorities include CDP in their certificates.</p>
</dd>
<dt class="hdlist1"><code>CRL file path</code> (optional)</dt>
<dd>
<p>Defines a path to a file that contains a CRL list. The value must be a path to a valid file if <code>CRL Checking Enabled</code> option is turned on.</p>
</dd>
<dt class="hdlist1"><code>OCSP Checking Enabled</code>(optional)</dt>
<dd>
<p>Defines whether to check the certificate revocation status using Online Certificate Status Protocol.</p>
</dd>
<dt class="hdlist1"><code>OCSP Responder URI</code> (optional)</dt>
<dd>
<p>Allows to override a value of the OCSP responder URI in the certificate.</p>
</dd>
<dt class="hdlist1"><code>Validate Key Usage</code> (optional)</dt>
<dd>
<p>Verifies whether the certificate&#8217;s KeyUsage extension bits are set. For example, "digitalSignature,KeyEncipherment" will verify if  bits 0 and 2 in the KeyUsage extension are asserted. Leave the parameter empty to disable the Key Usage validation. See <a href="https://tools.ietf.org/html/rfc5280#section-4.2.1.3">RFC5280, Section-4.2.1.3</a>. The server will raise an error only when flagged as critical by the issuing CA and there is a key usage extension mismatch.</p>
</dd>
<dt class="hdlist1"><code>Validate Extended Key Usage</code> (optional)</dt>
<dd>
<p>Verifies one or more purposes as defined in the Extended Key Usage extension. See <a href="https://tools.ietf.org/html/rfc5280#section-4.2.1.12">RFC5280, Section-4.2.1.12</a>. Leave the parameter empty to disable the Extended Key Usage validation. The server will raise an error only when flagged as critical by the issuing CA and there is a key usage extension mismatch.</p>
</dd>
<dt class="hdlist1"><code>Bypass identity confirmation</code></dt>
<dd>
<p>If set, X.509 client certificate authentication will not prompt the user to confirm the certificate identity and will automatically sign in the user upon successful authentication.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="adding-x-509-client-certificate-authentication-to-a-direct-grant-flow"><a class="anchor" href="#adding-x-509-client-certificate-authentication-to-a-direct-grant-flow"></a>Adding X.509 Client Certificate Authentication to a Direct Grant Flow</h4>
<div class="ulist">
<ul>
<li>
<p>Using Keycloak admin console, click on "Authentication" and select the "Direct Grant" flow,</p>
</li>
<li>
<p>Make a copy of the build-in "Direct Grant" flow. You may want to give the new flow a distinctive name, i.e. "X509 Direct Grant",</p>
</li>
<li>
<p>Delete "Username Validation" and "Password" authenticators,</p>
</li>
<li>
<p>Click on "Add execution" and add "X509/Validate Username" and click on "Save" to add the execution step to the parent flow.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-directgrant-execution.png" alt="x509 directgrant execution"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the <code>Requirement</code> to <em>REQUIRED</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-directgrant-flow.png" alt="x509 directgrant flow"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set up the x509 authentication configuration by following the steps described earlier in the x.509 Browser Flow section.</p>
</li>
<li>
<p>Select the "Bindings" tab, find the drop down for "Direct Grant Flow". Select the newly created X509 direct grant flow from the drop down and click on "Save".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-directgrant-flow-bindings.png" alt="x509 directgrant flow bindings"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="client-certificate-lookup"><a class="anchor" href="#client-certificate-lookup"></a>Client certificate lookup</h4>
<div class="paragraph">
<p>When an HTTP request is sent directly to Keycloak server, the WildFly undertow subsystem will establish an SSL handshake and extract the client certificate. The client certificate will be then saved to the attribute <code>javax.servlet.request.X509Certificate</code> of the HTTP request, as specified in the servlet specification. The Keycloak X509 authenticator will be then able to lookup the certificate from this attribute.</p>
</div>
<div class="paragraph">
<p>However, when the Keycloak server listens to HTTP requests behind a load balancer or reverse proxy, it may be the proxy server which extracts the client certificate and establishes the mutual SSL connection. A reverse proxy usually puts the authenticated client certificate in the HTTP header of the underlying request and forwards it to the back end Keycloak server. In this case, Keycloak must be able to look up the X.509 certificate chain from the HTTP headers instead of from the attribute of HTTP request, as is done for Undertow.</p>
</div>
<div class="paragraph">
<p>If Keycloak is behind a reverse proxy, you usually need to configure alternative provider of the <code>x509cert-lookup</code> SPI in KEYCLOAK_HOME/standalone/configuration/standalone.xml. Along with the <code>default</code> provider, which looks up the certificate from the HTTP header, we also have two additional built-in providers: <code>haproxy</code> and <code>apache</code>, which are described next.</p>
</div>
<div class="sect4">
<h5 id="haproxy-certificate-lookup-provider"><a class="anchor" href="#haproxy-certificate-lookup-provider"></a>HAProxy certificate lookup provider</h5>
<div class="paragraph">
<p>You can use this provider when your Keycloak server is behind an HAProxy reverse proxy. Configure the server like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x509cert-lookup</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>haproxy<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">haproxy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sslClientCert</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SSL_CLIENT_CERT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sslCertChainPrefix</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CERT_CHAIN</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">certificateChainLength</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example configuration, the client certificate will be looked up from the HTTP header, <code>SSL_CLIENT_CERT</code>, and the other certificates from its chain will be looked up from HTTP headers like <code>CERT_CHAIN_0</code> , <code>CERT_CHAIN_1</code>, &#8230;&#8203;, <code>CERT_CHAIN_9</code> . The attribute <code>certificateChainLength</code> is the maximum length of the chain, so the last one tried attribute would be <code>CERT_CHAIN_9</code> .</p>
</div>
<div class="paragraph">
<p>Consult the HAProxy documentation for the details of how the HTTP Headers for the client certificate and client certificate chain can be configured and their proper names.</p>
</div>
</div>
<div class="sect4">
<h5 id="apache-certificate-lookup-provider"><a class="anchor" href="#apache-certificate-lookup-provider"></a>Apache certificate lookup provider</h5>
<div class="paragraph">
<p>You can use this provider when your Keycloak server is behind an Apache reverse proxy. Configure the server like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x509cert-lookup</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>apache<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">apache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sslClientCert</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SSL_CLIENT_CERT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sslCertChainPrefix</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CERT_CHAIN</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">certificateChainLength</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration is same as for the <code>haproxy</code> provider. Consult the Apache documentation on <a href="https://httpd.apache.org/docs/current/mod/mod_ssl.html">mod_ssl</a> and <a href="https://httpd.apache.org/docs/current/mod/mod_headers.html">mod_headers</a> for the details of how the HTTP Headers for the client certificate and client certificate chain can be configured and their proper names.</p>
</div>
</div>
<div class="sect4">
<h5 id="nginx-certificate-lookup-provider"><a class="anchor" href="#nginx-certificate-lookup-provider"></a>Nginx certificate lookup provider</h5>
<div class="paragraph">
<p>You can use this provider when your Keycloak server is behind an Nginx reverse proxy. Configure the server like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x509cert-lookup</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>nginx<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">nginx</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sslClientCert</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ssl-client-cert</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sslCertChainPrefix</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">USELESS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">certificateChainLength</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
NGINX <a href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html#variables">SSL/TLS module</a> does not expose the client certificate chain, so Keycloak NGINX certificate lookup provider is rebuilding it using the <a href="https://www.keycloak.org/docs/12.0/server_installation/#_truststore">Keycloak truststore</a>. Please populate Keycloak truststore using keytool CLI with all root and intermediate CA&#8217;s needed for rebuilding client certificate chain.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consult the NGINX documentation for the details of how the HTTP Headers for the client certificate can be configured.
Example of NGINX configuration file :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt"> ...
 server {
    ...
    ssl_client_certificate                  trusted-ca-list-for-client-auth.pem;
    ssl_verify_client                       optional_no_ca;
    ssl_verify_depth                        2;
    ...
    location / {
      ...
      proxy_set_header ssl-client-cert        $ssl_client_escaped_cert;
      ...
    }
    ...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
all certificates in trusted-ca-list-for-client-auth.pem must be added to <a href="https://www.keycloak.org/docs/12.0/server_installation/#_truststore">Keycloak truststore</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="other-reverse-proxy-implementations"><a class="anchor" href="#other-reverse-proxy-implementations"></a>Other reverse proxy implementations</h5>
<div class="paragraph">
<p>We do not have built-in support for other reverse proxy implementations. However, it is possible that other reverse proxies can be made to behave in a similar way to <code>apache</code> or <code>haproxy</code> and that some of those providers can be used. If none of those works, you may need to create your own implementation of the <code>org.keycloak.services.x509.X509ClientCertificateLookupFactory</code> and <code>org.keycloak.services.x509.X509ClientCertificateLookup</code> provider. See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for the details on how to add your own provider.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting-2"><a class="anchor" href="#troubleshooting-2"></a>Troubleshooting</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Dumping HTTP headers</dt>
<dd>
<p>If you want to view what the reverse proxy is sending to Keycloak, enable the <code>RequestDumpingHandler</code> Undertow filter and consult <code>server.log</code> file.</p>
</dd>
<dt class="hdlist1">Enable TRACE logging under the logging subsystem</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">...
    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:logging:3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
            <span class="tag">&lt;logger</span> <span class="attribute-name">category</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.authentication.authenticators.x509</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;level</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TRACE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/logger&gt;</span>
            <span class="tag">&lt;logger</span> <span class="attribute-name">category</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.services.x509</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;level</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TRACE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/logger&gt;</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>WARNING: Don't use RequestDumpingHandler or TRACE logging in production.</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Direct Grant authentication with X.509</dt>
<dd>
<p>The following template can be used to request a token using the Resource Owner Password Credentials Grant:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ curl https://[host][:port]/auth/realms/master/protocol/openid-connect/token \
       --insecure \
       --data "grant_type=password&amp;scope=openid profile&amp;username=&amp;password=&amp;client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET" \
       -E /path/to/client_cert.crt \
       --key /path/to/client_cert.key</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>[host][:port]</code></dt>
<dd>
<p>The host and the port number of a remote Keycloak server that has been configured to allow users authenticate with x.509 client certificates using the Direct Grant Flow.</p>
</dd>
<dt class="hdlist1"><code>CLIENT_ID</code></dt>
<dd>
<p>A client id.</p>
</dd>
<dt class="hdlist1"><code>CLIENT_SECRET</code></dt>
<dd>
<p>For confidential clients, a client secret; otherwise, leave it empty.</p>
</dd>
<dt class="hdlist1"><code>client_cert.crt</code></dt>
<dd>
<p>A public key certificate that will be used to verify the identity of the client in mutual SSL authentication. The certificate should be in PEM format.</p>
</dd>
<dt class="hdlist1"><code>client_cert.key</code></dt>
<dd>
<p>A private key in the public key pair. Also expected in PEM format.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_webauthn"><a class="anchor" href="#_webauthn"></a>W3C Web Authentication (WebAuthn)</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/authentication/webauthn.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/authentication/webauthn.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak provides the limited support for <a href="https://www.w3.org/TR/webauthn/">W3C Web Authentication (WebAuthn)</a>. Keycloak works as a WebAuthn&#8217;s <a href="https://www.w3.org/TR/webauthn/#rp-operations">Relying Party (RP)</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please note that WebAuthn support is still in development and not yet complete, so we recommend that you use this feature experimentally. Also, this support&#8217;s specification and user interfaces may change.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Whether WebAuthn&#8217;s operations succeed depends on a user&#8217;s WebAuthn supporting authenticator, browser and platform. If you use this WebAuthn support, please clarify to what extent those entities support the WebAuthn specification.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="setup"><a class="anchor" href="#setup"></a>Setup</h4>
<div class="paragraph">
<p>The setup procedure of WebAuthn support for 2FA is the following :</p>
</div>
<div class="sect4">
<h5 id="_webauthn-register"><a class="anchor" href="#_webauthn-register"></a>Enable Webauthn Authenticator Registration</h5>
<div class="paragraph">
<p>An administrator carries out the following operations on the <code>Admin Console</code> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the <code>Authentication &#8594; Required Actions</code> tab.</p>
</li>
<li>
<p>Click <code>Register</code>.</p>
</li>
<li>
<p>Select <code>Webauthn Register</code> as <code>Required Action</code>.</p>
</li>
<li>
<p>Mark <code>Enabled</code> checkbox. Optionally mark <code>Default Action</code> checkbox if you want all new created users to be required to register WebAuthn credential.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_webauthn-authenticator-setup"><a class="anchor" href="#_webauthn-authenticator-setup"></a>Adding WebAuthn Authentication to a Browser Flow</h5>
<div class="ulist">
<ul>
<li>
<p>Select a realm, click on <code>Authentication</code> link, select the <code>Browser</code> flow</p>
</li>
<li>
<p>Make a copy of the built-in "Browser" flow. You may want to give the new flow a distinctive name, for example "WebAuthn Browser"</p>
</li>
<li>
<p>Using the drop down, select the copied flow</p>
</li>
<li>
<p>Delete the <code>WebAuthn Browser Browser - Conditional OTP</code> sub-flow using its <code>Actions</code> menu</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you want to have WebAuthn required for all users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the <code>Actions</code> menu of the <code>WebAuthn Browser Forms</code>, click on <code>Add execution</code></p>
</li>
<li>
<p>Select <code>WebAuthn Authenticator</code> using the drop down and click on <code>Save</code></p>
</li>
<li>
<p>Set its Requirement to <em>Required</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/webauthn-browser-flow-required.png" alt="webauthn browser flow required"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the <code>Bindings</code> menu, change the browser flow to <code>WebAuthn Browser</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that in this scenario, if a user doesn&#8217;t have a WebAuthn credential, a required action will be set that forces that user
to register one.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can have users log in with WebAuthn only if they have a WebAuthn credential registered, so instead of adding
the <code>WebAuthn Authenticator</code> execution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the <code>Actions</code> menu of the <code>WebAuthn Browser Forms</code>, click on <code>Add flow</code></p>
</li>
<li>
<p>Set the alias to "Conditional 2FA" and click on <code>Save</code></p>
</li>
<li>
<p>Set the Requirement of <code>Conditional 2FA</code> to <em>Conditional</em></p>
</li>
<li>
<p>Using the <code>Actions</code> menu of the <code>Conditional 2FA</code>, click on <code>Add execution</code></p>
</li>
<li>
<p>Select <code>Condition - User Configured</code> using the drop down and click on <code>Save</code></p>
</li>
<li>
<p>Set the Requirement of <code>Condition - User Configured</code> execution to <em>Required</em></p>
</li>
<li>
<p>Using the <code>Actions</code> menu of the <code>Conditional 2FA</code>, click on <code>Add execution</code></p>
</li>
<li>
<p>Select <code>WebAuthn Authenticator</code> using the drop down and click on <code>Save</code></p>
</li>
<li>
<p>Set its Requirement to <em>Alternative</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/webauthn-browser-flow-conditional.png" alt="webauthn browser flow conditional"></span></p>
</div>
<div class="paragraph">
<p>You can also allow the user to choose between using WebAuthn and OTP for his second factor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the <code>Actions</code> menu of the <code>Conditional 2FA</code>, click on <code>Add execution</code></p>
</li>
<li>
<p>Select <code>OTP Form</code> using the drop down and click on <code>Save</code></p>
</li>
<li>
<p>Set its Requirement to <em>Alternative</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/webauthn-browser-flow-conditional-with-OTP.png" alt="webauthn browser flow conditional with OTP"></span></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="authenticate-with-webauthn-authenticator"><a class="anchor" href="#authenticate-with-webauthn-authenticator"></a>Authenticate with WebAuthn Authenticator</h4>
<div class="paragraph">
<p>After registering a WebAuthn authenticator, the user carries out the following operations
assuming that authentication flow configuration above with the conditional subflow using <code>WebAuthn Authenticator</code> was used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the login form. The user must authenticate with a username and password.</p>
</li>
<li>
<p>The user&#8217;s browser asks the user to authenticate by their WebAuthn authenticator.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="managing-webauthn-as-an-administrator"><a class="anchor" href="#managing-webauthn-as-an-administrator"></a>Managing WebAuthn as an administrator</h4>
<div class="sect4">
<h5 id="managing-credentials"><a class="anchor" href="#managing-credentials"></a>Managing Credentials</h5>
<div class="paragraph">
<p>WebAuthn credentials are managed in a similar manner as other credentials, such as OTP, from the <a href="#_user-credentials">User credential management</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Users can be assigned a required action to create a WebAuthn credential from the <code>Reset Actions</code> list, and selecting <code>Webauthn Register</code></p>
</li>
<li>
<p>The administrator can delete a WebAuthn credential by pressing <code>Delete</code>.</p>
</li>
<li>
<p>The administrator can view the credential&#8217;s data such as the AAGUID by selecting <code>Show data&#8230;&#8203;</code>.</p>
</li>
<li>
<p>The administrator can set a label for the credential by setting a value in the <code>User Label</code> field and saving the data.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_webauthn-policy"><a class="anchor" href="#_webauthn-policy"></a>Managing Policy</h5>
<div class="paragraph">
<p>An administrator can configure WebAuthn related operations as <code>WebAuthn Policy</code> per realm.</p>
</div>
<div class="paragraph">
<p>An administrator carries out the following operations on the <code>Admin Console</code> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the <code>Authentication &#8594; WebAuthn Policy</code> tab.</p>
</li>
<li>
<p>Configure items and click <code>Save</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The configurable items and their description follow.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Relying Party Entity Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Human-readable server name as a WebAuthn Relying Party. This is a mandatory configuration, which is applied to the operation of registering the WebAuthn authenticator. The default setting is "keycloak".
 For more details, see <a href="https://www.w3.org/TR/webauthn/#dictionary-pkcredentialentity">WebAuthn Specification</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signature Algorithms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It tells the WebAuthn authenticator which signature algorithms to use for the <a href="https://www.w3.org/TR/webauthn/#public-key-credential">Public Key Credential</a> that can be used for signing and verifying the <a href="https://www.w3.org/TR/webauthn/#authentication-assertion">Authentication Assertion</a>. Multiple algorithms can be specified. If no algorithm is specified, <a href="https://tools.ietf.org/html/rfc8152#section-8.1">ES256</a> is adapted. The default setting is ES256. This is an optional configuration item that is applied to the operation of registering a WebAuthn authenticator.
 For more details, see <a href="https://www.w3.org/TR/webauthn/#dictdef-publickeycredentialparameters">WebAuthn Specification</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Relying Party ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the ID as a WebAuthn Relying Party and determines the scope of Public Key Credentials. It must be origin&#8217;s effective domain. This is an optional configuration item that is applied to the operation of registering a WebAuthn authenticator. If no entry is entered, the host part of the base URL of Keycloak&#8217;s server is adapted.
 For more details, see <a href="https://www.w3.org/TR/webauthn/#rp-id">WebAuthn Specification</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Attestation Conveyance Preference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It tells the WebAuthn API implementation on the browser (<a href="https://www.w3.org/TR/webauthn/#webauthn-client">WebAuthn Client</a>) the preference of how to generate an Attestation Statement. This is an optional configuration item that is applied to the operation of registering a WebAuthn authenticator. If no option is selected, its behavior is the same as selecting "none".
 For more details, see <a href="https://www.w3.org/TR/webauthn/#attestation-convey">WebAuthn Specification</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authenticator Attachment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It tells the WebAuthn Client an acceptable attachment pattern of a WebAuthn authenticator. This is an optional configuration item that is applied to the operation of registering a WebAuthn authenticator. If no option is selected, the WebAuthn Client does not consider the attachment pattern.
 For more details, see <a href="https://www.w3.org/TR/webauthn/#enumdef-authenticatorattachment">WebAuthn Specification</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Require Resident Key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It tells the WebAuthn authenticator to generate the Public Key Credential as <a href="https://www.w3.org/TR/webauthn/#client-side-resident-public-key-credential-source">Client-side-resident Public Key Credential Source</a>. This is an optional configuration item that is applied to the operation of registering a WebAuthn authenticator. If no option is selected, its behavior is the same as selecting "No".
 For more details, see <a href="https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-requireresidentkey">WebAuthn Specification</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Verification Requirement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It tells the WebAuthn authenticator to confirm actually verifying a user. This is an optional configuration item that is applied to the operation of registering a WebAuthn authenticator and authenticating the user by a WebAuthn authenticator. If no option is selected, its behavior is the same as selecting "preferred".
 For more details, see <a href="https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-userverification">WebAuthn Specification for registering a WebAuthn authenticator</a> and <a href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialrequestoptions-userverification">WebAuthn Specification for authenticating the user by a WebAuthn authenticator</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It specifies the timeout value in seconds for registering a WebAuthn authenticator and authenticating the user by a WebAuthn authenticator. If set to 0, its behavior depends on the WebAuthn authenticator&#8217;s implementation. The default value is 0.
 For more details, see <a href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialcreationoptions-timeout">WebAuthn Specification for registering a WebAuthn authenticator</a> and <a href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialrequestoptions-timeout">WebAuthn Specification for authenticating the user by a WebAuthn authenticator</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Avoid Same Authenticator Registration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to "ON", the WebAuthn authenticator that has already been registered can not be newly registered. This is applied to the operation of registering a WebAuthn authenticator. The default setting is "OFF".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Acceptable AAGUIDs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The white list of AAGUID of which a WebAuthn authenticator can be registered. This is applied to the operation of registering a WebAuthn authenticator. If no entry is set on this list, any WebAuthn authenticator can be registered.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="attestation-statement-verification"><a class="anchor" href="#attestation-statement-verification"></a>Attestation Statement Verification</h4>
<div class="paragraph">
<p>When registering a WebAuthn authenticator, Keycloak verifies an attestation statement generated by this WebAuthn authenticator. On this verification process, Keycloak validates this attestation statement&#8217;s trustworthiness. It requires trust anchor&#8217;s certificates. Keycloak uses the <a href="https://www.keycloak.org/docs/12.0/server_installation/#_truststore">Keycloak truststore</a>  so that you need to import these certificates onto it in advance.</p>
</div>
<div class="paragraph">
<p>If you want to omit this attestation statement trustworthiness validation, please disable this truststore or set the WebAuthn policy&#8217;s configuration item "Attestation Conveyance Preference" to "none".</p>
</div>
</div>
<div class="sect3">
<h4 id="managing-webauthn-credentials-as-a-user"><a class="anchor" href="#managing-webauthn-credentials-as-a-user"></a>Managing WebAuthn credentials as a user</h4>
<div class="sect4">
<h5 id="register-webauthn-authenticator"><a class="anchor" href="#register-webauthn-authenticator"></a>Register WebAuthn Authenticator</h5>
<div class="paragraph">
<p>The appropriate method to register a WebAuthn authenticator depends on if the user has or has not already registered an account on Keycloak.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">New user</dt>
<dd>
<p>If the <code>WebAuthn Register</code> required action is set as <code>Default Action</code> in a realm, new users are required to
set up the WebAuthn security key after the first successful login. A new user carries out the following operations :</p>
<div class="ulist">
<ul>
<li>
<p>Open the login form.</p>
</li>
<li>
<p>Click the <code>Register</code> link.</p>
</li>
<li>
<p>Fill in items on the register form and click <code>Register</code>.</p>
</li>
<li>
<p>The user&#8217;s browser asks the user to register their WebAuthn authenticator.</p>
</li>
<li>
<p>After successful registration, the user&#8217;s browser asks the user to enter the text as their just registered WebAuthn authenticator&#8217;s label.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Existing user</dt>
<dd>
<p>If <code>WebAuthn Authenticator</code> is set up as required as shown in the first example, then when existing users try to log in,
they are required to register their WebAuthn authenticator automatically :</p>
<div class="ulist">
<ul>
<li>
<p>Open the login form.</p>
</li>
<li>
<p>Fill in items, click <code>Save</code> and  click <code>Login</code>.</p>
</li>
<li>
<p>When the users log in, they are required to register their WebAuthn authenticator.</p>
</li>
<li>
<p>After successful registration, the user&#8217;s browser asks the user to enter the text as their just registered WebAuthn authenticator&#8217;s label.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="passwordless-webauthn-together-with-two-factor"><a class="anchor" href="#passwordless-webauthn-together-with-two-factor"></a>Passwordless WebAuthn together with Two-Factor</h4>
<div class="paragraph">
<p>WebAuthn is often used for two-factor authentication, however it can be desired to use it also as first factor authentication. In this case,
a user with <code>passwordless</code> WebAuthn credential will be able to authenticate to Keycloak without a password. Keycloak allows to use WebAuthn
as both the passwordless and two-factor authentication mechanism in the context of a single realm and even in the context of a single authentication flow.</p>
</div>
<div class="paragraph">
<p>Administrator may typically require that Security Keys registered by users for the WebAuthn passwordless authentication must meet different
(usually stronger) requirements. For example, those security keys may require users to authenticate to that security key using a PIN, or the
security key should be attested with stronger certificate authority.</p>
</div>
<div class="paragraph">
<p>Because of this situation, Keycloak allows administrator to configure separate <code>WebAuthn Passwordless Policy</code>. There is a separate required action
of type <code>Webauthn Register Passwordless</code> and separate authenticator of type <code>WebAuthn Passwordless Authenticator</code>.</p>
</div>
<div class="sect4">
<h5 id="setup-2"><a class="anchor" href="#setup-2"></a>Setup</h5>
<div class="paragraph">
<p>The setup procedure of WebAuthn passwordless support is the following :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Register new required action for WebAuthn passwordless support. Use the same steps as described <a href="#_webauthn-register">above</a>
with the only difference, that you need to register the action called <code>Webauthn Register Passwordless</code>.</p>
</li>
<li>
<p>Configure the policy. You can use same steps and configuration options as described <a href="#_webauthn-policy">above</a>, however you
need to configure them in the admin console in the tab <code>WebAuthn Passwordless Policy</code>. You can configure this policy as you want, however
typically the requirements for the security key will be stronger than for the two-factor policy. For example the <code>User Verification Requirement</code> can
be set to <code>Required</code> when you configure the passwordless policy.</p>
</li>
<li>
<p>Finally configure the authentication flow. Let&#8217;s assume that we will use same flow called <code>WebAuthn Browser</code> as described
<a href="#_webauthn-authenticator-setup">above</a>, but
we will configure it as follows:</p>
<div class="ulist">
<ul>
<li>
<p>The <code>WebAuthn Browser Forms</code> subflow will contain <code>Username Form</code> as the first authenticator. Delete the default <code>Username Password Form</code>
authenticator and add the <code>Username Form</code> authenticator instead. This setting means that the user will provide just his or her username as the first step.</p>
</li>
<li>
<p>There will be a required subflow, which can be named for example <code>Passwordless Or Two-factor</code> . This setting indicates that user can
authenticate either with Passwordless WebAuthn credential or with Two-factor authentication.</p>
</li>
<li>
<p>Flow will contain <code>WebAuthn Passwordless Authenticator</code> as the first alternative.</p>
</li>
<li>
<p>The second alternative will be a subflow named for example <code>Password And Two-factor Webauthn</code>. This subflow will contain a <code>Password Form</code> and
a <code>WebAuthn Authenticator</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The final configuration of the flow will look like the following:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/webauthn-passwordless-flow.png" alt="webauthn passwordless flow"></span></p>
</div>
<div class="paragraph">
<p>You can now add <code>WebAuthn Register Passwordless</code> as the required action to some user, already known to Keycloak, to test this.
During the first authentication, the user will be still required to use the password and second-factor WebAuthn credential. However, once
the user registers the credentials, that user will be able
to choose during future authentications. If he uses  his or her WebAuthn Passwordless credential, he won&#8217;t need to
provide the password and second-factor WebAuthn credential at all.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conditions-in-conditional-flows"><a class="anchor" href="#conditions-in-conditional-flows"></a>Conditions in Conditional flows</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/authentication/conditions.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/authentication/conditions.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>As was mentioned in <a href="#_execution-requirements">Execution requirements</a>, <em>Condition</em> executions can be only contained in <em>Conditional</em> subflow.
If all <em>Condition</em> executions evaluate as true, then the <em>Conditional</em> sub-flow acts as <em>Required</em>.
You can process the next execution in the <em>Conditional</em> sub-flow.
If some executions included in the <em>Conditional</em> sub-flow evaluate as false, then the whole sub-flow is considered as <em>Disabled</em>.</p>
</div>
<div class="sect3">
<h4 id="available-conditions"><a class="anchor" href="#available-conditions"></a>Available Conditions</h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Condition - User Role</code></dt>
<dd>
<p>This execution has the ability to determine if the user has a role defined by <em>User role</em> field.
If the user has the required role, the execution is considered as true and other executions are evaluated.
The administrator has to define the following fields:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Alias</dt>
<dd>
<p>Describes a name of the execution, which will be shown in the authentication flow.</p>
</dd>
<dt class="hdlist1">User role</dt>
<dd>
<p>Role the user should have to execute this flow.
To specify an application role the syntax is <code>appname.approle</code> (for example <code>myapp.myrole</code>).</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1"><code>Condition - User Configured</code></dt>
<dd>
<p>This checks if the other executions in the flow are configured for the user.
The Execution requirements section includes an example of the OTP form.</p>
</dd>
<dt class="hdlist1"><code>Condition - User Attribute</code></dt>
<dd>
<p>This checks if the user has set up the required attribute.
There is a possibility to negate output, which means the user should not have the attribute.
The <a href="#_user-attributes">User Attributes</a> section shows how to add a custom attribute.
You can provide these fields:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Alias</dt>
<dd>
<p>Describes a name of the execution, which will be shown in the authentication flow.</p>
</dd>
<dt class="hdlist1">Attribute name</dt>
<dd>
<p>Name of the attribute to check.</p>
</dd>
<dt class="hdlist1">Expected attribute value</dt>
<dd>
<p>Expected value in the attribute.</p>
</dd>
<dt class="hdlist1">Negate output</dt>
<dd>
<p>You can negate the output.
In other words, the attribute should not be present.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sso-protocols"><a class="anchor" href="#sso-protocols"></a>SSO Protocols</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sso-protocols.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sso-protocols.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The chapter gives a brief overview of the authentication protocols and how the Keycloak authentication server
and the applications it secures interact with these protocols.</p>
</div>
<div class="sect2">
<h3 id="_oidc"><a class="anchor" href="#_oidc"></a>OpenID Connect</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sso-protocols/oidc.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sso-protocols/oidc.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p><a href="https://openid.net/connect/">OpenID Connect</a> (OIDC) is an authentication protocol that is an extension of <a href="https://tools.ietf.org/html/rfc6749">OAuth 2.0</a>.
While OAuth 2.0 is only a framework for building authorization protocols and is mainly incomplete, OIDC is a full-fledged authentication and authorization
protocol.  OIDC also makes heavy use of the <a href="https://jwt.io">Json Web Token</a> (JWT) set of standards.  These standards define an
identity token JSON format and ways to digitally sign and encrypt that data in a compact and web-friendly way.</p>
</div>
<div class="paragraph">
<p>There are really two types of use cases when using OIDC.  The first is an application that asks the Keycloak server to authenticate
a user for them.  After a successful login, the application will receive an <em>identity token</em> and an <em>access token</em>.  The <em>identity token</em>
contains information about the user such as username, email, and other profile information.  The <em>access token</em> is digitally signed by
the realm and contains access information (like user role mappings) that the application can use to determine what resources the user
is allowed to access on the application.</p>
</div>
<div class="paragraph">
<p>The second type of use cases is that of a client that wants to gain access to remote services.  In this case, the client asks Keycloak
to obtain an <em>access token</em> it can use to invoke on other remote services on behalf of the user.  Keycloak authenticates the user
then asks the user for consent to grant access to the client requesting it.  The client then receives the <em>access token</em>.  This <em>access token</em>
is digitally signed by the realm.  The client can make REST invocations on remote services using this <em>access token</em>.  The REST service
extracts the <em>access token</em>, verifies the signature of the token, then decides based on access information within the token whether or not to process
the request.</p>
</div>
<div class="sect3">
<h4 id="_oidc-auth-flows"><a class="anchor" href="#_oidc-auth-flows"></a>OIDC Auth Flows</h4>
<div class="paragraph">
<p>OIDC has different ways for a client or application to authenticate a user and receive an <em>identity</em> and <em>access</em> token.  Which
path you use depends greatly on the type of application or client requesting access.  All of these flows are described in the
OIDC and OAuth 2.0 specifications so only a brief overview will be provided here.</p>
</div>
<div class="sect4">
<h5 id="authorization-code-flow"><a class="anchor" href="#authorization-code-flow"></a>Authorization Code Flow</h5>
<div class="paragraph">
<p>This is a browser-based protocol and it is what we recommend you use to authenticate and authorize browser-based applications.  It makes
heavy use of browser redirects to obtain an <em>identity</em> and <em>access</em> token.  Here&#8217;s a brief summary:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browser visits application.  The application notices the user is not logged in, so it redirects the browser to Keycloak
to be authenticated.  The application passes along a callback URL (a redirect URL) as a query parameter in this browser redirect
that Keycloak will use when it finishes authentication.</p>
</li>
<li>
<p>Keycloak authenticates the user and creates a one-time, very short lived, temporary code.  Keycloak
redirects back to the application using the callback URL provided earlier and additionally adds the temporary code
as a query parameter in the callback URL.</p>
</li>
<li>
<p>The application extracts the temporary code and makes a background out of band REST invocation to Keycloak
to exchange the code for an <em>identity</em>, <em>access</em> and <em>refresh</em> token.  Once this temporary code has been used once
to obtain the tokens, it can never be used again.  This prevents potential replay attacks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It is important to note that <em>access</em> tokens are usually short lived and often expired after only minutes.  The additional <em>refresh</em>
token that was transmitted by the login protocol allows the application to obtain a new access token after it expires.  This
refresh protocol is important in the situation of a compromised system.  If access tokens are short lived, the whole system is only
vulnerable to a stolen token for the lifetime of the access token.  Future refresh token requests will fail if an admin
has revoked access.  This makes things more secure and more scalable.</p>
</div>
<div id="_confidential-clients" class="paragraph">
<p>Another important aspect of this flow is the concept of a <em>public</em> vs. a <em>confidential</em> client.  <em>Confidential</em> clients are required
to provide a client secret when they exchange the temporary codes for tokens.  <em>Public</em> clients are not required to provide this client secret.
<em>Public</em> clients are perfectly fine so long as HTTPS is strictly enforced and you are very strict about what redirect URIs are registered for the
client.  HTML5/JavaScript clients always have to be <em>public</em> clients because there is no way to transmit the client secret to them in a secure
manner.  Again, this is ok so long as you use HTTPS and strictly enforce redirect URI registration.  This guide goes more detail
into this in the <a href="#_clients">Managing Clients</a> chapter.</p>
</div>
<div class="paragraph">
<p>Keycloak also supports the optional <a href="https://tools.ietf.org/html/rfc7636">Proof Key for Code Exchange</a> specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="implicit-flow"><a class="anchor" href="#implicit-flow"></a>Implicit Flow</h5>
<div class="paragraph">
<p>This is a browser-based protocol that is similar to Authorization Code Flow except there are fewer requests and no refresh tokens involved.
We do not recommend this flow as there remains the possibility of <em>access</em> tokens being leaked in the browser history as tokens are transmitted
via redirect URIs (see below).  Also, since this flow doesn&#8217;t provide the client with a refresh token, access tokens would either have to
be long-lived or users would have to re-authenticate when they expired.  This flow is supported because it is in the OIDC and OAuth 2.0 specification.
Here&#8217;s a brief summary of the protocol:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browser visits application.  The application notices the user is not logged in, so it redirects the browser to Keycloak
to be authenticated.  The application passes along a callback URL (a redirect URL) as a query parameter in this browser redirect
that Keycloak will use when it finishes authentication.</p>
</li>
<li>
<p>Keycloak authenticates the user and creates an <em>identity</em> and <em>access</em> token.  Keycloak
redirects back to the application using the callback URL provided earlier and additionally adding the <em>identity</em> and
<em>access</em> tokens as query parameters in the callback URL.</p>
</li>
<li>
<p>The application extracts the <em>identity</em> and <em>access</em> tokens from the callback URL.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="resource-owner-password-credentials-grant-direct-access-grants"><a class="anchor" href="#resource-owner-password-credentials-grant-direct-access-grants"></a>Resource Owner Password Credentials Grant (Direct Access Grants)</h5>
<div class="paragraph">
<p>This is referred to in the Admin Console as <em>Direct Access Grants</em>. This is used by REST clients that want to obtain a token on behalf of a user.  It is one HTTP POST request that contains
the credentials of the user as well as the id of the client and the client&#8217;s secret (if it is a confidential client).  The user&#8217;s credentials
are sent within form parameters.  The HTTP response contains
<em>identity</em>, <em>access</em>, and <em>refresh</em> tokens.</p>
</div>
</div>
<div class="sect4">
<h5 id="_client_credentials_grant"><a class="anchor" href="#_client_credentials_grant"></a>Client Credentials Grant</h5>
<div class="paragraph">
<p>This is also used by REST clients, but instead of obtaining a token that works on behalf
of an external user, a token is created based on the metadata and permissions of a service account that is associated with the client.
More info together with example is in <a href="#_service_accounts">Service Accounts</a> chapter.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_oidc-endpoints"><a class="anchor" href="#_oidc-endpoints"></a>Keycloak Server OIDC URI Endpoints</h4>
<div class="paragraph">
<p>Here&#8217;s a list of OIDC endpoints that the Keycloak publishes.  These URLs are useful if you are using a non-Keycloak client adapter to
talk OIDC with the auth server.  These are all relative URLs and the root of the URL being the HTTP(S) protocol, hostname, and usually path prefixed with
<em>/auth</em>:  i.e. https://localhost:8080/auth</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">/realms/{realm-name}/protocol/openid-connect/auth</dt>
<dd>
<p>This is the URL endpoint for obtaining a temporary code in the Authorization Code Flow or for obtaining tokens via the
Implicit Flow, Direct Grants, or Client Grants.</p>
</dd>
<dt class="hdlist1">/realms/{realm-name}/protocol/openid-connect/token</dt>
<dd>
<p>This is the URL endpoint for the Authorization Code Flow to turn a temporary code into a token.</p>
</dd>
<dt class="hdlist1">/realms/{realm-name}/protocol/openid-connect/logout</dt>
<dd>
<p>This is the URL endpoint for performing logouts.</p>
</dd>
<dt class="hdlist1">/realms/{realm-name}/protocol/openid-connect/userinfo</dt>
<dd>
<p>This is the URL endpoint for the User Info service described in the OIDC specification.</p>
</dd>
<dt class="hdlist1">/realms/{realm-name}/protocol/openid-connect/revoke</dt>
<dd>
<p>This is the URL endpoint for OAuth 2.0 Token Revocation described in <a href="https://tools.ietf.org/html/rfc7009">RFC7009</a>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In all of these replace <em>{realm-name}</em> with the name of the realm.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_saml"><a class="anchor" href="#_saml"></a>SAML</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sso-protocols/saml.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sso-protocols/saml.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p><a href="http://saml.xml.org/saml-specifications">SAML 2.0</a> is a similar specification to OIDC but a lot older and more mature.  It has its roots in SOAP and the plethora
of WS-* specifications so it tends to be a bit more verbose than OIDC.  SAML 2.0 is primarily an authentication protocol
that works by exchanging XML documents between the authentication server and the application.  XML signatures and encryption
is used to verify requests and responses.</p>
</div>
<div class="paragraph">
<p>There are really two types of use cases when using SAML.  The first is an application that asks the Keycloak server to authenticate
a user for them.  After a successful login, the application will receive an XML document that contains
something called a SAML assertion that specify various attributes about the user.  This XML document is digitally signed by
the realm and contains access information (like user role mappings) that the application can use to determine what resources the user
is allowed to access on the application.</p>
</div>
<div class="paragraph">
<p>The second type of use cases is that of a client that wants to gain access to remote services.  In this case, the client asks Keycloak
to obtain an SAML assertion it can use to invoke on other remote services on behalf of the user.</p>
</div>
<div class="sect3">
<h4 id="saml-bindings"><a class="anchor" href="#saml-bindings"></a>SAML Bindings</h4>
<div class="paragraph">
<p>SAML defines a few different ways to exchange XML documents when executing the authentication protocol.  The <em>Redirect</em> and <em>Post</em> bindings
cover browser based applications.  The <em>ECP</em> binding covers REST invocations.  There are other binding types but Keycloak only
supports those three.</p>
</div>
<div class="sect4">
<h5 id="redirect-binding"><a class="anchor" href="#redirect-binding"></a>Redirect Binding</h5>
<div class="paragraph">
<p>The <em>Redirect</em> Binding uses a series of browser redirect URIs to exchange information.  This is a rough overview of
how it works.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The user visits the application and the application finds the user is not authenticated.  It generates an XML authentication
request document and encodes it as a query param in a URI that is used to redirect to the Keycloak server.
Depending on your settings, the application may also digitally sign this XML document and also stuff this signature as a query
param in the redirect URI to Keycloak.  This signature is used to validate the client that sent this
request.</p>
</li>
<li>
<p>The browser is redirected to Keycloak.  The server extracts the XML auth request document and verifies
the digital signature if required.  The user then has to enter in their credentials to be authenticated.</p>
</li>
<li>
<p>After authentication, the server generates an XML authentication response document.  This document contains
a SAML assertion that holds metadata about the user like name, address, email, and any role mappings the user
might have.  This document is almost always digitally signed using XML signatures, and may also be encrypted.</p>
</li>
<li>
<p>The XML auth response document is then encoded as a query param in a redirect URI that brings the browser back
to the application.  The digital signature is also included as a query param.</p>
</li>
<li>
<p>The application receives the redirect URI and extracts the XML document and verifies the realm&#8217;s signature to make
sure it is receiving a valid auth response.  The information inside the SAML assertion is then used to make
access decisions or display user data.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="post-binding"><a class="anchor" href="#post-binding"></a>POST Binding</h5>
<div class="paragraph">
<p>The SAML <em>POST</em> binding works almost the exact same way as the <em>Redirect</em> binding, but instead of GET requests, XML
documents are exchanged by POST requests.  The <em>POST</em> Binding uses JavaScript to trick the browser into making a POST request to
the Keycloak server or application when exchanging documents.  Basically HTTP responses contain an HTML document
that contains an HTML form with embedded JavaScript.  When the page is loaded, the JavaScript automatically invokes the form.
You really don&#8217;t need to know about this stuff, but it is a pretty clever trick.</p>
</div>
<div class="paragraph">
<p><em>POST</em> binding is usually recommended because of security and size restrictions. When using <em>REDIRECT</em> the SAML response
is part of the URL (it is a query parameter as it was explained before), so it can be captured in logs and it is considered
less secure. Regarding size, if the assertion contains a lot or large attributes sending the document inside the HTTP payload
is always better than in the more limited URL.</p>
</div>
</div>
<div class="sect4">
<h5 id="ecp"><a class="anchor" href="#ecp"></a>ECP</h5>
<div class="paragraph">
<p>ECP stands for "Enhanced Client or Proxy", a SAML v.2.0 profile which allows for the exchange of SAML attributes outside the context of a web browser.
This is used most often for REST or SOAP-based clients.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="keycloak-server-saml-uri-endpoints"><a class="anchor" href="#keycloak-server-saml-uri-endpoints"></a>Keycloak Server SAML URI Endpoints</h4>
<div class="paragraph">
<p>Keycloak really only has one endpoint for all SAML requests.</p>
</div>
<div class="paragraph">
<p><code>http(s)://authserver.host/auth/realms/{realm-name}/protocol/saml</code></p>
</div>
<div class="paragraph">
<p>All bindings use this endpoint.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="openid-connect-vs-saml"><a class="anchor" href="#openid-connect-vs-saml"></a>OpenID Connect vs. SAML</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sso-protocols/saml-vs-oidc.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sso-protocols/saml-vs-oidc.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Choosing between OpenID Connect and SAML is not just a matter of using a newer protocol (OIDC) instead of the older more mature protocol (SAML).</p>
</div>
<div class="paragraph">
<p>In most cases Keycloak recommends using OIDC.</p>
</div>
<div class="paragraph">
<p>SAML tends to be a bit more verbose than OIDC.</p>
</div>
<div class="paragraph">
<p>Beyond verbosity of exchanged data, if you compare the specifications you&#8217;ll find that OIDC was designed to work with the web while SAML was retrofitted to work on top of the web.  For example, OIDC is also more suited for HTML5/JavaScript applications because it is
easier to implement on the client side than SAML. As tokens are in the JSON format,
they are easier to consume by JavaScript. You will also find several nice features that
make implementing security in your web applications easier. For example, check out the <a href="https://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification">iframe trick</a> that the specification uses to easily determine if a user is still logged in or not.</p>
</div>
<div class="paragraph">
<p>SAML has its uses though. As you see the OIDC specifications evolve you see they implement more and more features that SAML has had for years. What we often see is that people pick SAML over OIDC because of the perception that it is more mature and also because they already have existing applications that are secured with it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_docker"><a class="anchor" href="#_docker"></a>Docker Registry v2 Authentication</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sso-protocols/docker.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sso-protocols/docker.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Docker authentication is disabled by default. To enable see <a href="https://www.keycloak.org/docs/12.0/server_installation/#profiles">Profiles</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://docs.docker.com/registry/spec/auth/">Docker Registry V2 Authentication</a> is an OIDC-Like protocol used to authenticate users against a Docker registry.  Keycloak&#8217;s implementation of this protocol allows for a Keycloak authentication server to be used by a Docker client to authenticate against a registry.  While this protocol uses fairly standard token and signature mechanisms, it has a few wrinkles that prevent it from being treated as a true OIDC implementation.  The largest deviations include a very specific JSON format for requests and responses as well as the ability to understand how to map repository names and permissions to the OAuth scope mechanism.</p>
</div>
<div class="sect3">
<h4 id="docker-auth-flow"><a class="anchor" href="#docker-auth-flow"></a>Docker Auth Flow</h4>
<div class="paragraph">
<p>The <a href="https://docs.docker.com/registry/spec/auth/token/">Docker API documentation</a> best describes and illustrates this process, however a brief summary will be given below from the perspective of the Keycloak authentication server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This flow assumes that a <code>docker login</code> command has already been performed
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>The flow begins when the Docker client requests a resource from the Docker registry.  If the resource is protected and no auth token is present in the request, the Docker registry server will respond to the client with a 401 + some information on required permissions and where to find the authorization server.</p>
</li>
<li>
<p>The Docker client will construct an authentication request based on the 401 response from the Docker registry.  The client will then use the locally cached credentials (from a previously run <code>docker login</code> command) as part of a <a href="https://tools.ietf.org/html/rfc2617">HTTP Basic Authentication</a> request to the Keycloak authentication server.</p>
</li>
<li>
<p>The Keycloak authentication server will attempt to authenticate the user and return a JSON body containing an OAuth-style Bearer token.</p>
</li>
<li>
<p>The Docker client will get the bearer token from the JSON response and use it in the Authorization header to request the protected resource.</p>
</li>
<li>
<p>When the Docker registry receives the new request for the protected resource with the token from the Keycloak server, the registry validates the token and grants access to the requested resource (if appropriate).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
No user session is created on the Keycloak side after successful authentication with the Docker protocol. The Docker protocol is
not used in case of browser SSO session and it does not have a way to refresh token or ask Keycloak server if a particular token/session
is still valid. So creating the session is unnecessary overhead for this protocol. For more details, see the <a href="#_transient-session">transient session</a> section.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="keycloak-docker-registry-v2-authentication-server-uri-endpoints"><a class="anchor" href="#keycloak-docker-registry-v2-authentication-server-uri-endpoints"></a>Keycloak Docker Registry v2 Authentication Server URI Endpoints</h4>
<div class="paragraph">
<p>Keycloak really only has one endpoint for all Docker auth v2 requests.</p>
</div>
<div class="paragraph">
<p><code>http(s)://authserver.host/auth/realms/{realm-name}/protocol/docker-v2</code></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clients"><a class="anchor" href="#_clients"></a>Managing Clients</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Clients are entities that can request authentication of a user.  Clients come in two forms.
The first type of client is an application that wants
to participate in single-sign-on.  These clients just want Keycloak to provide security for them.  The other type
of client is one that is requesting an access token so that it can invoke other services on behalf of the authenticated user.
This section discusses various aspects around configuring clients and various ways to do it.</p>
</div>
<div class="sect2">
<h3 id="oidc-clients"><a class="anchor" href="#oidc-clients"></a>OIDC Clients</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/client-oidc.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/client-oidc.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p><a href="#_oidc">OpenID Connect</a> is the preferred protocol to secure applications.  It was designed from the ground up to be web friendly
and work best with HTML5/JavaScript applications.</p>
</div>
<div class="paragraph">
<p>To create an OIDC client go to the <code>Clients</code> left menu item.  On this page you&#8217;ll see a <code>Create</code> button on the right.</p>
</div>
<div class="paragraph">
<div class="title">Clients</div>
<p><span class="image"><img src="./keycloak-images/clients.png" alt="clients"></span></p>
</div>
<div class="paragraph">
<p>This will bring you to the <code>Add Client</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Client</div>
<p><span class="image"><img src="./keycloak-images/add-client-oidc.png" alt="add client oidc"></span></p>
</div>
<div class="paragraph">
<p>Enter in the <code>Client ID</code> of the client.  This should be a simple
alpha-numeric string that will be used in requests and in the Keycloak database to identify the client.
Next select <code>openid-connect</code> in the <code>Client Protocol</code> drop down box.
Finally enter in the base URL of your
application in the <code>Root URL</code> field and click <code>Save</code>.  This will create the client and bring you to the client <code>Settings</code>
tab.</p>
</div>
<div class="paragraph">
<div class="title">Client Settings</div>
<p><span class="image"><img src="./keycloak-images/client-settings-oidc.png" alt="client settings oidc"></span></p>
</div>
<div class="paragraph">
<p>Let&#8217;s walk through each configuration item on this page.</p>
</div>
<div class="paragraph">
<p><strong>Client ID</strong></p>
</div>
<div class="paragraph">
<p>This specifies an alpha-numeric string that will be used as the client identifier for OIDC requests.</p>
</div>
<div class="paragraph">
<p><strong>Name</strong></p>
</div>
<div class="paragraph">
<p>This is the display name for the client whenever it is displayed in a Keycloak UI screen.  You can localize
the value of this field by setting up a replacement string value i.e. ${myapp}.  See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a>
for more information.</p>
</div>
<div class="paragraph">
<p><strong>Description</strong></p>
</div>
<div class="paragraph">
<p>This specifies the description of the client.  This can also be localized.</p>
</div>
<div class="paragraph">
<p><strong>Enabled</strong></p>
</div>
<div class="paragraph">
<p>If this is turned off, the client will not be allowed to request authentication.</p>
</div>
<div class="paragraph">
<p><strong>Consent Required</strong></p>
</div>
<div class="paragraph">
<p>If this is on, then users will get a consent page which asks the user if they grant access to that application.  It will also
display the metadata that the client is interested in so that the user knows exactly what information the client is getting access to.
If you&#8217;ve ever done a social login to Google, you&#8217;ll often see a similar page.  Keycloak provides the same functionality.</p>
</div>
<div id="_access-type" class="paragraph">
<p><strong>Access Type</strong></p>
</div>
<div class="paragraph">
<p>This defines the type of the OIDC client.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>confidential</em></dt>
<dd>
<p>Confidential access type is for server-side clients that need to perform a browser login and require a client secret when they turn an access code into an access token,
(see <a href="https://tools.ietf.org/html/rfc6749#section-4.1.3">Access Token Request</a> in the OAuth 2.0 spec for more details). This type should be used for server-side applications.</p>
</dd>
<dt class="hdlist1"><em>public</em></dt>
<dd>
<p>Public access type is for client-side clients that need to perform a browser login. With a client-side application there is no way to keep a secret safe. Instead it is very important to restrict  access by configuring correct redirect URIs for the client.</p>
</dd>
<dt class="hdlist1"><em>bearer-only</em></dt>
<dd>
<p>Bearer-only access type means that the application only allows bearer token requests.
If this is turned on, this application cannot participate in browser logins.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><strong>Standard Flow Enabled</strong></p>
</div>
<div class="paragraph">
<p>If this is on, clients are allowed to use the OIDC <a href="#_oidc-auth-flows">Authorization Code Flow</a>.</p>
</div>
<div class="paragraph">
<p><strong>Implicit Flow Enabled</strong></p>
</div>
<div class="paragraph">
<p>If this is on, clients are allowed to use the OIDC <a href="#_oidc-auth-flows">Implicit Flow</a>.</p>
</div>
<div class="paragraph">
<p><strong>Direct Access Grants Enabled</strong></p>
</div>
<div class="paragraph">
<p>If this is on, clients are allowed to use the OIDC <a href="#_oidc-auth-flows">Direct Access Grants</a>.</p>
</div>
<div class="paragraph">
<p><strong>Root URL</strong></p>
</div>
<div class="paragraph">
<p>If Keycloak uses any configured relative URLs, this value is prepended to them.</p>
</div>
<div class="paragraph">
<p><strong>Valid Redirect URIs</strong></p>
</div>
<div class="paragraph">
<p>This is a required field.  Enter in a URL pattern and click the + sign to add.  Click the - sign next to URLs you want to remove.
Remember that you still have to click the <code>Save</code> button!
Wildcards (*) are only allowed at the end of a URI, i.e. http://host.com/*</p>
</div>
<div class="paragraph">
<p>You should take extra precautions when registering valid redirect URI patterns. If you make
them too general you are vulnerable to attacks.  See <a href="#_unspecific-redirect-uris">Threat Model Mitigation</a> chapter
for more information.</p>
</div>
<div class="paragraph">
<p><strong>Base URL</strong></p>
</div>
<div class="paragraph">
<p>If Keycloak needs to link to the client, this URL is used.</p>
</div>
<div class="paragraph">
<p><strong>Admin URL</strong></p>
</div>
<div class="paragraph">
<p>For Keycloak specific client adapters, this is the callback endpoint for the client.  The Keycloak
server will use this URI to make callbacks like pushing revocation policies, performing backchannel logout, and other
administrative operations.  For Keycloak servlet adapters, this can be the root URL of the servlet application.
For more information see <a href="https://www.keycloak.org/docs/12.0/securing_apps/">Securing Applications and Services Guide</a>.</p>
</div>
<div class="paragraph">
<p><strong>Web Origins</strong></p>
</div>
<div class="paragraph">
<p>This option centers around <a href="https://fetch.spec.whatwg.org/">CORS</a> which stands for Cross-Origin Resource Sharing.
If browser JavaScript tries to make an AJAX HTTP request to a server whose domain is different from the one the
JavaScript code came from, then the request must use CORS.
The server must handle CORS requests in a special way, otherwise the browser will not display or allow the request to be processed.
This protocol exists to protect against XSS, CSRF and other JavaScript-based attacks.</p>
</div>
<div class="paragraph">
<p>Keycloak has support for validated CORS requests.  The way it works is that the domains listed in the
<code>Web Origins</code> setting for the client are embedded within the access token sent to the client application.  The client
application can then use this information to decide whether or not to allow a CORS request to be invoked on it.  This is
an extension to the OIDC protocol so only Keycloak client adapters support this feature.
See <a href="https://www.keycloak.org/docs/12.0/securing_apps/">Securing Applications and Services Guide</a> for more information.</p>
</div>
<div class="paragraph">
<p>To fill in the <code>Web Origins</code> data, enter in a base URL and click the + sign to add.  Click the - sign next to URLs you want to remove.
Remember that you still have to click the <code>Save</code> button!</p>
</div>
<div class="sect3">
<h4 id="advanced-settings"><a class="anchor" href="#advanced-settings"></a>Advanced Settings</h4>
<div id="_mtls-client-certificate-bound-tokens" class="paragraph">
<p><strong>OAuth 2.0 Mutual TLS Certificate Bound Access Tokens Enabled</strong></p>
</div>
<div class="paragraph">
<p>Mutual TLS binds an access token and a refresh token with a client certificate exchanged during TLS handshake. This prevents an attacker who finds a way to steal these tokens from exercising the tokens. This type of token is called a holder-of-key token. Unlike bearer tokens, the recipient of a holder-of-key token can verify whether the sender of the token is legitimate.</p>
</div>
<div class="paragraph">
<p>If the following conditions are satisfied on a token request, Keycloak will bind an access token and a refresh token with a client certificate and issue them as holder-of-key tokens. If all conditions are not met, Keycloak rejects the token request.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The feature is turned on</p>
</li>
<li>
<p>A token request is sent to the token endpoint in an authorization code flow or a hybrid flow</p>
</li>
<li>
<p>On TLS handshake, Keycloak requests a client certificate and a client send its client certificate</p>
</li>
<li>
<p>On TLS handshake, Keycloak successfully verifies the client certificate</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To enable mutual TLS in Keycloak, see <a href="#_enable-mtls-wildfly">Enable mutual SSL in WildFly</a>.</p>
</div>
<div class="paragraph">
<p>In the following cases, Keycloak will verify the client sending the access token or the refresh token; if verification fails, Keycloak rejects the token.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A token refresh request is sent to the token endpoint with a holder-of-key refresh token</p>
</li>
<li>
<p>A UserInfo request is sent to UserInfo endpoint with a holder-of-key access token</p>
</li>
<li>
<p>A logout request is sent to Logout endpoint with a holder-of-key refresh token</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please see <a href="https://tools.ietf.org/html/draft-ietf-oauth-mtls-08#section-3">Mutual TLS Client Certificate Bound Access Tokens</a> in the OAuth 2.0 Mutual TLS Client Authentication and Certificate Bound Access Tokens for more details.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
None of the keycloak client adapters currently support holder-of-key token verification.
Instead, keycloak adapters currently treat access and refresh tokens as bearer tokens.
</td>
</tr>
</table>
</div>
<div id="_proof-key-for-code-exchange" class="paragraph">
<p><strong>Proof Key for Code Exchange (PKCE)</strong></p>
</div>
<div class="paragraph">
<p>When an attacker steals an authorization code that was issued to a legitimate client, PKCE prevents the attacker from receiving the tokens that apply to that code.</p>
</div>
<div class="paragraph">
<p>The administrator can select the following three options:</p>
</div>
<div class="paragraph">
<p><strong>Proof Key for Code Exchange Code Challenge Method</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>(blank) : Keycloak does not apply PKCE unless the client sends PKCE&#8217;s parameters appropriately to Keycloak&#8217;s authorization endpoint. It is the default setting.</p>
</li>
<li>
<p>S256 : Keycloak applies to the client PKCE whose code challenge method is S256.</p>
</li>
<li>
<p>plain : Keycloak applies to the client PKCE whose code challenge method is plain.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please see <a href="https://tools.ietf.org/html/rfc7636">RFC 7636 Proof Key for Code Exchange by OAuth Public Clients</a> for more details.</p>
</div>
<div id="_jwe-id-token-encryption" class="paragraph">
<p><strong>Signed and Encrypted ID Token Support</strong></p>
</div>
<div class="paragraph">
<p>Keycloak can encrypt ID token according to the <a href="https://tools.ietf.org/html/rfc7516">Json Web Encryption (JWE)</a> specification. The administrator can determine whether encrypting ID token or not per client. This feature is disabled as default.</p>
</div>
<div class="paragraph">
<p>The key for encrypting ID token is called Content Encryption Key (CEK). Keycloak and a client need to negotiate which CEK is used and how to deliver it. The way to do so is called Key Management Mode.</p>
</div>
<div class="paragraph">
<p>JWE specification determines 5 types of Key Management Mode. Keycloak supports Key Encryption among them.</p>
</div>
<div class="paragraph">
<p>In Key Encryption, the client generates a key pair of asymmetric cryptography. The public key is used to encrypt CEK. Keycloak generates CEK per ID token, encrypts the ID token by this generated CEK and encrypts this CEK by this client&#8217;s public key. The client decrypts this encrypted CEK by their private key, and decrypt the ID token by decrypted CEK. Therefore, any party other than the client is not able to decrypt ID token.</p>
</div>
<div class="paragraph">
<p>The client needs to pass their public key for encrypting CEK onto Keycloak. Keycloak supports downloading public keys from the URL the client provides. The client needs to provide their public keys according to <a href="https://tools.ietf.org/html/rfc7517">Json Web Keys (JWK)</a> specification. The way to do so is defined in <code>Signed JWT</code> of <a href="#_client-credentials">Confidential Client Credentials</a>. The detailed procedure is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>open the client&#8217;s <code>Credentials</code> tab</p>
</li>
<li>
<p>select <code>Signed Jwt</code> from <code>Client Authenticator</code> pulldown menu</p>
</li>
<li>
<p>set ON to <code>JWKS URL</code> switch</p>
</li>
<li>
<p>input the client&#8217;s public key providing URL on <code>JWKS URL</code> textbox</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Key Encryption&#8217;s algorithms are defined in the <a href="https://tools.ietf.org/html/rfc7518#section-4.1">Json Web Algorithm (JWA)</a> specification. Keycloak supports RSAES-PKCS1-v1_5(RSA1_5), RSAES OAEP using default parameters (RSA-OAEP), and RSAES OAEP 256 using SHA-256 and MFG1 (RSA-OAEP-256). The detailed procedure to select this algorithm is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>open the client&#8217;s <code>Settings</code> tab</p>
</li>
<li>
<p>open <code>Fine Grain OpenID Connect Configuration</code></p>
</li>
<li>
<p>select <code>RSA1_5</code>,  <code>RSA-OAEP</code>, or <code>RSA-OAEP-256</code> from <code>ID Token Encryption Key Management Algorithm</code> pulldown menu</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ID token encryption algorithms by CEK are also defined in the <a href="https://tools.ietf.org/html/rfc7518#section-5.1">JWA</a> specification. Keycloak supports AES_CBC_HMAC_SHA2 algorithms and AES GCM algorithms. The detailed procedure to select this algorithm is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>open the client&#8217;s <code>Settings</code> tab</p>
</li>
<li>
<p>open <code>Fine Grain OpenID Connect Configuration</code></p>
</li>
<li>
<p>select the algorithm from <code>ID Token Encryption Content Encryption Algorithm</code> pulldown menu</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_client-credentials"><a class="anchor" href="#_client-credentials"></a>Confidential Client Credentials</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/oidc/confidential.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/oidc/confidential.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;ve set the client&#8217;s <a href="#_access-type">access type</a> to <code>confidential</code> in the client&#8217;s
<code>Settings</code> tab, a new <code>Credentials</code> tab will show up. Note that the <code>Credentials</code> tab only
shows up after you&#8217;ve clicked the <code>Save</code> button at the bottom of the settings screen with a
<code>confidential</code> access type. As part of dealing with thistype of client you have to configure
the client&#8217;s credentials.</p>
</div>
<div class="paragraph">
<div class="title">Credentials Tab</div>
<p><span class="image"><img src="./keycloak-images/client-credentials.png" alt="client credentials"></span></p>
</div>
<div class="paragraph">
<p>The <code>Client Authenticator</code> list box specifies the type of credential you are going to use for your confidential client.
It defaults to client ID and secret.  The secret is automatically generated for you and the <code>Regenerate Secret</code>
button allows you to recreate this secret if you want or need to.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can opt to use a signed Json Web Token (JWT) or x509 certificate validation (also called Mutual TLS) instead of a secret.</p>
</div>
<div class="paragraph">
<div class="title">Signed JWT</div>
<p><span class="image"><img src="./keycloak-images/client-credentials-jwt.png" alt="client credentials jwt"></span></p>
</div>
<div class="paragraph">
<p>When choosing this credential type you will have to also generate a private key and certificate for the client.  The private key
will be used to sign the JWT, while the certificate is used by the server to verify the signature.  Click on the
<code>Generate new keys and certificate</code> button to start this process.</p>
</div>
<div class="paragraph">
<div class="title">Generate Keys</div>
<p><span class="image"><img src="./keycloak-images/generate-client-keys.png" alt="generate client keys"></span></p>
</div>
<div class="paragraph">
<p>When you generate these keys, Keycloak will store the certificate, and you&#8217;ll need to download the private key
and certificate for your client to use.  Pick the archive format you want and specify the password for the private key
and store.</p>
</div>
<div class="paragraph">
<p>You can also opt to
generate these via an external tool and just import the client&#8217;s certificate.</p>
</div>
<div class="paragraph">
<div class="title">Import Certificate</div>
<p><span class="image"><img src="./keycloak-images/import-client-cert.png" alt="import client cert"></span></p>
</div>
<div class="paragraph">
<p>There are multiple formats you can import from, just choose the archive format you have the certificate stored in,
select the file, and click the <code>Import</code> button.</p>
</div>
<div class="paragraph">
<p>Finally note that you don&#8217;t even need to import certificate if you choose to <code>Use JWKS URL</code> . In that case, you can provide the URL where
client publishes its public key in <a href="https://self-issued.info/docs/draft-ietf-jose-json-web-key.html">JWK</a> format. This is flexible because when
client changes its keys, Keycloak will automatically download them without need to re-import anything on Keycloak side.</p>
</div>
<div class="paragraph">
<p>If you use client secured by Keycloak adapter, you can configure the JWKS URL like <a href="https://myhost.com/myapp/k_jwks" class="bare">https://myhost.com/myapp/k_jwks</a> assuming that <a href="https://myhost.com/myapp" class="bare">https://myhost.com/myapp</a> is the
root URL of your client application. See <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for additional details.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
For the performance purposes, Keycloak caches the public keys of the OIDC clients. If you think that private key of your client
was compromised, it is obviously good to update your keys, but it&#8217;s also good to clear the keys cache. See <a href="#_clear-cache">Clearing the cache</a>
section for more details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Signed JWT with Client Secret</div>
<p>If you select this option in the <code>Client Authenticator</code> list box, you can use a JWT signed by client secret instead of the private key.</p>
</div>
<div class="paragraph">
<p>This client secret will be used to sign the JWT by the client.</p>
</div>
<div class="paragraph">
<div class="title">X509 Certificate</div>
<p>By enabling this option Keycloak will validate if the client uses proper X509 certificate during the TLS Handshake.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This option requires mutual TLS in Keycloak, see <a href="#_enable-mtls-wildfly">Enable mutual SSL in WildFly</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">X509 Certificate</div>
<p><span class="image"><img src="./keycloak-images/x509-client-auth.png" alt="x509 client auth"></span></p>
</div>
<div class="paragraph">
<p>The validator checks also the certificate&#8217;s Subject DN field with configured regexp validation expression. For some
use cases, it is sufficient to accept all certificates. In that case, you can use <code>(.*?)(?:$)</code> expression.</p>
</div>
<div class="paragraph">
<p>There are two ways for Keycloak to obtain the Client ID from the request. The first option is the <code>client_id</code>
parameter in the query (described in Section 2.2 of the <a href="https://tools.ietf.org/html/rfc6749">OAuth 2.0 Specification</a>).
The second option is to supply <code>client_id</code> as a form parameter.</p>
</div>
</div>
<div class="sect3">
<h4 id="_service_accounts"><a class="anchor" href="#_service_accounts"></a>Service Accounts</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/oidc/service-accounts.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/oidc/service-accounts.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Each OIDC client has a built-in <em>service account</em> which allows it to obtain an access token.
This is covered in the OAuth 2.0 specifiation under <a href="#_client_credentials_grant">Client Credentials Grant</a>.
To use this feature you must set the <a href="#_access-type">Access Type</a> of your client to <code>confidential</code>.  When you do this,
the <code>Service Accounts Enabled</code> switch will appear.  You need to turn on this switch.  Also make sure that you have
configured your <a href="#_client-credentials">client credentials</a>.</p>
</div>
<div class="paragraph">
<p>To use it you must have registered a valid <code>confidential</code> Client and you need to check the switch <code>Service Accounts Enabled</code> in Keycloak admin console for this client.
In tab <code>Service Account Roles</code> you can configure the roles available to the service account retrieved on behalf of this client.
Remember that you must have the roles available in Role Scope Mappings (tab <code>Scope</code>) of this client as well, unless you
have <code>Full Scope Allowed</code> on. As in a normal login, roles from access token are the intersection of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Role scope mappings of particular client combined with the role scope mappings inherited from linked client scopes</p>
</li>
<li>
<p>Service account roles</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The REST URL to invoke on is <code>/auth/realms/{realm-name}/protocol/openid-connect/token</code>.
Invoking on this URL is a POST request and requires you to post the client credentials.
By default, client credentials are represented by clientId and clientSecret of the client in <code>Authorization: Basic</code> header, but you can also authenticate the client with a signed JWT assertion or any other custom mechanism for client authentication.
You also need to use the parameter <code>grant_type=client_credentials</code> as per the OAuth2 specification.</p>
</div>
<div class="paragraph">
<p>For example the POST invocation to retrieve a service account can look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    POST /auth/realms/demo/protocol/openid-connect/token
    Authorization: Basic cHJvZHVjdC1zYS1jbGllbnQ6cGFzc3dvcmQ=
    Content-Type: application/x-www-form-urlencoded

    grant_type=client_credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response would be this <a href="https://tools.ietf.org/html/rfc6749#section-4.4.3">standard JSON document</a> from the OAuth 2.0 specification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
    "access_token":"2YotnFZFEjr1zCsicMWpAA",
    "token_type":"bearer",
    "expires_in":60
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is the only access token returned by default. There is no refresh token returned and there is also no user session created
on the Keycloak side upon successful authentication by default. Due the lack of refresh token, there is a need to re-authenticate when access token expires,
however this does not mean any additional overhead on  Keycloak server side due the fact that sessions are not created by default.</p>
</div>
<div class="paragraph">
<p>Due to this, there is no need for logout, however issued access tokens can be revoked by sending request to the OAuth2 Revocation Endpoint described
in the <a href="#_oidc-endpoints">OpenID Connect Endpoints</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="_audience"><a class="anchor" href="#_audience"></a>Audience Support</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/oidc/audience.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/oidc/audience.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The typical environment where the Keycloak is deployed generally consists of a set of <em>confidential</em> or <em>public</em> client
applications (frontend client applications) which use Keycloak for authentication.</p>
</div>
<div class="paragraph">
<p>There are also <em>services</em> (called <em>Resource Servers</em> in the OAuth 2 specification), which serve requests from frontend client
applications and provide resources. These services typically require an <em>Access token</em> (Bearer token) to be sent to them to
authenticate for a particular request. This token was previously obtained by the frontend application when it tries to log in
against Keycloak.</p>
</div>
<div class="paragraph">
<p>In the environment where the trust among services is low, you may encounter this scenario:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A frontend client called <code>my-app</code> is required to be authenticated against Keycloak.</p>
</li>
<li>
<p>A user is authenticated in Keycloak. Keycloak then issued tokens to the <code>my-app</code> application.</p>
</li>
<li>
<p>The application <code>my-app</code> used the token to invoke the service <code>evil-service</code>. The application needs to invoke <code>evil-service</code> as
the service is able to serve some very useful data.</p>
</li>
<li>
<p>The <code>evil-service</code> application returned the response to <code>my-app</code>. However, at the same time, it kept the token previously sent to it.</p>
</li>
<li>
<p>The <code>evil-service</code> application then invoked another service called <code>good-service</code> with the previously kept token. The invocation
was successful and <code>good-service</code> returned the data. This results in broken security as the <code>evil-service</code> misused the token to
access other services on behalf of the client <code>my-app</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This flow may not be an issue in many environments with the high level of trust among services. However in other environments, where
the trust among services is lower, this can be problematic.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In some environments, this example work flow may be even requested behavior as the <code>evil-service</code> may need to retrieve
      additional data from <code>good-service</code> to be able to properly return the requested data to the original caller (my-app client).
      You may notice similarities with the Kerberos Credential Delegation. As with the Kerberos Credential Delegation, an unlimited
      audience is a mixed blessing as it is only useful when a high level of trust exists among services. Otherwise, it is
      recommended to limit audience as described next. You can limit audience and at the same time allow the <code>evil-service</code> to
      retrieve required data from the <code>good-service</code>. In this case, you need to ensure that both the <code>evil-service</code> and <code>good-service</code>
      are added as audiences to the token.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To prevent any misuse of the access token as in the example above, it is recommended to limit <em>Audience</em> on the token and configure
your services to verify the audience on the token. If this is done, the flow above will change, like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A frontend client called <code>my-app</code> is required to be authenticated against Keycloak.</p>
</li>
<li>
<p>A user is authenticated in Keycloak. Keycloak then issued tokens to the <code>my-app</code> application. The client application
already knows that it will need to invoke service <code>evil-service</code>, so it used <code>scope=evil-service</code> in the authentication request
sent to the Keycloak server. See <a href="#_client_scopes">Client Scopes section</a> for more details about the <em>scope</em> parameter.
The token issued to the <code>my-app</code> client contains the audience, as in <code>"audience": [ "evil-service" ]</code>, which declares that the
client wants to use this access token to invoke just the service <code>evil-service</code>.</p>
</li>
<li>
<p>The <code>evil-service</code> application served the request to the <code>my-app</code>. At the same time, it kept the token previously sent to it.</p>
</li>
<li>
<p>The <code>evil-service</code> application then invoked the <code>good-service</code> with the previously kept token. Invocation was not successful
because <code>good-service</code> checks the audience on the token and it sees that audience is only <code>evil-service</code>. This is expected behavior
and security is not broken.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the client wants to invoke the <code>good-service</code> later, it will need to obtain another token by issuing the SSO login with the
<code>scope=good-service</code>. The returned token will then contain <code>good-service</code> as an audience:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="key"><span class="delimiter">&quot;</span><span class="content">audience</span><span class="delimiter">&quot;</span></span>: [ <span class="string"><span class="delimiter">&quot;</span><span class="content">good-service</span><span class="delimiter">&quot;</span></span> ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>and can be used to invoke <code>good-service</code>.</p>
</div>
<div class="sect4">
<h5 id="setup-3"><a class="anchor" href="#setup-3"></a>Setup</h5>
<div class="paragraph">
<p>To properly set up audience checking:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure that services are configured to check audience on the access token sent to them by adding the flag <em>verify-token-audience</em>
in the adapter configuration. See <a href="https://www.keycloak.org/docs/12.0/securing_apps/#_java_adapter_config">Adapter configuration</a> for details.</p>
</li>
<li>
<p>Ensure that when an access token is issued by Keycloak, it contains all requested audiences and does not contain any
audiences that are not needed. The audience can be either automatically added due the client roles as described
in the <a href="#_audience_resolve">next section</a> or it can be hardcoded as described <a href="#_audience_hardcoded">below</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_audience_resolve"><a class="anchor" href="#_audience_resolve"></a>Automatically add audience</h5>
<div class="paragraph">
<p>In the default client scope <em>roles</em>, there is an <em>Audience Resolve</em>
protocol mapper defined. This protocol mapper will check all the clients for which current token has at least one client role
available. Then the client ID of each of those clients will be added as an audience automatically. This is especially useful if
your service (usually bearer-only) clients rely on client roles.</p>
</div>
<div class="paragraph">
<p>As an example, let us assume that you have a bearer-only client <code>good-service</code> and the confidential client <code>my-app</code>, which you want
to authenticate and then use the access token issued for the <code>my-app</code> to invoke the <code>good-service</code> REST service. If the following
are true:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>good-service</code> client has any client roles defined on itself</p>
</li>
<li>
<p>Target user has at least one of those client roles assigned</p>
</li>
<li>
<p>Client <code>my-app</code> has the role scope mappings for the assigned role</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>then the <code>good-service</code> will be automatically added as an audience to the access token issued for the <code>my-app</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to ensure that audience is not added automatically, do not configure role scope mappings directly
on the <code>my-app</code> client, but instead create a dedicated client scope, for example called <code>good-service</code>, which will contain the role scope mappings
for the client roles of the <code>good-service</code> client. Assuming that this client scope will be added as an optional client scope to
the <code>my-app</code> client, the client roles and audience will be added to the token just if explicitly requested by the <code>scope=good-service</code> parameter.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The frontend client itself is not automatically added to the access token audience. This allows for easy differentiation between
the access token and the ID token, because the access token will not contain the client for which the token was issued as an audience. So in
the example above, the <code>my-app</code> won&#8217;t be added as an audience. If you need the client itself as an audience, see the
<a href="#_audience_hardcoded">hardcoded audience</a> option. However, using the same client as both frontend and REST service is not recommended.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_audience_hardcoded"><a class="anchor" href="#_audience_hardcoded"></a>Hardcoded audience</h5>
<div class="paragraph">
<p>For the case when your service relies on realm roles or does not rely on the roles in the token at all, it can be useful to use hardcoded
audience. This is a protocol mapper, which will add client ID of the specified service client as an audience to the token.
You can even use any custom value, for example some URL, if you want different audience than client ID.</p>
</div>
<div class="paragraph">
<p>You can add protocol mapper directly to the frontend client, however than the audience will be always added. If you want more fine-grain
control, you can create protocol mapper on the dedicated client scope, which will be called for example <code>good-service</code>.</p>
</div>
<div class="paragraph">
<div class="title">Audience Protocol Mapper</div>
<p><span class="image"><img src="./keycloak-images/audience_mapper.png" alt="audience mapper"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>From the <a href="#_client_installation">Installation tab</a> of the <code>good-service</code> client, you can generate the adapter
configuration and you can confirm that <em>verify-token-audience</em> option will be set to true. This indicates that the adapter will
require verifying the audience if you use this generated configuration.</p>
</li>
<li>
<p>Finally, you need to ensure that the <code>my-app</code> frontend client is able to request <code>good-service</code> as an audience in its tokens.
On the <code>my-app</code> client, click the <em>Client Scopes</em> tab. Then assign <code>good-service</code> as an optional (or default) client scope. See
<a href="#_client_scopes_linking">Client Scopes Linking section</a> for more details.</p>
</li>
<li>
<p>You can optionally <a href="#_client_scopes_evaluate">Evaluate Client Scopes</a> and generate an example access token. If you do, notice
that <code>good-service</code> will be added to the audience of the generated access token only if <code>good-service</code> is included in the <em>scope</em>
parameter in the case you assigned it as an optional client scope.</p>
</li>
<li>
<p>In your <code>my-app</code> application, you must ensure that <em>scope</em> parameter is used with the value <code>good-service</code> always included when
you want to issue the token for accessing the <code>good-service</code>.
See the <a href="https://www.keycloak.org/docs/12.0/securing_apps/#_params_forwarding">parameters forwarding section</a>, if your application uses the servlet
adapter, or the <a href="https://www.keycloak.org/docs/12.0/securing_apps/#_javascript_adapter">javascript adapter section</a>, if your application uses the
javascript adapter.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are unsure what the correct audience and roles in the token will be, it is always a good idea to
<a href="#_client_scopes_evaluate">Evaluate Client Scopes</a> in the admin console and do some testing around it.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Both the <em>Audience</em> and <em>Audience Resolve</em> protocol mappers add the audiences just to the access token by default. The ID Token
typically contains only single audience, which is the client ID of the client for which the token was issued. This is a requirement
of the OpenID Connect specification. On the other hand, the access token does not necessarily have the client ID of the client,
which was the token issued for, unless any of the audience mappers added it.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="saml-clients"><a class="anchor" href="#saml-clients"></a>SAML Clients</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/client-saml.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/client-saml.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak supports <a href="#_saml">SAML 2.0</a> for registered applications.
Both POST and Redirect bindings are supported.
You can choose to require client signature validation and can have the server sign and/or encrypt responses as well.</p>
</div>
<div class="paragraph">
<p>To create a SAML client go to the <code>Clients</code> left menu item.  On this page you&#8217;ll see a <code>Create</code> button on the right.</p>
</div>
<div class="paragraph">
<div class="title">Clients</div>
<p><span class="image"><img src="./keycloak-images/clients.png" alt="clients"></span></p>
</div>
<div class="paragraph">
<p>This will bring you to the <code>Add Client</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Client</div>
<p><span class="image"><img src="./keycloak-images/add-client-saml.png" alt="add client saml"></span></p>
</div>
<div class="paragraph">
<p>Enter in the <code>Client ID</code> of the client.  This is often a URL and will be the expected <code>issuer</code> value in SAML requests sent
by the application.  Next select <code>saml</code> in the <code>Client Protocol</code> drop down box.
Finally enter in the <code>Client SAML Endpoint</code> URL.  Enter the
URL you want the Keycloak server to send SAML requests and responses to.  Usually applications have only one URL for processing SAML requests.
If your application has different URLs for its bindings, don&#8217;t worry, you can fix this in the <code>Settings</code> tab of the client.
Click <code>Save</code>.  This will create the client and bring you to the client <code>Settings</code>
tab.</p>
</div>
<div class="paragraph">
<div class="title">Client Settings</div>
<p><span class="image"><img src="./keycloak-images/client-settings-saml.png" alt="client settings saml"></span></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Client ID</dt>
<dd>
<p>This value must match the issuer value sent with AuthNRequests.
Keycloak will pull the issuer from the Authn SAML request and match it to a client by this value.</p>
</dd>
<dt class="hdlist1">Name</dt>
<dd>
<p>This is the display name for the client whenever it is displayed in a Keycloak UI screen.  You can localize
the value of this field by setting up a replacement string value i.e. ${myapp}.  See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a>
for more information.</p>
</dd>
<dt class="hdlist1">Description</dt>
<dd>
<p>This specifies the description of the client.  This can also be localized.</p>
</dd>
<dt class="hdlist1">Enabled</dt>
<dd>
<p>If this is turned off, the client will not be allowed to request authentication.</p>
</dd>
<dt class="hdlist1">Consent Required</dt>
<dd>
<p>If this is on, then users will get a consent page which asks the user if they grant access to that application.  It will also
display the metadata that the client is interested in so that the user knows exactly what information the client is getting access to.
If you&#8217;ve ever done a social login to Google, you&#8217;ll often see a similar page.  Keycloak provides the same functionality.</p>
</dd>
<dt class="hdlist1">Include AuthnStatement</dt>
<dd>
<p>SAML login responses may specify the authentication method used (password, etc.) as well as timestamps of the login and the session expiration.
This is enabled by default, which means that <code>AuthStatement</code> element will be included in login responses. Note that setting this to off
would prevent the client from determining the maximum session length which could result into never expiring client session.</p>
</dd>
<dt class="hdlist1">Sign Documents</dt>
<dd>
<p>When turned on, Keycloak will sign the document using the realm&#8217;s private key.</p>
</dd>
<dt class="hdlist1">Optimize REDIRECT signing key lookup</dt>
<dd>
<p>When turned on, the SAML protocol messages will include Keycloak
native extension that contains a hint with signing key ID. When the SP
understands this extension, it can use it for signature validation instead of
attempting to validate signature with all known keys. This option only applies to
REDIRECT bindings where the signature is transferred in query parameters where
there is no place with this information in the signature information
(contrary to POST binding messages where key ID is always included in
document signature). Currently this is relevant to situations where both
IDP and SP are provided by Keycloak server and adapter. This
option is only relevant when <code>Sign Documents</code> is switched on.</p>
</dd>
<dt class="hdlist1">Sign Assertions</dt>
<dd>
<p>The <code>Sign Documents</code> switch signs the whole document.
With this setting the assertion is also signed and embedded within the SAML XML Auth response.</p>
</dd>
<dt class="hdlist1">Signature Algorithm</dt>
<dd>
<p>Choose between a variety of algorithms for signing SAML documents.</p>
</dd>
<dt class="hdlist1">SAML Signature Key Name</dt>
<dd>
<p>Signed SAML documents sent via POST binding contain identification of signing key in <code>KeyName</code>
element. This by default contains Keycloak key ID. However various vendors might
expect a different key name or no key name at all. This switch controls whether <code>KeyName</code>
contains key ID (option <code>KEY_ID</code>), subject from certificate corresponding to the realm key
(option <code>CERT_SUBJECT</code> - expected for instance by Microsoft Active Directory Federation
Services), or that the key name hint is completely omitted from the SAML message (option <code>NONE</code>).</p>
</dd>
<dt class="hdlist1">Canonicalization Method</dt>
<dd>
<p>Canonicalization method for XML signatures.</p>
</dd>
<dt class="hdlist1">Encrypt Assertions</dt>
<dd>
<p>Encrypt assertions in SAML documents with the realm&#8217;s private key.
The AES algorithm is used with a key size of 128 bits.</p>
</dd>
<dt class="hdlist1">Client Signature Required</dt>
<dd>
<p>Expect that documents coming from a client are signed.
Keycloak will validate this signature using the client public key or cert set up in the <code>SAML Keys</code> tab.</p>
</dd>
<dt class="hdlist1">Force POST Binding</dt>
<dd>
<p>By default, Keycloak will respond using the initial SAML binding of the original request.
By turning on this switch, you will force Keycloak to always respond using the SAML POST Binding even if the original request was the Redirect binding.</p>
</dd>
<dt class="hdlist1">Front Channel Logout</dt>
<dd>
<p>If true, this application requires a browser redirect to be able to perform a logout.
For example, the application may require a cookie to be reset which could only be done via a redirect.
If this switch is false, then Keycloak will invoke a background SAML request to logout the application.</p>
</dd>
<dt class="hdlist1">Force Name ID Format</dt>
<dd>
<p>If the request has a name ID policy, ignore it and used the value configured in the admin console under Name ID Format</p>
</dd>
<dt class="hdlist1">Name ID Format</dt>
<dd>
<p>Name ID Format for the subject.
If no name ID policy is specified in the request or if the Force Name ID Format attribute is true, this value is used.
Properties used for each of the respective formats are defined below.</p>
</dd>
<dt class="hdlist1">Root URL</dt>
<dd>
<p>If Keycloak uses any configured relative URLs, this value is prepended to them.</p>
</dd>
<dt class="hdlist1">Valid Redirect URIs</dt>
<dd>
<p>This is an optional field.  Enter in a URL pattern and click the + sign to add.  Click the - sign next to URLs you want to remove.
Remember that you still have to click the <code>Save</code> button!
Wildcards (*) are only allowed at the end of a URI, i.e. http://host.com/*.  This field is used when the exact SAML
endpoints are not registered and Keycloak is pulling the Assertion Consumer URL from the request.</p>
</dd>
<dt class="hdlist1">Base URL</dt>
<dd>
<p>If Keycloak needs to link to the client, this URL would be used.</p>
</dd>
<dt class="hdlist1">Master SAML Processing URL</dt>
<dd>
<p>This URL will be used for all SAML requests and the response will be directed to the SP.
It will be used as the Assertion Consumer Service URL and the Single Logout Service URL.
If a login request contains the Assertion Consumer Service URL, that will take precedence, but this URL must be validated by a registered Valid Redirect URI pattern</p>
</dd>
<dt class="hdlist1">Assertion Consumer Service POST Binding URL</dt>
<dd>
<p>POST Binding URL for the Assertion Consumer Service.</p>
</dd>
<dt class="hdlist1">Assertion Consumer Service Redirect Binding URL</dt>
<dd>
<p>Redirect Binding URL for the Assertion Consumer Service.</p>
</dd>
<dt class="hdlist1">Logout Service POST Binding URL</dt>
<dd>
<p>POST Binding URL for the Logout Service.</p>
</dd>
<dt class="hdlist1">Logout Service Redirect Binding URL</dt>
<dd>
<p>Redirect Binding URL for the Logout Service.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="idp-initiated-login"><a class="anchor" href="#idp-initiated-login"></a>IDP Initiated Login</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/saml/idp-initiated-login.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/saml/idp-initiated-login.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>IDP Initiated Login is a feature that allows you to set up an endpoint on the Keycloak server that will log you into a specific application/client.
In the <code>Settings</code> tab for your client, you need to specify the <code>IDP Initiated SSO URL Name</code>.
This is a simple string with no whitespace in it.
After this you can reference your client at the following URL: <code>root/auth/realms/{realm}/protocol/saml/clients/{url-name}</code></p>
</div>
<div class="paragraph">
<p>The IDP initiated login implementation prefers <em>POST</em> over <em>REDIRECT</em> binding (check <a href="#_saml">saml bindings</a> for more information).
Therefore the final binding and SP URL are selected in the following way:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the specific <code>Assertion Consumer Service POST Binding URL</code> is defined (inside <code>Fine Grain SAML Endpoint Configuration</code> section
of the client settings) <em>POST</em> binding is used through that URL.</p>
</li>
<li>
<p>If the general <code>Master SAML Processing URL</code> is specified then <em>POST</em> binding is used again throught this general URL.</p>
</li>
<li>
<p>As the last resort, if the <code>Assertion Consumer Service Redirect Binding URL</code> is configured (inside
<code>Fine Grain SAML Endpoint Configuration</code>) <em>REDIRECT</em> binding is used with this URL.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If your client requires a special relay state, you can also configure this on the <code>Settings</code> tab in the <code>IDP Initiated SSO Relay State</code> field.
Alternatively, browsers can specify the relay state in a <code>RelayState</code> query parameter, i.e.
<code>root/auth/realms/{realm}/protocol/saml/clients/{url-name}?RelayState=thestate</code>.</p>
</div>
<div class="paragraph">
<p>When using <a href="#_identity_broker">identity brokering</a>, it is possible to set up an IDP Initiated Login for a client from an
external IDP. The actual client is set up for IDP Initiated Login at broker IDP as described above. The external IDP has
to set up the client for application IDP Initiated Login that will point to a special URL pointing to the broker and
representing IDP Initiated Login endpoint for a selected client at the brokering IDP. This means that in client settings
at the external IDP:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IDP Initiated SSO URL Name</code> is set to a name that will be published as IDP Initiated Login initial point,</p>
</li>
<li>
<p><code>Assertion Consumer Service POST Binding URL</code> in the <code>Fine Grain SAML Endpoint Configuration</code> section has
to be set to the following URL:
<code>broker-root/auth/realms/{broker-realm}/broker/{idp-name}/endpoint/clients/{client-id}</code>, where:</p>
<div class="ulist">
<ul>
<li>
<p><em>broker-root</em> is base broker URL</p>
</li>
<li>
<p><em>broker-realm</em> is name of the realm at broker where external IDP is declared</p>
</li>
<li>
<p><em>idp-name</em> is name of the external IDP at broker</p>
</li>
<li>
<p><em>client-id</em> is the value of <code>IDP Initiated SSO URL Name</code> attribute of the SAML client defined at broker. It is
this client, which will be made available for IDP Initiated Login from the external IDP.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please note that you can import basic client settings from the brokering IDP into client settings of the external IDP -
just use <a href="#_identity_broker_saml_sp_descriptor">SP Descriptor</a> available from the settings of the identity provider in
the brokering IDP, and add <code>clients/<em>client-id</em></code> to the endpoint URL.</p>
</div>
</div>
<div class="sect3">
<h4 id="saml-entity-descriptors"><a class="anchor" href="#saml-entity-descriptors"></a>SAML Entity Descriptors</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/saml/entity-descriptors.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/saml/entity-descriptors.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Instead of manually registering a SAML 2.0 client, you can import it via a standard SAML Entity Descriptor XML file.
There is an <code>Import</code> option on the Add Client page.</p>
</div>
<div class="paragraph">
<div class="title">Add Client</div>
<p><span class="image"><img src="./keycloak-images/add-client-saml.png" alt="add client saml"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Select File</code> button and load your entity descriptor file.  You should review all the information there to make sure everything is set up correctly.</p>
</div>
<div class="paragraph">
<p>Some SAML client adapters like <em>mod-auth-mellon</em> need the XML Entity Descriptor for the IDP.  You can obtain this by
going to this public URL:  <code>root/auth/realms/{realm}/protocol/saml/descriptor</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="client-links"><a class="anchor" href="#client-links"></a>Client Links</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/client-link.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/client-link.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>For scenarios where one wants to link from one client to another, Keycloak provides a special redirect endpoint: <code>/realms/realm_name/clients/{client-id}/redirect</code>.</p>
</div>
<div class="paragraph">
<p>If a client accesses this endpoint via an <code>HTTP GET</code> request, Keycloak returns the configured base URL for the provided Client and Realm in the form of an <code>HTTP 307</code> (Temporary Redirect) via the response&#8217;s <code>Location</code> header.</p>
</div>
<div class="paragraph">
<p>Thus, a client only needs to know the Realm name and the Client ID in order to link to them.
This indirection helps avoid hard-coding client base URLs.</p>
</div>
<div class="paragraph">
<p>As an example, given the realm <code>master</code> and the client-id <code>account</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://host:port/auth/realms/master/clients/account/redirect</code></pre>
</div>
</div>
<div class="paragraph">
<p>Would temporarily redirect to: <a href="http://host:port/auth/realms/master/account" class="bare">http://host:port/auth/realms/master/account</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_protocol-mappers"><a class="anchor" href="#_protocol-mappers"></a>OIDC Token and SAML Assertion Mappings</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/protocol-mappers.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/protocol-mappers.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Applications that receive ID Tokens, Access Tokens, or SAML assertions may need or want different user metadata and roles.
Keycloak allows you to define what exactly is transferred.
You can hardcode roles, claims and custom attributes.
You can pull user metadata into a token or assertion.
You can rename roles.
Basically you have a lot of control of what exactly goes back to the client.</p>
</div>
<div class="paragraph">
<p>Within the Admin Console, if you go to an application you&#8217;ve registered, you&#8217;ll see a <code>Mappers</code> tab.  Here&#8217;s one for
an OIDC based client.</p>
</div>
<div class="paragraph">
<div class="title">Mappers Tab</div>
<p><span class="image"><img src="./keycloak-images/mappers-oidc.png" alt="mappers oidc"></span></p>
</div>
<div class="paragraph">
<p>The new client does not have any built-in mappers, however it usually inherits some mappers from the client scopes as described
in the <a href="#_client_scopes">client scopes section</a>. Protocol mappers map things like, for example, email address to
a specific claim in the identity and access token.  Their function should each be self explanatory from their name.  There
are additional pre-configured mappers that are not attached to the client that you can add
by clicking the <code>Add Builtin</code> button.</p>
</div>
<div class="paragraph">
<p>Each mapper has common settings as well as additional ones depending on which type of mapper you are adding.  Click the <code>Edit</code> button
next to one of the mappers in the list to get to the config screen.</p>
</div>
<div class="paragraph">
<div class="title">Mapper Config</div>
<p><span class="image"><img src="./keycloak-images/mapper-config.png" alt="mapper config"></span></p>
</div>
<div class="paragraph">
<p>The best way to learn about a config option is to hover over its tooltip.</p>
</div>
<div class="paragraph">
<p>Most OIDC mappers also allow you to control where the claim gets put.  You can opt to include or exclude the claim from both the
<em>id</em> and <em>access</em> tokens by fiddling with the <code>Add to ID token</code> and <code>Add to access token</code> switches.</p>
</div>
<div class="paragraph">
<p>Finally, you can also add other mapper types.  If you go back to the <code>Mappers</code> tab, click the <code>Create</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Add Mapper</div>
<p><span class="image"><img src="./keycloak-images/add-mapper.png" alt="add mapper"></span></p>
</div>
<div class="paragraph">
<p>Pick a <code>Mapper Type</code> from the list box.  If you hover over the tooltip, you&#8217;ll see a description of what that mapper type does.
Different config parameters will appear for different mapper types.</p>
</div>
<div class="sect3">
<h4 id="priority-order"><a class="anchor" href="#priority-order"></a>Priority order</h4>
<div class="paragraph">
<p>Mapper implementations have <em>priority order</em>. This priority order is not the configuration property of the mapper; rather, it is
the property of the concrete implementation of the mapper.</p>
</div>
<div class="paragraph">
<p>Mappers are sorted in the admin console by the order in the list of mappers and the changes in the token or assertion will be
applied using that order with the lowest being applied first. This means that implementations which are dependent on other
implementations are processed in the needed order.</p>
</div>
<div class="paragraph">
<p>For example, when we first want to compute the roles which will be included with a token, we first resolve audiences based on
those roles. Then, we process a JavaScript script that uses the roles and audiences already available in the token.</p>
</div>
</div>
<div class="sect3">
<h4 id="_protocol-mappers_oidc-user-session-note-mappers"><a class="anchor" href="#_protocol-mappers_oidc-user-session-note-mappers"></a>OIDC User Session Note Mappers</h4>
<div class="paragraph">
<p>User session details are defined via mappers and depend on various criteria. User session details are automatically included when you use or enable a feature on a client. You can also click the <code>Add builtin</code> button to include session details.</p>
</div>
<div class="paragraph">
<p>Impersonated user sessions provide the following details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IMPERSONATOR_ID</code>: The ID of an impersonating user</p>
</li>
<li>
<p><code>IMPERSONATOR_USERNAME</code>: The username of an impersonating user</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Service account sessions provide the following details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>clientId</code>: The client ID of the service account</p>
</li>
<li>
<p><code>clientAddress</code>: The remote host IP of the service account authenticated device</p>
</li>
<li>
<p><code>clientHost</code>: The remote host name of the service account authenticated device</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="script-mapper"><a class="anchor" href="#script-mapper"></a>Script Mapper</h4>
<div class="paragraph">
<p>The <code>Script Mapper</code> allows you to map claims to tokens by running a user-defined JavaScript code. For more details about how to
deploy scripts to the server, please take a look at <a href="https://www.keycloak.org/docs/12.0/server_development/#_script_providers">JavaScript Providers</a>.</p>
</div>
<div class="paragraph">
<p>Once you have your scripts deployed, you should be able to select the scripts you deployed from the list of available mappers.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_client_installation"><a class="anchor" href="#_client_installation"></a>Generating Client Adapter Config</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/installation.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/installation.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The Keycloak can pre-generate configuration files that you can use to install a client adapter for in your application&#8217;s
deployment environment.  A number of adapter types are supported for both OIDC and SAML.  Go to the <code>Installation</code> tab of the
client you want to generate configuration for.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/client-installation.png" alt="client installation"></span></p>
</div>
<div class="paragraph">
<p>Select the <code>Format Option</code> you want configuration generated for.  All Keycloak client adapters for OIDC and SAML
are supported.  The mod-auth-mellon Apache HTTPD adapter for SAML is supported as well as standard SAML entity descriptor files.</p>
</div>
</div>
<div class="sect2">
<h3 id="_client_scopes"><a class="anchor" href="#_client_scopes"></a>Client Scopes</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/clients/client-scopes.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/clients/client-scopes.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If you have many applications you need to secure and register within your organization, it can become tedious to configure the
<a href="#_protocol-mappers">protocol mappers</a> and <a href="#_role_scope_mappings">role scope mappings</a> for each of these clients. Keycloak allows
you to define a shared client configuration in an entity called a <em>client scope</em>.</p>
</div>
<div class="paragraph">
<p>Client scopes also provide support for the OAuth 2 <code>scope</code> parameter, which allows a client application to request more or fewer
claims or roles in the access token, according to the application needs.</p>
</div>
<div class="paragraph">
<p>To create a client scope, follow these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Go to the <code>Client Scopes</code> left menu item. This initial screen shows you a list of currently defined client scopes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Client Scopes List</div>
<p><span class="image"><img src="./keycloak-images/client-scopes-list.png" alt="client scopes list"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Click the <code>Create</code> button. Name the client scope and save. A <em>client scope</em> will have similar tabs to a regular clients. You can
define <a href="#_protocol-mappers">protocol mappers</a> and <a href="#_role_scope_mappings">role scope mappings</a>, which can be inherited by other clients,
and which are configured to inherit from this client scope.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="protocol"><a class="anchor" href="#protocol"></a>Protocol</h4>
<div class="paragraph">
<p>When you are creating the client scope, you must choose the <code>Protocol</code>. Only the clients which use same protocol can then be linked
with this client scope.</p>
</div>
<div class="paragraph">
<p>Once you have created new realm, you can see that there is a list of pre-defined (builtin) client scopes in the menu.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For the SAML protocol, there is one builtin client scope, <code>roles_list</code>, which contains one protocol mapper for showing the roles
list in the SAML assertion.</p>
</li>
<li>
<p>For the OpenID Connect protocol, there are client scopes <code>profile</code>, <code>email</code>, <code>address</code>, <code>phone</code>, <code>offline_access</code>, <code>roles</code>,
<code>web-origins</code> and <code>microprofile-jwt</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The client scope, <code>offline_access</code>, is useful when client wants to obtain offline tokens. Learn about offline tokens in the
<a href="#_offline-access">Offline Access section</a> or in the <a href="https://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess">OpenID Connect specification</a>,
where scope parameter is defined with the value <code>offline_access</code>.</p>
</div>
<div class="paragraph">
<p>The client scopes <code>profile</code>, <code>email</code>, <code>address</code> and <code>phone</code> are also defined in the <a href="https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims">OpenID Connect specification</a>.
These client scopes do not have any role scope mappings defined, but they have some protocol mappers defined, and these mappers correspond
to the claims defined in the OpenID Connect specification.</p>
</div>
<div class="paragraph">
<p>For example, when you click to open the <code>phone</code> client scope and open the <code>Mappers</code> tab, you will see the protocol mappers, which
correspond to the claims defined in the specification for the scope <code>phone</code>.</p>
</div>
<div class="paragraph">
<div class="title">Client Scope Mappers</div>
<p><span class="image"><img src="./keycloak-images/client-scopes-phone.png" alt="client scopes phone"></span></p>
</div>
<div class="paragraph">
<p>When the <code>phone</code> client scope is linked to a client, that client automatically inherits all the protocol mappers defined in the
<code>phone</code> client scope. Access tokens issued for this client will contain the phone number information about the user, assuming that
the user has a defined phone number.</p>
</div>
<div class="paragraph">
<p>Builtin client scopes contain exactly the protocol mappers as defined per the specification,
however you are free to edit client scopes and create/update/remove any protocol mappers (or role scope mappings).</p>
</div>
<div class="paragraph">
<p>The client scope <code>roles</code> is not defined in the OpenID Connect specification and it is also not added automatically to the <code>scope</code>
claim in the access token. This client scope has some mappers, which are used to add roles of the user to the access token and
possibly add some audiences for the clients with at least one client role as described in the <a href="#_audience_resolve">Audience section</a>.</p>
</div>
<div class="paragraph">
<p>The client scope <code>web-origins</code> is also not defined in the OpenID Connect specification and not added to the <code>scope</code> claim. This is used
to add allowed web origins to the access token <code>allowed-origins</code> claim.</p>
</div>
<div class="paragraph">
<p>The client scope <code>microprofile-jwt</code> was created to handle the claims defined in the <a href="https://wiki.eclipse.org/MicroProfile/JWT_Auth">MicroProfile/JWT Auth Specification</a>.
This client scope defines a user property mapper for the <code>upn</code> claim and also a realm role mapper for the <code>groups</code> claim. These mappers
can be changed as needed so that different properties can be used to create the MicroProfile/JWT specific claims.</p>
</div>
</div>
<div class="sect3">
<h4 id="consent-related-settings"><a class="anchor" href="#consent-related-settings"></a>Consent related settings</h4>
<div class="paragraph">
<p>Client scope contains options related to the consent screen. Those options are useful only if the linked client is configured to
require consent (if the <code>Consent Required</code> switch is enabled on the client).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Display On Consent Screen</dt>
<dd>
<p>If on, and if this client scope is added to a client with consent required, then the text specified by <code>Consent Screen Text</code> will
be displayed on the consent screen, which is shown once the user is authenticated and right before he is redirected from Keycloak
to the client. If the switch is off, then this client scope will not be displayed on the consent screen.</p>
</dd>
<dt class="hdlist1">Consent Screen Text</dt>
<dd>
<p>The text shown on the consent screen when this client scope is added to some client with consent required defaults to
the name of client scope. The value for this text is localizable by specifying a substitution variable
with <code>${var-name}</code> strings. The localized value is then configured within property files in your theme. See the
<a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for more information on localization.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_client_scopes_linking"><a class="anchor" href="#_client_scopes_linking"></a>Link Client Scope with the Client</h4>
<div class="paragraph">
<p>Linking between client scope and client is configured in the <code>Client Scopes</code> tab of the particular client. There are 2 ways of
linking between client scope and client.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Default Client Scopes</dt>
<dd>
<p>This is applicable for both OpenID Connect and SAML clients. Default client scopes are always applied when issuing OpenID Connect tokens
or SAML assertions for this client. The client will inherit Protocol mappers and Role Scope Mappings defined on the client
scope. For the OpenID Connect Protocol, the Mappers and Role Scope Mappings are always applied, regardless of the value used for the scope
parameter in the OpenID Connect authorization request.</p>
</dd>
<dt class="hdlist1">Optional Client Scopes</dt>
<dd>
<p>This is applicable only for OpenID Connect clients. Optional client scopes are applied when issuing tokens for this client,
but only when they are requested by the <code>scope</code> parameter in the OpenID Connect authorization request.</p>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="example"><a class="anchor" href="#example"></a>Example</h5>
<div class="paragraph">
<p>For this example, we assume that the client has <code>profile</code> and <code>email</code> linked as default client scopes, and <code>phone</code> and <code>address</code>
are linked as optional client scopes. The client will use the value of the scope parameter when sending a request to the OpenID Connect authorization
endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>scope=openid phone</code></pre>
</div>
</div>
<div class="paragraph">
<p>The scope parameter contains the string, with the scope values divided by space (which is also the reason why a client scope name
cannot contain a space character in it). The value <code>openid</code> is the meta-value used for all OpenID Connect requests, so we will ignore
it for this example. The token will contain mappers and role scope mappings from the client scopes <code>profile</code>, <code>email</code> (which are
default scopes) and <code>phone</code> (an optional client scope requested by the scope parameter).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_client_scopes_evaluate"><a class="anchor" href="#_client_scopes_evaluate"></a>Evaluating Client Scopes</h4>
<div class="paragraph">
<p>The tabs <code>Mappers</code> and <code>Scope</code> of the client contain the protocol mappers and role scope mappings declared solely for this client.
They do not contain the mappers and scope mappings inherited from client scopes. However, it may be useful to see what the
effective protocol mappers will be (protocol mappers defined on the client itself as well as inherited from the linked client scopes)
and the effective role scope mappings used when you generate the token for the particular client.</p>
</div>
<div class="paragraph">
<p>You can see all of these when you click the <code>Client Scopes</code> tab for the client and then open the sub-tab <code>Evaluate</code>. From here you
can select the optional client scopes that you want to apply. This will also show you the value of the <code>scope</code> parameter, which needs to
be sent from the application to the Keycloak OpenID Connect authorization endpoint.</p>
</div>
<div class="paragraph">
<div class="title">Evaluating Client Scopes</div>
<p><span class="image"><img src="./keycloak-images/client-scopes-evaluate.png" alt="client scopes evaluate"></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to see how you can send a custom value for a <code>scope</code> parameter from your application, see the
<a href="https://www.keycloak.org/docs/12.0/securing_apps/#_params_forwarding">parameters forwarding section</a>, if your application uses the servlet adapter, or the
<a href="https://www.keycloak.org/docs/12.0/securing_apps/#_javascript_adapter">javascript adapter section</a>, if your application uses the javascript adapter.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="generating-example-tokens"><a class="anchor" href="#generating-example-tokens"></a>Generating Example Tokens</h5>
<div class="paragraph">
<p>To see an example of a real access token, generated for the particular user and issued for the particular client, with the specified
value of <code>scope</code> parameter, select the user from the <code>Evaluate</code> screen. This will generate an example token that includes all of the
claims and role mappings used.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="client-scopes-permissions"><a class="anchor" href="#client-scopes-permissions"></a>Client Scopes Permissions</h4>
<div class="paragraph">
<p>When issuing tokens for a particular user, the client scope is applied only if the user is permitted to use it. In the case that
a client scope does not have any role scope mappings defined on itself, then each user is automatically permitted to use this
client scope. However, when a client scope has any role scope mappings defined on itself, then the user must be a member of at least
one of the roles. In other words, there must be an intersection between the user roles and the roles of the client scope. Composite
roles are taken into account when evaluating this intersection.</p>
</div>
<div class="paragraph">
<p>If a user is not permitted to use the client scope, then no protocol mappers or role scope mappings will be used when generating tokens
and the client scope will not appear in the <em>scope</em> value in the token.</p>
</div>
</div>
<div class="sect3">
<h4 id="realm-default-client-scopes"><a class="anchor" href="#realm-default-client-scopes"></a>Realm Default Client Scopes</h4>
<div class="paragraph">
<p>The <code>Realm Default Client Scopes</code> allow you to define set of client scopes, which will be automatically linked to newly created clients.</p>
</div>
<div class="paragraph">
<p>Open the left menu item <code>Client Scopes</code> and then select <code>Default Client Scopes</code>.</p>
</div>
<div class="paragraph">
<p>From here, select the client scopes that you want to add as <code>Default Client Scopes</code> to newly created clients and <code>Optional Client Scopes</code>
to newly created clients.</p>
</div>
<div class="paragraph">
<div class="title">Default Client Scopes</div>
<p><span class="image"><img src="./keycloak-images/client-scopes-default.png" alt="client scopes default"></span></p>
</div>
<div class="paragraph">
<p>Once the client is created, you can unlink the default client scopes, if needed. This is similar to how you
remove <a href="#_default_roles">Default Roles</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="scopes-explained"><a class="anchor" href="#scopes-explained"></a>Scopes explained</h4>
<div class="paragraph">
<p>The term <code>scope</code> is used in Keycloak on few places. Various occurrences of scopes are related to each other, but may have
a different context and meaning. To clarify, here we explain the various <code>scopes</code> used in Keycloak.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Client scope</dt>
<dd>
<p>Referenced in this chapter. Client scopes are entities in Keycloak, which are configured at the realm level and they can be
linked to clients. The client scopes are referenced by their name when a request is sent to the Keycloak authorization endpoint
with a corresponding value of the <code>scope</code> parameter. The details are described in the <a href="#_client_scopes_linking">section about
client scopes linking</a>.</p>
</dd>
<dt class="hdlist1">Role scope mapping</dt>
<dd>
<p>This can be seen when you open tab <code>Scope</code> of a client or client scope. Role scope mapping allows you to limit the roles which can
be used in the access tokens. The details are described in the <a href="#_role_scope_mappings">Role Scope Mappings section</a>.</p>
</dd>
<dt class="hdlist1">Authorization scopes</dt>
<dd>
<p>This is used by the Authorization feature. The <code>Authorization Scope</code> is the action which can be done in the application.
More details in the <a href="https://www.keycloak.org/docs/12.0/authorization_services/">Authorization Services Guide</a>.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="roles"><a class="anchor" href="#roles"></a>Roles</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/roles.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/roles.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Roles identify a type or category of user.  <code>Admin</code>, <code>user</code>, <code>manager</code>, and <code>employee</code> are all typical roles that may exist
in an organization.
Applications often assign access and permissions to specific roles rather than individual users as dealing
with users can be too fine grained and hard to manage.  For example, the Admin Console has specific roles which give permission to users
to access parts of the Admin Console UI and perform certain actions.  There is a global namespace for roles and each client also has its own
dedicated namespace where roles can be defined.</p>
</div>
<div class="sect2">
<h3 id="realm-roles"><a class="anchor" href="#realm-roles"></a>Realm Roles</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/roles/realm-roles.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/roles/realm-roles.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Realm-level roles are a global namespace to define your roles. You can see the list of built-in and created roles by clicking the <code>Roles</code> left menu item.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/roles.png" alt="roles"></span></p>
</div>
<div class="paragraph">
<p>To create a role, click <strong>Add Role</strong> on this page, enter in the name and description of the role, and click <strong>Save</strong>.</p>
</div>
<div class="paragraph">
<div class="title">Add Role</div>
<p><span class="image"><img src="./keycloak-images/role.png" alt="role"></span></p>
</div>
<div class="paragraph">
<p>The value for the <code>description</code> field is localizable by specifying a substitution variable with <code>${var-name}</code> strings. The localized
value is then configured within property files in your theme. See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for more information
on localization.</p>
</div>
</div>
<div class="sect2">
<h3 id="client-roles"><a class="anchor" href="#client-roles"></a>Client Roles</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/roles/client-roles.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/roles/client-roles.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Client roles are basically a namespace dedicated to a client. Each client gets its own namespace. Client roles are managed under the <code>Roles</code> tab under each individual client. You interact with this UI the same way you do for realm-level roles.</p>
</div>
</div>
<div class="sect2">
<h3 id="_composite-roles"><a class="anchor" href="#_composite-roles"></a>Composite Roles</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/roles/composite.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/roles/composite.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Any realm or client level role can be turned into a <em>composite role</em>.
A <em>composite role</em> is a role that has one or more additional roles associated with it.
When a composite role is mapped to the user, the user also gains the roles associated with that composite.  This inheritance
is recursive so any composite of composites also gets inherited.</p>
</div>
<div class="paragraph">
<p>To turn a regular role into a composite role, go to the role detail page and flip the <code>Composite Role</code> switch on.</p>
</div>
<div class="paragraph">
<div class="title">Composite Role</div>
<p><span class="image"><img src="./keycloak-images/composite-role.png" alt="composite role"></span></p>
</div>
<div class="paragraph">
<p>Once you flip this switch the role selection UI will be displayed lower on the page and you&#8217;ll be able to associate
realm level and client level roles to the composite you are creating.  In this example, the <code>employee</code> realm-level
role was associated with the <code>developer</code> composite role.  Any user with the <code>developer</code> role will now also inherit
the <code>employee</code> role too.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When tokens and SAML assertions are created, any composite will also have its associated roles added to the claims and
      assertions of the authentication response sent back to the client.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="user-role-mappings"><a class="anchor" href="#user-role-mappings"></a>User Role Mappings</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/roles/user-role-mappings.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/roles/user-role-mappings.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>User role mappings can be assigned individually to each user through the <code>Role Mappings</code> tab for that single user.</p>
</div>
<div class="paragraph">
<div class="title">Role Mappings</div>
<p><span class="image"><img src="./keycloak-images/user-role-mappings.png" alt="user role mappings"></span></p>
</div>
<div class="paragraph">
<p>In the above example, we are about to assign the composite role <code>developer</code> that was created in the <a href="#_composite-roles">Composite Roles</a>
chapter.</p>
</div>
<div class="paragraph">
<div class="title">Effective Role Mappings</div>
<p><span class="image"><img src="./keycloak-images/effective-role-mappings.png" alt="effective role mappings"></span></p>
</div>
<div class="paragraph">
<p>Once the <code>developer</code> role is assigned, you see that the <code>employee</code> role that is associated with the <code>developer</code> composite shows up in the <code>Effective Roles</code>.
<code>Effective Roles</code> are all roles that are explicitly assigned to the user as well as any roles that are inherited from composites.</p>
</div>
<div class="sect3">
<h4 id="_default_roles"><a class="anchor" href="#_default_roles"></a>Default Roles</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/roles/user-role-mappings/default-roles.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/roles/user-role-mappings/default-roles.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Default roles allow you to automatically assign user role mappings when any user is newly created or imported through
<a href="#_identity_broker">Identity Brokering</a>.
To specify default roles go to the <code>Roles</code> left menu item, and click the <code>Default Roles</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Default Roles</div>
<p><span class="image"><img src="./keycloak-images/default-roles.png" alt="default roles"></span></p>
</div>
<div class="paragraph">
<p>As you can see from the screenshot, there are already a number of <em>default roles</em> set up by default.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_role_scope_mappings"><a class="anchor" href="#_role_scope_mappings"></a>Role Scope Mappings</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/roles/role-scope-mappings.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/roles/role-scope-mappings.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When an OIDC access token or SAML assertion is created, all the user role mappings of the user are, by default, added as claims
within the token or assertion.  Applications use this information to make access decisions on the resources controlled by that
application.  In Keycloak, access tokens are digitally signed and can actually be re-used by the application
to invoke on other remotely secured REST services.  This means that if an application gets compromised or there is a rogue
client registered with the realm, attackers can get access tokens that have a broad range of permissions and your whole
network is compromised.  This is where <em>role scope mappings</em> becomes important.</p>
</div>
<div class="paragraph">
<p><em>Role Scope Mappings</em> is a way to limit the roles that get declared inside an access token.  When a client requests that a user
be authenticated, the access token they receive back will only contain the role mappings you&#8217;ve explicitly specified
for the client&#8217;s scope.  This allows you to limit the permissions each individual access token has rather than giving the
client access to all of the user&#8217;s permissions.  By default, each client gets all the role mappings of the user.
You can view this in the <code>Scope</code> tab of each client.</p>
</div>
<div class="paragraph">
<div class="title">Full Scope</div>
<p><span class="image"><img src="./keycloak-images/full-client-scope.png" alt="full client scope"></span></p>
</div>
<div class="paragraph">
<p>You can see from the picture that the effective roles of the scope are every declared role in the realm.
To change this default behavior, you must explicitly turn off the <code>Full Scope Allowed</code> switch and declare the specific roles you want in each individual
client.  Alternatively, you can also use <a href="#_client_scopes">client scopes</a>
to define the same role scope mappings for a whole set of clients.</p>
</div>
<div class="paragraph">
<div class="title">Partial Scope</div>
<p><span class="image"><img src="./keycloak-images/client-scope.png" alt="client scope"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="groups"><a class="anchor" href="#groups"></a>Groups</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/groups.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/groups.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Groups in Keycloak allow you to manage a common set of attributes and role mappings for a set of users.
Users can be members of zero or more groups.
Users inherit the attributes and role mappings assigned to each group.  To manage groups go to the <code>Groups</code> left menu
item.</p>
</div>
<div class="paragraph">
<div class="title">Groups</div>
<p><span class="image"><img src="./keycloak-images/groups.png" alt="groups"></span></p>
</div>
<div class="paragraph">
<p>Groups are hierarchical.
A group can have many subgroups, but a group can only have one parent.
Subgroups inherit the attributes and role mappings from the parent.
This applies to the user as well.
So, if you have a parent group and a child group and a user that only belongs to the child group, the user inherits the attributes and role mappings of both the parent and child.
In this example, we have a top level <code>Sales</code> group and a child <code>North America</code> subgroup.  To add a group, click on the
parent you want to add a new child to and click <code>New</code> button.  Select the <code>Groups</code> icon in the tree to make a top-level group.
Entering in a group name in the <code>Create Group</code> screen and hitting <code>Save</code> will bring you to the individual group management page.</p>
</div>
<div class="paragraph">
<div class="title">Group</div>
<p><span class="image"><img src="./keycloak-images/group.png" alt="group"></span></p>
</div>
<div class="paragraph">
<p>The <code>Attributes</code> and <code>Role Mappings</code> tab work exactly as the tabs with similar names under a user.  Any attributes and role mappings
you define will be inherited by the groups and users that are members of this group.</p>
</div>
<div class="paragraph">
<p>To add a user to a group you need to go all the way back to the user detail page and click on the <code>Groups</code> tab there.</p>
</div>
<div class="paragraph">
<div class="title">User Groups</div>
<p><span class="image"><img src="./keycloak-images/user-groups.png" alt="user groups"></span></p>
</div>
<div class="paragraph">
<p>Select a group from the <code>Available Groups</code> tree and hit the <code>join</code> button to add the user to a group.  Vice versa to remove a group.
Here we&#8217;ve added the user <em>Jim</em> to the <em>North America</em> sales group.  If you go back to the detail page for that group and
select the <code>Membership</code> tab, <em>Jim</em> is now displayed there.</p>
</div>
<div class="paragraph">
<div class="title">Group Membership</div>
<p><span class="image"><img src="./keycloak-images/group-membership.png" alt="group membership"></span></p>
</div>
<div class="sect2">
<h3 id="groups-vs-roles"><a class="anchor" href="#groups-vs-roles"></a>Groups vs. Roles</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/groups/groups-vs-roles.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/groups/groups-vs-roles.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>In the IT world the concepts of Group and Role are often blurred and interchangeable.
In Keycloak, Groups are just a collection of users that you can apply roles and attributes to in one place.
Roles define a type of user and applications assign permission and access control to roles.</p>
</div>
<div class="paragraph">
<p>Aren&#8217;t <a href="#_composite-roles">Composite Roles</a> also similar to Groups?
Logically they provide the same exact functionality, but the difference is conceptual.
Composite roles should be used to apply the permission model to your set of services and applications.
Groups should focus on collections of users and their roles in your organization.
Use groups to manage users.  Use composite roles to manage applications and services.</p>
</div>
</div>
<div class="sect2">
<h3 id="default-groups"><a class="anchor" href="#default-groups"></a>Default Groups</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/groups/default-groups.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/groups/default-groups.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Default groups allow you to automatically assign group membership whenever any new user is created or imported through
<a href="#_identity_broker">Identity Brokering</a>.
To specify default groups go to the <code>Groups</code> left menu item, and click the <code>Default Groups</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Default Groups</div>
<p><span class="image"><img src="./keycloak-images/default-groups.png" alt="default groups"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_admin_permissions"><a class="anchor" href="#_admin_permissions"></a>Admin Console Access Control and Permissions</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/admin-console-permissions.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/admin-console-permissions.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Each realm created on the Keycloak has a dedicated Admin Console from which that realm can be managed.
The <code>master</code> realm is a special realm that allows admins to manage more than one realm on the system.  You can also
define fine-grained access to users in different realms to manage the server.  This chapter goes over all the scenarios for this.</p>
</div>
<div class="sect2">
<h3 id="master-realm-access-control"><a class="anchor" href="#master-realm-access-control"></a>Master Realm Access Control</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/admin-console-permissions/master-realm.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/admin-console-permissions/master-realm.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The <code>master</code> realm in Keycloak is a special realm and treated differently than other realms.
Users in the Keycloak <code>master</code> realm can be granted permission to manage zero or more realms that are deployed on the Keycloak server.
When a realm is created, Keycloak automatically creates various roles that grant fine-grain permissions to access that new realm.
Access to The Admin Console and Admin REST endpoints can be controlled by mapping these roles to users in the <code>master</code> realm.
It&#8217;s possible to create multiple super users,  as well as users that can only manage specific realms.</p>
</div>
<div class="sect3">
<h4 id="global-roles"><a class="anchor" href="#global-roles"></a>Global Roles</h4>
<div class="paragraph">
<p>There are two realm-level roles in the <code>master</code> realm.
These are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>admin</p>
</li>
<li>
<p>create-realm</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Users with the <code>admin</code> role are super users and have full access to manage any realm on the server.  Users with the <code>create-realm</code> role
are allowed to create new realms.  They will be granted full access to any new realm they create.</p>
</div>
</div>
<div class="sect3">
<h4 id="realm-specific-roles"><a class="anchor" href="#realm-specific-roles"></a>Realm Specific Roles</h4>
<div class="paragraph">
<p>Admin users within the <code>master</code> realm can be granted management privileges to one or more other realms in the system.
Each realm in Keycloak is represented by a client in the <code>master</code> realm.
The name of the client is <code>&lt;realm name&gt;-realm</code>.  These clients each have client-level roles defined which define varying
level of access to manage an individual realm.</p>
</div>
<div class="paragraph">
<p>The roles available are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>view-realm</p>
</li>
<li>
<p>view-users</p>
</li>
<li>
<p>view-clients</p>
</li>
<li>
<p>view-events</p>
</li>
<li>
<p>manage-realm</p>
</li>
<li>
<p>manage-users</p>
</li>
<li>
<p>create-client</p>
</li>
<li>
<p>manage-clients</p>
</li>
<li>
<p>manage-events</p>
</li>
<li>
<p>view-identity-providers</p>
</li>
<li>
<p>manage-identity-providers</p>
</li>
<li>
<p>impersonation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assign the roles you want to your users and they will only be able to use that specific part of the administration console.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Admins with the <code>manage-users</code> role will only be able to assign admin roles to users that they themselves have.  So, if an admin has the <code>manage-users</code> role but doesn&#8217;t have the <code>manage-realm</code> role, they will not be able to assign this role.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_per_realm_admin_permissions"><a class="anchor" href="#_per_realm_admin_permissions"></a>Dedicated Realm Admin Consoles</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/admin-console-permissions/per-realm.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/admin-console-permissions/per-realm.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Each realm has a dedicated Admin Console that can be accessed by going to the url <code>/auth/admin/{realm-name}/console</code>.
Users within that realm can be granted realm management permissions by assigning specific user role mappings.</p>
</div>
<div class="paragraph">
<p>Each realm has a built-in client called <code>realm-management</code>.  You can view this client by going to the
<code>Clients</code> left menu item of your realm.  This client defines client-level roles that specify permissions that can be granted to manage the realm.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>view-realm</p>
</li>
<li>
<p>view-users</p>
</li>
<li>
<p>view-clients</p>
</li>
<li>
<p>view-events</p>
</li>
<li>
<p>manage-realm</p>
</li>
<li>
<p>manage-users</p>
</li>
<li>
<p>create-client</p>
</li>
<li>
<p>manage-clients</p>
</li>
<li>
<p>manage-events</p>
</li>
<li>
<p>view-identity-providers</p>
</li>
<li>
<p>manage-identity-providers</p>
</li>
<li>
<p>impersonation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assign the roles you want to your users and they will only be able to use that specific part of the administration console.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fine_grain_permissions"><a class="anchor" href="#_fine_grain_permissions"></a>Fine Grain Admin Permissions</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/admin-console-permissions/fine-grain.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/admin-console-permissions/fine-grain.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Fine Grain Admin Permissions is <strong>Technology Preview</strong> and is not fully supported. This feature is disabled by default.</p>
</div>
<div class="paragraph">
<p>To enable start the server with <code>-Dkeycloak.profile=preview</code>
or <code>-Dkeycloak.profile.feature.admin_fine_grained_authz=enabled</code>
. For more details see <a href="https://www.keycloak.org/docs/12.0/server_installation/#profiles">Profiles</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sometimes roles like <code>manage-realm</code> or <code>manage-users</code> are too coarse grain and you want to create
restricted admin accounts that have more fine grain permissions.  Keycloak allows you to define
and assign restricted access policies for managing a realm.  Things like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Managing one specific client</p>
</li>
<li>
<p>Managing users that belong to a specific group</p>
</li>
<li>
<p>Managing membership of a group</p>
</li>
<li>
<p>Limited user management.</p>
</li>
<li>
<p>Fine grain impersonation control</p>
</li>
<li>
<p>Being able to assign a specific restricted set of roles to users.</p>
</li>
<li>
<p>Being able to assign a specific restricted set of roles to a composite role.</p>
</li>
<li>
<p>Being able to assign a specific restricted set of roles to a client&#8217;s scope.</p>
</li>
<li>
<p>New general policies for viewing and managing users, groups, roles, and clients.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are some important things to note about fine grain admin permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fine grain admin permissions were implemented on top of <a href="https://www.keycloak.org/docs/12.0/authorization_services/">Authorization Services</a>.  It is highly recommended that you read up on those features before diving into fine grain permissions.</p>
</li>
<li>
<p>Fine grain permissions are only available within <a href="#_per_realm_admin_permissions">dedicated admin consoles</a> and admins defined within those realms.  You cannot define cross-realm fine grain permissions.</p>
</li>
<li>
<p>Fine grain permissions are used to grant additional permissions.  You cannot override the
default behavior of the built in admin roles.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="managing-one-specific-client"><a class="anchor" href="#managing-one-specific-client"></a>Managing One Specific Client</h4>
<div class="paragraph">
<p>Let&#8217;s look first at allowing
an admin to manage one client and one client only.  In our example, we have a realm
called <code>test</code> and a client called <code>sales-application</code>.  In the realm <code>test</code> we will give a
user in that realm permission to only manage that application.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You cannot do cross realm fine grain permissions.  Admins in the <code>master</code> realm are limited to the predefined admin roles defined in previous chapters.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="permission-setup"><a class="anchor" href="#permission-setup"></a>Permission Setup</h5>
<div class="paragraph">
<p>The first thing we must do is login to the Admin Console so we can set up permissions for that client.  We navigate to the management section
of the client, we want to define fine-grain permissions for.</p>
</div>
<div class="paragraph">
<div class="title">Client Management</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client.png" alt="fine grain client"></span></p>
</div>
<div class="paragraph">
<p>You should see a tab menu item called <code>Permissions</code>.  Click on that tab.</p>
</div>
<div class="paragraph">
<div class="title">Client Permissions Tab</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-permissions-tab-off.png" alt="fine grain client permissions tab off"></span></p>
</div>
<div class="paragraph">
<p>By default, each client is not enabled to do fine grain permissions.  So turn the <code>Permissions Enabled</code> switch to on
to initialize permissions.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you turn the <code>Permissions Enabled</code> switch to off, it will delete any and all permissions you have defined for this client.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Client Permissions Tab</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-permissions-tab-on.png" alt="fine grain client permissions tab on"></span></p>
</div>
<div class="paragraph">
<p>When you switch <code>Permissions Enabled</code> to on, it initializes various permission objects behind the scenes
using <a href="https://www.keycloak.org/docs/12.0/authorization_services/">Authorization Services</a>.  For this example, we&#8217;re
interested in the <code>manage</code> permission for the client.  Clicking on that will redirect you
to the permission that handles the <code>manage</code> permission for the client.  All authorization
objects are contained in the <code>realm-management</code> client&#8217;s <code>Authorization</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Client Manage Permission</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-manage-permissions.png" alt="fine grain client manage permissions"></span></p>
</div>
<div class="paragraph">
<p>When first initialized the <code>manage</code> permission does not have any policies associated with it.
You will need to create one by going to the policy tab.  To get there fast, click on
the <code>Authorization</code> link shown in the above image. Then click on the policies tab.</p>
</div>
<div class="paragraph">
<p>There&#8217;s a pull down menu on this page called <code>Create policy</code>.  There&#8217;s a multitude of policies
you can define.  You can define a policy that is associated with a role or a group or even define
rules in JavaScript.  For this simple example, we&#8217;re going to create a <code>User Policy</code>.</p>
</div>
<div class="paragraph">
<div class="title">User Policy</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-user-policy.png" alt="fine grain client user policy"></span></p>
</div>
<div class="paragraph">
<p>This policy will match a hard-coded user in the user database.  In this case, it is the <code>sales-admin</code> user.  We must then go back to the
<code>sales-application</code> client&#8217;s <code>manage</code> permission page and assign the policy to the permission object.</p>
</div>
<div class="paragraph">
<div class="title">Assign User Policy</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-assign-user-policy.png" alt="fine grain client assign user policy"></span></p>
</div>
<div class="paragraph">
<p>The <code>sales-admin</code> user can now has permission to manage the <code>sales-application</code> client.</p>
</div>
<div class="paragraph">
<p>There&#8217;s one more thing we have to do.  Go to the <code>Role Mappings</code> tab and assign the <code>query-clients</code>
role to the <code>sales-admin</code>.</p>
</div>
<div class="paragraph">
<div class="title">Assign query-clients</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-assign-query-clients.png" alt="fine grain assign query clients"></span></p>
</div>
<div class="paragraph">
<p>Why do you have to do this?  This role tells the Admin Console
what menu items to render when the <code>sales-admin</code> visits the Admin Console.  The <code>query-clients</code>
role tells the Admin Console that it should render client menus for the <code>sales-admin</code> user.</p>
</div>
<div class="paragraph">
<p>IMPORTANT If you do not set the <code>query-clients</code> role, restricted admins like <code>sales-admin</code> will not see any menu options when they log into the Admin Console</p>
</div>
</div>
<div class="sect4">
<h5 id="testing-it-out"><a class="anchor" href="#testing-it-out"></a>Testing It Out.</h5>
<div class="paragraph">
<p>Next, we log out of the master realm and re-login to the <a href="#_per_realm_admin_permissions">dedicated admin console</a> for the <code>test</code> realm
using the <code>sales-admin</code> as a username.  This is located under <code>/auth/admin/test/console</code>.</p>
</div>
<div class="paragraph">
<div class="title">Sales Admin Login</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-sales-admin-login.png" alt="fine grain sales admin login"></span></p>
</div>
<div class="paragraph">
<p>This admin is now able to manage this one client.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="restrict-user-role-mapping"><a class="anchor" href="#restrict-user-role-mapping"></a>Restrict User Role Mapping</h4>
<div class="paragraph">
<p>Another thing you might want to do is to restrict the set of roles an admin is allowed
to assign to a user.  Continuing our last example, let&#8217;s expand the permission set of the 'sales-admin'
user so that he can also control which users are allowed to access this application.  Through fine grain permissions, we can
enable it so that the <code>sales-admin</code> can only assign roles that grant specific access to
the <code>sales-application</code>.  We can also restrict it so that the admin can only map roles
and not perform any other types of user administration.</p>
</div>
<div class="paragraph">
<p>The <code>sales-application</code> has defined three different client roles.</p>
</div>
<div class="paragraph">
<div class="title">Sales Application Roles</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-sales-application-roles.png" alt="fine grain sales application roles"></span></p>
</div>
<div class="paragraph">
<p>We want the <code>sales-admin</code> user to be able to map these roles to any user in the system.  The
first step to do this is to allow the role to be mapped by the admin.  If we click on the
<code>viewLeads</code> role, you&#8217;ll see that there is a <code>Permissions</code> tab for this role.</p>
</div>
<div class="paragraph">
<div class="title">View Leads Role Permission Tab</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-view-leads-role-tab.png" alt="fine grain view leads role tab"></span></p>
</div>
<div class="paragraph">
<p>If we click on that tab and turn the <code>Permissions Enabled</code> on, you&#8217;ll see that there
are a number of actions we can apply policies to.</p>
</div>
<div class="paragraph">
<div class="title">View Leads Permissions</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-view-leads-permissions.png" alt="fine grain view leads permissions"></span></p>
</div>
<div class="paragraph">
<p>The one we are interested in is <code>map-role</code>.  Click on this permission and add the same
User Policy that was created in the earlier example.</p>
</div>
<div class="paragraph">
<div class="title">Map-roles Permission</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-map-roles-permission.png" alt="fine grain map roles permission"></span></p>
</div>
<div class="paragraph">
<p>What we&#8217;ve done is say that the <code>sales-admin</code> can map the <code>viewLeads</code> role.  What we have
not done is specify which users the admin is allowed to map this role too.  To do that
we must go to the <code>Users</code> section of the admin console for this realm.  Clicking on the
<code>Users</code> left menu item brings us to the users interface of the realm.  You should see a
<code>Permissions</code> tab.  Click on that and enable it.</p>
</div>
<div class="paragraph">
<div class="title">Users Permissions</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-users-permissions.png" alt="fine grain users permissions"></span></p>
</div>
<div class="paragraph">
<p>The permission we are interested in is <code>map-roles</code>.  This is a restrictive policy
in that it only allows admins the ability to map roles to a user.  If we click on the
<code>map-roles</code> permission and again add the User Policy we created for this, our <code>sales-admin</code>
will be able to map roles to any user.</p>
</div>
<div class="paragraph">
<p>The last thing we have to do is add the <code>view-users</code> role to the <code>sales-admin</code>.  This will
allow the admin to view users in the realm he wants to add the <code>sales-application</code> roles to.</p>
</div>
<div class="paragraph">
<div class="title">Add view-users</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-add-view-users.png" alt="fine grain add view users"></span></p>
</div>
<div class="sect4">
<h5 id="testing-it-out-2"><a class="anchor" href="#testing-it-out-2"></a>Testing It Out.</h5>
<div class="paragraph">
<p>Next, we log out of the master realm and re-login to the <a href="#_per_realm_admin_permissions">dedicated admin console</a> for the <code>test</code> realm
using the <code>sales-admin</code> as a username.  This is located under <code>/auth/admin/test/console</code>.</p>
</div>
<div class="paragraph">
<p>You will see that now the <code>sales-admin</code> can view users in the system.  If you select one of the
users you&#8217;ll see that each user detail page is read only, except for the <code>Role Mappings</code> tab.
Going to this tab you&#8217;ll find that there are no <code>Available</code> roles for the admin to
map to the user except when we browse the <code>sales-application</code> roles.</p>
</div>
<div class="paragraph">
<div class="title">Add viewLeads</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-add-view-leads.png" alt="fine grain add view leads"></span></p>
</div>
<div class="paragraph">
<p>We&#8217;ve only specified that the <code>sales-admin</code> can map the <code>viewLeads</code> role.</p>
</div>
</div>
<div class="sect4">
<h5 id="per-client-map-roles-shortcut"><a class="anchor" href="#per-client-map-roles-shortcut"></a>Per Client map-roles Shortcut</h5>
<div class="paragraph">
<p>It would be tedious if we had to do this for every client role that the <code>sales-application</code> published.
to make things easier, there&#8217;s a way to specify that an admin can map any role defined
by a client.  If we log back into the admin console to our master realm admin and go back
  to the <code>sales-application</code> permissions page, you&#8217;ll see the <code>map-roles</code> permission.</p>
</div>
<div class="paragraph">
<div class="title">Client map-roles Permission</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-permissions-tab-on.png" alt="fine grain client permissions tab on"></span></p>
</div>
<div class="paragraph">
<p>If you grant access to this particular permission to an admin, that admin will be able
map any role defined by the client.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="full-list-of-permissions"><a class="anchor" href="#full-list-of-permissions"></a>Full List of Permissions</h4>
<div class="paragraph">
<p>You can do a lot more with fine grain permissions beyond managing a specific client or the specific roles of a client.
This chapter defines the whole list of permission types that can be described for
a realm.</p>
</div>
<div class="sect4">
<h5 id="role"><a class="anchor" href="#role"></a>Role</h5>
<div class="paragraph">
<p>When going to the <code>Permissions</code> tab for a specific role, you will see these
permission types listed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">map-role</dt>
<dd>
<p>Policies that decide if an admin can map this role to a user.  These policies
only specify that the role can be mapped to a user, not that the admin is allowed
to perform user role mapping tasks.  The admin will also have to have manage or
role mapping permissions.  See <a href="#_users-permissions">Users Permissions</a> for more information.</p>
</dd>
<dt class="hdlist1">map-role-composite</dt>
<dd>
<p>Policies that decide if an admin can map this role as a composite to another role.
An admin can define roles for a client if he has to manage permissions for that client
but he will not be able to add composites to those roles unless he has the
<code>map-role-composite</code> privileges for the role he wants to add as a composite.</p>
</dd>
<dt class="hdlist1">map-role-client-scope</dt>
<dd>
<p>Policies that decide if an admin can apply this role to the scope of a client.
Even if the admin can manage the client, he will not have permission to
create tokens for that client that contain this role unless this privilege
is granted.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="client"><a class="anchor" href="#client"></a>Client</h5>
<div class="paragraph">
<p>When going to the <code>Permissions</code> tab for a specific client, you will see these
permission types listed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">view</dt>
<dd>
<p>Policies that decide if an admin can view the client&#8217;s configuration.</p>
</dd>
<dt class="hdlist1">manage</dt>
<dd>
<p>Policies that decide if an admin can view and manage the client&#8217;s configuration.
There are some issues with this in that privileges could be leaked unintentionally.
For example, the admin could define a protocol mapper that hardcoded a role
even if the admin does not have privileges to map the role to the client&#8217;s scope.
This is currently the limitation of protocol mappers as they don&#8217;t have a way
to assign individual permissions to them like roles do.</p>
</dd>
<dt class="hdlist1">configure</dt>
<dd>
<p>Reduced set of privileges to manage the client.  It is like the <code>manage</code> scope except
the admin is not allowed to define protocol mappers, change the client template,
or the client&#8217;s scope.</p>
</dd>
<dt class="hdlist1">map-roles</dt>
<dd>
<p>Policies that decide if an admin can map any role defined by the client to a user.
This is a shortcut, easy-of-use feature to avoid having to define policies
for each and every role defined by the client.</p>
</dd>
<dt class="hdlist1">map-roles-composite</dt>
<dd>
<p>Policies that decide if an admin can map any role defined by the client
as a composite to another role.
This is a shortcut, easy-of-use feature to avoid having to define policies
for each and every role defined by the client.</p>
</dd>
<dt class="hdlist1">map-roles-client-scope</dt>
<dd>
<p>Policies that decide if an admin can map any role defined by the client
to the scope of another client.
This is a shortcut, easy-of-use feature to avoid having to define policies
for each and every role defined by the client.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_users-permissions"><a class="anchor" href="#_users-permissions"></a>Users</h5>
<div class="paragraph">
<p>When going to the <code>Permissions</code> tab for all users, you will see these
permission types listed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">view</dt>
<dd>
<p>Policies that decide if an admin can view all users in the realm.</p>
</dd>
<dt class="hdlist1">manage</dt>
<dd>
<p>Policies that decide if an admin can manage all users in the realm.  This
permission grants the admin the privilege to perform user role mappings, but
it does not specify which roles the admin is allowed to map.  You&#8217;ll need to
define the privilege for each role you want the admin to be able to map.</p>
</dd>
<dt class="hdlist1">map-roles</dt>
<dd>
<p>This is a subset of the privileges granted by the <code>manage</code> scope.  In this
case the admin is only allowed to map roles.  The admin is not allowed to perform
any other user management operation.  Also, like <code>manage</code>, the roles that the
admin is allowed to apply must be specified per role or per set of roles if dealing
with client roles.</p>
</dd>
<dt class="hdlist1">manage-group-membership</dt>
<dd>
<p>Similar to <code>map-roles</code> except that it pertains to group membership: which
groups a user can be added or removed from.  These
policies just grant the admin permission to manage group membership, not which
groups the admin is allowed to manage membership for.  You&#8217;ll have to
specify policies for each group&#8217;s <code>manage-members</code> permission.</p>
</dd>
<dt class="hdlist1">impersonate</dt>
<dd>
<p>Policies that decide if the admin is allowed to impersonate other users.  These
policies are applied to the admin&#8217;s attributes and role mappings.</p>
</dd>
<dt class="hdlist1">user-impersonated</dt>
<dd>
<p>Policies that decide which users can be impersonated.  These policies will be
applied to the user being impersonated.  For example, you might want to define
a policy that will forbid anybody from impersonating a user that has admin
privileges.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="group"><a class="anchor" href="#group"></a>Group</h5>
<div class="paragraph">
<p>When going to the <code>Permissions</code> tab for a specific group, you will see these
permission types listed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">view</dt>
<dd>
<p>Policies that decide if the admin can view information about the group.</p>
</dd>
<dt class="hdlist1">manage</dt>
<dd>
<p>Policies that decide if the admin can manage the configuration of the group.</p>
</dd>
<dt class="hdlist1">view-members</dt>
<dd>
<p>Policies that decide if the admin can view the user details of members of the group.</p>
</dd>
<dt class="hdlist1">manage-members</dt>
<dd>
<p>Policies that decide if the admin can manage the users that belong to this group.</p>
</dd>
<dt class="hdlist1">manage-membership</dt>
<dd>
<p>Policies that decide if an admin can change the membership of the group.  Add or
remove members from the group.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="realm_keys"><a class="anchor" href="#realm_keys"></a>Realm Keys</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/realms/keys.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/realms/keys.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The authentication protocols that are used by Keycloak require cryptographic signatures and sometimes
encryption.  Keycloak uses asymmetric key pairs, a private and public key, to accomplish this.</p>
</div>
<div class="paragraph">
<p>Keycloak has a single active keypair at a time, but can have several passive keys as well. The active keypair
is used to create new signatures, while the passive keypairs can be used to verify previous signatures. This makes it
possible to regularly rotate the keys without any downtime or interruption to users.</p>
</div>
<div class="paragraph">
<p>When a realm is created a key pair and a self-signed certificate is automatically generated.</p>
</div>
<div class="paragraph">
<p>To view the active keys for a realm select the realm in the admin console click on <code>Realm settings</code> then <code>Keys</code>. This
will show the currently active keys for the realm.</p>
</div>
<div class="paragraph">
<p>To view passive or disabled keys select <code>Passive</code> or <code>Disabled</code>.
A keypair can have the status <code>Active</code>, but still not be selected as the currently active keypair for the realm.
The selected active pair which is used for signatures is selected based on the first key provider sorted by priority
that is able to provide an active keypair.</p>
</div>
<div class="sect3">
<h4 id="rotating-keys"><a class="anchor" href="#rotating-keys"></a>Rotating keys</h4>
<div class="paragraph">
<p>It&#8217;s recommended to regularly rotate keys. To do so you should start by creating new keys with a higher priority than
the existing active keys. Or create new keys with the same priority and making the previous keys passive.</p>
</div>
<div class="paragraph">
<p>Once new keys are available all new tokens and cookies will be signed with the new keys. When a user authenticates to an
application the SSO cookie is updated with the new signature. When OpenID Connect tokens are refreshed new tokens are
signed with the new keys. This means that over time all cookies and tokens will use the new keys and after a while the
old keys can be removed.</p>
</div>
<div class="paragraph">
<p>How long you wait to delete old keys is a tradeoff between security and making sure all cookies and tokens are updated.
In general it should be acceptable to drop old keys after a few weeks. Users that have not been active in the period
between the new keys where added and the old keys removed will have to re-authenticate.</p>
</div>
<div class="paragraph">
<p>This also applies to offline tokens. To make sure they are updated the applications need to refresh the tokens before
the old keys are removed.</p>
</div>
<div class="paragraph">
<p>As a guideline, it may be a good idea to create new keys every 3-6 months and delete old keys 1-2 months after the new
keys were created.</p>
</div>
</div>
<div class="sect3">
<h4 id="adding-a-generated-keypair"><a class="anchor" href="#adding-a-generated-keypair"></a>Adding a generated keypair</h4>
<div class="paragraph">
<p>To add a new generated keypair select <code>Providers</code> and choose <code>rsa-generated</code> from the dropdown. You can change the priority
to make sure the new keypair becomes the active keypair. You can also change the <code>keysize</code> if you want smaller or larger keys (default is 2048,
supported values are 1024, 2048 and 4096).</p>
</div>
<div class="paragraph">
<p>Click <code>Save</code> to add the new keys. This will generated a new keypair including a self-signed certificate.</p>
</div>
<div class="paragraph">
<p>Changing the priority for a provider will not cause the keys to be re-generated, but if you want to change the keysize
you can edit the provider and new keys will be generated.</p>
</div>
</div>
<div class="sect3">
<h4 id="adding-an-existing-keypair-and-certificate"><a class="anchor" href="#adding-an-existing-keypair-and-certificate"></a>Adding an existing keypair and certificate</h4>
<div class="paragraph">
<p>To add a keypair and certificate obtained elsewhere select <code>Providers</code> and choose <code>rsa</code> from the dropdown. You can change
the priority to make sure the new keypair becomes the active keypair.</p>
</div>
<div class="paragraph">
<p>Click on <code>Select file</code> for <code>Private RSA Key</code> to upload your private key. The file should be encoded in PEM format. You
don&#8217;t need to upload the public key as it is automatically extracted from the private key.</p>
</div>
<div class="paragraph">
<p>If you have a signed certificate for the keys click on <code>Select file</code> next to <code>X509 Certificate</code>. If you don&#8217;t have one
 you can skip this and a self-signed certificate will be generated.</p>
</div>
</div>
<div class="sect3">
<h4 id="loading-keys-from-a-java-keystore"><a class="anchor" href="#loading-keys-from-a-java-keystore"></a>Loading keys from a Java Keystore</h4>
<div class="paragraph">
<p>To add a keypair and certificate stored in a Java Keystore file on the host select <code>Providers</code> and choose <code>java-keystore</code>
from the dropdown. You can change the priority to make sure the new keypair becomes the active keypair.</p>
</div>
<div class="paragraph">
<p>Fill in the values for <code>Keystore</code>, <code>Keystore Password</code>, <code>Key Alias</code> and <code>Key Password</code> and click on <code>Save</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="making-keys-passive"><a class="anchor" href="#making-keys-passive"></a>Making keys passive</h4>
<div class="paragraph">
<p>Locate the keypair in <code>Active</code> then click on the provider in the <code>Provider</code> column. This will take you to the
configuration screen for the key provider for the keys. Click on <code>Active</code> to turn it <code>OFF</code>, then click on <code>Save</code>. The
keys will no longer be active and can only be used for verifying signatures.</p>
</div>
</div>
<div class="sect3">
<h4 id="disabling-keys"><a class="anchor" href="#disabling-keys"></a>Disabling keys</h4>
<div class="paragraph">
<p>Locate the keypair in <code>Active</code> then click on the provider in the <code>Provider</code> column. This will take you to the
configuration screen for the key provider for the keys. Click on <code>Enabled</code> to turn it <code>OFF</code>, then click on <code>Save</code>. The
keys will no longer be enabled.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can delete the provider from the <code>Providers</code> table.</p>
</div>
</div>
<div class="sect3">
<h4 id="compromised-keys"><a class="anchor" href="#compromised-keys"></a>Compromised keys</h4>
<div class="paragraph">
<p>Keycloak has the signing keys stored just locally and they are never shared with the client applications, users or other
entities. However if you think that your realm signing key was compromised, you should first generate new keypair as described above and
then immediately remove the compromised keypair.</p>
</div>
<div class="paragraph">
<p>Then to ensure that client applications won&#8217;t accept the tokens signed by the compromised key, you should update and push not-before policy for
the realm, which is doable from the admin console. Pushing new policy will ensure that client applications won&#8217;t accept the existing
tokens signed by the compromised key, but also the client application will be forced to download new keypair from the Keycloak, hence
the tokens signed by the compromised key won&#8217;t be valid anymore. Note that your REST and confidential clients must have set <code>Admin URL</code>, so that
Keycloak is able to send them the request about pushed not-before policy.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_identity_broker"><a class="anchor" href="#_identity_broker"></a>Identity Brokering</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>An Identity Broker is an intermediary service that connects multiple service providers with different identity providers.
As an intermediary service, the identity broker is responsible for creating
a trust relationship with an external identity provider in order to use its identities to access internal services exposed by service providers.</p>
</div>
<div class="paragraph">
<p>From a user perspective, an identity broker provides a user-centric and centralized way to manage identities across different security
domains or realms. An existing account can be linked with one or more identities from different identity providers or even created
based on the identity information obtained from them.</p>
</div>
<div class="paragraph">
<p>An identity provider is usually based on a specific protocol that is used to authenticate and communicate authentication and authorization information to their users.
It can be a social provider such as Facebook, Google or Twitter.  It can be a business partner whose users need to access your services. Or it can be a cloud-based identity
service that you want to integrate with.</p>
</div>
<div class="paragraph">
<p>Usually, identity providers are based on the following protocols:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SAML v2.0</code></p>
</li>
<li>
<p><code>OpenID Connect v1.0</code></p>
</li>
<li>
<p><code>OAuth v2.0</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the next sections we&#8217;ll see how to configure and use Keycloak as an identity broker, covering some important aspects such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Social Authentication</code></p>
</li>
<li>
<p><code>OpenID Connect v1.0 Brokering</code></p>
</li>
<li>
<p><code>SAML v2.0 Brokering</code></p>
</li>
<li>
<p><code>Identity Federation</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_identity_broker_overview"><a class="anchor" href="#_identity_broker_overview"></a>Brokering Overview</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/overview.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/overview.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When using Keycloak as an identity broker, users are not forced to provide their credentials in order to authenticate in a specific realm.
Instead, they are presented with a list of identity providers from which they can authenticate.</p>
</div>
<div class="paragraph">
<p>You can also configure a default identity provider. In this case the user will not be given a choice, but will instead be redirected directly to the default provider.</p>
</div>
<div class="paragraph">
<p>The following diagram demonstrates the steps involved when using Keycloak to broker an external identity provider:</p>
</div>
<div class="paragraph">
<div class="title">Identity Broker Flow</div>
<p><span class="image"><img src="./images/identity_broker_flow.png" alt="identity broker flow"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User is not authenticated and requests a protected resource in a client application.</p>
</li>
<li>
<p>The client applications redirects the user to Keycloak to authenticate.</p>
</li>
<li>
<p>At this point the user is presented with the login page where there is a list of identity providers configured in a realm.</p>
</li>
<li>
<p>User selects one of the identity providers by clicking on its respective button or link.</p>
</li>
<li>
<p>Keycloak issues an authentication request to the target identity provider asking for authentication and the user
is redirected to the login page of the identity provider.
The connection properties and other configuration options for the identity provider were previously set by the administrator in the Admin Console.</p>
</li>
<li>
<p>User provides his credentials or consent in order to authenticate with the identity provider.</p>
</li>
<li>
<p>Upon a successful authentication by the identity provider, the user is redirected back to Keycloak with an authentication response.
Usually this response contains a security token that will be used by Keycloak to trust the authentication performed by the identity provider
and retrieve information about the user.</p>
</li>
<li>
<p>Now Keycloak is going to check if the response from the identity provider is valid.
If valid, it will import and create a new user or just skip that if the user already exists.
If it is a new user, Keycloak may ask the identity provider for information about the user if that info doesn&#8217;t already exist in the token.
This is what we call <em>identity federation</em>.
If the user already exists Keycloak may ask him to link the identity returned from the identity provider with the existing account.
We call this process <em>account linking</em>.
What exactly is done is configurable and can be specified by setup of <a href="#_identity_broker_first_login">First Login Flow</a>. At the end of this step, Keycloak authenticates the user and issues its own token in order to access the requested resource in the service provider.</p>
</li>
<li>
<p>Once the user is locally authenticated, Keycloak redirects the user to the service provider by sending the token previously issued during the local authentication.</p>
</li>
<li>
<p>The service provider receives the token from Keycloak and allows access to the protected resource.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are some variations of this flow that we will talk about later.
For instance, instead of presenting a list of identity providers, the client application can request a specific one.
Or you can tell Keycloak to force the user to provide additional information before federating his identity.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Different protocols may require different authentication flows.
      At this moment, all the identity providers supported by Keycloak use a flow just like described above.
      However, regardless of the protocol in use, user experience should be pretty much the same.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you may notice, at the end of the authentication process Keycloak will always issue its own token to client applications.
What this means is that client applications are completely decoupled from external identity providers.
They don&#8217;t need to know which protocol (eg.: SAML, OpenID Connect, OAuth, etc) was used or how the user&#8217;s identity was validated.
They only need to know about Keycloak.</p>
</div>
</div>
<div class="sect2">
<h3 id="default_identity_provider"><a class="anchor" href="#default_identity_provider"></a>Default Identity Provider</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/default-provider.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/default-provider.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>It is possible to automatically redirect to a identity provider instead of displaying the login form. To enable this go to the <code>Authentication</code> page in the administration console and select the <code>Browser</code> flow. Then click on config for the <code>Identity Provider Redirector</code> authenticator. Set <code>Default Identity Provider</code> to the alias of the identity provider you want to automatically redirect users to.</p>
</div>
<div class="paragraph">
<p>If the configured default identity provider is not found the login form will be displayed instead.</p>
</div>
<div class="paragraph">
<p>This authenticator is also responsible for dealing with the <code>kc_idp_hint</code> query parameter. See <a href="#_client_suggested_idp">client suggested identity provider</a> section for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_general-idp-config"><a class="anchor" href="#_general-idp-config"></a>General Configuration</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/configuration.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/configuration.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The identity broker configuration is all based on identity providers.
Identity providers are created for each realm and by default they are enabled for every single application.
That means that users from a realm can use any of the registered identity providers when signing in to an application.</p>
</div>
<div class="paragraph">
<p>In order to create an identity provider click the <code>Identity Providers</code> left menu item.</p>
</div>
<div class="paragraph">
<div class="title">Identity Providers</div>
<p><span class="image"><img src="./keycloak-images/identity-providers.png" alt="identity providers"></span></p>
</div>
<div class="paragraph">
<p>In the drop down list box, choose the identity provider you want to add.  This will bring you to the
configuration page for that identity provider type.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/add-identity-provider.png" alt="add identity provider"></span></p>
</div>
<div class="paragraph">
<p>Above is an example of configuring a Facebook social login provider.  Once you configure an IDP, it will appear on the Keycloak
login page as an option. It&#8217;s possible to have custom icons on login screen for each identity provider.
For more details, please refer to the <a href="https://www.keycloak.org/docs/12.0/server_development/#custom-identity-providers-icons">custom icons</a>.</p>
</div>
<div class="paragraph">
<div class="title">IDP login page</div>
<p><span class="image"><img src="./keycloak-images/identity-provider-login-page.png" alt="identity provider login page"></span></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Social</dt>
<dd>
<p>Social providers allow you to enable social authentication in your realm.
Keycloak makes it easy to let users log in to your application using an existing account with a social network.
Currently supported providers include: Twitter, Facebook, Google, LinkedIn, Instagram, Microsoft, PayPal, Openshift v3, GitHub, GitLab, Bitbucket, and Stack Overflow.</p>
</dd>
<dt class="hdlist1">Protocol-based</dt>
<dd>
<p>Protocol-based providers are those that rely on a specific protocol in order to authenticate and authorize users.
They allow you to connect to any identity provider compliant with a specific protocol.
Keycloak provides support for SAML v2.0 and OpenID Connect v1.0 protocols.
It makes it easy to configure and broker any identity provider based on these open standards.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Although each type of identity provider has its own configuration options, all of them share some very common configuration.
Regardless of which identity provider you are creating, you&#8217;ll see the following configuration options available:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Common Configuration</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alias</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The alias is a unique identifier for an identity provider. It is used to reference an identity provider internally.
 Some protocols such as OpenID Connect require a redirect URI or callback url in order to communicate with an identity provider.
 In this case, the alias is used to build the redirect URI.
 Every single identity provider must have an alias. Examples are <code>facebook</code>, <code>google</code>, <code>idp.acme.com</code>, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Turn the provider on/off.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hide on Login Page</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this switch is on, this provider will not be shown as a login option on the login page.  Clients can still request to use this provider by using the 'kc_idp_hint' parameter in the URL they use to request a login.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Account Linking Only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this switch is on, this provider cannot be used to login users and will not be shown as an option on the login page.  Existing accounts can still be linked with this provider though.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store Tokens</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not to store the token received from the identity provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stored Tokens Readable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not users are allowed to retrieve the stored identity provider token.  This also applies to the <em>broker</em> client-level
 role <em>read token</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trust Email</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the identity provider supplies an email address this email address will be trusted.  If the realm required email validation,
 users that log in from this IDP will not have to go through the email verification process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GUI Order</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The order number that sorts how the available IDPs are listed on the login page.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First Login Flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the authentication flow that will be triggered for users that log into Keycloak through this IDP
 for the first time ever.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Post Login Flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication flow that is triggered after the user finishes logging in with the external identity provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sync Mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strategy of how to update user information from the idp through mappers: When choosing <code>legacy</code>, the current behavior is kept,
 <code>import</code> will never update user data, while <code>force</code> will always update user data when possible. See also the documentation for <a href="#_mappers">Identity Provider Mappers</a> for more details.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="social-identity-providers"><a class="anchor" href="#social-identity-providers"></a>Social Identity Providers</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social-login.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social-login.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>For Internet facing applications, it is quite burdensome for users to have to register at your site to obtain access.
It requires them to remember yet another username and password combination.  Social identity providers allow you to delegate
authentication to a semi-trusted and respected entity where the user probably already has an account.
Keycloak provides built-in support for the most common social networks out there, such as Google, Facebook, Twitter, GitHub, LinkedIn, Microsoft and Stack Overflow.</p>
</div>
<div class="sect3">
<h4 id="bitbucket"><a class="anchor" href="#bitbucket"></a>Bitbucket</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/bitbucket.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/bitbucket.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with Bitbucket.</p>
</div>
<div class="paragraph">
<p>First, open the <code>Identity Providers</code> left menu item and select <code>Bitbucket</code> from the <code>Add provider</code> drop down list. This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/bitbucket-add-identity-provider.png" alt="bitbucket add identity provider"></span></p>
</div>
<div class="paragraph">
<p>Before you can click <code>Save</code>, you must obtain a <code>Client ID</code> and <code>Client Secret</code> from Bitbucket.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will use the <code>Redirect URI</code> from this page in a later step, which you will provide to Bitbucket when you register Keycloak as a client there.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Add a New App</div>
<p>To enable login with Bitbucket you must first register an application project in
<a href="https://support.atlassian.com/bitbucket-cloud/docs/use-oauth-on-bitbucket-cloud/">OAuth on Bitbucket Cloud</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Bitbucket often changes the look and feel of application registration, so what you see on the Bitbucket site may differ. If in doubt, see the Bitbucket documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/bitbucket-developer-applications.png" alt="bitbucket developer applications"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Add consumer</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Register App</div>
<p><span class="image"><img src="./images/bitbucket-register-app.png" alt="bitbucket register app"></span></p>
</div>
<div class="paragraph">
<p>Copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and enter it into the Callback URL field on the Bitbucket Add OAuth Consumer page.</p>
</div>
<div class="paragraph">
<p>On the same page, mark the <code>Email</code> and <code>Read</code> boxes under <code>Account</code> to allow your application to read user email.</p>
</div>
<div class="paragraph">
<div class="title">Bitbucket App Page</div>
<p><span class="image"><img src="./images/bitbucket-app-page.png" alt="bitbucket app page"></span></p>
</div>
<div class="paragraph">
<p>When you are done registering, click <code>Save</code>. This will open the application management page in Bitbucket. Find the client ID and secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page. Click <code>Save</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="facebook"><a class="anchor" href="#facebook"></a>Facebook</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/facebook.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/facebook.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with Facebook.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Facebook</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/facebook-add-identity-provider.png" alt="facebook add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Facebook.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Facebook when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Facebook you first have to create a project and a client in the <a href="https://developers.facebook.com/">Facebook Developer Console</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Facebook often changes the look and feel of the Facebook Developer Console, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once you&#8217;ve logged into the console there is a pull down menu in the top right corner of the screen that says <code>My Apps</code>.  Select the <code>Add a New App</code>
menu item.</p>
</div>
<div class="paragraph">
<div class="title">Add a New App</div>
<p><span class="image"><img src="./images/facebook-add-new-app.png" alt="facebook add new app"></span></p>
</div>
<div class="paragraph">
<p>Select the <code>Website</code> icon.  Click the <code>Skip and Create App ID</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Create a New App ID</div>
<p><span class="image"><img src="./images/facebook-create-app-id.png" alt="facebook create app id"></span></p>
</div>
<div class="paragraph">
<p>The email address and app category are required fields.  Once you&#8217;re done with that, you will be brought to the dashboard
for the application.  Click the <code>Settings</code> left menu item.</p>
</div>
<div class="paragraph">
<div class="title">Create a New App ID</div>
<p><span class="image"><img src="./images/facebook-app-settings.png" alt="facebook app settings"></span></p>
</div>
<div class="paragraph">
<p>Click on the <code>+ Add Platform</code> button at the end of this page and select the <code>Website</code> icon.  Copy and paste the <code>Redirect URI</code> from the
Keycloak <code>Add identity provider</code> page into the <code>Site URL</code> of the Facebook <code>Website</code> settings block.</p>
</div>
<div class="paragraph">
<div class="title">Specify Website</div>
<p><span class="image"><img src="./images/facebook-app-settings-website.png" alt="facebook app settings website"></span></p>
</div>
<div class="paragraph">
<p>After this it is necessary to make the Facebook app public. Click <code>App Review</code> left menu item and switch button to "Yes".</p>
</div>
<div class="paragraph">
<p>You will need also to obtain the App ID and App Secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page. To obtain this click on the <code>Dashboard</code> left menu item and click on <code>Show</code> under <code>App Secret</code>. Go back to Keycloak and specify those items and finally save your Facebook Identity Provider.</p>
</div>
<div class="paragraph">
<p>One config option to note on the <code>Add identity provider</code> page for Facebook is the <code>Default Scopes</code> field.
This field allows you to manually specify the scopes that users must authorize when authenticating with this provider.
For a complete list of scopes, please take a look at <a href="https://developers.facebook.com/docs/graph-api" class="bare">https://developers.facebook.com/docs/graph-api</a>. By default, Keycloak
uses the following scopes: <code>email</code>.</p>
</div>
<div class="paragraph">
<p>Another thing to note is that Keycloak sends a profile request to <code>graph.facebook.com/me?fields=id,name,email,first_name,last_name</code> by default, and the response only contains the specified fields.
If you want to fetch additional fields (e.g. birthday) from the Facebook profile then you have to add a corresponding scope as described in a paragraph above and add the field name in <code>Additional user&#8217;s profile fields</code> configuration option field.
You can discover available field names and corresponding scopes by exploring the <a href="https://developers.facebook.com/tools/explorer">Facebook GraphQL API Explorer</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="github"><a class="anchor" href="#github"></a>GitHub</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/github.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/github.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with GitHub.  First, go to the <code>Identity Providers</code> left menu item
and select <code>GitHub</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/github-add-identity-provider.png" alt="github add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from GitHub.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to GitHub when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with GitHub you first have to register an application project in
<a href="https://github.com/settings/developers">GitHub Developer applications</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
GitHub often changes the look and feel of application registration, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Add a New App</div>
<p><span class="image"><img src="./images/github-developer-applications.png" alt="github developer applications"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Register a new application</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Register App</div>
<p><span class="image"><img src="./images/github-register-app.png" alt="github register app"></span></p>
</div>
<div class="paragraph">
<p>You&#8217;ll have to copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and enter it into the
<code>Authorization callback URL</code> field on the GitHub <code>Register a new OAuth application</code> page.  Once you&#8217;ve completed this
page you will be brought to the application&#8217;s management page.</p>
</div>
<div class="paragraph">
<div class="title">GitHub App Page</div>
<p><span class="image"><img src="./images/github-app-page.png" alt="github app page"></span></p>
</div>
<div class="paragraph">
<p>You will need to obtain the client ID and secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
</div>
<div class="sect3">
<h4 id="gitlab"><a class="anchor" href="#gitlab"></a>GitLab</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/gitlab.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/gitlab.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with GitLab.</p>
</div>
<div class="paragraph">
<p>First, go to the <code>Identity Providers</code> left menu item and select <code>GitLab</code> from the <code>Add provider</code> drop down list. This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/gitlab-add-identity-provider.png" alt="gitlab add identity provider"></span></p>
</div>
<div class="paragraph">
<p>Before you can click <code>Save</code>, you must obtain a <code>Client ID</code> and <code>Client Secret</code> from GitLab.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You will use the <code>Redirect URI</code> from this page in a later step, which you will provide to GitLab when you register Keycloak as a client there.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To enable login with GitLab you first have to register an application in
<a href="https://docs.gitlab.com/ee/integration/oauth_provider.html">GitLab as OAuth2 authentication service provider</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
GitLab often changes the look and feel of application registration, so what you see on the GitLab site may differ. If in doubt, see the GitLab documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Add a New App</div>
<p><span class="image"><img src="./images/gitlab-developer-applications.png" alt="gitlab developer applications"></span></p>
</div>
<div class="paragraph">
<p>Copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and enter it into the Redirect URI field on the GitLab Add new application page.</p>
</div>
<div class="paragraph">
<div class="title">GitLab App Page</div>
<p><span class="image"><img src="./images/gitlab-app-page.png" alt="gitlab app page"></span></p>
</div>
<div class="paragraph">
<p>When you are done registering, click <code>Save application</code>. This will open the application management page in GitLab. Find the client ID and secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<p>To finish, return to Keycloak and enter them. Click <code>Save</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="google"><a class="anchor" href="#google"></a>Google</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/google.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/google.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with Google.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Google</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/google-add-identity-provider.png" alt="google add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Google.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Google when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Google you first have to create a project and a client in the <a href="https://console.cloud.google.com/project">Google Developer Console</a>.
Then you need to copy the client ID and secret into the Keycloak Admin Console.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Google often changes the look and feel of the Google Developer Console, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see first how to create a project with Google.</p>
</div>
<div class="paragraph">
<p>Log in to the <a href="https://console.cloud.google.com/project">Google Developer Console</a>.</p>
</div>
<div class="paragraph">
<div class="title">Google Developer Console</div>
<p><span class="image"><img src="./images/google-developer-console.png" alt="google developer console"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Create Project</code> button.
Use any value for <code>Project name</code> and <code>Project ID</code> you want, then click the <code>Create</code> button.
Wait for the project to be created (this may take a while).  Once created you will be brought to the project&#8217;s dashboard.</p>
</div>
<div class="paragraph">
<div class="title">Dashboard</div>
<p><span class="image"><img src="./images/google-dashboard.png" alt="google dashboard"></span></p>
</div>
<div class="paragraph">
<p>Then navigate to the <code>APIs &amp; Services</code> section in the Google Developer Console. On that screen, navigate to <code>Credentials</code> administration.</p>
</div>
<div class="paragraph">
<p>When users log into Google from Keycloak they will see a consent screen from Google which will ask the user
if Keycloak is allowed to view information about their user profile. Thus Google requires some basic information about the product before creating any secrets for it. For a new project, you have first to configure <code>OAuth consent screen</code>.</p>
</div>
<div class="paragraph">
<p>For the very basic setup, filling in the Application name is sufficient. You can also set additional details like scopes for Google APIs in this page.</p>
</div>
<div class="paragraph">
<div class="title">Fill in OAuth consent screen details</div>
<p><span class="image"><img src="./images/google-oauth-consent-screen.png" alt="google oauth consent screen"></span></p>
</div>
<div class="paragraph">
<p>The next step is to create OAuth client ID and client secret. Back in <code>Credentials</code> administration, navigate to <code>Credentials</code> tab and select <code>OAuth client ID</code> under the <code>Create credentials</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Create credentials</div>
<p><span class="image"><img src="./images/google-create-credentials.png" alt="google create credentials"></span></p>
</div>
<div class="paragraph">
<p>You will then be brought to the <code>Create OAuth client ID</code> page. Select <code>Web application</code> as the application type. Specify the name you want for your client.  You&#8217;ll also need to
copy and paste the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page into the
<code>Authorized redirect URIs</code> field.  After you do this, click the <code>Create</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Create OAuth client ID</div>
<p><span class="image"><img src="./images/google-create-oauth-id.png" alt="google create oauth id"></span></p>
</div>
<div class="paragraph">
<p>After you click <code>Create</code> you will be brought to the <code>Credentials</code> page. Click on your new OAuth 2.0 Client ID to view
the settings of your new Google Client.</p>
</div>
<div class="paragraph">
<div class="title">Google Client Credentials</div>
<p><span class="image"><img src="./images/google-client-credentials.png" alt="google client credentials"></span></p>
</div>
<div class="paragraph">
<p>You will need to obtain the client ID and secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
<div class="paragraph">
<p>One config option to note on the <code>Add identity provider</code> page for Google is the <code>Default Scopes</code> field.
This field allows you to manually specify the scopes that users must authorize when authenticating with this provider.
For a complete list of scopes, please take a look at <a href="https://developers.google.com/oauthplayground/" class="bare">https://developers.google.com/oauthplayground/</a> . By default, Keycloak
uses the following scopes: <code>openid</code> <code>profile</code> <code>email</code>.</p>
</div>
<div class="paragraph">
<p>If your organization uses the G Suite and you want to restrict access to only members of your organization,
you must enter the domain that is used for the G Suite into the <code>Hosted Domain</code> field to enable it.</p>
</div>
</div>
<div class="sect3">
<h4 id="linkedin"><a class="anchor" href="#linkedin"></a>LinkedIn</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/linked-in.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/linked-in.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with LinkedIn.  First, go to the <code>Identity Providers</code> left menu item
and select <code>LinkedIn</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/linked-in-add-identity-provider.png" alt="linked in add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from LinkedIn.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to LinkedIn when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with LinkedIn you first have to create an application in <a href="https://www.linkedin.com/developer/apps">LinkedIn Developer Network</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
LinkedIn may change the look and feel of application registration, so these directions may not always be up to date.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Developer Network</div>
<p><span class="image"><img src="./images/linked-in-developer-network.png" alt="linked in developer network"></span></p>
</div>
<div class="paragraph">
<p>Click on the <code>Create Application</code> button.  This will bring you to the <code>Create a New Application</code> Page.</p>
</div>
<div class="paragraph">
<div class="title">Create App</div>
<p><span class="image"><img src="./images/linked-in-create-app.png" alt="linked in create app"></span></p>
</div>
<div class="paragraph">
<p>Fill in the form with the appropriate values, then click the <code>Submit</code> button.  This will bring you to the new application&#8217;s settings page.</p>
</div>
<div class="paragraph">
<div class="title">App Settings</div>
<p><span class="image"><img src="./images/linked-in-app-settings.png" alt="linked in app settings"></span></p>
</div>
<div class="paragraph">
<p>Select <code>r_basicprofile</code> and <code>r_emailaddress</code> in the <code>Default Application Permissions</code> section.
You&#8217;ll have to copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and enter it into the
<code>OAuth 2.0</code> <code>Authorized Redirect URLs</code> field on the LinkedIn app settings page.  Don&#8217;t forget to click the <code>Update</code> button after
you do this!</p>
</div>
<div class="paragraph">
<p>You will then need to obtain the client ID and secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
</div>
<div class="sect3">
<h4 id="microsoft"><a class="anchor" href="#microsoft"></a>Microsoft</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/microsoft.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/microsoft.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with Microsoft.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Microsoft</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/microsoft-add-identity-provider.png" alt="microsoft add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Microsoft.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Microsoft when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Microsoft account you first have to register an OAuth application at Microsoft.
Go to the <a href="https://account.live.com/developers/applications/create">Microsoft Application Registration</a> url.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Microsoft often changes the look and feel of application registration, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Register Application</div>
<p><span class="image"><img src="./images/microsoft-app-register.png" alt="microsoft app register"></span></p>
</div>
<div class="paragraph">
<p>Enter in the application name and click <code>Create application</code>.  This will bring you to the application settings page of your
new application.</p>
</div>
<div class="paragraph">
<div class="title">Settings</div>
<p><span class="image"><img src="./images/microsoft-app-settings.png" alt="microsoft app settings"></span></p>
</div>
<div class="paragraph">
<p>You&#8217;ll have to copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and add it to the
<code>Redirect URIs</code> field on the Microsoft application page.  Be sure to click the <code>Add Url</code> button and <code>Save</code> your changes.</p>
</div>
<div class="paragraph">
<p>Finally, you will need to obtain the Application ID and secret from this page so you can enter them back on the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
From November 2018 onwards, Microsoft is removing support for the Live SDK API in favor of the new Microsoft Graph API.
         The Keycloak Microsoft identity provider has been updated to use the new endpoints so make sure to upgrade to
         Keycloak version 4.6.0 or later in order to use this provider.
         Furthermore, client applications registered with Microsoft under "Live SDK applications" will need to be re-registered
         in the <a href="https://account.live.com/developers/applications/create">Microsoft Application Registration</a> portal to obtain an application id that
         is compatible with the Microsoft Graph API.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="openshift-3"><a class="anchor" href="#openshift-3"></a>OpenShift 3</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/openshift.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/openshift.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
OpenShift Online is currently in the developer preview mode. This documentation has been based on on-premise installations and local <code>minishift</code> development environment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are a just a few steps you have to complete to be able to enable login with OpenShift.  First, go to the <code>Identity Providers</code> left menu item
and select <code>OpenShift</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./images/openshift-add-identity-provider.png" alt="openshift add identity provider"></span></p>
</div>
<div class="paragraph">
<div class="title">Registering OAuth client</div>
<p>You can register your client using <code>oc</code> command line tool.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ oc create -f &lt;(echo '
kind: OAuthClient
apiVersion: v1
metadata:
 name: kc-client <i class="conum" data-value="1"></i><b>(1)</b>
secret: &quot;...&quot; <i class="conum" data-value="2"></i><b>(2)</b>
redirectURIs:
 - &quot;http://www.example.com/&quot; <i class="conum" data-value="3"></i><b>(3)</b>
grantMethod: prompt <i class="conum" data-value="4"></i><b>(4)</b>
')</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>name</code> of your OAuth client. Passed as <code>client_id</code> request parameter when making requests to <code><em>&lt;openshift_master&gt;</em>/oauth/authorize</code> and <code><em>&lt;openshift_master&gt;</em>/oauth/token</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>secret</code> is used as the <code>client_secret</code> request parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>redirect_uri</code> parameter specified in requests to <code><em>&lt;openshift_master&gt;</em>/oauth/authorize</code> and <code><em>&lt;openshift_master&gt;</em>/oauth/token</code> must be equal to (or prefixed by) one of the URIs in <code>redirectURIs</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>grantMethod</code> is used to determine what action to take when this client requests tokens and has not yet been granted access by the user.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Use client ID and secret defined by <code>oc create</code> command to enter them back on the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
<div class="paragraph">
<p>Please refer to <a href="https://docs.okd.io/latest/authentication/configuring-oauth-clients.html#oauth-register-additional-client_configuring-oauth-clients">official OpenShift documentation</a> for more detailed guides.</p>
</div>
</div>
<div class="sect3">
<h4 id="openshift-4"><a class="anchor" href="#openshift-4"></a>OpenShift 4</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Prior to configuring OpenShift 4 Identity Provider, please locate the correct OpenShift 4 API URL up.
In some scenarios, that URL might be hidden from users. The easiest way to obtain it is to invoke the following command (this might require installing <code>jq</code> command separately) <code>curl -s -k -H "Authorization: Bearer $(oc whoami -t)" https://&lt;openshift-user-facing-api-url&gt;/apis/config.openshift.io/v1/infrastructures/cluster | jq ".status.apiServerURL"</code>. In most cases, the address will be protected by HTTPS. Therefore, it is essential to configure <code>X509_CA_BUNDLE</code> in the container and set it to <code>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</code>. Otherwise, Keycloak won&#8217;t be able to communicate
 with the API Server.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are a just a few steps you have to complete to be able to enable login with OpenShift 4.  First, go to the <code>Identity Providers</code> left menu item and select <code>OpenShift v4</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./images/openshift-4-add-identity-provider.png" alt="openshift 4 add identity provider"></span></p>
</div>
<div class="paragraph">
<div class="title">Registering OAuth client</div>
<p>You can register your client using <code>oc</code> command line tool.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ oc create -f &lt;(echo '
kind: OAuthClient
apiVersion: v1
metadata:
 name: keycloak-broker <i class="conum" data-value="1"></i><b>(1)</b>
secret: &quot;...&quot; <i class="conum" data-value="2"></i><b>(2)</b>
redirectURIs:
 - &quot;&lt;copy pasted Redirect URI from OpenShift 4 Identity Providers page&gt;&quot; <i class="conum" data-value="3"></i><b>(3)</b>
grantMethod: prompt <i class="conum" data-value="4"></i><b>(4)</b>
')</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>name</code> of your OAuth client. Passed as <code>client_id</code> request parameter when making requests to <code><em>&lt;openshift_master&gt;</em>/oauth/authorize</code> and <code><em>&lt;openshift_master&gt;</em>/oauth/token</code>. The <code>name</code> parameter needs to be the same
in <code>OAuthClient</code> object as well as in Keycloak configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>secret</code> is used as the <code>client_secret</code> request parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>redirect_uri</code> parameter specified in requests to <code><em>&lt;openshift_master&gt;</em>/oauth/authorize</code> and <code><em>&lt;openshift_master&gt;</em>/oauth/token</code> must be equal to (or prefixed by) one of the URIs in <code>redirectURIs</code>. The easiest way to configure it correctly is to copy-paste
it from Keycloak OpenShift 4 Identity Provider configuration page (<code>Redirect URI</code> field).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>grantMethod</code> is used to determine what action to take when this client requests tokens and has not yet been granted access by the user.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Use the client ID and secret defined by <code>oc create</code> command to enter them back on the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The OpenShift API server returns <code>The client is not authorized to request a token using this method</code> whenever <code>OAuthClient</code>
 <code>name</code>, <code>secret</code> or <code>redirectURIs</code> is incorrect. Make sure you copy-pasted them into Keycloak OpenShift 4 Identity Provider page correctly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please refer to <a href="https://docs.okd.io/latest/authentication/configuring-oauth-clients.html#oauth-register-additional-client_configuring-oauth-clients">official OpenShift documentation</a> for more detailed guides.</p>
</div>
</div>
<div class="sect3">
<h4 id="paypal"><a class="anchor" href="#paypal"></a>PayPal</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/paypal.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/paypal.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with PayPal.  First, go to the <code>Identity Providers</code> left menu item
and select <code>PayPal</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/paypal-add-identity-provider.png" alt="paypal add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from PayPal.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to PayPal when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with PayPal you first have to register an application project in
<a href="https://developer.paypal.com/developer/applications">PayPal Developer applications</a>.</p>
</div>
<div class="paragraph">
<div class="title">Add a New App</div>
<p><span class="image"><img src="./images/paypal-developer-applications.png" alt="paypal developer applications"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Create App</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Register App</div>
<p><span class="image"><img src="./images/paypal-register-app.png" alt="paypal register app"></span></p>
</div>
<div class="paragraph">
<p>You will now be brought to the app settings page.</p>
</div>
<div class="ulist">
<div class="title">Do the following changes</div>
<ul>
<li>
<p>Choose to configure either Sandbox or Live (choose Live if you haven&#8217;t enabled the <code>Target Sandbox</code> switch on the <code>Add identity provider</code> page)</p>
</li>
<li>
<p>Copy Client ID and Secret so you can paste them into the Keycloak <code>Add identity provider</code> page.</p>
</li>
<li>
<p>Scroll down to <code>App Settings</code></p>
</li>
<li>
<p>Copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and enter it into the <code>Return URL</code> field.</p>
</li>
<li>
<p>Check the <code>Log In with PayPal</code> checkbox.</p>
</li>
<li>
<p>Check the <code>Full name</code> checkbox under the personal information section.</p>
</li>
<li>
<p>Check the <code>Email address</code> checkbox under the address information section.</p>
</li>
<li>
<p>Add both a privacy and a user agreement URL pointing to the respective pages on your domain.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="stack-overflow"><a class="anchor" href="#stack-overflow"></a>Stack Overflow</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/stack-overflow.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/stack-overflow.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with Stack Overflow.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Stack Overflow</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/stack-overflow-add-identity-provider.png" alt="stack overflow add identity provider"></span></p>
</div>
<div class="paragraph">
<p>To enable login with Stack Overflow you first have to register an OAuth application on <a href="https://stackapps.com/">StackApps</a>.
Go to <a href="https://stackapps.com/apps/oauth/register">registering your application on Stack Apps</a> URL and login.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Stack Overflow often changes the look and feel of application registration, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Register Application</div>
<p><span class="image"><img src="./images/stack-overflow-app-register.png" alt="stack overflow app register"></span></p>
</div>
<div class="paragraph">
<p>Enter in the application name and the OAuth Domain Name of your application and click <code>Register your Application</code>.  Type in anything you want
for the other items.</p>
</div>
<div class="paragraph">
<div class="title">Settings</div>
<p><span class="image"><img src="./images/stack-overflow-app-settings.png" alt="stack overflow app settings"></span></p>
</div>
<div class="paragraph">
<p>Finally, you will need to obtain the client ID, secret, and key from this page so you can enter them back on the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
</div>
<div class="sect3">
<h4 id="twitter"><a class="anchor" href="#twitter"></a>Twitter</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/twitter.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/twitter.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with Twitter.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Twitter</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/twitter-add-identity-provider.png" alt="twitter add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Twitter.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Twitter when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Twtter you first have to create an application in the <a href="https://developer.twitter.com/apps/">Twitter Application Management</a>.</p>
</div>
<div class="paragraph">
<div class="title">Register Application</div>
<p><span class="image"><img src="./images/twitter-app-register.png" alt="twitter app register"></span></p>
</div>
<div class="paragraph">
<p>Click on the <code>Create New App</code> button.  This will bring you to the <code>Create an Application</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Register Application</div>
<p><span class="image"><img src="./images/twitter-app-create.png" alt="twitter app create"></span></p>
</div>
<div class="paragraph">
<p>Enter in a Name and Description.  The Website can be anything, but cannot have a <code>localhost</code> address.  For the
<code>Callback URL</code> you must copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
You cannot use <code>localhost</code> in the <code>Callback URL</code>.  Instead replace it with <code>127.0.0.1</code> if you are trying to test drive Twitter login on your laptop.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After clicking save you will be brought to the <code>Details</code> page.</p>
</div>
<div class="paragraph">
<div class="title">App Details</div>
<p><span class="image"><img src="./images/twitter-details.png" alt="twitter details"></span></p>
</div>
<div class="paragraph">
<p>Next go to the <code>Keys and Access Tokens</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Keys and Access Tokens</div>
<p><span class="image"><img src="./images/twitter-keys.png" alt="twitter keys"></span></p>
</div>
<div class="paragraph">
<p>Finally, you will need to obtain the API Key and secret from this page and copy them back into the <code>Client ID</code> and <code>Client Secret</code> fields on the Keycloak <code>Add identity provider</code> page.</p>
</div>
</div>
<div class="sect3">
<h4 id="instagram"><a class="anchor" href="#instagram"></a>Instagram</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/social/instagram.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/social/instagram.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to enable login with Instagram.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Instagram</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/instagram-add-identity-provider.png" alt="instagram add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Instagram.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Instagram when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Instagram you first have to create a project and a client. Instagram API is managed through the <a href="https://developers.facebook.com/">Facebook Developer Console</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Facebook often changes the look and feel of the Facebook Developer Console, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once you&#8217;ve logged into the console there is a menu in the top right corner of the screen that says <code>My Apps</code>.  Select the <code>Add a New App</code>
menu item.</p>
</div>
<div class="paragraph">
<div class="title">Add a New App</div>
<p><span class="image"><img src="./images/instagram-add-new-app.png" alt="instagram add new app"></span></p>
</div>
<div class="paragraph">
<p>Select <code>For Everything Else</code>.</p>
</div>
<div class="paragraph">
<div class="title">Create a New App ID</div>
<p><span class="image"><img src="./images/instagram-create-app-id.png" alt="instagram create app id"></span></p>
</div>
<div class="paragraph">
<p>Fill all required fields. Once you&#8217;re done with that, you will be brought to the dashboard
for the application. In the menu in the left navigation panel select <code>Basic</code> under <code>Settings</code>.</p>
</div>
<div class="paragraph">
<div class="title">Add Platform</div>
<p><span class="image"><img src="./images/instagram-add-platform.png" alt="instagram add platform"></span></p>
</div>
<div class="paragraph">
<p>Select <code>+ Add Platform</code> at the bottom and then click <code>[Website]</code> with the globe icon. Specify URL of your site.</p>
</div>
<div class="paragraph">
<div class="title">Add a Product</div>
<p><span class="image"><img src="./images/instagram-add-product.png" alt="instagram add product"></span></p>
</div>
<div class="paragraph">
<p>Select <code>Dashboard</code> from the left menu and click <code>Set Up</code> in the Instagram box. In the left menu then select <code>Basic Display</code> under <code>Instagram</code>
and click <code>Create New App</code>.</p>
</div>
<div class="paragraph">
<div class="title">Create a New Instagram App ID</div>
<p><span class="image"><img src="./images/instagram-create-instagram-app-id.png" alt="instagram create instagram app id"></span></p>
</div>
<div class="paragraph">
<p>Specify <code>Display Name</code>.</p>
</div>
<div class="paragraph">
<div class="title">Setup the App</div>
<p><span class="image"><img src="./images/instagram-app-settings.png" alt="instagram app settings"></span></p>
</div>
<div class="paragraph">
<p>Copy and paste the <code>Redirect URI</code> from the Keycloak <code>Add identity provider</code> page into the <code>Valid OAuth Redirect URIs</code> of the Instagram <code>Client OAuth Settings</code> settings block.</p>
</div>
<div class="paragraph">
<p>You can use this URL also for <code>Deauthorize Callback URL</code> and <code>Data Deletion Request URL</code>. Keycloak currently doesn&#8217;t support either of them,
but the Facebook Developer Console requires both of them to be filled.</p>
</div>
<div class="paragraph">
<p>You will need also to obtain the App ID and App Secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page.
To obtain this click on <code>Show</code> under <code>App Secret</code>. Go back to Keycloak and specify those items and finally save your Instagram Identity Provider.</p>
</div>
<div class="paragraph">
<p>After this it is necessary to make the Instagram app public. Click <code>App Review</code> left menu item and then <code>Requests</code>. After that follow the instructions on screen.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_identity_broker_oidc"><a class="anchor" href="#_identity_broker_oidc"></a>OpenID Connect v1.0 Identity Providers</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/oidc.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/oidc.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak can broker identity providers based on the OpenID Connect protocol.  These IDPs must support the <a href="#_oidc">Authorization Code Flow</a>
as defined by the specification in order to authenticate the user and authorize access.</p>
</div>
<div class="paragraph">
<p>To begin configuring an OIDC provider, go to the <code>Identity Providers</code> left menu item
and select <code>OpenID Connect v1.0</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/oidc-add-identity-provider.png" alt="oidc add identity provider"></span></p>
</div>
<div class="paragraph">
<p>The initial configuration options on this page are described in <a href="#_general-idp-config">General IDP Configuration</a>.
You must define the OpenID Connect configuration options as well.  They basically describe the OIDC IDP you are communicating with.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. OpenID Connect Config</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorization URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorization URL endpoint required by the OIDC protocol.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Token URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Token URL endpoint required by the OIDC protocol.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logout URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logout URL endpoint defined in the OIDC protocol.  This value is optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backchannel Logout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backchannel logout is a background, out-of-band, REST invocation to the IDP to logout the user.  Some IDPs can only perform logout through browser redirects as they may
 only be able to identity sessions via a browser cookie.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Info URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Info URL endpoint defined by the OIDC protocol.  This is an endpoint from which user profile information can be downloaded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Switch to define the Client Authentication method to be used with the Authorization Code Flow.  In the case of JWT signed with private key, the realm private key
 is used.  In the other cases, a client secret has to be defined.
 For more details, see the <a href="https://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication">Client Authentication specifications</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This realm will act as an OIDC client to the external IDP.  Your realm will need an OIDC client ID when using the Authorization Code Flow
 to interact with the external IDP.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This realm will need a client secret to use when using the Authorization Code Flow. The value of this field can refer a value from an external <a href="#_vault-administration">vault</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Issuer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Responses from the IDP may contain an issuer claim.  This config value is optional.  If specified, this claim will be validated against the value you provide.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default Scopes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Space-separated list of OIDC scopes to send with the authentication request.  The default is <code>openid</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prompt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Another optional switch.  This is the prompt parameter defined by the OIDC specification. Through it you can force re-authentication and other options.  See the specification for
 more details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Accepts prompt=none forward from client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies whether the IDP accepts forwarded authentication requests that contain the prompt=none query parameter or not. When a realm receives an auth request with <code>prompt=none</code> it checks
 if the user is currently authenticated and normally returns a <code>login_required</code> error if the user is not logged in. However, when a default IDP can be determined
 for the auth request (either via <code>kc_idp_hint</code> query param or by setting up a default IDP for the realm) we should be able to forward the auth request with
 <code>prompt=none</code> to the default IDP so that it checks if the user is currently authenticated there. Because not all IDPs support requests with <code>prompt=none</code> this switch
 is used to indicate if the default IDP supports the param before redirecting the auth request.
</p><p class="tableblock"> It is important to note that if the user is not authenticated in the IDP, the client will still get a <code>login_required</code> error. Even if the user is currently authenticated in the IDP,
 the client might still get an <code>interaction_required</code> error if authentication or consent pages requiring user interaction would be otherwise displayed. This includes required actions
 (e.g. change password), consent screens and any screens set to be displayed by the <code>first broker login</code> flow or <code>post broker login</code> flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validate Signatures</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Another optional switch. This is to specify if Keycloak will verify the signatures on the external ID Token signed by this identity provider. If this is on,
the Keycloak will need to know the public key of the external OIDC identity provider. See below for how to set it up.
WARNING: For the performance purposes, Keycloak caches the public key of the external OIDC identity provider. If you think that private key of your identity provider
was compromised, it is obviously good to update your keys, but it&#8217;s also good to clear the keys cache. See
<a href="#_clear-cache">Clearing the cache</a> section for more details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use JWKS URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Applicable if <code>Validate Signatures</code> is on. If the switch is on, then identity provider public keys will be downloaded from given JWKS URL.
 This allows great flexibility because new keys will be always re-downloaded when the identity provider generates new keypair. If the switch is off,
 then public key (or certificate) from the Keycloak DB is used, so whenever the identity provider keypair changes, you will always need to import the new key to the Keycloak DB as well.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWKS URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL where the identity provider JWK keys are stored. See the <a href="https://self-issued.info/docs/draft-ietf-jose-json-web-key.html">JWK specification</a> for more details.
 If you use an external Keycloak as an identity provider, then you can use URL like <a href="http://broker-keycloak:8180/auth/realms/test/protocol/openid-connect/certs" class="bare">http://broker-keycloak:8180/auth/realms/test/protocol/openid-connect/certs</a> assuming your brokered
 Keycloak is running on <a href="http://broker-keycloak:8180" class="bare">http://broker-keycloak:8180</a> and it&#8217;s realm is <code>test</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validating Public Key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Applicable if <code>Use JWKS URL</code> is off. Here is the public key in PEM format that must be used to verify external IDP signatures.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validating Public Key Id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Applicable if <code>Use JWKS URL</code> is off. This field specifies ID of the public key in PEM format. This config value is optional. As there is no standard way
 for computing key ID from key, various external identity providers might use different algorithm from Keycloak. If the value of this field
 is not specified, the validating public key specified above is used for all requests regardless of key ID sent by external IDP. When set, value of this
 field serves as key ID used by Keycloak for validating signatures from such providers and must match the key ID specified by the IDP.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can also import all this configuration data by providing a URL or file that points to OpenID Provider Metadata (see OIDC Discovery specification).
If you are connecting to a Keycloak external IDP, you can import the IDP settings from the url <code>&lt;root&gt;/auth/realms/{realm-name}/.well-known/openid-configuration</code>.
This link is a JSON document describing metadata about the IDP.</p>
</div>
</div>
<div class="sect2">
<h3 id="saml-v2-0-identity-providers"><a class="anchor" href="#saml-v2-0-identity-providers"></a>SAML v2.0 Identity Providers</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/saml.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/saml.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak can broker identity providers based on the SAML v2.0 protocol.</p>
</div>
<div class="paragraph">
<p>To begin configuring an SAML v2.0 provider, go to the <code>Identity Providers</code> left menu item
and select <code>SAML v2.0</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/saml-add-identity-provider.png" alt="saml add identity provider"></span></p>
</div>
<div class="paragraph">
<p>The initial configuration options on this page are described in <a href="#_general-idp-config">General IDP Configuration</a>.
You must define the SAML configuration options as well.  They basically describe the SAML IDP you are communicating with.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. SAML Config</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Provider Entity ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is a required field and specifies the SAML Entity ID that the remote Identity Provider will use to identify requests coming from this Service Provider. By default it is set to the realm base URL <code>&lt;root&gt;/auth/realms/{realm-name}</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single Sign-On Service URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is a required field and specifies the SAML endpoint to start the authentication process.  If your SAML IDP publishes an IDP entity descriptor, the value of
 this field will be specified there.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single Logout Service URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is an optional field that specifies the SAML logout endpoint. If your SAML IDP publishes an IDP entity descriptor, the value of
 this field will be specified there.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backchannel Logout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable if your SAML IDP supports backchannel logout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NameID Policy Format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the URI reference corresponding to a name identifier format. Defaults to <code>urn:oasis:names:tc:SAML:2.0:nameid-format:persistent</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Principal Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies which part of the SAML assertion will be used to identify and track external user identities. Can be either Subject NameID or SAML attribute (either by name or by friendly name).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Principal Attribute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If Principal is set to either "Attribute [Name]" or "Attribute [Friendly Name]", this field will specify the name or the friendly name of the identifying attribute, respectively.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP-POST Binding Response</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this realm responds to any SAML requests sent by the external IDP, which SAML binding should be used?  If set to <code>off</code>, then the Redirect Binding will be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP-POST Binding for AuthnRequest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this realm requests authentication from the external SAML IDP, which SAML binding should be used?  If set to <code>off</code>, then the Redirect Binding will be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Want AuthnRequests Signed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, it will use the realm&#8217;s keypair to sign requests sent to the external SAML IDP.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signature Algorithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>Want AuthnRequests Signed</code> is on, then you can also pick the signature algorithm to use.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAML Signature Key Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signed SAML documents sent via POST binding contain identification of signing key in <code>KeyName</code>
 element. This by default contains Keycloak key ID. However various external SAML IDPs might
 expect a different key name or no key name at all. This switch controls whether <code>KeyName</code>
 contains key ID (option <code>KEY_ID</code>), subject from certificate corresponding to the realm key
 (option <code>CERT_SUBJECT</code> - expected for instance by Microsoft Active Directory Federation
 Services), or that the key name hint is completely omitted from the SAML message (option <code>NONE</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Force Authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that the user will be forced to enter their credentials at the external IDP even if they are already logged in.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validate Signature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not the realm should expect that SAML requests and responses from the external IDP to be digitally signed.  It is highly recommended you turn this on!</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validating X509 Certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The public certificate that will be used to validate the signatures of SAML requests and responses from the external IDP.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sign Service Provider Metadata</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, it will use the realm&#8217;s keypair to sign the <a href="#_identity_broker_saml_sp_descriptor">SAML Service Provider Metadata descriptor</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass subject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not a <code>login_hint</code> query parameter should be forwarded to the IDP. When provided, this login_hint parameter is added to AuthnRequest&#8217;s Subject. This allows destination providers to prefill their login form. When no login_hint is provided, nothing is forwarded as an AuthnRequest Subject.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can also import all this configuration data by providing a URL or file that points to the SAML IDP entity descriptor of the external IDP.
If you are connecting to a Keycloak external IDP, you can import the IDP settings from the URL <code>&lt;root&gt;/auth/realms/{realm-name}/protocol/saml/descriptor</code>.
This link is an XML document describing metadata about the IDP.</p>
</div>
<div class="paragraph">
<p>You can also import all this configuration data by providing a URL or XML file that points to the entity descriptor of the external SAML IDP you want to connect to.</p>
</div>
<div class="sect3">
<h4 id="_identity_broker_saml_requested_authncontext"><a class="anchor" href="#_identity_broker_saml_requested_authncontext"></a>Requesting specific AuthnContexts</h4>
<div class="paragraph">
<p>Some Identity Providers let the clients specify particular constraints on the authentication method used to verify the user identity (such as asking for MFA, Kerberos authentication, security requirements, and so on). These constraints are specified using particular AuthnContext criteria. A client can ask for one or more criteria and also specify how the Identity Provider should match the requested AuthnContext - exactly, or by satisfying same-or-better equivalents.</p>
</div>
<div class="paragraph">
<p>You can list the criteria your Service Provider requires by adding one or more ClassRef or DeclRef in the Requested AuthnContext Constraints section. Usually you need to provide either ClassRefs or DeclRefs; you should check with your Identity Provider documentation which values are supported. If no ClassRefs or DeclRefs are present, the Identity Provider will not enforce additional constraints.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Requested AuthnContext Constraints</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comparison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The comparison method the Identity Provider should use to evaluate the context requirements. Available values are <code>Exact</code>, <code>Minimum</code>, <code>Maximum</code> or <code>Better</code>. Default value is <code>Exact</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AuthnContext ClassRefs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more AuthnContext ClassRefs that describe the required criteria.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AuthnContext DeclRefs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more AuthnContext DeclRefs that describe the required criteria.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_identity_broker_saml_sp_descriptor"><a class="anchor" href="#_identity_broker_saml_sp_descriptor"></a>SP Descriptor</h4>
<div class="paragraph">
<p>If you need to access the provider&#8217;s SAML SP metadata, look for the <code>Endpoints</code> item in the identity provider configuration settings. It contains a link called
<code>SAML 2.0 Service Provider Metadata</code> that generates the SAML entity descriptor for the Service Provider. You can either download it or copy its URL and then import it in the remote Identity Provider.</p>
</div>
<div class="paragraph">
<p>This metadata is also available publicly by going to the URL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http[s]://{host:port}/auth/realms/{realm-name}/broker/{broker-alias}/endpoint/descriptor</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure to save any configuration changes before accessing the descriptor or they will not be reflected in the metadata.</p>
</div>
</div>
<div class="sect3">
<h4 id="_identity_broker_saml_login_hint"><a class="anchor" href="#_identity_broker_saml_login_hint"></a>Send Subject in SAML requests</h4>
<div class="paragraph">
<p>By default, a social button pointing to a SAML Identity Provider redirects the user to a login URL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http[s]://{host:port}/auth/realms/${realm-name}/broker/{broker-alias}/login</code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding a query parameter named <code>login_hint</code> to this URL will add its value to SAML request as a Subject attribute. When this query parameter is absent or left empty, no subject will be added to the request.</p>
</div>
<div class="paragraph">
<p>"Pass subject" option must be enabled.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_client_suggested_idp"><a class="anchor" href="#_client_suggested_idp"></a>Client-suggested Identity Provider</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/suggested.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/suggested.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>OIDC applications can bypass the Keycloak login page by specifying a hint on which
identity provider they want to use.</p>
</div>
<div class="paragraph">
<p>This is done by setting the <code>kc_idp_hint</code> query parameter in the Authorization Code Flow authorization endpoint.</p>
</div>
<div class="paragraph">
<p>Keycloak OIDC client adapters also allow you to specify this query parameter when you access a secured resource
at the application.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>GET /myapplication.com?kc_idp_hint=facebook HTTP/1.1
Host: localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, it is expected that your realm has an identity provider with an alias <code>facebook</code>. If this provider doesn&#8217;t exist the login form will be displayed.</p>
</div>
<div class="paragraph">
<p>If you are using <code>keycloak.js</code> adapter, you can also achieve the same behavior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> keycloak = <span class="keyword">new</span> Keycloak(<span class="string"><span class="delimiter">'</span><span class="content">keycloak.json</span><span class="delimiter">'</span></span>);

keycloak.createLoginUrl({
        <span class="key">idpHint</span>: <span class="string"><span class="delimiter">'</span><span class="content">facebook</span><span class="delimiter">'</span></span>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>kc_idp_hint</code> query parameter also allows the client to override the default identity provider if one is configured for the <code>Identity Provider Redirector</code> authenticator. The client can also disable the automatic redirecting by setting the <code>kc_idp_hint</code> query parameter to an empty value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mappers"><a class="anchor" href="#_mappers"></a>Mapping Claims and Assertions</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/mappers.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/mappers.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You can import the SAML and OpenID Connect metadata provided by the external IDP you are authenticating with into the environment
of the realm.  This allows you to extract user profile metadata and other information so that you can make it available to your
applications.</p>
</div>
<div class="paragraph">
<p>Each new user that logs into your realm via an external identity provider will have an entry for them created in the local
Keycloak database, based on the metadata from the SAML or OIDC assertions and claims.</p>
</div>
<div class="paragraph">
<p>If you click on an identity provider listed in the <code>Identity Providers</code> page for your realm, you will be brought to the IDPs
<code>Settings</code> tab.  On this page there is also a <code>Mappers</code> tab.  Click on that tab to start mapping your incoming IDP metadata.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/identity-provider-mappers.png" alt="identity provider mappers"></span></p>
</div>
<div class="paragraph">
<p>There is a <code>Create</code> button on this page.
Clicking on this create button allows you to create a broker mapper.
Broker mappers can import SAML attributes or OIDC ID/Access token claims into user attributes and user role mappings.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/identity-provider-mapper.png" alt="identity provider mapper"></span></p>
</div>
<div class="paragraph">
<p>Select a mapper from the <code>Mapper Type</code> list.  Hover over the tooltip to see a description of what the mapper does.  The
tooltips also describe what configuration information you need to enter. Click <code>Save</code> and your new mapper will be added.</p>
</div>
<div class="paragraph">
<p>The mapper will update user information when the user logs in repeatedly according to the <code>Sync Mode Override</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Choose <code>legacy</code> to use the behavior in the previous Keycloak version.</p>
</li>
<li>
<p>Choose <code>import</code> to import only data from when the user was first created in Keycloak during the first login to Keycloak with a particular identity provider.</p>
</li>
<li>
<p>Choose <code>force</code> to update user data at each user login.</p>
</li>
<li>
<p>Choose <code>inherit</code> to use the sync mode configured in the identity provider, all other options will override this sync mode.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For JSON based claims, you can use dot notation for nesting and square brackets to access array fields by index.
For example 'contact.address[0].country'.</p>
</div>
<div class="paragraph">
<p>To investigate the structure of user profile JSON data provided by social providers you can enable the <code>DEBUG</code> level logger <code>org.keycloak.social.user_profile_dump</code>.
This is done in the server&#8217;s app-server configuration file (domain.xml or standalone.xml).</p>
</div>
</div>
<div class="sect2">
<h3 id="available-user-session-data"><a class="anchor" href="#available-user-session-data"></a>Available User Session Data</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/session-data.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/session-data.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>After a user logs in from the external IDP, there is some additional user session note data that Keycloak stores that you can access.
This data can be propagated to the client requesting a login via the token or SAML assertion being passed back to it by using an appropriate client mapper.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">identity_provider</dt>
<dd>
<p>This is the IDP alias of the broker used to perform the login.</p>
</dd>
<dt class="hdlist1">identity_provider_identity</dt>
<dd>
<p>This is the IDP username of the currently authenticated user. This is often the same as the Keycloak username, but doesn&#8217;t necessarily needs to be.
For example Keycloak user <code>john</code> can be linked to the Facebook user <code>john123@gmail.com</code>, so in that case value of user session note will be <code>john123@gmail.com</code> .</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can use a <a href="#_protocol-mappers">Protocol Mapper</a> of type <code>User Session Note</code> to propagate this information to your clients.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identity_broker_first_login"><a class="anchor" href="#_identity_broker_first_login"></a>First Login Flow</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/first-login-flow.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/first-login-flow.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When a user logs in through identity brokering some aspects of the user are imported and linked within the realm&#8217;s local database.
When Keycloak successfully authenticates users through an external identity provider
there can be two situations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There is already a Keycloak user account imported and linked with the authenticated identity provider account.
In this case, Keycloak will just authenticate as the existing user and redirect back to application.</p>
</li>
<li>
<p>There is not yet an existing Keycloak user account imported and linked for this external user.
Usually you just want to register and import the new account into Keycloak database, but what if there is an existing
Keycloak account with the same email? Automatically linking the existing local account to the external
identity provider is a potential security hole as you can&#8217;t always trust the information you get from the external identity provider.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Different organizations have different requirements when dealing with some of the conflicts and situations listed above.
For this, there is a <code>First Login Flow</code> option in the IDP settings which allows you to choose a <a href="#_authentication-flows">workflow</a> that will be
used after a user logs in from an external IDP the first time.
By default it points to <code>first broker login</code> flow, but you can configure and use your own flow and use different flows for different identity providers.</p>
</div>
<div class="paragraph">
<p>The flow itself is configured in admin console under <code>Authentication</code> tab.
When you choose <code>First Broker Login</code> flow, you will see what authenticators are used by default.
You can re-configure the existing flow. (For example you can disable some authenticators, mark some of them as <code>required</code>, configure some authenticators, etc).</p>
</div>
<div class="paragraph">
<p>You can also create a new authentication flow and/or write your own Authenticator implementations and use it in your flow.
See <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for more details.</p>
</div>
<div class="sect3">
<h4 id="default-first-login-flow"><a class="anchor" href="#default-first-login-flow"></a>Default First Login Flow</h4>
<div class="paragraph">
<p>Let&#8217;s describe the default behavior provided by <code>First Broker Login</code> flow.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Review Profile</dt>
<dd>
<p>This authenticator might display the profile info page, where the user can review their profile retrieved from an identity provider.
The authenticator is configurable.
You can set the <code>Update Profile On First Login</code> option.
When <code>On</code>, users will be always presented with the profile page asking for additional information in order to federate their identities.
When <code>missing</code>, users will be presented with the profile page only if some mandatory information (email, first name, last name) is not provided by the identity provider.
If <code>Off</code>, the profile page won&#8217;t be displayed, unless user clicks in later phase on <code>Review profile info</code> link (page displayed in later phase
by <code>Confirm Link Existing Account</code> authenticator).</p>
</dd>
<dt class="hdlist1">Create User If Unique</dt>
<dd>
<p>This authenticator checks if there is already an existing Keycloak account with the same email or username like the account from the identity provider.
If it&#8217;s not, then the authenticator just creates a new local Keycloak account and links it with the identity provider and the whole flow is finished.
Otherwise it goes to the next <code>Handle Existing Account</code> subflow.
If you always want to ensure that there is no duplicated account, you can mark this authenticator as <code>REQUIRED</code>. In this case, the user
will see the error page if there is an existing Keycloak account and the user will need to link his identity provider account through Account management.</p>
</dd>
<dt class="hdlist1">Confirm Link Existing Account</dt>
<dd>
<p>On the info page, the user will see that there is an existing Keycloak account with the same email.
They can review their profile again and use different email or username (flow is restarted and goes back to <code>Review Profile</code> authenticator).
Or they can confirm that they want to link their identity provider account with their existing Keycloak account.
Disable this authenticator if you don&#8217;t want users to see this confirmation page, but go straight to linking identity provider account by email verification or re-authentication.</p>
</dd>
<dt class="hdlist1">Verify Existing Account By Email</dt>
<dd>
<p>This authenticator is <code>ALTERNATIVE</code> by default, so it&#8217;s used only if the realm has SMTP setup configured.
It will send email to the user, where they can confirm that they want to link the identity provider with their Keycloak account.
Disable this if you don&#8217;t want to confirm linking by email, but instead you always want users to reauthenticate with their password (and alternatively OTP).</p>
</dd>
<dt class="hdlist1">Verify Existing Account By Re-authentication</dt>
<dd>
<p>This authenticator is used if email authenticator is disabled or not available (SMTP not configured for realm). It will display a login screen
where the user needs to authenticate to link their Keycloak account with the Identity provider.
User can also re-authenticate with some different identity provider, which is already linked to their Keycloak account.
You can also force users to use OTP. Otherwise it&#8217;s optional and used only if OTP is already set for the user account.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="automatically-link-existing-first-login-flow"><a class="anchor" href="#automatically-link-existing-first-login-flow"></a>Automatically Link Existing First Login Flow</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The AutoLink authenticator would be dangerous in a generic environment where users can register themselves using arbitrary usernames/email addresses. Do not use this authenticator unless registration of users is carefully curated and usernames/email addresses are assigned, not requested.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to configure a first login flow in which users are automatically linked without being prompted, create a new flow with the following two authenticators:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Create User If Unique</dt>
<dd>
<p>This authenticator ensures that unique users are handled. Set the authenticator requirement to "Alternative".</p>
</dd>
<dt class="hdlist1">Automatically Set Existing User</dt>
<dd>
<p>Automatically sets an existing user to the authentication context without any verification. Set the authenticator requirement to "Alternative".</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The described setup uses two authenticators. This setup is the simplest one, but it is possible to use other
authenticators according to your needs. For example, you can add the Review Profile authenticator to the beginning of the flow if you still want
end users to confirm their profile information. You can also add authentication mechanisms to this flow, forcing a user to verify his credentials. This
would require a more complex flow, for example setting the "Automatically Set Existing User" and "Password Form" as "Required" in an "Alternative" sub-flow.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_disabling_automatic_user_creation"><a class="anchor" href="#_disabling_automatic_user_creation"></a>Disabling Automatic User Creation</h4>
<div class="paragraph">
<p>The Default first login flow will look up a Keycloak account matching the external identity, and will then offer to link them; if there is no matching Keycloak account, it will automatically create one.
This default behavior may be unsuitable for some setups, for example, when using read-only LDAP user store (which means all users are pre-created).
In this case, automatic user creation should be turned off. To disable user creation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>open the <code>First Broker Login</code> flow configuration;</p>
</li>
<li>
<p>set <code>Create User If Unique</code> to <code>DISABLED</code>;</p>
</li>
<li>
<p>set <code>Confirm Link Existing Account</code> to <code>DISABLED</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This configuration also implies that Keycloak itself won&#8217;t be able to determine which internal account would correspond to the external identity.
Therefore, the <code>Verify Existing Account By Re-authentication</code> authenticator will ask the user to provide both username and password.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="retrieving-external-idp-tokens"><a class="anchor" href="#retrieving-external-idp-tokens"></a>Retrieving External IDP Tokens</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/tokens.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/tokens.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak allows you to store tokens and responses from the authentication process with the external IDP.
For that, you can use the <code>Store Token</code> configuration option on the IDP&#8217;s settings page.</p>
</div>
<div class="paragraph">
<p>Application code can retrieve these tokens and responses to pull in extra user information, or to securely invoke requests on the external IDP.
For example, an application might want to use the Google token to invoke on other Google services and REST APIs.
To retrieve a token for a particular identity provider you need to send a request as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>GET /auth/realms/{realm}/broker/{provider_alias}/token HTTP/1.1
Host: localhost:8080
Authorization: Bearer &lt;KEYCLOAK ACCESS TOKEN&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An application must have authenticated with Keycloak and have received an access token.  This access token
will need to have the <code>broker</code> client-level role <code>read-token</code> set.  This means that the user must have a role mapping for this role
and the client application must have that role within its scope.
In this case, given that you are accessing a protected service in Keycloak, you need to send the access token issued by Keycloak during the user authentication.
In the broker configuration page you can automatically assign this role to newly imported users by turning on the <code>Stored Tokens Readable</code> switch.</p>
</div>
<div class="paragraph">
<p>These external tokens can be re-established by either logging in again through the provider, or using the client-initiated account linking API.</p>
</div>
</div>
<div class="sect2">
<h3 id="identity-broker-logout"><a class="anchor" href="#identity-broker-logout"></a>Identity broker logout</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/identity-broker/logout.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/identity-broker/logout.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When logout from Keycloak is triggered, Keycloak will send a request to the external identity provider
that was used to login to Keycloak, and the user will be logged out from this identity provider as well.
It is possible to skip this behavior and avoid logout at the external identity provider.
See <a href="https://www.keycloak.org/docs/12.0/securing_apps/#_java_adapter_logout">adapter logout documentation</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user-session-management"><a class="anchor" href="#user-session-management"></a>User Session Management</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sessions.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sessions.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>When a user logs into a realm, Keycloak maintains a user session for them and remembers each and every client they
have visited within the session.  There are a lot of administrative
functions that realm admins can perform on these user sessions.  They can view login stats for the entire realm and dive down
into each client to see who is logged in and where.  Admins can logout a user or a set of users from the Admin Console. They
can revoke tokens and set up all the token and session timeouts there too.</p>
</div>
<div class="sect2">
<h3 id="administering-sessions"><a class="anchor" href="#administering-sessions"></a>Administering Sessions</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sessions/administering.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sessions/administering.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If you go to the <code>Sessions</code> left menu item you can see a top level view of the number of sessions that are currently active in the realm.</p>
</div>
<div class="paragraph">
<div class="title">Sessions</div>
<p><span class="image"><img src="./keycloak-images/sessions.png" alt="sessions"></span></p>
</div>
<div class="paragraph">
<p>A list of clients is given and how many active sessions there currently are for that client. You can also log out all
users in the realm by clicking the <code>Logout all</code> button on the right side of this list.</p>
</div>
<div class="sect3">
<h4 id="limitations-of-the-code-logout-all-code-operation"><a class="anchor" href="#limitations-of-the-code-logout-all-code-operation"></a>Limitations of the <code>Logout all</code> Operation</h4>
<div class="paragraph">
<p>Any SSO cookies set will now be invalid and clients that request authentication in active browser sessions will now have to
re-login.  Only certain clients are notified of this logout event, specifically clients that are using the Keycloak
OIDC client adapter. Other client types, such as SAML, will not receive a backchannel logout request.</p>
</div>
<div class="paragraph">
<p>It is important to note that any outstanding access tokens are not revoked by clicking <code>Logout all</code>.  They have to
expire naturally.  You have to push a <a href="#_revocation-policy">revocation policy</a> out to
clients, but that also only works with clients using the Keycloak OIDC client adapter.</p>
</div>
</div>
<div class="sect3">
<h4 id="application-drilldown"><a class="anchor" href="#application-drilldown"></a>Application Drilldown</h4>
<div class="paragraph">
<p>On the <code>Sessions</code> page, you can also drill down to each client. This will bring you to the <code>Sessions</code> tab of that client.
Clicking on the <code>Show Sessions</code> button there allows you to see which users are logged into that application.</p>
</div>
<div class="paragraph">
<div class="title">Application Sessions</div>
<p><span class="image"><img src="./keycloak-images/application-sessions.png" alt="application sessions"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="user-drilldown"><a class="anchor" href="#user-drilldown"></a>User Drilldown</h4>
<div class="paragraph">
<p>If you go to the <code>Sessions</code> tab of an individual user, you can also view the session information.</p>
</div>
<div class="paragraph">
<div class="title">User Sessions</div>
<p><span class="image"><img src="./keycloak-images/user-sessions.png" alt="user sessions"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_revocation-policy"><a class="anchor" href="#_revocation-policy"></a>Revocation Policies</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sessions/revocation.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sessions/revocation.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If your system is compromised you will want a way to revoke all sessions and access tokens that have been handed out.
You can do this by going to the <code>Revocation</code> tab of the <code>Sessions</code> screen.</p>
</div>
<div class="paragraph">
<div class="title">Revocation</div>
<p><span class="image"><img src="./keycloak-images/revocation.png" alt="revocation"></span></p>
</div>
<div class="paragraph">
<p>You can only set a time-based revocation policy.  The console allows you to specify a time and date where any session
or token issued before that time and date is invalid.  The <code>Set to now</code> will set the policy to the current time and date.
The <code>Push</code> button will push this revocation policy to any registered OIDC client that has the Keycloak
OIDC client adapter installed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_timeouts"><a class="anchor" href="#_timeouts"></a>Session and Token Timeouts</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sessions/timeouts.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sessions/timeouts.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak gives you fine grain control of session, cookie, and token timeouts.  This is all done on the
<code>Tokens</code> tab in the <code>Realm Settings</code> left menu item.</p>
</div>
<div class="paragraph">
<div class="title">Tokens Tab</div>
<p><span class="image"><img src="./keycloak-images/tokens-tab.png" alt="tokens tab"></span></p>
</div>
<div class="paragraph">
<p>Let&#8217;s walk through each of the items on this page.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default Signature Algorithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default algorithm that is used to assign tokens for this realm.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revoke Refresh Token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For OIDC clients that are doing the refresh token flow, this flag, if on, will revoke that refresh token and issue another token with the request that the client has to use. The result is that each refresh token is used only once.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSO Session Idle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Also pertains to OIDC clients.  If the user is not active for longer than this timeout, the user session will be invalidated.  The idle timeout is reset by a client requesting authentication or by a refresh token request.
There is a small window of time that is always added to the idle timeout before the session  invalidation takes effect. See the note below.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSO Session Max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time before a user session is expired and invalidated. This option controls the maximum time that a user session can remain active, regardless of user activity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSO Session Idle Remember Me</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as the standard SSO Session Idle configuration but specific to logins with Remember Me enabled. It allows for the specification of longer
 session idle timeouts when Remember Me is selected during the login process. It is an optional configuration and if not set to a value
greater than 0 it uses the same idle timeout as set in the SSO Session Idle configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSO Session Max Remember Me</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as the standard SSO Session Max but specific to logins with Remember Me enabled. It allows for the specification of longer lived
 sessions when Remember Me is selected during the login process. It is an optional configuration and if not set to a value greater than 0
 it uses the same session lifespan as set in the SSO Session Max configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offline Session Idle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For <a href="#_offline-access">offline access</a>, this is the time the session is allowed to remain idle before the offline token is revoked.
There is a small window of time that is always added to the idle timeout before the session  invalidation takes effect. See the note below.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offline Session Max Limited</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For <a href="#_offline-access">offline access</a>, if this flag is on, Offline Session Max is enabled to control the maximum time the offline token can remain active, regardless of user activity. Also Client Offline Session Idle and Client Offline Session Max are enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offline Session Max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For <a href="#_offline-access">offline access</a>, this is the maximum time before the corresponding offline token is revoked.  This option controls the maximum time the offline token can remain active, regardless of user activity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Offline Session Idle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For <a href="#_offline-access">offline access</a>, if the user is not active for longer than this timeout, offline token requests will bump the idle timeout. It allows for the specification of a shorter idle timeout of offline token than offline session idle timeout. However, it can be overridden on individual clients. It is an optional configuration and if not set to a value bigger than 0, it uses the same idle timeout set in the Offline Session Idle configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Offline Session Max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For <a href="#_offline-access">offline access</a>, the maximum time before a offline token is expired and invalidated. It allows for the specification of a shorter timeout of offline token than offline session timeout. However, it can be overridden on individual clients. It is an optional configuration and if not set to a value bigger than 0, it uses the same idle timeout set in the Offline Session Max configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Session Idle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the user is not active for longer than this timeout, refresh token requests will bump the idle timeout. It allows for the specification of a shorter idle timeout of refresh token than session idle timeout. And it can be overridden on individual clients. It is an optional configuration and if not set to a value bigger than 0 it uses the same idle timeout set in the SSO Session Idle configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Session Max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum time before a refresh token is expired and invalidated. It allows for the specification of a shorter timeout of refresh token than session timeout. And it can be overridden on individual clients. It is an optional configuration and if not set to a value bigger than 0 it uses the same idle timeout set in the SSO Session Max configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Token Lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When an OIDC access token is created, this value affects the expiration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Token Lifespan For Implicit Flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">With the Implicit Flow no refresh token is provided. For this reason there&#8217;s a separate timeout for access tokens created with the Implicit Flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client login timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the maximum time that a client has to finish the Authorization Code Flow in OIDC.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total time a login must take.  If authentication takes longer than this time then the user will have to start the authentication process over.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login action timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time a user can spend on any one page in the authentication process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User-Initiated Action Lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time before an action permit sent by a user (e.g. forgot password e-mail) is expired. This value is recommended to be short because it is expected that the user would react to self-created action quickly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default Admin-Initiated Action Lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time before an action permit sent to a user by an admin is expired. This value is recommended to be long to allow admins send e-mails for users that are currently offline. The default timeout can be overridden right before issuing the token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Override User-Initiated Action Lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permits the possibility of having independent timeouts per operation (for example, e-mail verification, forgot password, user actions and Identity Provider E-mail Verification). This field is optional. If nothing is specified, it defaults to the value configured at <em>User-Initiated Action Lifespan</em>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For idle timeouts, there is a small window of time (2 minutes) during which the session is kept unexpired. For example, when you have
timeout set to 30 minutes, it will be actually 32 minutes before the session is expired. This is needed for some corner-case scenarios in
cluster and cross-datacenter environments, in cases where the token was refreshed on one cluster node for a very short time before the
expiration and the other cluster nodes would in the meantime incorrectly consider the session as expired, because they had not yet received
the message about successful refresh from the node which did the refresh.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_offline-access"><a class="anchor" href="#_offline-access"></a>Offline Access</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sessions/offline.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sessions/offline.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Offline access is a feature described in <a href="https://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess">OpenID Connect specification</a> .
The idea is that during login, your client application will request an Offline token instead of a classic Refresh token.
The application can save this offline token in a database or on disk and can use it later even if user is logged out.
This is useful if your application needs to do some "offline" actions on behalf of user even when the user is not online.
An example is a periodic backup of some data every night.</p>
</div>
<div class="paragraph">
<p>Your application is responsible for persisting the offline token in some storage (usually a database) and then using it to retrieve new access token from Keycloak server.</p>
</div>
<div class="paragraph">
<p>The difference between a classic Refresh token and an Offline token is, that an offline token will never expire by default and is not subject of the <code>SSO Session Idle timeout</code> and <code>SSO Session Max lifespan</code>.
The offline token is valid even after a user logout or server restart.
However by default you do need to use the offline token for a refresh token action at least once per 30 days (this value, <code>Offline Session Idle timeout</code>, can be changed in the administration console in the <code>Tokens</code> tab under <code>Realm Settings</code>).
Moreover, if you enable the option <code>Offline Session Max Limited</code>, then the offline token expires after 60 days regardless of using the offline token for a refresh token action (this value, <code>Offline Session Max</code>, can also be changed in the administration console in the Tokens tab under Realm Settings).
Also if you enable the option <code>Revoke refresh tokens</code>, then each offline token can be used just once. So after refresh, you always need to store the new offline token from refresh response into your DB instead of the previous one.</p>
</div>
<div class="paragraph">
<p>Users can view and revoke offline tokens that have been granted by them in the <a href="#_account-service">User Account Service</a>.
The admin user can revoke offline tokens for individual users in admin console in the <code>Consents</code> tab of a particular user.
The admin can also view all the offline tokens issued in the <code>Offline Access</code> tab of each client.
Offline tokens can also be revoked by setting a <a href="#_revocation-policy">revocation policy</a>.</p>
</div>
<div class="paragraph">
<p>To be able to issue an offline token, users need to have the role mapping for the realm-level role <code>offline_access</code>.
Clients also need to have that role in their scope. Finally, the client needs to have an <code>offline_access</code> client scope added as an <code>Optional
client scope</code> to it, which is done by default.</p>
</div>
<div class="paragraph">
<p>The client can request an offline token by adding the parameter <code>scope=offline_access</code> when sending authorization request to Keycloak.
The Keycloak OIDC client adapter automatically adds this parameter when you use it to access secured URL of your application (i.e.
http://localhost:8080/customer-portal/secured?scope=offline_access). The Direct Access Grant and Service Accounts also
support offline tokens if you include <code>scope=offline_access</code> in the body of the authentication request.</p>
</div>
</div>
<div class="sect2">
<h3 id="_transient-session"><a class="anchor" href="#_transient-session"></a>Transient sessions</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/sessions/transient.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/sessions/transient.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak has concept of transient sessions. When transient sessions are used, there is no real user session created after successful authentication.
Only a temporary transient session is created for the scope of the current request that successfully authenticated the user. This transient session allows Keycloak
to run <a href="#_protocol-mappers">protocol mappers</a> after the authentication.</p>
</div>
<div class="paragraph">
<p>When transient sessions are used, the client application has no way to refresh or introspect the token or check if a specific session is valid.
In some situations, these actions are not needed, so you can avoid the additional overhead for persistence of user sessions.
This would mean the save of performance, memory and network communication (in case of cluster and cross-datacenter environments).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user-storage-federation"><a class="anchor" href="#_user-storage-federation"></a>User Storage Federation</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/user-federation.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/user-federation.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Many companies have existing user databases that hold information about users and their passwords or other credentials.
In many cases, it is just not possible to migrate off of those existing stores to a pure Keycloak deployment.
Keycloak can federate existing external user databases.
By default, we support LDAP and Active Directory, but you can also code your own extension for any custom
user database using our User Storage SPI.</p>
</div>
<div class="paragraph">
<p>The way it works is that when a user logs in, Keycloak will look into its own internal user store to find the user.
If it cannot find it there, it will iterate
over every User Storage provider you have configured for the realm until it finds a match.  Data from the external store is mapped into a common user model that is consumed by the Keycloak
runtime.  This common user model can then be mapped to OIDC token claims and SAML assertion attributes.</p>
</div>
<div class="paragraph">
<p>External user databases rarely have every piece of data needed to support all the features that Keycloak has.
Therefore, the User Storage Provider can opt to store some things locally in the Keycloak user store.
Some providers even import the user locally and sync periodically with the external store. This approach depends on the capabilities of the provider and how it is configured.  For example, your
external user store may not support OTP.  Depending on the provider, this OTP can be handled and stored by Keycloak.</p>
</div>
<div class="sect2">
<h3 id="adding-a-provider"><a class="anchor" href="#adding-a-provider"></a>Adding a Provider</h3>
<div class="paragraph">
<p>To add a storage provider go to the <code>User Federation</code> left menu item in the Admin Console.</p>
</div>
<div class="paragraph">
<div class="title">User Federation</div>
<p><span class="image"><img src="./keycloak-images/user-federation.png" alt="user federation"></span></p>
</div>
<div class="paragraph">
<p>On the center, there is an <code>Add Provider</code> list box.  Choose the provider type you want to add and you will be brought to the configuration page of that provider.</p>
</div>
</div>
<div class="sect2">
<h3 id="dealing-with-provider-failures"><a class="anchor" href="#dealing-with-provider-failures"></a>Dealing with Provider Failures</h3>
<div class="paragraph">
<p>If a User Storage Provider fails (for example, your LDAP server is down), you may have trouble logging in and may not be able to view users in the admin console.
Keycloak does not catch failures when using a Storage Provider to lookup a user.  It will abort the invocation.  So, if you have a Storage Provider with a higher
priority that fails during user lookup, the login or user query will fail entirely with an exception and abort.  It will not fail over to the next configured provider.</p>
</div>
<div class="paragraph">
<p>The local Keycloak user database is always searched first to resolve users before any LDAP or custom User Storage Provider.
You may want to consider creating an admin account that is stored in the local Keycloak user database just in case any problems come up in connecting
to your LDAP and custom back ends.</p>
</div>
<div class="paragraph">
<p>Each LDAP and custom User Storage Provider has an <code>enable</code> switch on its admin console page.  Disabling the User Storage Provider will skip the provider when
doing user queries so that you can view and login with users that might be stored in a different provider with lower priority.  If your provider is using an
<code>import</code> strategy and you disable it, imported users are still available for lookup, but only in read only mode.  You will not be able to modify these users until
you re-enable the provider.</p>
</div>
<div class="paragraph">
<p>The reason why Keycloak does not fail over if a Storage Provider lookup fails is that user databases often have duplicate usernames or duplicate emails between them.
This can cause security issues and unforeseen problems as the user may be loaded from one external store when the admin is expecting the user to be loaded from another.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ldap"><a class="anchor" href="#_ldap"></a>LDAP and Active Directory</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/user-federation/ldap.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/user-federation/ldap.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak comes with a built-in LDAP/AD provider.  It is possible to federate multiple different LDAP servers in the same
Keycloak realm.  You can map LDAP user attributes into the Keycloak common user model.
By default, it maps username, email, first name, and last name, but you are free to configure additional <a href="#_ldap_mappers">mappings</a>.
The LDAP provider also supports password validation via LDAP/AD protocols and different storage, edit, and synchronization modes.</p>
</div>
<div class="paragraph">
<p>To configure a federated LDAP store go to the Admin Console.
Click on the <code>User Federation</code> left menu option.
When you get to this page there is an <code>Add Provider</code> select box.
You should see <em>ldap</em> within this list.
Selecting <em>ldap</em> will bring you to the LDAP configuration page.</p>
</div>
<div class="sect3">
<h4 id="storage-mode"><a class="anchor" href="#storage-mode"></a>Storage Mode</h4>
<div class="paragraph">
<p>By default, Keycloak will import users from LDAP into the local Keycloak user database. This copy of the user
is either synchronized on demand, or through a periodic background task.
The single exception to this is the synchronization of passwords. Passwords are never imported. Their validation is always delegated to the LDAP server.
The benefits of this approach is that all Keycloak features will work as any extra per-user data that is needed can be stored locally.
The downside of this approach is that each time that a specific user is queried for the first time, a corresponding Keycloak database insert is performed.
The import may also have to be synchronized with your LDAP server. However, import synchronization is not necessary in
the case that the LDAP mappers are configured to always read particular attributes from the LDAP rather than from the database.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can choose not to import users into the Keycloak user database.  In this case, the common user model
that the  Keycloak runtime uses is backed only by the LDAP server.  This means that if LDAP doesn&#8217;t support
a piece of data that a Keycloak feature needs that feature will not work.
The benefit to this approach is that you do not have the overhead of importing and synchronizing a copy of the LDAP user into the
Keycloak user database.</p>
</div>
<div class="paragraph">
<p>This storage mode is controled by the <code>Import Users</code> switch.  Set to <code>On</code> to import users.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If user import is disabled, you cannot save user profile attributes into the Keycloak database. Also you cannot save
      metadata except for user profile metadata that are mapped to the LDAP. The single exception to this are user profile metadata,
      which are mapped to the LDAP. This possibly includes role mappings, group mappings and other metadata based on the configuration
      of your LDAP mappers.
      When the attempt is made to change some of the non-LDAP mapped user data, the update of the user will not be possible. For example
      you will not be able to disable the LDAP mapped user unless the <code>enabled</code> flag of the user is mapped to some LDAP
      attribute (which is usually not the case).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="edit-mode"><a class="anchor" href="#edit-mode"></a>Edit Mode</h4>
<div class="paragraph">
<p>Users, through the <a href="#_account-service">User Account Service</a>, and admins through the Admin Console
have the ability to modify user metadata.  Depending on your setup you may or may not have LDAP update privileges.  The
<code>Edit Mode</code> configuration option defines the edit policy you have with your LDAP store.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">READONLY</dt>
<dd>
<p>Username, email, first name, last name, and other mapped attributes will be unchangeable.
Keycloak will show an error anytime anybody tries to update these fields.
Also, password updates will not be supported.</p>
</dd>
<dt class="hdlist1">WRITABLE</dt>
<dd>
<p>Username, email, first name, last name, and other mapped attributes and passwords can all be updated and will be synchronized automatically with your LDAP store.</p>
</dd>
<dt class="hdlist1">UNSYNCED</dt>
<dd>
<p>Any changes to username, email, first name, last name, and passwords will be stored in Keycloak local storage.
It is up to you to figure out how to synchronize back to LDAP. This allows Keycloak deployments to support
updates of user metadata on a read-only LDAP server.  This option only applies when you are importing users from LDAP into the local Keycloak user database.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When the LDAP provider is created, the set of initial <a href="#_ldap_mappers">LDAP mappers</a> is created. The mappers are configured on a "best-effort" basis
      based on the chosen combination of the <code>Vendor</code>, <code>Edit Mode</code>, and <code>Import Users</code> switches. For example in case of UNSYNCED edit mode, the mappers are pre-configured
      in a way that a particular user attribute is preferably read from the database instead of from the LDAP. However when you later change the edit mode,
      the mappers configuration will not be changed as it is not easily possible to detect if they were manually changed in the meantime.
      This means that it is recommended NOT to update the <code>Edit Mode</code> switch, but rather always decide on <code>Edit Mode</code> when creating the
      LDAP provider. This applies for <code>Import Users</code> switch as well.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="other-config-options"><a class="anchor" href="#other-config-options"></a>Other config options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Console Display Name</dt>
<dd>
<p>Name used when this provider is referenced in the admin console</p>
</dd>
<dt class="hdlist1">Priority</dt>
<dd>
<p>The priority of this provider when looking up users or adding a user.</p>
</dd>
<dt class="hdlist1">Sync Registrations</dt>
<dd>
<p>Does your LDAP support adding new users?  Click this switch if you want new users created by Keycloak in the admin console or the registration page
to be added to LDAP.</p>
</dd>
<dt class="hdlist1">Allow Kerberos authentication</dt>
<dd>
<p>Enable Kerberos/SPNEGO authentication in realm with users data provisioned from LDAP.
More info in <a href="#_kerberos">Kerberos section</a>.</p>
</dd>
<dt class="hdlist1">Other options</dt>
<dd>
<p>The rest of the configuration options should be self explanatory.
You can hover the mouse pointer over the tooltips in the Admin Console to see some more details about them.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="connect-to-ldap-over-ssl"><a class="anchor" href="#connect-to-ldap-over-ssl"></a>Connect to LDAP over SSL</h4>
<div class="paragraph">
<p>When you configure a secured connection URL to your LDAP store (for example,`ldaps://myhost.com:636'), Keycloak will use SSL for communication with the LDAP server.
The important thing is to properly configure a truststore on the Keycloak server side, otherwise Keycloak can&#8217;t trust the SSL connection to LDAP.</p>
</div>
<div class="paragraph">
<p>The global truststore for the Keycloak can be configured with the Truststore SPI.  Please check out the <a href="https://www.keycloak.org/docs/12.0/server_installation/">Server Installation and Configuration Guide</a> for more details.
If you do not figure the truststore SPI, the truststore will fall back on the default mechanism provided by Java (either the file provided by system property <code>javax.net.ssl.trustStore</code>
or the cacerts file from the JDK if the system property is not set).</p>
</div>
<div class="paragraph">
<p>There is a configuration property <code>Use Truststore SPI</code> in the LDAP federation provider configuration, where you can choose whether the Truststore SPI is used.
By default, the value is <code>Only for ldaps</code>, which is fine for most deployments.  The Truststore SPI will only be used
if the connection URL to LDAP starts with <code>ldaps</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sync-of-ldap-users-to-keycloak"><a class="anchor" href="#sync-of-ldap-users-to-keycloak"></a>Sync of LDAP users to Keycloak</h4>
<div class="paragraph">
<p>If you enable the Import Users option, the LDAP Provider will automatically take care of synchronization (import) of needed LDAP users into the Keycloak local database.
As users log in, the LDAP provider will import the LDAP user
into the Keycloak database and then authenticate against the LDAP password. This is the only time users will be imported.
If you go to the <code>Users</code> left menu item in the Admin Console and click the <code>View all users</code> button, you will only see those LDAP users that
have been authenticated at least once by Keycloak.  It is implemented this way so that this operation does not trigger an import of the entire LDAP user database.</p>
</div>
<div class="paragraph">
<p>If you want to sync all LDAP users into the Keycloak database, you may configure and enable the <code>Sync Settings</code> on the LDAP provider configuration page.
Two types of synchronization exist:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Periodic Full sync</dt>
<dd>
<p>This type will synchronize all LDAP users into the Keycloak database.
Those LDAP users, which already exist in Keycloak and were changed in LDAP directly will be updated in the Keycloak database.  For example, the user <code>Mary Kelly</code> was changed in LDAP to <code>Mary Smith</code>.</p>
</dd>
<dt class="hdlist1">Periodic Changed users sync</dt>
<dd>
<p>When syncing occurs, only those users that were created or updated after the last sync will be updated and/or imported.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The best way to handle syncing is to click the <code>Synchronize all users</code> button when you first create the LDAP provider,
then set up a periodic sync of changed users.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ldap_mappers"><a class="anchor" href="#_ldap_mappers"></a>LDAP Mappers</h4>
<div class="paragraph">
<p>LDAP mappers are <code>listeners</code>, which are triggered by the LDAP Provider at various points and provide another extension point to LDAP integration.
They are triggered when a user logs in via LDAP and needs to be imported, during Keycloak initiated registration, or when a user is queried from the Admin Console.
When you create an LDAP Federation provider, Keycloak will automatically provide set of built-in <code>mappers</code> for this provider.
You are free to change this set and create a new mapper or update/delete existing ones.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">User Attribute Mapper</dt>
<dd>
<p>This allows you to specify which LDAP attribute is mapped to which attribute of Keycloak user.
So, for example, you can configure that LDAP attribute <code>mail</code> to the attribute <code>email</code> in the Keycloak database.
For this mapper implementation, there is always a one-to-one mapping (one LDAP attribute is mapped to one Keycloak attribute)</p>
</dd>
<dt class="hdlist1">FullName Mapper</dt>
<dd>
<p>This allows you to specify that the full name of the user, which is saved in some LDAP attribute (usually <code>cn</code> ) will be mapped to <code>firstName</code> and <code>lastname</code> attributes in the Keycloak database.
Having <code>cn</code> to contain full name of user is a common case for some LDAP deployments.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When registering new users in Keycloak and <code>Sync Registrations</code> is ON for the LDAP provider, the fullName mapper
      allows the possibility of fallback to the username. This fallback is especially useful in case of the Microsoft Active Directory. The common
      setup for the MSAD is to configure <code>cn</code> LDAP attribute as fullName and at the same time, the <code>cn</code> is usually used as <code>RDN LDAP Attribute</code>
      in the configuration of the LDAP provider. With this setup, the fallback to the username will be used. For example when you create
      Keycloak user "john123" and leave firstName and lastName empty, then fullname mapper will save "john123" as the value of the <code>cn</code> in LDAP.
      When you later enter "John Doe" for firstName and lastName, the fullname mapper will update LDAP <code>cn</code> to the value "John Doe" as
      fallback to the username will not be needed anymore.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Hardcoded Attribute Mapper</dt>
<dd>
<p>This mapper adds a hardcoded attribute value to each Keycloak user linked with LDAP.
This mapper can also force the values for the <code>enabled</code> or <code>emailVerified</code> user properties.</p>
</dd>
<dt class="hdlist1">Role Mapper</dt>
<dd>
<p>This allows you to configure role mappings from LDAP into Keycloak role mappings.
One Role mapper can be used to map LDAP roles (usually groups from a particular branch of LDAP tree) into roles corresponding to either realm roles or client roles of a specified client.
It&#8217;s not a problem to configure more Role mappers for the same LDAP provider.
So for example you can specify that role mappings from groups under
<code>ou=main,dc=example,dc=org</code> will be mapped to realm role mappings and role mappings from groups under
<code>ou=finance,dc=example,dc=org</code> will be mapped to client role mappings of client <code>finance</code>.</p>
</dd>
<dt class="hdlist1">Hardcoded Role Mapper</dt>
<dd>
<p>This mapper will grant a specified Keycloak role to each Keycloak user from the LDAP provider.</p>
</dd>
<dt class="hdlist1">Group Mapper</dt>
<dd>
<p>This allows you to map LDAP groups from a particular branch of an LDAP tree into groups in Keycloak.
It will also propagate user-group mappings from LDAP into user-group mappings in Keycloak.</p>
</dd>
<dt class="hdlist1">MSAD User Account Mapper</dt>
<dd>
<p>This mapper is specific to Microsoft Active Directory (MSAD). It&#8217;s able to tightly integrate the MSAD user account state
into the Keycloak account state (account enabled, password is expired, and so on).
It is using the <code>userAccountControl</code> and <code>pwdLastSet</code> LDAP attributes, which are both specific to MSAD and are not LDAP standard.
For example if <code>pwdLastSet</code> is <code>0</code>, the Keycloak user is required to update their password
and there will be an UPDATE_PASSWORD required action added to the user. If <code>userAccountControl</code> is
<code>514</code> (disabled account) the Keycloak user is disabled as well.</p>
</dd>
<dt class="hdlist1">Certificate Mapper</dt>
<dd>
<p>This mapper is specific for mapping X.509 certificates. It will generally be used in conjunction with X.509 authentication
and <code>Full certificate in PEM format</code> as an identity source.
It behaves the same way as the <code>User Attribute Mapper</code>, but allows Keycloak to filter for an LDAP attribute which stores
a certificate in either PEM or DER format. It is generally advised to enable <code>Always Read Value From LDAP</code> with this mapper.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>By default, there are User Attribute mappers that map basic Keycloak user attributes like username, firstname, lastname, and email to corresponding LDAP attributes.
You are free to extend these and provide additional attribute mappings.
Admin console provides tooltips, which should help with configuring the corresponding mappers.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ldap_password_hashing"><a class="anchor" href="#_ldap_password_hashing"></a>Password Hashing</h4>
<div class="paragraph">
<p>When the password of user is updated from Keycloak and sent to LDAP, it is always sent in plain-text. This is different from
updating the password to built-in Keycloak database, when the hashing and salting is applied to the password before it is sent to DB.
In the case of LDAP, the Keycloak relies on the LDAP server to provide hashing and salting of passwords.</p>
</div>
<div class="paragraph">
<p>LDAP servers such as Microsoft Active Directory, RHDS or FreeIPA provide this by default. Others such as OpenLDAP or ApacheDS may store the passwords
in plain-text by default unless you use the <em>LDAPv3 Password Modify Extended Operation</em> as per <strong>RFC3062</strong>. The LDAPv3 Password Modify Extended Operation
must be enabled explicitly in the LDAP configuration page. See the documentation of your LDAP server for more details.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Always verify that user passwords are properly hashed and not stored as plaintext by inspecting a changed
directory entry using <code>ldapsearch</code> and base64 decode the <code>userPassword</code> attribute value.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sssd"><a class="anchor" href="#_sssd"></a>SSSD and FreeIPA Identity Management Integration</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/user-federation/sssd.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/user-federation/sssd.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak also comes with a built-in <a href="https://fedoraproject.org/wiki/Features/SSSD">SSSD</a> (System Security Services Daemon) plugin. SSSD is part of the latest Fedora or Red Hat Enterprise Linux and provides access to multiple identity and authentication providers. It provides benefits such as failover and offline support. To see configuration options and for more information see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/sssd">the Red Hat Enterprise Linux Identity Management documentation</a>.</p>
</div>
<div class="paragraph">
<p>SSSD also integrates with the FreeIPA identity management (IdM) server, providing authentication and access control. For Keycloak, we benefit from this integration authenticating against PAM services and retrieving user data from SSSD. For more information about using Red Hat Identity Management in Linux environments, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/linux_domain_identity_authentication_and_policy_guide/index">the Red Hat Enterprise Linux Identity Management documentation</a>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/keycloak-sssd-freeipa-integration-overview.png" alt="keycloak sssd freeipa integration overview"></span></p>
</div>
<div class="paragraph">
<p>Most of the communication between Keycloak and SSSD occurs through read-only D-Bus interfaces. For this reason, the only way to provision and update users is to use the FreeIPA/IdM administration interface. By default, like the LDAP federation provider, it is set up only to import username, email, first name, and last name.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Groups and roles are automatically registered, but not synchronized, so any changes made by the Keycloak administrator directly in Keycloak are not synchronized with SSSD.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Information on how to configure the FreeIPA/IdM server follows.</p>
</div>
<div class="sect3">
<h4 id="freeipa-idm-server"><a class="anchor" href="#freeipa-idm-server"></a>FreeIPA/IdM Server</h4>
<div class="paragraph">
<p>For the sake of simplicity, a <a href="https://hub.docker.com/r/freeipa/freeipa-server/">FreeIPA Docker image</a> already available is used. To set up a server, see the <a href="https://www.freeipa.org/page/Quick_Start_Guide">FreeIPA documentation</a>.</p>
</div>
<div class="paragraph">
<p>Running a FreeIPA server with Docker requires this command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run --name freeipa-server-container -it \
-h server.freeipa.local -e PASSWORD=YOUR_PASSWORD \
-v /sys/fs/cgroup:/sys/fs/cgroup:ro \
-v /var/lib/ipa-data:/data:Z freeipa/freeipa-server</pre>
</div>
</div>
<div class="paragraph">
<p>The parameter <code>-h</code> with <code>server.freeipa.local</code> represents the FreeIPA/IdM server hostname. Be sure to change <code>YOUR_PASSWORD</code> to a password of your choosing.</p>
</div>
<div class="paragraph">
<p>After the container starts, change <code>/etc/hosts</code> to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>x.x.x.x     server.freeipa.local</pre>
</div>
</div>
<div class="paragraph">
<p>If you do not make this change, you must set up a DNS server.</p>
</div>
<div class="paragraph">
<p>You must enroll your Linux machine in the IPA domain so that the SSSD federation provider is started and running on Keycloak:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ipa-client-install --mkhomedir -p admin -w password</pre>
</div>
</div>
<div class="paragraph">
<p>To ensure that everything is working as expected, on the client machine, run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kinit admin</pre>
</div>
</div>
<div class="paragraph">
<p>You should be prompted for the password. After that, you can add users to the IPA server using this command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ipa user-add john --first=John --last=Smith --email=john@smith.com --phone=042424242 --street="Testing street" \      --city="Testing city" --state="Testing State" --postalcode=0000000000 --password</pre>
</div>
</div>
<div class="paragraph">
<p>To force setting the user&#8217;s password, use kinit.  Given the user john, you would enter this command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kinit john</pre>
</div>
</div>
<div class="paragraph">
<p>To restore normal IPA operation, you would enter these commands:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kdestroy -A
kinit admin</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sssd-and-d-bus"><a class="anchor" href="#sssd-and-d-bus"></a>SSSD and D-Bus</h4>
<div class="paragraph">
<p>As mentioned previously, the federation provider obtains the data from SSSD using D-BUS and authentication occurs using PAM.</p>
</div>
<div class="paragraph">
<p>First, you have to install the sssd-dbus RPM, which allows information from SSSD to be transmitted over the system bus.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo yum install sssd-dbus</pre>
</div>
</div>
<div class="paragraph">
<p>You must run the provisioning script available from the Keycloak distribution:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/federation-sssd-setup.sh</pre>
</div>
</div>
<div class="paragraph">
<p>This script makes the necessary changes to <code>/etc/sssd/sssd.conf</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[domain/your-hostname.local]
...
ldap_user_extra_attrs = mail:mail, sn:sn, givenname:givenname, telephoneNumber:telephoneNumber
...
[sssd]
services = nss, sudo, pam, ssh, ifp
...
[ifp]
allowed_uids = root, yourOSUsername
user_attributes = +mail, +telephoneNumber, +givenname, +sn</pre>
</div>
</div>
<div class="paragraph">
<p>Also, a <code>keycloak</code> file is included under <code>/etc/pam.d/</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>auth    required   pam_sss.so
account required   pam_sss.so</pre>
</div>
</div>
<div class="paragraph">
<p>Ensure everything is working as expected by running <code>dbus-send</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo dbus-send --print-reply --system --dest=org.freedesktop.sssd.infopipe /org/freedesktop/sssd/infopipe org.freedesktop.sssd.infopipe.GetUserGroups string:john</pre>
</div>
</div>
<div class="paragraph">
<p>You should be able to see the user&#8217;s group. If this command returns a timeout or an error, it means that the federation provider running on Keycloak will also be unable to retrieve anything.</p>
</div>
<div class="paragraph">
<p>Most of the time this occurs because the machine was not enrolled in the FreeIPA IdM server or you do not have permission to access the SSSD service.</p>
</div>
<div class="paragraph">
<p>If you do not have permission, ensure that the user running the Keycloak server is included in the <code>/etc/sssd/sssd.conf</code> file in the following section:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[ifp]
allowed_uids = root, your_username</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enabling-the-sssd-federation-provider"><a class="anchor" href="#enabling-the-sssd-federation-provider"></a>Enabling the SSSD Federation Provider</h4>
<div class="paragraph">
<p>Keycloak uses DBus-Java to communicate at a low level with D-Bus, which depends on the <a href="http://www.matthew.ath.cx/projects/java/">Unix Sockets Library</a>.</p>
</div>
<div class="paragraph">
<p>An RPM for this library can be found in <a href="https://github.com/keycloak/libunix-dbus-java/releases">this repository</a>. Before installing it, be sure to check the RPM signature:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ rpm -K libunix-dbus-java-0.8.0-1.fc24.x86_64.rpm
libunix-dbus-java-0.8.0-1.fc24.x86_64.rpm:
  Header V4 RSA/SHA256 Signature, key ID 84dc9914: OK
  Header SHA1 digest: OK (d17bb7ebaa7a5304c1856ee4357c8ba4ec9c0b89)
  V4 RSA/SHA256 Signature, key ID 84dc9914: OK
  MD5 digest: OK (770c2e68d052cb4a4473e1e9fd8818cf)
$ sudo yum install libunix-dbus-java-0.8.0-1.fc24.x86_64.rpm</pre>
</div>
</div>
<div class="paragraph">
<p>For authentication with PAM Keycloak uses JNA. Be sure you have this package installed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo yum install jna</pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>sssctl user-checks</code> command to validate your setup:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo sssctl user-checks admin -s keycloak</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-a-federated-sssd-store"><a class="anchor" href="#configuring-a-federated-sssd-store"></a>Configuring a Federated SSSD Store</h3>
<div class="paragraph">
<p>After the installation, you need to configure a federated SSSD store.</p>
</div>
<div class="paragraph">
<p>To configure a federated SSSD store, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the Administration Console.</p>
</li>
<li>
<p>From the left menu, select <strong>User Federation.</strong></p>
</li>
<li>
<p>From the <strong>Add Provider</strong> dropdown list, select <strong>sssd.</strong> The sssd configuration page opens.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now you can authenticate against Keycloak using FreeIPA/IdM credentials.</p>
</div>
</div>
<div class="sect2">
<h3 id="custom-providers"><a class="anchor" href="#custom-providers"></a>Custom Providers</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/user-federation/custom.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/user-federation/custom.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak does have an SPI for User Storage Federation that you can use to write your own custom providers.
You can find documentation for this in our <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="auditing-and-events"><a class="anchor" href="#auditing-and-events"></a>Auditing and Events</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/events.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/events.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak provides a rich set of auditing capabilities.  Every single login action can be recorded and stored in
the database and reviewed in the Admin Console.  All admin actions can also be recorded and reviewed.  There is also a Listener SPI
with which plugins can listen for these events and perform some action.  Built-in listeners include a simple log file and the ability
to send an email if an event occurs.</p>
</div>
<div class="sect2">
<h3 id="login-events"><a class="anchor" href="#login-events"></a>Login Events</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/events/login.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/events/login.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Login events occur for things like when a user logs in successfully, when somebody enters in a bad password, or when a user account
is updated.  Every single event that happens to a user can be recorded and viewed.  By default, no events are stored
or viewed in the Admin Console.  Only error events are logged to the console and the server&#8217;s log file.  To start
persisting  you&#8217;ll need to enable storage.  Go to the <code>Events</code> left menu item and select the <code>Config</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Event Configuration</div>
<p><span class="image"><img src="./keycloak-images/login-events-config.png" alt="login events config"></span></p>
</div>
<div class="paragraph">
<p>To start storing events you&#8217;ll need to turn the <code>Save Events</code> switch to on under the <code>Login Events Settings</code>.</p>
</div>
<div class="paragraph">
<div class="title">Save Events</div>
<p><span class="image"><img src="./keycloak-images/login-events-settings.png" alt="login events settings"></span></p>
</div>
<div class="paragraph">
<p>The <code>Saved Types</code> field allows you to specify which event types you want to store in the event store.  The <code>Clear events</code>
button allows you to delete all the events in the database. The <code>Expiration</code> field allows you to specify how long you want
to keep events stored.  Once you&#8217;ve enabled storage of login events and decided on your settings, don&#8217;t forget to click
the <code>Save</code> button on the bottom of this page.</p>
</div>
<div class="paragraph">
<p>To view events, go to the <code>Login Events</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Login Events</div>
<p><span class="image"><img src="./keycloak-images/login-events.png" alt="login events"></span></p>
</div>
<div class="paragraph">
<p>As you can see, there&#8217;s a lot of information stored and, if you are storing every event, there are a lot of events stored for
each login action.  The <code>Filter</code> button on this page allows you to filter which events you are actually interested in.</p>
</div>
<div class="paragraph">
<div class="title">Login Event Filter</div>
<p><span class="image"><img src="./keycloak-images/login-events-filter.png" alt="login events filter"></span></p>
</div>
<div class="paragraph">
<p>In this screenshot, we&#8217;re filtering only <code>Login</code> events.  Clicking the <code>Update</code> button runs the filter.</p>
</div>
<div class="sect3">
<h4 id="event-types"><a class="anchor" href="#event-types"></a>Event Types</h4>
<div class="paragraph">
<p>Login events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Login - A user has logged in.</p>
</li>
<li>
<p>Register - A user has registered.</p>
</li>
<li>
<p>Logout - A user has logged out.</p>
</li>
<li>
<p>Code to Token - An application/client has exchanged a code for a token.</p>
</li>
<li>
<p>Refresh Token - An application/client has refreshed a token.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Account events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Social Link - An account has been linked to a social provider.</p>
</li>
<li>
<p>Remove Social Link - A social provider has been removed from an account.</p>
</li>
<li>
<p>Update Email - The email address for an account has changed.</p>
</li>
<li>
<p>Update Profile - The profile for an account has changed.</p>
</li>
<li>
<p>Send Password Reset - A password reset email has been sent.</p>
</li>
<li>
<p>Update Password - The password for an account has changed.</p>
</li>
<li>
<p>Update TOTP - The TOTP settings for an account have changed.</p>
</li>
<li>
<p>Remove TOTP - TOTP has been removed from an account.</p>
</li>
<li>
<p>Send Verify Email - An email verification email has been sent.</p>
</li>
<li>
<p>Verify Email - The email address for an account has been verified.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For all events there is a corresponding error event.</p>
</div>
</div>
<div class="sect3">
<h4 id="event-listener"><a class="anchor" href="#event-listener"></a>Event Listener</h4>
<div class="paragraph">
<p>Event listeners listen for events and perform an action based on that event.  There are two built-in
listeners that come with Keycloak: Logging Event Listener and Email Event Listener.</p>
</div>
<div class="paragraph">
<p>The Logging Event Listener writes to a log file whenever an error event occurs and is enabled by default.
Here&#8217;s an example log message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>11:36:09,965 WARN  [org.keycloak.events] (default task-51) type=LOGIN_ERROR, realmId=master,
                    clientId=myapp,
                    userId=19aeb848-96fc-44f6-b0a3-59a17570d374, ipAddress=127.0.0.1,
                    error=invalid_user_credentials, auth_method=openid-connect, auth_type=code,
                    redirect_uri=http://localhost:8180/myapp,
                    code_id=b669da14-cdbb-41d0-b055-0810a0334607, username=admin</pre>
</div>
</div>
<div class="paragraph">
<p>This logging is very useful if you want to use a tool like Fail2Ban to detect if there is a hacker bot somewhere that
is trying to guess user passwords.  You can parse the log file for <code>LOGIN_ERROR</code> and pull out the IP Address. Then feed this information
into Fail2Ban so that it can help prevent attacks.</p>
</div>
<div class="paragraph">
<p>The Logging Event Listener logs events to the <code>org.keycloak.events</code> logger category. By default debug log events are not
included in server logs.</p>
</div>
<div class="paragraph">
<p>To include debug log events in server logs, edit the <code>standalone.xml</code> file and change the log level used by the Logging
Event listener. Alternately, you can configure the log level for <code>org.keycloak.events</code>.</p>
</div>
<div class="paragraph">
<p>For example, to change the log level add the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:logging:...</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;logger</span> <span class="attribute-name">category</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.events</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;level</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DEBUG</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/logger&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To change the log level used by the Logging Event listener, add the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-server:...</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">eventsListener</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jboss-logging</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">success-level</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">info</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">error-level</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/provider&gt;</span>
    <span class="tag">&lt;/spi&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Valid values for the log levels are <code>debug</code>, <code>info</code>, <code>warn</code>, <code>error</code>, and <code>fatal</code>.</p>
</div>
<div class="paragraph">
<p>The Email Event Listener sends an email to the user&#8217;s account when an event occurs.</p>
</div>
<div class="paragraph">
<p>Currently, the Email Event Listener supports the following events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Login Error</p>
</li>
<li>
<p>Update Password</p>
</li>
<li>
<p>Update TOTP</p>
</li>
<li>
<p>Remove TOTP</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To enable the Email Listener go to the <code>Config</code> tab and click on the <code>Event Listeners</code> field.  This will show a drop down list box
where you can select email.</p>
</div>
<div class="paragraph">
<p>You can exclude one or more events by editing the <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code>
that comes with your distribution and adding for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">eventsListener</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;properties&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exclude-events</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">[</span><span class="entity">&amp;quot;</span><span class="content">UPDATE_TOTP</span><span class="entity">&amp;quot;</span><span class="content">,</span><span class="entity">&amp;quot;</span><span class="content">REMOVE_TOTP</span><span class="entity">&amp;quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/properties&gt;</span>
  <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also set up a maximum length of the Event detail stored in the database by editing <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or
<code>domain.xml</code>. This setting can be useful in case some field (e.g. redirect_uri) is very long. Here is an example of defining the maximum length.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">eventsStore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jpa</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">max-detail-length</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://www.keycloak.org/docs/12.0/server_installation/">Server Installation and Configuration Guide</a> for more details on
where the <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code> file lives.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="admin-events"><a class="anchor" href="#admin-events"></a>Admin Events</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/events/admin.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/events/admin.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Any action an admin performs within the admin console can be recorded for auditing purposes.
The Admin Console performs administrative functions by invoking on the Keycloak REST interface.  Keycloak
audits these REST invocations.  The resulting events can then be viewed in the Admin Console.</p>
</div>
<div class="paragraph">
<p>To enable auditing of Admin actions, go to the <code>Events</code> left menu item and select the <code>Config</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Event Configuration</div>
<p><span class="image"><img src="./keycloak-images/login-events-config.png" alt="login events config"></span></p>
</div>
<div class="paragraph">
<p>In the <code>Admin Events Settings</code> section, turn on the <code>Save Events</code> switch.</p>
</div>
<div class="paragraph">
<div class="title">Admin Event Configuration</div>
<p><span class="image"><img src="./keycloak-images/admin-events-settings.png" alt="admin events settings"></span></p>
</div>
<div class="paragraph">
<p>The <code>Include Representation</code> switch will include any JSON document that is sent through the admin REST API.  This allows you to view exactly what an admin has done, but can lead to a lot of information stored in the
database.  The <code>Clear admin events</code> button allows you to wipe out the current information stored.</p>
</div>
<div class="paragraph">
<p>To view the admin events go to the <code>Admin Events</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Admin Events</div>
<p><span class="image"><img src="./keycloak-images/admin-events.png" alt="admin events"></span></p>
</div>
<div class="paragraph">
<p>If the <code>Details</code> column has a <code>Representation</code> box, you can click on that to view the JSON that was sent with that operation.</p>
</div>
<div class="paragraph">
<div class="title">Admin Representation</div>
<p><span class="image"><img src="./keycloak-images/admin-events-representation.png" alt="admin events representation"></span></p>
</div>
<div class="paragraph">
<p>You can also filter for the events you are interested in by clicking the <code>Filter</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Admin Event Filter</div>
<p><span class="image"><img src="./keycloak-images/admin-events-filter.png" alt="admin events filter"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_export_import"><a class="anchor" href="#_export_import"></a>Export and Import</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/export-import.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/export-import.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak has the ability to export and import the entire database.
This can be especially useful if you want to migrate your whole Keycloak database from one environment to another or migrate to a different database (for example from MySQL to Oracle). Export and import is triggered at server boot time  and its parameters are passed in via Java system properties.
It is important to note that because import and export happens at server startup, no other actions should be taken on the server or the database while this happens.</p>
</div>
<div class="paragraph">
<p>You can export/import your database either to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Directory on local filesystem</p>
</li>
<li>
<p>Single JSON file on your filesystem</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When importing using the directory strategy, note that the files need to follow the naming convention specified below.
If you are importing files which were previously exported, the files already follow this convention.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&lt;REALM_NAME&gt;-realm.json, such as "acme-roadrunner-affairs-realm.json" for the realm named "acme-roadrunner-affairs"</p>
</li>
<li>
<p>&lt;REALM_NAME&gt;-users-&lt;INDEX&gt;.json, such as "acme-roadrunner-affairs-users-0.json" for the first users file of the realm named "acme-roadrunner-affairs"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you export to a directory, you can also specify the number of users that will be stored in each JSON file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have bigger amount of users in your database (500 or more), it&#8217;s highly recommended to export into directory rather
      than to single file. Exporting into single file may lead to the very big file. Also the directory provider is using separate transaction for each "page" (file with users),
      which leads to much better performance.
      Default count of users per file (and transaction) is 50, which showed us best performance, but you have possibility to override (See below).
      Exporting to single file is using one transaction per whole export and one per whole import, which results in bad performance with large amount of users.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To export into unencrypted directory you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh -Dkeycloak.migration.action=export
-Dkeycloak.migration.provider=dir -Dkeycloak.migration.dir=&lt;DIR TO EXPORT TO&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To export into single JSON file you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh -Dkeycloak.migration.action=export
-Dkeycloak.migration.provider=singleFile -Dkeycloak.migration.file=&lt;FILE TO EXPORT TO&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And similarly for import just use <code>-Dkeycloak.migration.action=import</code> instead of <code>export</code> .
Here&#8217;s an example of importing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh -Dkeycloak.migration.action=import
-Dkeycloak.migration.provider=singleFile -Dkeycloak.migration.file=&lt;FILE TO IMPORT&gt;
-Dkeycloak.migration.strategy=OVERWRITE_EXISTING</code></pre>
</div>
</div>
<div class="paragraph">
<p>Other available options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-Dkeycloak.migration.realmName</dt>
<dd>
<p>This property is used if you want to export just one specified realm instead of all.
If not specified, then all realms will be exported.</p>
</dd>
<dt class="hdlist1">-Dkeycloak.migration.usersExportStrategy</dt>
<dd>
<p>This property is used to specify where users are exported.
Possible values are:</p>
<div class="ulist">
<ul>
<li>
<p>DIFFERENT_FILES - Users will be exported into different files according to the maximum number of users per file. This is default value.</p>
</li>
<li>
<p>SKIP - Exporting of users will be skipped completely.</p>
</li>
<li>
<p>REALM_FILE - All users will be exported to same file with the realm settings. (The result will be a file like "foo-realm.json" with both realm data and users.)</p>
</li>
<li>
<p>SAME_FILE - All users will be exported to same file but different from the realm file. (The result will be a file like "foo-realm.json" with realm data and "foo-users.json" with users.)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">-Dkeycloak.migration.usersPerFile</dt>
<dd>
<p>This property is used to specify the number of users per file (and also per DB transaction). It&#8217;s 50 by default.
It&#8217;s used only if usersExportStrategy is DIFFERENT_FILES</p>
</dd>
<dt class="hdlist1">-Dkeycloak.migration.strategy</dt>
<dd>
<p>This property is used during import.
It can be used to specify how to proceed if a realm with same name already exists in the database where you are going to import data.
Possible values are:</p>
<div class="ulist">
<ul>
<li>
<p>IGNORE_EXISTING - Ignore importing if a realm of this name already exists.</p>
</li>
<li>
<p>OVERWRITE_EXISTING - Remove existing realm and import it again with new data from the JSON file.
If you want to fully migrate one environment to another and ensure that the new environment will contain the same data
as the old one, you can specify this.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When importing realm files that weren&#8217;t exported before, the option <code>keycloak.import</code> can be used.
If more than one realm file needs to be imported, a comma separated list of file names can be specified.
This is more appropriate than the cases before, as this will happen only after the master realm has been initialized.
Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>-Dkeycloak.import=/tmp/realm1.json</p>
</li>
<li>
<p>-Dkeycloak.import=/tmp/realm1.json,/tmp/realm2.json</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The mechanism based on <code>keycloak.import</code> cannot be used together with the other mechanism based on <code>keycloak.migration.X</code> properties.
If it is used together, the <code>keycloak.import</code> will be ignored. The <code>keycloak.import</code> mechanism always ignores the realms, which already
exist in Keycloak. Generally the <code>keycloak.import</code> mechanism can be convenient for some development purposes, but if more
flexibility is needed, we recommend that you stick with the mechanism based on <code>keycloak.migration.X</code> properties.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="admin-console-export-import"><a class="anchor" href="#admin-console-export-import"></a>Admin console export/import</h3>
<div class="paragraph">
<p>Import of most resources can be performed from the admin console as well as export of most resources.
Export of users is not supported.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Attributes containing secrets or private information will be masked in export file. Export files obtained via Admin Console
are thus not appropriate for backups or data transfer between servers. Only boot-time exports are appropriate for that.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The files created during a "startup" export can also be used to import from the admin UI.
This way, you can export from one realm and import to another realm. Or, you can export from one server and import to another.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The admin console export/import allows just one realm per file.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The admin console import allows you to "overwrite" resources if you choose.
Use this feature with caution, especially on a production system. Export .json files from Admin Console Export operation
are generally not appropriate for data import since they contain invalid values for secrets.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The admin console export allows you to export clients, groups, and roles. If there is a great number of any of these
assets in your realm, the operation may take some time to complete. During that time server may not be responsive to user requests.
Use this feature with caution, especially on a production system.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vault-administration"><a class="anchor" href="#_vault-administration"></a>Using Vault to Obtain Secrets</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/vault.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/vault.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Several fields in the administration support obtaining the value of a secret from an external vault.</p>
</div>
<div class="paragraph">
<p>To obtain a secret from a vault instead of entering it directly, enter
the following specially crafted string into the appropriate field:
<code><strong>${vault.</strong><em>key</em><strong>}</strong></code> where you replace the <code><em>key</em></code>
with the name of the secret as recognized by the vault.</p>
</div>
<div class="paragraph">
<p>In order to prevent secrets from leaking across realms, implementations may combine the realm name with the <code><em>key</em></code>
obtained from the vault expression. This means that the <code><em>key</em></code> won&#8217;t directly map to an entry in the vault, but rather
be used to create the final entry name according to the algorithm used to combine it with the realm name.</p>
</div>
<div class="paragraph">
<p>Currently, the secret can be obtained from the vault in the following fields:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">SMTP password</dt>
<dd>
<p>In realm <a href="#_email">SMTP settings</a></p>
</dd>
<dt class="hdlist1">LDAP bind credential</dt>
<dd>
<p>In <a href="#_ldap">LDAP settings</a> of LDAP-based user federation.</p>
</dd>
<dt class="hdlist1">OIDC identity provider secret</dt>
<dd>
<p>In <em>Client Secret</em> inside identity provider <a href="#_identity_broker_oidc">OpenID Connect Config</a></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To use a vault, a vault provider must be registered within Keycloak.
It is possible to either use a built-in provider described below or
implement your own provider. See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for more information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is at most one vault provider active per Keycloak instance
at any given time, and the vault provider in each instance within the cluster
has to be configured consistently.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="kubernetes-openshift-files-plaintext-vault-provider"><a class="anchor" href="#kubernetes-openshift-files-plaintext-vault-provider"></a>Kubernetes / OpenShift Files Plaintext Vault Provider</h3>
<div class="paragraph">
<p>Keycloak supports vault implementation for <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Kubernetes secrets</a>. These secrets
can be mounted as data volumes, and they appear as a directory with a flat file structure, where each secret is represented by a file whose name is the secret name, and contents of that file is the secret value.</p>
</div>
<div class="paragraph">
<p>The files within this directory have to be named as secret name prefixed by realm name and an underscore. All underscores within the secret name or the realm name have to be doubled in the file name. For example, for a field within a realm called <code>sso_realm</code>, a reference to a secret with name <code>secret-name</code> would be written as <code>${vault.secret-name}</code>, and the file name looked up would be <code>sso__realm_secret-name</code> (note the underscore doubled in realm name).</p>
</div>
<div class="paragraph">
<p>To use this type of secret store, you have to declare the <code>files-plaintext</code> vault provider in standalone.xml, and set its parameter for the directory that contains the mounted volume. The following example shows the <code>files-plaintext</code>
provider with the directory where vault files are searched for set to <code>standalone/configuration/vault</code> relative to Keycloak base directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vault</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>files-plaintext<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">files-plaintext</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dir</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.home.dir}/standalone/configuration/vault/</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the equivalent configuration using CLI commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">/subsystem=keycloak-server/spi=vault/:add
/subsystem=keycloak-server/spi=vault/provider=files-plaintext/:add(enabled=true,properties={dir =&gt; &quot;${jboss.home.dir}/standalone/configuration/vault&quot;})</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="elytron-credential-store-vault-provider"><a class="anchor" href="#elytron-credential-store-vault-provider"></a>Elytron Credential Store Vault Provider</h3>
<div class="paragraph">
<p>Keycloak also provides support for reading secrets stored in an Elytron credential store. The <code>elytron-cs-keystore</code>
vault provider is capable of retrieving secrets from the keystore-based implementation of the credential store, which
is also the default implementation provided by Elytron.</p>
</div>
<div class="paragraph">
<p>This credential store is backed by a keystore (<code>JCEKS</code> is the default format, but it is possible to use other formats such as <code>PKCS12</code>)
and users can create and manage the store contents using either the <code>elytron</code> subsystem in WildFly/JBoss EAP, or using the
<code>elytron-tool.sh</code> script.</p>
</div>
<div class="paragraph">
<p>To use this provider, you have to declare the <code>elytron-cs-keystore</code> in the <code>keycloak-server</code> subsystem and set the location
and master secret of the keystore that was created by Elytron. An example of the minimal configuration for the provider follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vault</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>elytron-cs-keystore<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">elytron-cs-keystore</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">location</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.home.dir}/standalone/configuration/vault/credential-store.jceks</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secretpw1!</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the underlying keystore has a format other than <code>JCEKS</code>, this format has to be informed using the <code>keyStoreType</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vault</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>elytron-cs-keystore<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">elytron-cs-keystore</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">location</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.home.dir}/standalone/configuration/vault/credential-store.p12</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secretpw1!</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keyStoreType</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PKCS12</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For the secret, the <code>elytron-cs-keystore</code> provider supports both clear-text values (as shown above) and also values that
were masked using the <code>elytron-tool.sh</code> script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vault</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   ...
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MASK-3u2HNQaMogJJ8VP7J6gRIl;12345678;321</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   ...
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more detailed information on how to create/manage elytron credential stores, as well as how to mask keystore secrets,
please refer to the Elytron documentation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>elytron-cs-keystore</code> vault provider has been implemented as a WildFly extension and as such is only available
if the Keycloak server runs on WildFly/JBoss EAP.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="key-resolvers"><a class="anchor" href="#key-resolvers"></a>Key Resolvers</h3>
<div class="paragraph">
<p>All built-in providers support the configuration of one or more key resolvers. A key resolver essentially implements
the algorithm or strategy for combining the realm name with the key (as obtained from the <code>${vault.key}</code> expression) into
the final entry name that will be used to retrieve the secret from the vault. The <code>keyResolvers</code> property is used to configure
the resolvers that are to be used by the provider. The value is a comma-separated list of resolver names. An example of
configuration for the <code>files-plaintext</code> provider follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vault</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>files-plaintext<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">files-plaintext</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dir</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.home.dir}/standalone/configuration/vault/</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keyResolvers</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REALM_UNDERSCORE_KEY, KEY_ONLY</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resolvers are executed in the same order that they are declared in the configuration. For each resolver, the final entry
name produced by the resolver that combines the realm with the vault key is used to search for the secret in the vault.
If a secret is found, it is immediately returned. If not, the next resolver is used and this continues until a non-empty
secret is found or all resolvers have been tried, in which case an empty secret is returned. In the example above, first
the <code>REALM_UNDERSCORE_KEY</code> resolver is used. If an entry is found in the vault with the name it produces, it is returned.
If not, then the <code>KEY_ONLY</code> resolver is used. Again, if an entry is found in the vault with the name it produces, it is
returned. If not, an empty secret is returned since there are no more resolvers to be used.</p>
</div>
<div class="paragraph">
<p>A list of the currently available resolvers follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>KEY_ONLY</code>: the realm name is ignored and the key from the vault expression is used as is.</p>
</li>
<li>
<p><code>REALM_UNDERSCORE_KEY</code>: the realm and key are combined using an underscore <code>_</code> character. Occurrences of underscore in either the
realm or key are escaped by another underscore character. So if the realm is called <code>master_realm</code> and the key is <code>smtp_key</code>, the
combined key will be <code>master__realm_smtp__key</code>.</p>
</li>
<li>
<p><code>REALM_FILESEPARATOR_KEY</code>: the realm and key are combined using the platform file separator character. This is useful in situations
where the keys are grouped by realm using a directory structure.</p>
</li>
<li>
<p><code>FACTORY_PROVIDED</code>: the realm and key are combined using the <code>VaultKeyResolver</code> that is provided by the vault provider factory,
allowing the creation of a custom key resolver by extending an existing factory and implementing the <code>getFactoryResolver</code> method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If no resolver is configured for the built-in providers, the <code>REALM_UNDERSCORE_KEY</code> is selected by default.</p>
</div>
<div class="paragraph">
<p>The <code>FACTORY_PROVIDED</code> resolver provides a hook that can be used to implement a custom resolver by extending the provider
factory of choice and overriding the <code>getFactoryResolver</code> method so it returns the custom resolver. For example, if you want
to use the <code>elytron-cs-keystore</code> provider but none of the built-in resolvers match the format used in your keystore, you
can extend the <code>ElytronCSKeystoreProvider</code> and implement the <code>getFactoryResolver</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="directive">public</span> <span class="type">class</span> <span class="class">CustomElytronProviderFactory</span> <span class="directive">extends</span> ElytronCSKeyStoreProviderFactory {
        ...
        <span class="annotation">@Override</span>
        <span class="directive">protected</span> VaultKeyResolver getFactoryResolver() {
            <span class="keyword">return</span> (realm, key) -&gt; realm + <span class="string"><span class="delimiter">&quot;</span><span class="content">###</span><span class="delimiter">&quot;</span></span> + key;
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
            <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">custom-elytron-cs-keystore;
        }

        ...
    }</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom factory returns a key resolver that combines the realm and key with a triple <code><mark></code> character. So an entry would look
like <code>master_realm</mark>##smtp_key</code>, for example. This factory must then be installed just like any custom provider.</p>
</div>
<div class="paragraph">
<p>Note that the custom factory must override both the <code>getFactoryResolver</code> and <code>getId</code> methods. The second method is needed so that
we can properly configure the custom factory in Keycloak.</p>
</div>
<div class="paragraph">
<p>To install and use the above custom provider the configuration would look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vault</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>custom-elytron-cs-keystore<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-elytron-cs-keystore</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">location</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.home.dir}/standalone/configuration/vault/credential-store.p12</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MASK-3u2HNQaMogJJ8VP7J6gRIl;12345678;321</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keyStoreType</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PKCS12</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keyResolvers</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FACTORY_PROVIDED</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration above tells Keycloak to setup the custom Elytron provider and use the key resolver that is created by
the custom factory.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_account-service"><a class="anchor" href="#_account-service"></a>User Account Service</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/account.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/account.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak has a built-in User Account Service which every user has access to.  This service allows users to manage their account,
change their credentials, update their profile, and view their login sessions.  The URL to this service is <code>&lt;server-root&gt;/auth/realms/{realm-name}/account</code>.</p>
</div>
<div class="paragraph">
<div class="title">Account Service</div>
<p><span class="image"><img src="./keycloak-images/account-service-profile.png" alt="account service profile"></span></p>
</div>
<div class="paragraph">
<p>The initial page is the user&#8217;s profile, which is the <code>Account</code> left menu item.  This is where they specify basic data about themselves.  This screen can be extended
to allow the user to manage additional attributes.  See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for more details.</p>
</div>
<div class="paragraph">
<p>The <code>Password</code> left menu item allows the user to change their password.</p>
</div>
<div class="paragraph">
<div class="title">Password Update</div>
<p><span class="image"><img src="./keycloak-images/account-service-password.png" alt="account service password"></span></p>
</div>
<div class="paragraph">
<p>The <code>Authenticator</code> menu item allows the user to set up OTP if they desire.  This will only show up if OTP is a valid authentication mechanism for your realm.
Users are given directions to install <a href="https://freeotp.github.io/">FreeOTP</a> or <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2">Google Authenticator</a> on their mobile device to be their OTP generator.
The QR code you see in the screen shot can be scanned into the FreeOTP or Google Authenticator mobile application for nice and easy setup.</p>
</div>
<div class="paragraph">
<div class="title">OTP Authenticator</div>
<p><span class="image"><img src="./keycloak-images/account-service-authenticator.png" alt="account service authenticator"></span></p>
</div>
<div class="paragraph">
<p>The <code>Federated Identity</code> menu item allows the user to link their account with an <a href="#_identity_broker">identity broker</a> (this is usually used to link social provider
accounts together).  This will show the list of external identity providers you have configured for your realm.</p>
</div>
<div class="paragraph">
<div class="title">Federated Identity</div>
<p><span class="image"><img src="./keycloak-images/account-service-federated-identity.png" alt="account service federated identity"></span></p>
</div>
<div class="paragraph">
<p>The <code>Sessions</code> menu item allows the user to view and manage which devices are logged in and from where.  They can perform logout of these sessions from this screen too.</p>
</div>
<div class="paragraph">
<div class="title">Sessions</div>
<p><span class="image"><img src="./keycloak-images/account-service-sessions.png" alt="account service sessions"></span></p>
</div>
<div class="paragraph">
<p>The <code>Applications</code> menu item shows users which applications they have access to.</p>
</div>
<div class="paragraph">
<div class="title">Applications</div>
<p><span class="image"><img src="./keycloak-images/account-service-apps.png" alt="account service apps"></span></p>
</div>
<div class="sect2">
<h3 id="themeable"><a class="anchor" href="#themeable"></a>Themeable</h3>
<div class="paragraph">
<p>Like all UIs in Keycloak, the User Account Service is completely themeable and internationalizable.
See the <a href="https://www.keycloak.org/docs/12.0/server_development/">Server Developer Guide</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="threat-model-mitigation"><a class="anchor" href="#threat-model-mitigation"></a>Threat Model Mitigation</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This chapter discusses possible security vulnerabilities any authentication server could have and how Keycloak
mitigates those vulnerabilities.
A good list of potential vulnerabilities and what security implementations should do to mitigate them can be found in
the <a href="https://tools.ietf.org/html/rfc6819">OAuth 2.0 Threat Model</a> document and its most recent extension <a href="https://tools.ietf.org/html/draft-ietf-oauth-security-topics-15">OAuth 2.0 Security Best Current Practice</a> put out by the IETF.
Many of those vulnerabilities are discussed here.</p>
</div>
<div class="sect2">
<h3 id="host"><a class="anchor" href="#host"></a>Host</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/host.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/host.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak uses the public hostname for a number of things. For example, in the token issuer fields and URLs sent in
password reset emails.</p>
</div>
<div class="paragraph">
<p>By default, the hostname is based on the request headers and there is no check to make sure this hostname is valid.</p>
</div>
<div class="paragraph">
<p>If you are not using a load balancer or proxy in front of Keycloak that prevents invalid host headers, you must
explicitly configure what hostnames should be accepted.</p>
</div>
<div class="paragraph">
<p>The Hostname SPI provides a way to configure the hostname for a request. The out of the box provider allows setting
a fixed URL for frontend requests, while allowing backend requests to be based on the request URI. It is also possible
to develop your own provider in the case the built-in provider does not provide the functionality needed.</p>
</div>
</div>
<div class="sect2">
<h3 id="admin-endpoints-and-console"><a class="anchor" href="#admin-endpoints-and-console"></a>Admin Endpoints and Console</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/admin.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/admin.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The Keycloak administrative REST API and the web console are exposed by default on the same port as non-admin
usage. If access to the admin console is not needed externally, we recommend not exposing the admin endpoints on the
Internet.</p>
</div>
<div class="paragraph">
<p>This can be achieved either directly in Keycloak or with a proxy such as Apache or nginx.</p>
</div>
<div class="paragraph">
<p>For the proxy option please follow the documentation for the proxy. You need to control access to any requests
to <code>/auth/admin</code>.</p>
</div>
<div class="paragraph">
<p>To achieve this directly in Keycloak there are a few options. This document covers two options, IP restriction
and separate ports.</p>
</div>
<div class="paragraph">
<p>Once the admin console is no longer accessible on the frontend URL of Keycloak, you need to configure a fixed admin
URL in the default hostname provider.</p>
</div>
<div class="sect3">
<h4 id="ip-restriction"><a class="anchor" href="#ip-restriction"></a>IP Restriction</h4>
<div class="paragraph">
<p>It is possible to restrict access to <code>/auth/admin</code> to only specific IP addresses.</p>
</div>
<div class="paragraph">
<p>The following example restricts access to <code>/auth/admin</code> to IP addresses in the range <code>10.0.0.1</code> to <code>10.0.0.255</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:11.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
        <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-host</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
            <span class="tag">&lt;filter-ref</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ipAccess</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/host&gt;</span>
    <span class="tag">&lt;/server&gt;</span>
    <span class="tag">&lt;filters&gt;</span>
        <span class="tag">&lt;expression-filter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ipAccess</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">path-prefix('/auth/admin') -</span></span><span class="error">&gt;</span> ip-access-control(acl={'10.0.0.0/24 allow'})&quot;/<span class="error">&gt;</span>
    <span class="tag">&lt;/filters&gt;</span>
    ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Equivalent configuration using CLI commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">/subsystem=undertow/configuration=filter/expression-filter=ipAccess:add(,expression=&quot;path-prefix[/auth/admin] -&gt; ip-access-control(acl={'10.0.0.0/24 allow'})&quot;)
/subsystem=undertow/server=default-server/host=default-host/filter-ref=ipAccess:add()</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For IP restriction if you are using a proxy it is important to configure it correctly to make sure Keycloak
receives the client IP address and not the proxy IP address
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="port-restriction"><a class="anchor" href="#port-restriction"></a>Port Restriction</h4>
<div class="paragraph">
<p>It is possible to expose <code>/auth/admin</code> to a different port that is not exposed on the Internet.</p>
</div>
<div class="paragraph">
<p>The following example exposes <code>/auth/admin</code> on port <code>8444</code> while not permitting access with the default port <code>8443</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:11.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
        <span class="tag">&lt;https-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ApplicationRealm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enable-http2</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;https-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https-admin</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https-admin</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ApplicationRealm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enable-http2</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-host</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
            <span class="tag">&lt;filter-ref</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">portAccess</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/host&gt;</span>
    <span class="tag">&lt;/server&gt;</span>
    <span class="tag">&lt;filters&gt;</span>
        <span class="tag">&lt;expression-filter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">portAccess</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">path-prefix('/auth/admin') and not equals(%p, 8444) -</span></span><span class="error">&gt;</span> response-code(403)&quot;/<span class="error">&gt;</span>
    <span class="tag">&lt;/filters&gt;</span>
    ...
<span class="tag">&lt;/subsystem&gt;</span>

...

<span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.socket.binding.port-offset:0}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.https.port:8443}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https-admin</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.https.port:8444}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Equivalent configuration using CLI commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">/socket-binding-group=standard-sockets/socket-binding=https-admin/:add(port=8444)

/subsystem=undertow/server=default-server/https-listener=https-admin:add(socket-binding=https-admin, security-realm=ApplicationRealm, enable-http2=true)

/subsystem=undertow/configuration=filter/expression-filter=portAccess:add(,expression=&quot;path-prefix('/auth/admin') and not equals(%p, 8444) -&gt; response-code(403)&quot;)
/subsystem=undertow/server=default-server/host=default-host/filter-ref=portAccess:add()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="password-guess-brute-force-attacks"><a class="anchor" href="#password-guess-brute-force-attacks"></a>Password guess: brute force attacks</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/brute-force.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/brute-force.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>A brute force attack happens when an attacker is trying to guess a user&#8217;s password.
Keycloak has some limited brute force detection capabilities.
If turned on, a user account will be temporarily disabled if a threshold of login failures is reached.
To enable this feature go to the <code>Realm Settings</code> left menu item, click on the <code>Security Defenses</code> tab, then additional
go to the <code>Brute Force Detection</code> sub-tab.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Brute Force Detection is disabled by default. Enabling this feature is highly recommended to protect against this type of attack.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Brute Force Detection</div>
<p><span class="image"><img src="./keycloak-images/brute-force.png" alt="brute force"></span></p>
</div>
<div class="paragraph">
<p>There are 2 different configurations for brute force detection; permanent lockout and temporary lockout. Permanent lockout will disable a user&#8217;s account after an attack is detected; the account will be disabled until an administrator renables it. Temporary lockout will disable a user&#8217;s account for a time period after an attack is detected; the time period for which the account is disabled increases the longer the attack continues.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When user is temporarily locked and attempt to login, the default error message <code>Invalid username or password</code> is shown.
This is the same error message as the message displayed when invalid username or invalid password is provided. This is by design as
we do not want to reveal to the attacker that user is temporarily disabled.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Common Parameters</strong></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Max Login Failures</dt>
<dd>
<p>Maximum number of login failures permitted. Default value is 30.</p>
</dd>
<dt class="hdlist1">Quick Login Check Milli Seconds</dt>
<dd>
<p>Minimum time required between login attempts. Default is 1000.</p>
</dd>
<dt class="hdlist1">Minimum Quick Login Wait</dt>
<dd>
<p>Minimum amount of time the user will be temporarily disabled if logins attempts are quicker than <em>Quick Login Check Milli Seconds</em>. Default is 1 minute.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>Temporary Lockout Parameters</strong></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Wait Increment</dt>
<dd>
<p>Amount of time added to the time a user is temporarily disabled after each time <em>Max Login Failures</em> is reached. Default is 1 minute.</p>
</dd>
<dt class="hdlist1">Max Wait</dt>
<dd>
<p>The maximum amount of time for which a user will be temporarily disabled. Default is 15 minutes.</p>
</dd>
<dt class="hdlist1">Failure Reset Time</dt>
<dd>
<p>Time after which the failure count will be reset; timer runs from the last failed login. Default is 12 hours.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>Permanent Lockout Algorithm</strong></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On successful login</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Reset <code>count</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>On failed login</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Increment <code>count</code></p>
</li>
<li>
<p>If <code>count</code> greater than <em>Max Login Failures</em></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Permanently disable user</p>
</li>
</ol>
</div>
</li>
<li>
<p>Else if time between this failure and the last failure is less than <em>Quick Login Check Milli Seconds</em></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Temporarily disable user for <em>Minimum Quick Login Wait</em></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>When a user is disabled they can not login until an administrator enables the user; enabling an account resets <code>count</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>Temporary Lockout Algorithm</strong></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On successful login</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Reset <code>count</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>On failed login</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If time between this failure and the last failure is greater than <em>Failure Reset Time</em></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Reset <code>count</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Increment <code>count</code></p>
</li>
<li>
<p>Calculate <code>wait</code> using <em>Wait Increment</em> * (<code>count</code> / <em>Max Login Failures</em>). The division is an integer division so will always be rounded down to a whole number</p>
</li>
<li>
<p>If <code>wait</code> equals 0 and time between this failure and the last failure is less than <em>Quick Login Check Milli Seconds</em> then set <code>wait</code> to <em>Minimum Quick Login Wait</em> instead</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Temporarily disable the user for the smaller of <code>wait</code> and <em>Max Wait</em> seconds</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Login failures when a user is temporarily disabled do not increment <code>count</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The downside of Keycloak brute force detection is that the server becomes vulnerable to denial of service attacks.
An attacker can simply try to guess passwords for any accounts it knows and these account will be disabled.
Eventually we will expand this functionality to take client IP address into account when deciding whether to block a user.</p>
</div>
<div class="paragraph">
<p>A better option might be a tool like <a href="http://www.fail2ban.org/wiki/index.php/Main_Page">Fail2Ban</a>.  You can point this service at the Keycloak server&#8217;s log file.
Keycloak logs every login failure and client IP address that had the failure.  Fail2Ban can be used to modify
firewalls after it detects an attack to block connections from specific IP addresses.</p>
</div>
<div class="sect3">
<h4 id="password-policies"><a class="anchor" href="#password-policies"></a>Password Policies</h4>
<div class="paragraph">
<p>Another thing you should do to prevent password guess is to have a complex enough password policy to ensure that
users pick hard to guess passwords.  See the <a href="#_password-policies">Password Policies</a> chapter for more details.</p>
</div>
<div class="paragraph">
<p>The best way to prevent password guessing though is to set up the server to use a one-time-password (OTP).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_read_only_user_attributes"><a class="anchor" href="#_read_only_user_attributes"></a>Read-only User Attributes</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/read-only-attributes.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/read-only-attributes.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Typical users who are stored in Keycloak have various attributes related to their user profiles. Such attributes include email, firstName or lastname.
However users may also have attributes, which are not typical profile data, but rather metadata. The metadata attributes usually should be read-only for the users
and the typical users never should have a way to update those attributes from the Keycloak user interface or Account REST API. Some of the attributes should
be even read-only for the administrators when creating or updating user with the Admin REST API.</p>
</div>
<div class="paragraph">
<p>The metadata attributes are usually attributes from those groups:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Various links or metadata related to the user storage providers. For example in case of the LDAP integration, the <code>LDAP_ID</code> attribute contains
the ID of the user in the LDAP server.</p>
</li>
<li>
<p>Metadata provisioned by User Storage. For example <code>createdTimestamp</code> provisioned from the LDAP should be always read-only by user or administrator.</p>
</li>
<li>
<p>Metadata related to various authenticators. For example <code>KERBEROS_PRINCIPAL</code> attribute can contain the kerberos principal name of the particular user. Similarly attribute
<code>usercertificate</code> can contain metadata related to binding the user with the data from the X.509 certificate, which is used typically when X.509 certificate authentication is enabled.</p>
</li>
<li>
<p>Metadata related to the identificator of users by the applications/clients. For example <code>saml.persistent.name.id.for.my_app</code> can contain SAML NameID, which will
be used by the client application <code>my_app</code> as the identifier of the user.</p>
</li>
<li>
<p>Metadata related to the authorization policies, which are used for the attribute based access control (ABAC). Values of those attributes may be used for the
authorization decisions. Hence it is important that those attributes cannot be updated by the users.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From the long term perspective, Keycloak will have a proper User Profile SPI, which will allow fine-grained configuration of every user attribute. Currently
this capability is not fully available yet. So Keycloak has the internal list of user attributes, which are read-only for the users and read-only for the administrators configured
at the server level.</p>
</div>
<div class="paragraph">
<p>This is the list of the read-only attributes, which are used internally by the Keycloak default providers and functionalities and hence are always read-only:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For users: <code>KERBEROS_PRINCIPAL</code>, <code>LDAP_ID</code>, <code>LDAP_ENTRY_DN</code>, <code>CREATED_TIMESTAMP</code>, <code>createTimestamp</code>, <code>modifyTimestamp</code>, <code>userCertificate</code>, <code>saml.persistent.name.id.for.*</code>, <code>ENABLED</code>, <code>EMAIL_VERIFIED</code></p>
</li>
<li>
<p>For administrators: <code>KERBEROS_PRINCIPAL</code>, <code>LDAP_ID</code>, <code>LDAP_ENTRY_DN</code>, <code>CREATED_TIMESTAMP</code>, <code>createTimestamp</code>, <code>modifyTimestamp</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>System administrators have a way to add additional attributes to this list. The configuration is currently available at the server level.
You can add this configuration to your <code>standalone(-*).xml</code> files to the configuration of the Keycloak server subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">&lt;spi name="userProfile"&gt;
    &lt;provider name="legacy-user-profile" enabled="true"&gt;
        &lt;properties&gt;
            &lt;property name="read-only-attributes" value="[&amp;quot;foo&amp;quot;,&amp;quot;bar*&amp;quot;]"/&gt;
            &lt;property name="admin-read-only-attributes" value="[&amp;quot;foo&amp;quot;]"/&gt;
        &lt;/properties&gt;
    &lt;/provider&gt;
&lt;/spi&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The same can be configured with the usage of the JBoss CLI with the commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">/subsystem=keycloak-server/spi=userProfile/:add
/subsystem=keycloak-server/spi=userProfile/provider=legacy-user-profile/:add(properties={},enabled=true)
/subsystem=keycloak-server/spi=userProfile/provider=legacy-user-profile/:map-put(name=properties,key=read-only-attributes,value=[foo,bar*])
/subsystem=keycloak-server/spi=userProfile/provider=legacy-user-profile/:map-put(name=properties,key=admin-read-only-attributes,value=[foo])</pre>
</div>
</div>
<div class="paragraph">
<p>For this example, users and administrators would not be able to update attribute <code>foo</code>. Users would not be able to edit any attributes starting with the <code>bar</code>.
So for example <code>bar</code> or <code>barrier</code>. Configuration is case insensitive, so attributes like <code>FOO</code> or <code>BarRier</code> will be denied as well for this example. The wildcard character <code>*</code> is supported
only at the end of the attribute name, so the administrator can effectively deny all the attributes starting with the specified character. The <code>*</code> in the middle of the attribute is considered
as a normal character.</p>
</div>
</div>
<div class="sect2">
<h3 id="clickjacking"><a class="anchor" href="#clickjacking"></a>Clickjacking</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/clickjacking.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/clickjacking.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>With clickjacking, a malicious site loads the target site in a transparent iFrame overlaid on top of a set of dummy
buttons that are carefully constructed to be placed directly under important buttons on the target site.
When a user clicks a visible button, they are actually clicking a button (such as a "login" button) on the hidden page.
An attacker can steal a user&#8217;s authentication credentials and access their resources.</p>
</div>
<div class="paragraph">
<p>By default, every response by Keycloak sets some specific browser headers that can prevent this from happening.
Specifically, it sets <a href="https://tools.ietf.org/html/rfc7034">X-FRAME_OPTIONS</a> and <a href="http://www.w3.org/TR/CSP/">Content-Security-Policy</a>.
You should take a look at the definition of both of these headers as there is a lot of fine-grain browser access you can control.
In the admin console you can specify the values these headers will have.  Go to the <code>Realm Settings</code> left menu item and
click the <code>Security Defenses</code> tab and make sure you are on the <code>Headers</code> sub-tab.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/security-headers.png" alt="security headers"></span></p>
</div>
<div class="paragraph">
<p>By default, Keycloak only sets up a <em>same-origin</em> policy for iframes.</p>
</div>
</div>
<div class="sect2">
<h3 id="ssl-https-requirement"><a class="anchor" href="#ssl-https-requirement"></a>SSL/HTTPS Requirement</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/ssl.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/ssl.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If you do not use SSL/HTTPS for all communication between the Keycloak auth server and the clients it secures, you will be very vulnerable to man in the middle attacks.
OAuth 2.0/OpenID Connect uses access tokens for security.
Without SSL/HTTPS, attackers can sniff your network and obtain an access token.
Once they have an access token they can do any operation that the token has been given permission for.</p>
</div>
<div class="paragraph">
<p>Keycloak has <a href="#_ssl_modes">three modes for SSL/HTTPS</a>.
SSL can be hard to set up, so out of the box, Keycloak allows non-HTTPS communication over private IP addresses like
localhost, 192.168.x.x, and other private IP addresses.
In production, you should make sure SSL is enabled and required across the board.</p>
</div>
<div class="paragraph">
<p>On the adapter/client side, Keycloak allows you to turn off the SSL trust manager.
The trust manager ensures identity the client is talking to.
It checks the DNS domain name against the server&#8217;s certificate.
In production you should make sure that each of your client adapters is configured to use a truststore.
Otherwise you are vulnerable to DNS man in the middle attacks.</p>
</div>
</div>
<div class="sect2">
<h3 id="csrf-attacks"><a class="anchor" href="#csrf-attacks"></a>CSRF Attacks</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/csrf.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/csrf.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Cross-site request forgery (CSRF) is a web-based attack whereby HTTP requests are transmitted from a user that the
web site trusts or has authenticated with(e.g. via HTTP redirects or HTML forms).  Any site that uses cookie based authentication is vulnerable to these types of attacks.
These attacks are mitigated by matching a state cookie against a posted form or query parameter.</p>
</div>
<div class="paragraph">
<p>The OAuth 2.0 login specification requires that a state cookie be used and matched against a transmitted state parameter.
Keycloak fully implements this part of the specification so all logins are protected.</p>
</div>
<div class="paragraph">
<p>The Keycloak Admin Console is a pure JavaScript/HTML5 application that makes REST calls to the backend Keycloak admin REST API.
These calls all require bearer token authentication and are made via JavaScript Ajax calls.
CSRF does not apply here.
The admin REST API can also be configured to validate the CORS origins as well.</p>
</div>
<div class="paragraph">
<p>The only part of Keycloak that really falls into CSRF is the user account management pages.
To mitigate this Keycloak sets a state cookie and also embeds the value of this state cookie within hidden form fields or query parameters in action links.
This query or form parameter is checked against the state cookie to verify that the call was made by the user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unspecific-redirect-uris"><a class="anchor" href="#_unspecific-redirect-uris"></a>Unspecific Redirect URIs</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/redirect.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/redirect.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>For the <a href="#_oidc-auth-flows">Authorization Code Flow</a>, if you register redirect URIs that
are too general, then it would be possible for a rogue client to impersonate a different client that has a broader scope
of access.  This could happen for instance if two clients live under the same domain.  So, it&#8217;s a good idea to make your
registered redirect URIs as specific as feasible.</p>
</div>
</div>
<div class="sect2">
<h3 id="compromised-access-and-refresh-tokens"><a class="anchor" href="#compromised-access-and-refresh-tokens"></a>Compromised Access and Refresh Tokens</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/compromised-tokens.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/compromised-tokens.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are a few things you can do to mitigate access tokens and refresh tokens from being stolen. The most important thing is to enforce SSL/HTTPS communication between Keycloak and its clients and applications. It might seem obvious, but since Keycloak does not have SSL enabled by default, an administrator might not realize that it is necessary.</p>
</div>
<div class="paragraph">
<p>Another thing you can do to mitigate leaked access tokens is to shorten their lifespans.  You can specify this within the <a href="#_timeouts">timeouts page</a>.
Short lifespans (minutes) for access tokens for clients and applications to refresh their access tokens after a short amount of time. If an admin detects a leak, they can logout all user sessions to invalidate these refresh tokens or set up a revocation policy. Making sure refresh tokens always stay private to the client and are never transmitted ever is very important as well.</p>
</div>
<div class="paragraph">
<p>You can also mitigate against leaked access tokens and refresh tokens by issuing these tokens as holder-of-key tokens. See <a href="#_mtls-client-certificate-bound-tokens">OAuth 2.0 Mutual TLS Client Certificate Bound Access Token</a> to learn how.</p>
</div>
<div class="paragraph">
<p>If an access token or refresh token is compromised, the first thing you should do is go to the admin console and push a not-before revocation policy to all applications. This will enforce that any tokens issued prior to that date are now invalid. Pushing new not-before policy will also ensure that application will be forced to download new public keys from Keycloak, hence it is also useful for the case, when you think that realm signing key was compromised.
More info in the  <a href="#realm_keys">keys chapter</a>.</p>
</div>
<div class="paragraph">
<p>You can also disable specific applications, clients, and users if you feel that any one of those entities is completely compromised.</p>
</div>
</div>
<div class="sect2">
<h3 id="compromised-authorization-code"><a class="anchor" href="#compromised-authorization-code"></a>Compromised Authorization Code</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/compromised-codes.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/compromised-codes.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>For the <a href="#_oidc-auth-flows">OIDC Auth Code Flow</a>, it would be very hard for an attacker to compromise Keycloak authorization codes.
Keycloak generates a cryptographically strong random value for its authorization codes so it would be very hard to guess an access token.
An authorization code can only be used once to obtain an access token.
In the admin console you can specify how long an authorization code is valid for on the <a href="#_timeouts">timeouts page</a>.
This value should be really short, as short as a few seconds and just long enough for the client to make the request to obtain a token from the code.</p>
</div>
<div class="paragraph">
<p>You can also mitigate against leaked autorization codes by applying PKCE to clients. See <a href="#_proof-key-for-code-exchange">Proof Key for Code Exchange (PKCE)</a> to learn how.</p>
</div>
</div>
<div class="sect2">
<h3 id="open-redirectors"><a class="anchor" href="#open-redirectors"></a>Open redirectors</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/open-redirect.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/open-redirect.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>An attacker could use the end-user authorization endpoint and the redirect URI parameter to abuse the authorization server as an open redirector.
An open redirector is an endpoint using a parameter to automatically redirect a user agent to the location specified by the parameter value without any validation.
An attacker could utilize a user&#8217;s trust in an authorization server to launch a phishing attack.</p>
</div>
<div class="paragraph">
<p>Keycloak requires that all registered applications and clients register at least one redirection URI pattern.
Any time a client asks Keycloak to perform a redirect (on login or logout for example), Keycloak will check the redirect URI vs.
the list of valid registered URI patterns.
It is important that clients and applications register as specific a URI pattern as possible to mitigate open redirector attacks.</p>
</div>
</div>
<div class="sect2">
<h3 id="password-database-compromised"><a class="anchor" href="#password-database-compromised"></a>Password database compromised</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/password-db-compromised.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/password-db-compromised.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak does not store passwords in raw text.
It stores a hash of them using the PBKDF2 algorithm.  It actually uses
a default of 20,000 hashing iterations!  This is the security community&#8217;s recommended number of iterations.
This can be a rather large performance hit on your system as PBKDF2, by design, gobbles up a significant amount of CPU.
It is up to you to decide how serious you want to be to protect your password database.</p>
</div>
</div>
<div class="sect2">
<h3 id="limiting-scope"><a class="anchor" href="#limiting-scope"></a>Limiting Scope</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/scope.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/scope.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>By default, each new client application has an unlimited <code>role scope mappings</code>.  This means that every access token that is created
for that client will contain all the permissions the user has.  If the client gets compromised and the access token
is leaked, then each system that the user has permission to access is now also compromised.  It is highly suggested
that you limit the roles an access token is assigned by using the <a href="#_role_scope_mappings">Scope menu</a> for each client.
Or alternatively, you can set role scope mappings at the Client Scope level and assign Client Scopes to your client by using the
<a href="#_client_scopes_linking">Client Scope menu</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="limit-token-audience"><a class="anchor" href="#limit-token-audience"></a>Limit Token Audience</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/audience-limit.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/audience-limit.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>In environments where the level of trust among services is low, it is a good practice to limit the audiences on the token. The
motivation behind this is described in the <a href="https://tools.ietf.org/html/rfc6819#section-5.1.5.5">OAuth2 Threat Model</a> document and
more details are in the <a href="#_audience">Audience Support section</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sql-injection-attacks"><a class="anchor" href="#sql-injection-attacks"></a>SQL Injection Attacks</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/threat/sql.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/threat/sql.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>At this point in time, there is no knowledge of any SQL injection vulnerabilities in Keycloak.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-admin-cli"><a class="anchor" href="#the-admin-cli"></a>The Admin CLI</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak-documentation/blob/master/server_admin/topics/admin-cli.adoc" target="_blank">Edit this section</a>
<a href="https://issues.redhat.com/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File:%20server_admin/topics/admin-cli.adoc" target="_blank">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>In previous chapters, we described how to use the Keycloak Admin Console to perform administrative tasks. You can also perform those tasks from the command-line interface (CLI) by using the Admin CLI command-line tool.</p>
</div>
<div class="sect2">
<h3 id="installing-the-admin-cli"><a class="anchor" href="#installing-the-admin-cli"></a>Installing the Admin CLI</h3>
<div class="paragraph">
<p>The Admin CLI is packaged inside Keycloak Server distribution. You can find execution scripts inside the <code class="filename">bin</code> directory.</p>
</div>
<div class="paragraph">
<p>The Linux script is called <code class="filename">kcadm.sh</code>, and the script for Windows is called <code class="filename">kcadm.bat</code>.</p>
</div>
<div class="paragraph">
<p>You can add the Keycloak server directory to your <code class="filename">PATH</code> to use the client from any location on your file system.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ export PATH=$PATH:$KEYCLOAK_HOME/bin
$ kcadm.sh</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; set PATH=%PATH%;%KEYCLOAK_HOME%\bin
c:\&gt; kcadm</pre>
</div>
</div>
<div class="paragraph">
<p>We assume the <code>KEYCLOAK_HOME</code> environment (env) variable is set to the path where you extracted the Keycloak Server distribution.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To avoid repetition, the rest of this document only gives Windows examples in places where the difference in the CLI is more than just in the <code class="command">kcadm</code> command name.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using-the-admin-cli"><a class="anchor" href="#using-the-admin-cli"></a>Using the Admin CLI</h3>
<div class="paragraph">
<p>The Admin CLI works by making HTTP requests to Admin REST endpoints. Access to them is protected and requires authentication.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Consult the Admin REST API documentation for details about JSON attributes for specific endpoints.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start an authenticated session by providing credentials, that is, logging in. You are ready to perform create, read, update, and delete (CRUD) operations.</p>
<div class="paragraph">
<p>For example, on</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh config credentials --server http://localhost:8080/auth --realm demo --user admin --client admin
$ kcadm.sh create realms -s realm=demorealm -s enabled=true -o
$ CID=$(kcadm.sh create clients -r demorealm -s clientId=my_client -s 'redirectUris=["http://localhost:8980/myapp/*"]' -i)
$ kcadm.sh get clients/$CID/installation/providers/keycloak-oidc-keycloak-json</pre>
</div>
</div>
</li>
<li>
<p>Windows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">c:\&gt; kcadm config credentials --server http://localhost:8080/auth --realm demo --user admin --client admin
c:\&gt; kcadm create realms -s realm=demorealm -s enabled=true -o
c:\&gt; kcadm create clients -r demorealm -s clientId=my_client -s "redirectUris=[\"http://localhost:8980/myapp/*\"]" -i &gt; clientid.txt
c:\&gt; set /p CID=&lt;clientid.txt
c:\&gt; kcadm get clients/%CID%/installation/providers/keycloak-oidc-keycloak-json</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>In a production environment, you must access Keycloak with <code>https:</code> to avoid exposing tokens to network sniffers. If a server&#8217;s certificate is not issued by one of the trusted certificate authorities (CAs) that are included in Java&#8217;s default certificate truststore, prepare a <code class="filename">truststore.jks</code> file and instruct the Admin CLI to use it.</p>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh config truststore --trustpass $PASSWORD ~/.keycloak/truststore.jks</pre>
</div>
</div>
</li>
<li>
<p>Windows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">c:\&gt; kcadm config truststore --trustpass %PASSWORD% %HOMEPATH%\.keycloak\truststore.jks</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="authenticating"><a class="anchor" href="#authenticating"></a>Authenticating</h3>
<div class="paragraph">
<p>When you log in with the Admin CLI, you specify a server endpoint URL and a realm, and then you specify a user name. Another option is to specify only a clientId, which results in using a special "service account". When you log in using a user name, you must use a password for the specified user. When you log in using a clientId, you only need the client secret, not the user password. You could also use <code class="command">Signed JWT</code> instead of the client secret.</p>
</div>
<div class="paragraph">
<p>Make sure the account used for the session has the proper permissions to invoke Admin REST API operations. For example, the <code>realm-admin</code> role of the <code>realm-management</code> client allows the user to administer the realm within which the user is defined.</p>
</div>
<div class="paragraph">
<p>There are two primary mechanisms for authentication. One mechanism uses <code class="command">kcadm config credentials</code> to start an authenticated session.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh config credentials --server http://localhost:8080/auth --realm master --user admin --password admin</pre>
</div>
</div>
<div class="paragraph">
<p>This approach maintains an authenticated session between the <code class="command">kcadm</code> command invocations by saving the obtained access token and the associated refresh token. It may also maintain other secrets in a private configuration file. See <a href="#_working_with_alternative_configurations">next chapter</a> for more information on the configuration file.</p>
</div>
<div class="paragraph">
<p>The second approach only authenticates each command invocation for the duration of that invocation. This approach increases the load on the server and the time spent with roundtrips obtaining tokens. The benefit of this approach is not needing to save any tokens between invocations, which means nothing is saved to disk. This mode is used when the <code class="command">--no-config</code> argument is specified.</p>
</div>
<div class="paragraph">
<p>For example, when performing an operation, we specify all the information required for authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get realms --no-config --server http://localhost:8080/auth --realm master --user admin --password admin</pre>
</div>
</div>
<div class="paragraph">
<p>Run the <code class="command">kcadm.sh help</code> command for more information on using the Admin CLI.</p>
</div>
<div class="paragraph">
<p>Run the <code class="command">kcadm.sh config credentials --help</code> command for more information about starting an authenticated session.</p>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_alternative_configurations"><a class="anchor" href="#_working_with_alternative_configurations"></a>Working with alternative configurations</h3>
<div class="paragraph">
<p>By default, the Admin CLI automatically maintains a configuration file called <code class="filename">kcadm.config</code> located under the user&#8217;s home directory. In Linux-based systems, the full path name is <code class="filename">$HOME/.keycloak/kcadm.config</code>. On Windows, the full path name is <code class="filename">%HOMEPATH%\.keycloak\kcadm.config</code>. You can use the <code class="command">--config</code> option to point to a different file or location so you can maintain multiple authenticated sessions in parallel.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is best to perform operations tied to a single configuration file from a single thread.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Make sure you do not make the configuration file visible to other users on the system. It contains access tokens and secrets that should be kept private. By default, the <code class="filename">~/.keycloak</code> directory and its content are created automatically with proper access limits. If the directory already exists, its permissions are not updated.</p>
</div>
<div class="paragraph">
<p>If your unique circumstances require you to avoid storing secrets inside a configuration file, you can do so. It will be less convenient and you will have to make more token requests. To not store secrets, use the <code class="command">--no-config</code> option with all your commands and specify all the authentication information needed by the <code class="command">config credentials</code> command with each <code class="command">kcadm</code> invocation.</p>
</div>
</div>
<div class="sect2">
<h3 id="basic-operations-and-resource-uris"><a class="anchor" href="#basic-operations-and-resource-uris"></a>Basic operations and resource URIs</h3>
<div class="paragraph">
<p>The Admin CLI allows you to generically perform CRUD operations against Admin REST API endpoints with additional commands that simplify performing certain tasks.</p>
</div>
<div class="paragraph">
<p>The main usage pattern is listed below, where the <code class="command">create</code>, <code class="command">get</code>, <code class="command">update</code>, and <code class="command">delete</code> commands are mapped to the HTTP verbs <code>POST</code>, <code>GET</code>, <code>PUT</code>, and <code>DELETE</code>, respectively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create ENDPOINT [ARGUMENTS]
$ kcadm.sh get ENDPOINT [ARGUMENTS]
$ kcadm.sh update ENDPOINT [ARGUMENTS]
$ kcadm.sh delete ENDPOINT [ARGUMENTS]</pre>
</div>
</div>
<div class="paragraph">
<p>ENDPOINT is a target resource URI and can either be absolute (starting with <code>http:</code> or <code>https:</code>) or relative, used to compose an absolute URL of the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">SERVER_URI/admin/realms/REALM/ENDPOINT</pre>
</div>
</div>
<div class="paragraph">
<p>For example, if you authenticate against the server <a href="http://localhost:8080/auth" class="bare">http://localhost:8080/auth</a> and realm is <code class="filename">master</code>, then using <code class="filename">users</code> as ENDPOINT results in the resource URL <a href="http://localhost:8080/auth/admin/realms/master/users" class="bare">http://localhost:8080/auth/admin/realms/master/users</a>.</p>
</div>
<div class="paragraph">
<p>If you set ENDPOINT to <code class="filename">clients</code>, the effective resource URI would be <a href="http://localhost:8080/auth/admin/realms/master/clients" class="bare">http://localhost:8080/auth/admin/realms/master/clients</a>.</p>
</div>
<div class="paragraph">
<p>There is a <code class="filename">realms</code> endpoint that is treated slightly differently because it is the container for realms. It resolves to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">SERVER_URI/admin/realms</pre>
</div>
</div>
<div class="paragraph">
<p>There is also a <code class="filename">serverinfo</code> endpoint, which is treated the same way because it is independent of realms.</p>
</div>
<div class="paragraph">
<p>When you authenticate as a user with realm-admin powers, you might need to perform commands on multiple realms. In that case, specify the <code class="command">-r</code> option to tell explicitly which realm the command should be executed against. Instead of using <code class="filename">REALM</code> as specified via the <code class="command">--realm</code> option of <code class="command">kcadm.sh config credentials</code>, the <code class="filename">TARGET_REALM</code> is used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">SERVER_URI/admin/realms/TARGET_REALM/ENDPOINT</pre>
</div>
</div>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh config credentials --server http://localhost:8080/auth --realm master --user admin --password admin
$ kcadm.sh create users -s username=testuser -s enabled=true -r demorealm</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, you start a session authenticated as the <code class="filename">admin</code> user in the <code class="filename">master</code> realm. You then perform a POST call against the resource URL <code class="filename"><a href="http://localhost:8080/auth/admin/realms/demorealm/users" class="bare">http://localhost:8080/auth/admin/realms/demorealm/users</a></code>.</p>
</div>
<div class="paragraph">
<p>The <code class="command">create</code> and <code class="command">update</code> commands send a JSON body to the server by default. You can use <code class="filename">-f FILENAME</code> to read a premade document from a file. When you can use <code class="command">-f -</code> option, the message body is read from standard input. You can also specify individual attributes and their values as seen in the previous <code class="command">create users</code> example. They are composed into a JSON body and sent to the server.</p>
</div>
<div class="paragraph">
<p>There are several ways to update a resource using the <code class="command">update</code> command. You can first determine the current state of a resource and save it to a file, and then edit that file and send it to the server for updating.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcadm.sh get realms/demorealm &gt; demorealm.json
$ vi demorealm.json
$ kcadm.sh update realms/demorealm -f demorealm.json</pre>
</div>
</div>
<div class="paragraph">
<p>This method updates the resource on the server with all the attributes in the sent JSON document.</p>
</div>
<div class="paragraph">
<p>Another option is to perform an on-the-fly update using the <code class="command">-s, --set</code> options to set new values.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcadm.sh update realms/demorealm -s enabled=false</pre>
</div>
</div>
<div class="paragraph">
<p>That method only updates the <code class="command">enabled</code> attribute to <code>false</code>.</p>
</div>
<div class="paragraph">
<p>By default, the <code class="commamd">update</code> command first performs a <code class="command">get</code> and then merges the new attribute values with existing values. This is the preferred behavior. In some cases, the endpoint may support the <code class="command">PUT</code> command but not the <code class="command">GET</code> command. You can use the <code class="command">-n</code> option to perform a "no-merge" update, which performs a <code class="command">PUT</code> command without first running a <code class="command">GET</code> command.</p>
</div>
</div>
<div class="sect2">
<h3 id="realm-operations"><a class="anchor" href="#realm-operations"></a>Realm operations</h3>
<h4 id="creating-a-new-realm" class="discrete">Creating a new realm</h4>
<div class="paragraph">
<p>Use the <code class="command">create</code> command on the <code>realms</code> endpoint to create a new enabled realm, and set the attributes to <code>realm</code> and <code>enabled</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create realms -s realm=demorealm -s enabled=true</pre>
</div>
</div>
<div class="paragraph">
<p>A realm is not enabled by default. By enabling it, you can use a realm immediately for authentication.</p>
</div>
<div class="paragraph">
<p>A description for a new object can also be in a JSON format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create realms -f demorealm.json</pre>
</div>
</div>
<div class="paragraph">
<p>You can send a JSON document with realm attributes directly from a file or piped to a standard input.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcadm.sh create realms -f - &lt;&lt; EOF
{ "realm": "demorealm", "enabled": true }
EOF</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; echo { "realm": "demorealm", "enabled": true } | kcadm create realms -f -</pre>
</div>
</div>
<h4 id="listing-existing-realms" class="discrete">Listing existing realms</h4>
<div class="paragraph">
<p>The following command returns a list of all realms.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get realms</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A list of realms is additionally filtered on the server to return only realms a user can see.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Returning the entire realm description often provides too much information. Most users are interested only in a subset of attributes, such as realm name and whether the realm is enabled. You can specify which attributes to return by using the <code class="command">--fields</code> option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get realms --fields realm,enabled</pre>
</div>
</div>
<div class="paragraph">
<p>You can also display the result as comma separated values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get realms --fields realm --format csv --noquotes</pre>
</div>
</div>
<h4 id="getting-a-specific-realm" class="discrete">Getting a specific realm</h4>
<div class="paragraph">
<p>You append a realm name to a collection URI to get an individual realm.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get realms/master</pre>
</div>
</div>
<h4 id="updating-a-realm" class="discrete">Updating a realm</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the <code class="command">-s</code> option to set new values for the attributes when you want to change only some of the realm&#8217;s attributes.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update realms/demorealm -s enabled=false</pre>
</div>
</div>
</li>
<li>
<p>If you want to set all writable attributes with new values, run a <code class="command">get</code> command, edit the current values in the JSON file, and resubmit.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get realms/demorealm &gt; demorealm.json
$ vi demorealm.json
$ kcadm.sh update realms/demorealm -f demorealm.json</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="deleting-a-realm" class="discrete">Deleting a realm</h4>
<div class="paragraph">
<p>Run the following command to delete a realm.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete realms/demorealm</pre>
</div>
</div>
<h4 id="turning-on-all-login-page-options-for-the-realm" class="discrete">Turning on all login page options for the realm</h4>
<div class="paragraph">
<p>Set the attributes controlling specific capabilities to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update realms/demorealm -s registrationAllowed=true -s registrationEmailAsUsername=true -s rememberMe=true -s verifyEmail=true -s resetPasswordAllowed=true -s editUsernameAllowed=true</pre>
</div>
</div>
<h4 id="listing-the-realm-keys" class="discrete">Listing the realm keys</h4>
<div class="paragraph">
<p>Use the <code class="command">get</code> operation on the <code class="filename">keys</code> endpoint of the target realm.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get keys -r demorealm</pre>
</div>
</div>
<h4 id="generating-new-realm-keys" class="discrete">Generating new realm keys</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get the ID of the target realm before adding a new RSA-generated key pair.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get realms/demorealm --fields id --format csv --noquotes</pre>
</div>
</div>
</li>
<li>
<p>Add a new key provider with a higher priority than the existing providers as revealed by <code class="command">kcadm.sh get keys -r demorealm</code>.</p>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create components -r demorealm -s name=rsa-generated -s providerId=rsa-generated -s providerType=org.keycloak.keys.KeyProvider -s parentId=959844c1-d149-41d7-8359-6aa527fca0b0 -s 'config.priority=["101"]' -s 'config.enabled=["true"]' -s 'config.active=["true"]' -s 'config.keySize=["2048"]'</pre>
</div>
</div>
</li>
<li>
<p>Windows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">c:\&gt; kcadm create components -r demorealm -s name=rsa-generated -s providerId=rsa-generated -s providerType=org.keycloak.keys.KeyProvider -s parentId=959844c1-d149-41d7-8359-6aa527fca0b0 -s "config.priority=[\"101\"]" -s "config.enabled=[\"true\"]" -s "config.active=[\"true\"]" -s "config.keySize=[\"2048\"]"</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Set the <code>parentId</code> attribute to the value of the target realm&#8217;s ID.</p>
<div class="paragraph">
<p>The newly added key should now become the active key as revealed by <code class="command">kcadm.sh get keys -r demorealm</code>.</p>
</div>
</li>
</ol>
</div>
<h4 id="adding-new-realm-keys-from-a-java-key-store-file" class="discrete">Adding new realm keys from a Java Key Store file</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a new key provider to add a new key pair already prepared as a JKS file on the server.</p>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create components -r demorealm -s name=java-keystore -s providerId=java-keystore -s providerType=org.keycloak.keys.KeyProvider -s parentId=959844c1-d149-41d7-8359-6aa527fca0b0 -s 'config.priority=["101"]' -s 'config.enabled=["true"]' -s 'config.active=["true"]' -s 'config.keystore=["/opt/keycloak/keystore.jks"]' -s 'config.keystorePassword=["secret"]' -s 'config.keyPassword=["secret"]' -s 'config.keyAlias=["localhost"]'</pre>
</div>
</div>
</li>
<li>
<p>Windows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">c:\&gt; kcadm create components -r demorealm -s name=java-keystore -s providerId=java-keystore -s providerType=org.keycloak.keys.KeyProvider -s parentId=959844c1-d149-41d7-8359-6aa527fca0b0 -s "config.priority=[\"101\"]" -s "config.enabled=[\"true\"]" -s "config.active=[\"true\"]" -s "config.keystore=[\"/opt/keycloak/keystore.jks\"]" -s "config.keystorePassword=[\"secret\"]" -s "config.keyPassword=[\"secret\"]" -s "config.keyAlias=[\"localhost\"]"</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Make sure to change the attribute values for <code>keystore</code>, <code>keystorePassword</code>, <code>keyPassword</code>, and <code>alias</code> to match your specific keystore.</p>
</li>
<li>
<p>Set the <code>parentId</code> attribute to the value of the target realm&#8217;s ID.</p>
</li>
</ol>
</div>
<h4 id="making-the-key-passive-or-disabling-the-key" class="discrete">Making the key passive or disabling the key</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the key you want to make passive</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get keys -r demorealm</pre>
</div>
</div>
</li>
<li>
<p>Use the key&#8217;s <code>providerId</code> attribute to construct an endpoint URI, such as <code class="filename">components/PROVIDER_ID</code>.</p>
</li>
<li>
<p>Perform an <code class="command">update</code>.</p>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update components/PROVIDER_ID -r demorealm -s 'config.active=["false"]'</pre>
</div>
</div>
</li>
<li>
<p>Windows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">c:\&gt; kcadm update components/PROVIDER_ID -r demorealm -s "config.active=[\"false\"]"</pre>
</div>
</div>
<div class="paragraph">
<p>You can update other key attributes.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Set a new <code>enabled</code> value to disable the key, for example, <code>config.enabled=["false"]</code>.</p>
</li>
<li>
<p>Set a new <code>priority</code> value to change the key&#8217;s priority, for example, <code>config.priority=["110"]</code>.</p>
</li>
</ol>
</div>
<h4 id="deleting-an-old-key" class="discrete">Deleting an old key</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure the key you are deleting has been passive and disabled to prevent any existing tokens held by applications and users from abruptly failing to work.</p>
</li>
<li>
<p>Identify the key you want to make passive.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get keys -r demorealm</pre>
</div>
</div>
</li>
<li>
<p>Use the <code>providerId</code> of that key to perform a delete.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete components/PROVIDER_ID -r demorealm</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="configuring-event-logging-for-a-realm" class="discrete">Configuring event logging for a realm</h4>
<div class="paragraph">
<p>Use the <code class="command">update</code> command on the <code class="filename">events/config</code> endpoint.</p>
</div>
<div class="paragraph">
<p>The <code>eventsListeners</code> attribute contains a list of EventListenerProviderFactory IDs that specify all event listeners receiving events. Separately, there are attributes that control a built-in event storage, which allows querying past events via the Admin REST API. There is separate control over logging of service calls (<code>eventsEnabled</code>) and auditing events triggered during Admin Console or Admin REST API (<code>adminEventsEnabled</code>). You may want to set up expiry of old events so that your database does not fill up; <code>eventsExpiration</code> is set to time-to-live expressed in seconds.</p>
</div>
<div class="paragraph">
<p>Here is an example of setting up a built-in event listener that receives all the events and logs them through jboss-logging. (Using a logger called <code>org.keycloak.events</code>, error events are logged as <code>WARN</code>, and others are logged as <code>DEBUG</code>.)</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcadm.sh update events/config -r demorealm -s 'eventsListeners=["jboss-logging"]'</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; kcadm update events/config -r demorealm -s "eventsListeners=[\"jboss-logging\"]"</pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of turning on storage of all available ERROR events&#8212;not including auditing events&#8212;for 2 days so they can be retrieved via Admin REST.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcadm.sh update events/config -r demorealm -s eventsEnabled=true -s 'enabledEventTypes=["LOGIN_ERROR","REGISTER_ERROR","LOGOUT_ERROR","CODE_TO_TOKEN_ERROR","CLIENT_LOGIN_ERROR","FEDERATED_IDENTITY_LINK_ERROR","REMOVE_FEDERATED_IDENTITY_ERROR","UPDATE_EMAIL_ERROR","UPDATE_PROFILE_ERROR","UPDATE_PASSWORD_ERROR","UPDATE_TOTP_ERROR","VERIFY_EMAIL_ERROR","REMOVE_TOTP_ERROR","SEND_VERIFY_EMAIL_ERROR","SEND_RESET_PASSWORD_ERROR","SEND_IDENTITY_PROVIDER_LINK_ERROR","RESET_PASSWORD_ERROR","IDENTITY_PROVIDER_FIRST_LOGIN_ERROR","IDENTITY_PROVIDER_POST_LOGIN_ERROR","CUSTOM_REQUIRED_ACTION_ERROR","EXECUTE_ACTIONS_ERROR","CLIENT_REGISTER_ERROR","CLIENT_UPDATE_ERROR","CLIENT_DELETE_ERROR"]' -s eventsExpiration=172800</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; kcadm update events/config -r demorealm -s eventsEnabled=true -s "enabledEventTypes=[\"LOGIN_ERROR\",\"REGISTER_ERROR\",\"LOGOUT_ERROR\",\"CODE_TO_TOKEN_ERROR\",\"CLIENT_LOGIN_ERROR\",\"FEDERATED_IDENTITY_LINK_ERROR\",\"REMOVE_FEDERATED_IDENTITY_ERROR\",\"UPDATE_EMAIL_ERROR\",\"UPDATE_PROFILE_ERROR\",\"UPDATE_PASSWORD_ERROR\",\"UPDATE_TOTP_ERROR\",\"VERIFY_EMAIL_ERROR\",\"REMOVE_TOTP_ERROR\",\"SEND_VERIFY_EMAIL_ERROR\",\"SEND_RESET_PASSWORD_ERROR\",\"SEND_IDENTITY_PROVIDER_LINK_ERROR\",\"RESET_PASSWORD_ERROR\",\"IDENTITY_PROVIDER_FIRST_LOGIN_ERROR\",\"IDENTITY_PROVIDER_POST_LOGIN_ERROR\",\"CUSTOM_REQUIRED_ACTION_ERROR\",\"EXECUTE_ACTIONS_ERROR\",\"CLIENT_REGISTER_ERROR\",\"CLIENT_UPDATE_ERROR\",\"CLIENT_DELETE_ERROR\"]" -s eventsExpiration=172800</pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to reset stored event types to <strong>all available event types</strong>; setting to empty list is the same as enumerating all.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update events/config -r demorealm -s enabledEventTypes=[]</pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to enable storage of auditing events.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update events/config -r demorealm -s adminEventsEnabled=true -s adminEventsDetailsEnabled=true</pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to get the last 100 events; they are ordered from newest to oldest.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get events --offset 0 --limit 100</pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of how to delete all saved events.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm delete events</pre>
</div>
</div>
<h4 id="flushing-the-caches" class="discrete">Flushing the caches</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the <code class="command">create</code> command and one of the following endpoints: <code class="filename">clear-realm-cache</code>, <code class="filename">clear-user-cache</code>, or <code class="filename">clear-keys-cache</code>.</p>
</li>
<li>
<p>Set <code>realm</code> to the same value as the target realm.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create clear-realm-cache -r demorealm -s realm=demorealm
$ kcadm.sh create clear-user-cache -r demorealm -s realm=demorealm
$ kcadm.sh create clear-keys-cache -r demorealm -s realm=demorealm</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="importing-a-realm-from-exported-json-file" class="discrete">Importing a realm from exported .json file</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the <code class="command">create</code> command on the <code class="filename">partialImport</code> endpoint.</p>
</li>
<li>
<p>Set <code>ifResourceExists</code> to one of <code>FAIL</code>, <code>SKIP</code>, <code>OVERWRITE</code>.</p>
</li>
<li>
<p>Use <code>-f</code> to submit the exported realm <code>.json</code> file</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create partialImport -r demorealm2 -s ifResourceExists=FAIL -o -f demorealm.json</pre>
</div>
</div>
<div class="paragraph">
<p>If realm does not yet exist, you first have to create it.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create realms -s realm=demorealm2 -s enabled=true</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="role-operations"><a class="anchor" href="#role-operations"></a>Role operations</h3>
<h4 id="creating-a-realm-role" class="discrete">Creating a realm role</h4>
<div class="paragraph">
<p>Use the <code class="filename">roles</code> endpoint to create a realm role.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create roles -r demorealm -s name=user -s 'description=Regular user with limited set of permissions'</pre>
</div>
</div>
<h4 id="creating-a-client-role" class="discrete">Creating a client role</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the client first and then use the <code class="command">get</code> command to list available clients when creating a client role.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get clients -r demorealm --fields id,clientId</pre>
</div>
</div>
</li>
<li>
<p>Create a new role by using the <code class="command">clientId</code> attribute to construct an endpoint URI, such as <code class="filename">clients/ID/roles</code>.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create clients/a95b6af3-0bdc-4878-ae2e-6d61a4eca9a0/roles -r demorealm -s name=editor -s 'description=Editor can edit, and publish any article'</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="listing-realm-roles" class="discrete">Listing realm roles</h4>
<div class="paragraph">
<p>Use the <code class="command">get</code> command on the <code class="filename">roles</code> endpoint to list existing realm roles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get roles -r demorealm</pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code class="command">get-roles</code> command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm</pre>
</div>
</div>
<h4 id="listing-client-roles" class="discrete">Listing client roles</h4>
<div class="paragraph">
<p>There is a dedicated <code class="command">get-roles</code> command to simplify listing realm and client roles. It is an extension of the <code class="command">get</code> command and behaves the same with additional semantics for listing roles.</p>
</div>
<div class="paragraph">
<p>Use the <code class="command">get-roles</code> command, passing it either the clientId attribute (via the <code class="command">--cclientid</code> option) or <code class="command">id</code> (via the <code class="command">--cid</code> option) to identify the client to list client roles.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --cclientid realm-management</pre>
</div>
</div>
<h4 id="getting-a-specific-realm-role" class="discrete">Getting a specific realm role</h4>
<div class="paragraph">
<p>Use the <code class="command">get</code> command and the role <code class="filename">name</code> to construct an endpoint URI for a specific realm role: <code class="filename">roles/ROLE_NAME</code>, where <code class="filename">user</code> is the name of the existing role.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get roles/user -r demorealm</pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the special <code class="command">get-roles</code> command, passing it a role name (via the <code class="command">--rolename</code> option) or ID (via the <code class="command">--roleid</code> option).</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --rolename user</pre>
</div>
</div>
<h4 id="getting-a-specific-client-role" class="discrete">Getting a specific client role</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">get-roles</code> command, passing it either the clientId attribute (via the <code class="command">--cclientid</code> option) or ID (via the <code class="command">--cid</code> option) to identify the client, and passing it either the role name (via the <code class="command">--rolename</code> option) or ID (via the <code class="command">--roleid</code>) to identify a specific client role.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --cclientid realm-management --rolename manage-clients</pre>
</div>
</div>
<h4 id="updating-a-realm-role" class="discrete">Updating a realm role</h4>
<div class="paragraph">
<p>Use the <code class="command">update</code> command with the same endpoint URI that you used to get a specific realm role.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update roles/user -r demorealm -s 'description=Role representing a regular user'</pre>
</div>
</div>
<h4 id="updating-a-client-role" class="discrete">Updating a client role</h4>
<div class="paragraph">
<p>Use the <code class="command">update</code> command with the same endpoint URI that you used to get a specific client role.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update clients/a95b6af3-0bdc-4878-ae2e-6d61a4eca9a0/roles/editor -r demorealm -s 'description=User that can edit, and publish articles'</pre>
</div>
</div>
<h4 id="deleting-a-realm-role" class="discrete">Deleting a realm role</h4>
<div class="paragraph">
<p>Use the <code class="command">delete</code> command with the same endpoint URI that you used to get a specific realm role.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete roles/user -r demorealm</pre>
</div>
</div>
<h4 id="deleting-a-client-role" class="discrete">Deleting a client role</h4>
<div class="paragraph">
<p>Use the <code class="command">delete</code> command with the same endpoint URI that you used to get a specific client role.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete clients/a95b6af3-0bdc-4878-ae2e-6d61a4eca9a0/roles/editor -r demorealm</pre>
</div>
</div>
<h4 id="listing-assigned-available-and-effective-realm-roles-for-a-composite-role" class="discrete">Listing assigned, available, and effective realm roles for a composite role</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">get-roles</code> command to list assigned, available, and effective realm roles for a composite role.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To list <strong>assigned</strong> realm roles for the composite role, you can specify the target composite role by either name (via the <code class="command">--rname</code> option) or ID (via the <code class="command">--rid</code> option).</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --rname testrole</pre>
</div>
</div>
</li>
<li>
<p>Use the additional <code class="command">--effective</code> option to list <strong>effective</strong> realm roles.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --rname testrole --effective</pre>
</div>
</div>
</li>
<li>
<p>Use the <code class="command">--available</code> option to list realm roles that can still be added to the composite role.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --rname testrole --available</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="listing-assigned-available-and-effective-client-roles-for-a-composite-role" class="discrete">Listing assigned, available, and effective client roles for a composite role</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">get-roles</code> command to list assigned, available, and effective client roles for a composite role.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To list <strong>assigned</strong> client roles for the composite role, you can specify the target composite role by either name (via the <code class="command">--rname</code> option) or ID (via the <code class="command">--rid</code> option) and client by either the clientId attribute (via the <code class="command">--cclientid</code> option) or ID (via the <code class="command">--cid</code> option).</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --rname testrole --cclientid realm-management</pre>
</div>
</div>
</li>
<li>
<p>Use the additional <code class="command">--effective</code> option to list <strong>effective</strong> realm roles.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --rname testrole --cclientid realm-management --effective</pre>
</div>
</div>
</li>
<li>
<p>Use the <code class="command">--available</code> option to list realm roles that can still be added to the target composite role.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --rname testrole --cclientid realm-management --available</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="adding-realm-roles-to-a-composite-role" class="discrete">Adding realm roles to a composite role</h4>
<div class="paragraph">
<p>There is a dedicated <code class="command">add-roles</code> command that can be used for adding realm roles and client roles.</p>
</div>
<div class="paragraph">
<p>The following example adds the <code class="command">user</code> role to the composite role <code class="command">testrole</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh add-roles --rname testrole --rolename user -r demorealm</pre>
</div>
</div>
<h4 id="removing-realm-roles-from-a-composite-role" class="discrete">Removing realm roles from a composite role</h4>
<div class="paragraph">
<p>There is a dedicated <code class="command">remove-roles</code> command that can be used to remove realm roles and client roles.</p>
</div>
<div class="paragraph">
<p>The following example removes the <code class="command">user</code> role from the target composite role <code class="command">testrole</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh remove-roles --rname testrole --rolename user -r demorealm</pre>
</div>
</div>
<h4 id="adding-client-roles-to-a-realm-role" class="discrete">Adding client roles to a realm role</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">add-roles</code> command that can be used for adding realm roles and client roles.</p>
</div>
<div class="paragraph">
<p>The following example adds the roles defined on the client <code class="command">realm-management</code> - <code>create-client</code> role and the <code class="command">view-users</code> role to the <code class="command">testrole</code> composite role.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh add-roles -r demorealm --rname testrole --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
<h4 id="adding-client-roles-to-a-client-role" class="discrete">Adding client roles to a client role</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Determine the ID of the composite client role by using the <code class="command">get-roles</code> command.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --cclientid test-client --rolename operations</pre>
</div>
</div>
</li>
<li>
<p>Assume that there is a client with a clientId attribute of <code class="filename">test-client</code>, a client role called <code class="filename">support</code>, and another client role called <code class="filename">operations</code>, which becomes a composite role, that has an ID of "fc400897-ef6a-4e8c-872b-1581b7fa8a71".</p>
</li>
<li>
<p>Use the following example to add another role to the composite role.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh add-roles -r demorealm --cclientid test-client --rid fc400897-ef6a-4e8c-872b-1581b7fa8a71 --rolename support</pre>
</div>
</div>
</li>
<li>
<p>List the roles of a composite role by using the <code class="command">get-roles --all</code> command.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles --rid fc400897-ef6a-4e8c-872b-1581b7fa8a71 --all</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="removing-client-roles-from-a-composite-role" class="discrete">Removing client roles from a composite role</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">remove-roles</code> command to remove client roles from a composite role.</p>
</div>
<div class="paragraph">
<p>Use the following example to remove two roles defined on the client <code class="command">realm-management</code> - <code>create-client</code> role and the <code class="command">view-users</code> role from the <code class="command">testrole</code> composite role.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh remove-roles -r demorealm --rname testrole --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
<h4 id="adding-client-roles-to-a-group" class="discrete">Adding client roles to a group</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">add-roles</code> command that can be used for adding realm roles and client roles.</p>
</div>
<div class="paragraph">
<p>The following example adds the roles defined on the client <code class="command">realm-management</code> - <code>create-client</code> role and the <code class="command">view-users</code> role to the <code class="command">Group</code> group (via the <code class="command">--gname</code> option). The group can alternatively be specified by ID (via the <code class="command">--gid</code> option).</p>
</div>
<div class="paragraph">
<p>See <a href="#_group_operations">Group operations</a> for more operations that can be performed to groups.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh add-roles -r demorealm --gname Group --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
<h4 id="removing-client-roles-from-a-group" class="discrete">Removing client roles from a group</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">remove-roles</code> command to remove client roles from a group.</p>
</div>
<div class="paragraph">
<p>Use the following example to remove two roles defined on the client <code class="command">realm management</code> - <code>create-client</code> role and the <code class="command">view-users</code> role from the <code class="command">Group</code> group.</p>
</div>
<div class="paragraph">
<p>See <a href="#_group_operations">Group operations</a> for more operations that can be performed to groups.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh remove-roles -r demorealm --gname Group --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="client-operations"><a class="anchor" href="#client-operations"></a>Client operations</h3>
<h4 id="creating-a-client" class="discrete">Creating a client</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the <code class="command">create</code> command on a <code class="filename">clients</code> endpoint to create a new client.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create clients -r demorealm -s clientId=myapp -s enabled=true</pre>
</div>
</div>
</li>
<li>
<p>Specify a secret if you want to set a secret for adapters to authenticate.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create clients -r demorealm -s clientId=myapp -s enabled=true -s clientAuthenticatorType=client-secret -s secret=d0b8122f-8dfb-46b7-b68a-f5cc4e25d000</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="listing-clients" class="discrete">Listing clients</h4>
<div class="paragraph">
<p>Use the <code class="command">get</code> command on the <code class="filename">clients</code> endpoint to list clients.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get clients -r demorealm --fields id,clientId</pre>
</div>
</div>
<div class="paragraph">
<p>This example filters the output to list only the <code class="filename">id</code> and <code class="filename">clientId</code> attributes.</p>
</div>
<h4 id="getting-a-specific-client" class="discrete">Getting a specific client</h4>
<div class="paragraph">
<p>Use a client&#8217;s ID to construct an endpoint URI that targets a specific client, such as <code class="filename">clients/ID</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm</pre>
</div>
</div>
<h4 id="getting-the-current-secret-for-a-specific-client" class="discrete">Getting the current secret for a specific client</h4>
<div class="paragraph">
<p>Use a client&#8217;s ID to construct an endpoint URI, such as <code class="filename">clients/ID/client-secret</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get clients/$CID/client-secret</pre>
</div>
</div>
<h4 id="generate-a-new-secret-for-a-specific-client" class="discrete">Generate a new secret for a specific client</h4>
<div class="paragraph">
<p>Use a client&#8217;s ID to construct an endpoint URI, such as <code class="filename">clients/ID/client-secret</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create clients/$CID/client-secret</pre>
</div>
</div>
<h4 id="updating-the-current-secret-for-a-specific-client" class="discrete">Updating the current secret for a specific client</h4>
<div class="paragraph">
<p>Use a client&#8217;s ID to construct an endpoint URI, such as <code class="filename">clients/ID</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update clients/$CID -s "secret=newSecret"</pre>
</div>
</div>
<h4 id="getting-an-adapter-configuration-file-keycloak-json-for-a-specific-client" class="discrete">Getting an adapter configuration file (keycloak.json) for a specific client</h4>
<div class="paragraph">
<p>Use a client&#8217;s ID to construct an endpoint URI that targets a specific client, such as <code class="filename">clients/ID/installation/providers/keycloak-oidc-keycloak-json</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get clients/c7b8547f-e748-4333-95d0-410b76b3f4a3/installation/providers/keycloak-oidc-keycloak-json -r demorealm</pre>
</div>
</div>
<h4 id="getting-a-wildfly-subsystem-adapter-configuration-for-a-specific-client" class="discrete">Getting a WildFly subsystem adapter configuration for a specific client</h4>
<div class="paragraph">
<p>Use a client&#8217;s ID to construct an endpoint URI that targets a specific client, such as <code class="filename">clients/ID/installation/providers/keycloak-oidc-jboss-subsystem</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get clients/c7b8547f-e748-4333-95d0-410b76b3f4a3/installation/providers/keycloak-oidc-jboss-subsystem -r demorealm</pre>
</div>
</div>
<h4 id="getting-a-docker-v2-example-configuration-for-a-specific-client" class="discrete">Getting a Docker-v2 example configuration for a specific client</h4>
<div class="paragraph">
<p>Use a client&#8217;s ID to construct an endpoint URI that targets a specific client, such as <code class="filename">clients/ID/installation/providers/docker-v2-compose-yaml</code>.</p>
</div>
<div class="paragraph">
<p>Note that response will be in <code>.zip</code> format.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get http://localhost:8080/auth/admin/realms/demorealm/clients/8f271c35-44e3-446f-8953-b0893810ebe7/installation/providers/docker-v2-compose-yaml -r demorealm &gt; keycloak-docker-compose-yaml.zip</pre>
</div>
</div>
<h4 id="updating-a-client" class="discrete">Updating a client</h4>
<div class="paragraph">
<p>Use the <code class="command">update</code> command with the same endpoint URI that you used to get a specific client.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcadm.sh update clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm -s enabled=false -s publicClient=true -s 'redirectUris=["http://localhost:8080/myapp/*"]' -s baseUrl=http://localhost:8080/myapp -s adminUrl=http://localhost:8080/myapp</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; kcadm update clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm -s enabled=false -s publicClient=true -s "redirectUris=[\"http://localhost:8080/myapp/*\"]" -s baseUrl=http://localhost:8080/myapp -s adminUrl=http://localhost:8080/myapp</pre>
</div>
</div>
<h4 id="deleting-a-client" class="discrete">Deleting a client</h4>
<div class="paragraph">
<p>Use the <code class="command">delete</code> command with the same endpoint URI that you used to get a specific client.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm</pre>
</div>
</div>
<h4 id="adding-or-removing-roles-for-client-s-service-account" class="discrete">Adding or removing roles for client&#8217;s service account</h4>
<div class="paragraph">
<p>Service account for the client is just a special kind of user account with username <code class="filename">service-account-CLIENT_ID</code>.
You can perform user operations on this account as if it was a regular user.</p>
</div>
</div>
<div class="sect2">
<h3 id="user-operations"><a class="anchor" href="#user-operations"></a>User operations</h3>
<h4 id="creating-a-user" class="discrete">Creating a user</h4>
<div class="paragraph">
<p>Run the <code class="command">create</code> command on the <code class="filename">users</code> endpoint to create a new user.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create users -r demorealm -s username=testuser -s enabled=true</pre>
</div>
</div>
<h4 id="listing-users" class="discrete">Listing users</h4>
<div class="paragraph">
<p>Use the <code class="filename">users</code> endpoint to list users. The target user will have to change the password the next time they log in.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get users -r demorealm --offset 0 --limit 1000</pre>
</div>
</div>
<div class="paragraph">
<p>You can filter users by <code class="filename">username</code>, <code class="filename">firstName</code>, <code class="filename">lastName</code>, or <code class="filename">email</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get users -r demorealm -q email=google.com
$ kcadm.sh get users -r demorealm -q username=testuser</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Filtering does not use exact matching. For example, the above example would match the value of the <code class="filename">username</code> attribute against the <code class="filename">*testuser*</code> pattern.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also filter across multiple attributes by specifying multiple <code class="command">-q</code> options, which return only users that match the condition for all the attributes.</p>
</div>
<h4 id="getting-a-specific-user" class="discrete">Getting a specific user</h4>
<div class="paragraph">
<p>Use a user&#8217;s ID to compose an endpoint URI, such as <code class="filename">users/USER_ID</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm</pre>
</div>
</div>
<h4 id="updating-a-user" class="discrete">Updating a user</h4>
<div class="paragraph">
<p>Use the <code class="command">update</code> command with the same endpoint URI that you used to get a specific user.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcadm.sh update users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm -s 'requiredActions=["VERIFY_EMAIL","UPDATE_PROFILE","CONFIGURE_TOTP","UPDATE_PASSWORD"]'</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; kcadm update users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm -s "requiredActions=[\"VERIFY_EMAIL\",\"UPDATE_PROFILE\",\"CONFIGURE_TOTP\",\"UPDATE_PASSWORD\"]"</pre>
</div>
</div>
<h4 id="deleting-a-user" class="discrete">Deleting a user</h4>
<div class="paragraph">
<p>Use the <code class="command">delete</code> command with the same endpoint URI that you used to get a specific user.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm</pre>
</div>
</div>
<h4 id="resetting-a-user-s-password" class="discrete">Resetting a user&#8217;s password</h4>
<div class="paragraph">
<p>Use the dedicated <code class="command">set-password</code> command to reset a user&#8217;s password.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh set-password -r demorealm --username testuser --new-password NEWPASSWORD --temporary</pre>
</div>
</div>
<div class="paragraph">
<p>That command sets a temporary password for the user. The target user will have to change the password the next time they log in.</p>
</div>
<div class="paragraph">
<p>You can use <code class="command">--userid</code> if you want to specify the user by using the <code class="filename">id</code> attribute.</p>
</div>
<div class="paragraph">
<p>You can achieve the same result using the <code class="command">update</code> command on an endpoint constructed from the one you used to get a specific user, such as <code class="filename">users/USER_ID/reset-password</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2/reset-password -r demorealm -s type=password -s value=NEWPASSWORD -s temporary=true -n</pre>
</div>
</div>
<div class="paragraph">
<p>The last parameter (<code class="command">-n</code>) ensures that only the <code class="command">PUT</code> command is performed without a prior <code class="command">GET</code> command. It is necessary in this instance because the <code class="command">reset-password</code> endpoint does not support <code class="command">GET</code>.</p>
</div>
<h4 id="listing-assigned-available-and-effective-realm-roles-for-a-user" class="discrete">Listing assigned, available, and effective realm roles for a user</h4>
<div class="paragraph">
<p>You can use a dedicated <code class="command">get-roles</code> command to list assigned, available, and effective realm roles for a user.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Specify the target user by either user name or ID to list <strong>assigned</strong> realm roles for the user.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --uusername testuser</pre>
</div>
</div>
</li>
<li>
<p>Use the additional <code class="command">--effective</code> option to list <strong>effective</strong> realm roles.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --uusername testuser --effective</pre>
</div>
</div>
</li>
<li>
<p>Use the <code class="command">--available</code> option to list realm roles that can still be added to the user.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --uusername testuser --available</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="listing-assigned-available-and-effective-client-roles-for-a-user" class="discrete">Listing assigned, available, and effective client roles for a user</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">get-roles</code> command to list assigned, available, and effective client roles for a user.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Specify the target user by either a user name (via the <code class="command">--uusername</code> option) or an ID (via the <code class="command">--uid</code> option) and client by either a clientId attribute (via the <code class="command">--cclientid</code> option) or an ID (via the <code class="command">--cid</code> option) to list <strong>assigned</strong> client roles for the user.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --uusername testuser --cclientid realm-management</pre>
</div>
</div>
</li>
<li>
<p>Use the additional <code class="command">--effective</code> option to list <strong>effective</strong> realm roles.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --uusername testuser --cclientid realm-management --effective</pre>
</div>
</div>
</li>
<li>
<p>Use the <code class="command">--available</code> option to list realm roles that can still be added to the user.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --uusername testuser --cclientid realm-management --available</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="adding-realm-roles-to-a-user" class="discrete">Adding realm roles to a user</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">add-roles</code> command to add realm roles to a user.</p>
</div>
<div class="paragraph">
<p>Use the following example to add the <code class="command">user</code> role to user <code class="command">testuser</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh add-roles --uusername testuser --rolename user -r demorealm</pre>
</div>
</div>
<h4 id="removing-realm-roles-from-a-user" class="discrete">Removing realm roles from a user</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">remove-roles</code> command to remove realm roles from a user.</p>
</div>
<div class="paragraph">
<p>Use the following example to remove the <code class="command">user</code> role from the user <code class="command">testuser</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh remove-roles --uusername testuser --rolename user -r demorealm</pre>
</div>
</div>
<h4 id="adding-client-roles-to-a-user" class="discrete">Adding client roles to a user</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">add-roles</code> command to add client roles to a user.</p>
</div>
<div class="paragraph">
<p>Use the following example to add two roles defined on the client <code class="command">realm management</code> - <code>create-client</code> role and the <code class="command">view-users</code> role to the user <code>testuser</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh add-roles -r demorealm --uusername testuser --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
<h4 id="removing-client-roles-from-a-user" class="discrete">Removing client roles from a user</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">remove-roles</code> command to remove client roles from a user.</p>
</div>
<div class="paragraph">
<p>Use the following example to remove two roles defined on the realm management client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh remove-roles -r demorealm --uusername testuser --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
<h4 id="listing-a-user-s-sessions" class="discrete">Listing a user&#8217;s sessions</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the user&#8217;s ID, and then use it to compose an endpoint URI, such as <code class="filename">users/ID/sessions</code>.</p>
</li>
<li>
<p>Use the <code class="command">get</code> command to retrieve a list of the user&#8217;s sessions.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$kcadm get users/6da5ab89-3397-4205-afaa-e201ff638f9e/sessions</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="logging-out-a-user-from-a-specific-session" class="discrete">Logging out a user from a specific session</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Determine the session&#8217;s ID as described above.</p>
</li>
<li>
<p>Use the session&#8217;s ID to compose an endpoint URI, such as <code class="filename">sessions/ID</code>.</p>
</li>
<li>
<p>Use the <code class="command">delete</code> command to invalidate the session.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete sessions/d0eaa7cc-8c5d-489d-811a-69d3c4ec84d1</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="logging-out-a-user-from-all-sessions" class="discrete">Logging out a user from all sessions</h4>
<div class="paragraph">
<p>You need a user&#8217;s ID to construct an endpoint URI, such as <code class="filename">users/ID/logout</code>.</p>
</div>
<div class="paragraph">
<p>Use the <code class="command">create</code> command to perform <code class="command">POST</code> on that endpoint URI.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create users/6da5ab89-3397-4205-afaa-e201ff638f9e/logout -r demorealm -s realm=demorealm -s user=6da5ab89-3397-4205-afaa-e201ff638f9e</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_group_operations"><a class="anchor" href="#_group_operations"></a>Group operations</h3>
<h4 id="creating-a-group" class="discrete">Creating a group</h4>
<div class="paragraph">
<p>Use the <code class="command">create</code> command on the <code class="filename">groups</code> endpoint to create a new group.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create groups -r demorealm -s name=Group</pre>
</div>
</div>
<h4 id="listing-groups" class="discrete">Listing groups</h4>
<div class="paragraph">
<p>Use the <code class="command">get</code> command on the <code class="filename">groups</code> endpoint to list groups.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get groups -r demorealm</pre>
</div>
</div>
<h4 id="getting-a-specific-group" class="discrete">Getting a specific group</h4>
<div class="paragraph">
<p>Use the group&#8217;s ID to construct an endpoint URI, such as <code>groups/GROUP_ID</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get groups/51204821-0580-46db-8f2d-27106c6b5ded -r demorealm</pre>
</div>
</div>
<h4 id="updating-a-group" class="discrete">Updating a group</h4>
<div class="paragraph">
<p>Use the <code class="command">update</code> command with the same endpoint URI that you used to get a specific group.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update groups/51204821-0580-46db-8f2d-27106c6b5ded -s 'attributes.email=["group@example.com"]' -r demorealm</pre>
</div>
</div>
<h4 id="deleting-a-group" class="discrete">Deleting a group</h4>
<div class="paragraph">
<p>Use the <code class="command">delete</code> command with the same endpoint URI that you used to get a specific group.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete groups/51204821-0580-46db-8f2d-27106c6b5ded -r demorealm</pre>
</div>
</div>
<h4 id="creating-a-subgroup" class="discrete">Creating a subgroup</h4>
<div class="paragraph">
<p>Find the ID of the parent group by listing groups, and then use that ID to construct an endpoint URI, such as <code class="filename">groups/GROUP_ID/children</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create groups/51204821-0580-46db-8f2d-27106c6b5ded/children -r demorealm -s name=SubGroup</pre>
</div>
</div>
<h4 id="moving-a-group-under-another-group" class="discrete">Moving a group under another group</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Find the ID of an existing parent group and of an existing child group.</p>
</li>
<li>
<p>Use the parent group&#8217;s ID to construct an endpoint URI, such as <code class="filename">groups/PARENT_GROUP_ID/children</code>.</p>
</li>
<li>
<p>Run the <code class="command">create</code> command on this endpoint and pass the child group&#8217;s ID as a JSON body.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create groups/51204821-0580-46db-8f2d-27106c6b5ded/children -r demorealm -s id=08d410c6-d585-4059-bb07-54dcb92c5094</pre>
</div>
</div>
<h4 id="get-groups-for-a-specific-user" class="discrete">Get groups for a specific user</h4>
<div class="paragraph">
<p>Use a user&#8217;s ID to determine a user&#8217;s membership in groups to compose an endpoint URI, such as <code class="filename">users/USER_ID/groups</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get users/b544f379-5fc4-49e5-8a8d-5cfb71f46f53/groups -r demorealm</pre>
</div>
</div>
<h4 id="adding-a-user-to-a-group" class="discrete">Adding a user to a group</h4>
<div class="paragraph">
<p>Use the <code class="command">update</code> command with an endpoint URI composed from user&#8217;s ID and a group&#8217;s ID, such as <code class="filename">users/USER_ID/groups/GROUP_ID</code>, to add a user to a group.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update users/b544f379-5fc4-49e5-8a8d-5cfb71f46f53/groups/ce01117a-7426-4670-a29a-5c118056fe20 -r demorealm -s realm=demorealm -s userId=b544f379-5fc4-49e5-8a8d-5cfb71f46f53 -s groupId=ce01117a-7426-4670-a29a-5c118056fe20 -n</pre>
</div>
</div>
<h4 id="removing-a-user-from-a-group" class="discrete">Removing a user from a group</h4>
<div class="paragraph">
<p>Use the <code class="command">delete</code> command on the same endpoint URI as used for adding a user to a group, such as <code class="filename">users/USER_ID/groups/GROUP_ID</code>, to remove a user from a group.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete users/b544f379-5fc4-49e5-8a8d-5cfb71f46f53/groups/ce01117a-7426-4670-a29a-5c118056fe20 -r demorealm</pre>
</div>
</div>
<h4 id="listing-assigned-available-and-effective-realm-roles-for-a-group" class="discrete">Listing assigned, available, and effective realm roles for a group</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">get-roles</code> command to list assigned, available, and effective realm roles for a group.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Specify the target group by name (via the <code class="command">--gname</code> option), path (via the [command] <code>--gpath</code> option), or ID (via the <code class="command">--gid</code> option) to list <strong>assigned</strong> realm roles for the group.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --gname Group</pre>
</div>
</div>
</li>
<li>
<p>Use the additional <code class="command">--effective</code> option to list <strong>effective</strong> realm roles.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --gname Group --effective</pre>
</div>
</div>
</li>
<li>
<p>Use the <code class="command">--available</code> option to list realm roles that can still be added to the group.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --gname Group --available</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="listing-assigned-available-and-effective-client-roles-for-a-group" class="discrete">Listing assigned, available, and effective client roles for a group</h4>
<div class="paragraph">
<p>Use a dedicated <code class="command">get-roles</code> command to list assigned, available, and effective client roles for a group.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Specify the target group by either name (via the <code class="command">--gname</code> option) or ID (via the <code class="command">--gid</code> option), and client by either the clientId attribute (via the [command] <code>--cclientid</code> option) or ID (via the <code class="command">--id</code> option) to list <strong>assigned</strong> client roles for the user.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --gname Group --cclientid realm-management</pre>
</div>
</div>
</li>
<li>
<p>Use the additional <code class="command">--effective</code> option to list <strong>effective</strong> realm roles.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --gname Group --cclientid realm-management --effective</pre>
</div>
</div>
</li>
<li>
<p>Use the <code class="command">--available</code> option to list realm roles that can still be added to the group.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get-roles -r demorealm --gname Group --cclientid realm-management --available</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="identity-provider-operations"><a class="anchor" href="#identity-provider-operations"></a>Identity provider operations</h3>
<h4 id="listing-available-identity-providers" class="discrete">Listing available identity providers</h4>
<div class="paragraph">
<p>Use the <code class="filename">serverinfo</code> endpoint to list available identity providers.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get serverinfo -r demorealm --fields 'identityProviders(*)'</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code class="filename">serverinfo</code> endpoint is handled similarly to the <code class="filename">realms</code> endpoint in that it is not resolved relative to a target realm because it exists outside any specific realm.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="listing-configured-identity-providers" class="discrete">Listing configured identity providers</h4>
<div class="paragraph">
<p>Use the <code class="filename">identity-provider/instances</code> endpoint.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get identity-provider/instances -r demorealm --fields alias,providerId,enabled</pre>
</div>
</div>
<h4 id="getting-a-specific-configured-identity-provider" class="discrete">Getting a specific configured identity provider</h4>
<div class="paragraph">
<p>Use the <code class="command">alias</code> attribute of the identity provider to construct an endpoint URI, such as <code class="filename">identity-provider/instances/ALIAS</code>, to get a specific identity provider.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get identity-provider/instances/facebook -r demorealm</pre>
</div>
</div>
<h4 id="removing-a-specific-configured-identity-provider" class="discrete">Removing a specific configured identity provider</h4>
<div class="paragraph">
<p>Use the <code class="command">delete</code> command with the same endpoint URI that you used to get a specific configured identity provider to remove a specific configured identity provider.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete identity-provider/instances/facebook -r demorealm</pre>
</div>
</div>
<h4 id="configuring-a-keycloak-openid-connect-identity-provider" class="discrete">Configuring a Keycloak OpenID Connect identity provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code class="command">keycloak-oidc</code> as the <code class="command">providerId</code> when creating a new identity provider instance.</p>
</li>
<li>
<p>Provide the <code class="command">config</code> attributes: <code class="command">authorizationUrl</code>, <code class="command">tokenUrl</code>, <code class="command">clientId</code>, and <code class="command">clientSecret</code>.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create identity-provider/instances -r demorealm -s alias=keycloak-oidc -s providerId=keycloak-oidc -s enabled=true -s 'config.useJwksUrl="true"' -s config.authorizationUrl=http://localhost:8180/auth/realms/demorealm/protocol/openid-connect/auth -s config.tokenUrl=http://localhost:8180/auth/realms/demorealm/protocol/openid-connect/token -s config.clientId=demo-oidc-provider -s config.clientSecret=secret</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="configuring-an-openid-connect-identity-provider" class="discrete">Configuring an OpenID Connect identity provider</h4>
<div class="paragraph">
<p>Configure the generic OpenID Connect provider the same way you configure the Keycloak OpenID Connect provider, except that you set the <code class="command">providerId</code> attribute value to <code class="command">oidc</code>.</p>
</div>
<h4 id="configuring-a-saml-2-identity-provider" class="discrete">Configuring a SAML 2 identity provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code class="command">saml</code> as the <code class="command">providerId</code>.</p>
</li>
<li>
<p>Provide the <code class="command">config</code> attributes: <code class="command">singleSignOnServiceUrl</code>, <code class="command">nameIDPolicyFormat</code>, and <code class="command">signatureAlgorithm</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create identity-provider/instances -r demorealm -s alias=saml -s providerId=saml -s enabled=true -s 'config.useJwksUrl="true"' -s config.singleSignOnServiceUrl=http://localhost:8180/auth/realms/saml-broker-realm/protocol/saml -s config.nameIDPolicyFormat=urn:oasis:names:tc:SAML:2.0:nameid-format:persistent -s config.signatureAlgorithm=RSA_SHA256</pre>
</div>
</div>
<h4 id="configuring-a-facebook-identity-provider" class="discrete">Configuring a Facebook identity provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code class="command">facebook</code> as the <code class="command">providerId</code>.</p>
</li>
<li>
<p>Provide the <code class="command">config</code> attributes: <code class="command">clientId</code> and <code class="command">clientSecret</code>. You can find these attributes in the Facebook Developers application configuration page for your application.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create identity-provider/instances -r demorealm -s alias=facebook -s providerId=facebook -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=FACEBOOK_CLIENT_ID -s config.clientSecret=FACEBOOK_CLIENT_SECRET</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="configuring-a-google-identity-provider" class="discrete">Configuring a Google identity provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code class="command">google</code> as the <code class="command">providerId</code>.</p>
</li>
<li>
<p>Provide the <code class="command">config</code> attributes: <code class="command">clientId</code> and <code class="command">clientSecret</code>. You can find these attributes in the Google Developers application configuration page for your application.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create identity-provider/instances -r demorealm -s alias=google -s providerId=google -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=GOOGLE_CLIENT_ID -s config.clientSecret=GOOGLE_CLIENT_SECRET</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="configuring-a-twitter-identity-provider" class="discrete">Configuring a Twitter identity provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code class="command">twitter</code> as the <code class="command">providerId</code>.</p>
</li>
<li>
<p>Provide the <code class="command">config</code> attributes <code class="command">clientId</code> and <code class="command">clientSecret</code>. You can find these attributes in the Twitter Application Management application configuration page for your application.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create identity-provider/instances -r demorealm -s alias=google -s providerId=google -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=TWITTER_API_KEY -s config.clientSecret=TWITTER_API_SECRET</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="configuring-a-github-identity-provider" class="discrete">Configuring a GitHub identity provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code class="command">github</code> as the <code class="command">providerId</code>.</p>
</li>
<li>
<p>Provide the <code class="command">config</code> attributes <code class="command">clientId</code> and <code class="command">clientSecret</code>. You can find these attributes in the GitHub Developer Application Settings page for your application.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create identity-provider/instances -r demorealm -s alias=github -s providerId=github -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=GITHUB_CLIENT_ID -s config.clientSecret=GITHUB_CLIENT_SECRET</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="configuring-a-linkedin-identity-provider" class="discrete">Configuring a LinkedIn identity provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code class="command">linkedin</code> as the <code class="command">providerId</code>.</p>
</li>
<li>
<p>Provide the <code class="command">config</code> attributes <code class="command">clientId</code> and <code class="command">clientSecret</code>. You can find these attributes in the LinkedIn Developer Console application page for your application.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create identity-provider/instances -r demorealm -s alias=linkedin -s providerId=linkedin -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=LINKEDIN_CLIENT_ID -s config.clientSecret=LINKEDIN_CLIENT_SECRET</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="configuring-a-microsoft-live-identity-provider" class="discrete">Configuring a Microsoft Live identity provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code class="command">microsoft</code> as the <code class="command">providerId</code>.</p>
</li>
<li>
<p>Provide the <code class="command">config</code> attributes <code>clientId</code> and <code>clientSecret</code>. You can find these attributes in the Microsoft Application Registration Portal page for your application.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create identity-provider/instances -r demorealm -s alias=microsoft -s providerId=microsoft -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=MICROSOFT_APP_ID -s config.clientSecret=MICROSOFT_PASSWORD</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="configuring-a-stack-overflow-identity-provider" class="discrete">Configuring a Stack Overflow identity provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use <code>stackoverflow</code> command as the <code class="command">providerId</code>.</p>
</li>
<li>
<p>Provide the <code class="command">config</code> attributes <code class="command">clientId</code>, <code class="command">clientSecret</code>, and <code class="command">key</code>. You can find these attributes in the Stack Apps OAuth page for your application.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create identity-provider/instances -r demorealm -s alias=stackoverflow -s providerId=stackoverflow -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=STACKAPPS_CLIENT_ID -s config.clientSecret=STACKAPPS_CLIENT_SECRET -s config.key=STACKAPPS_KEY</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="storage-provider-operations"><a class="anchor" href="#storage-provider-operations"></a>Storage provider operations</h3>
<h4 id="configuring-a-kerberos-storage-provider" class="discrete">Configuring a Kerberos storage provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the <code class="command">create</code> command against the <code class="filename">components</code> endpoint.</p>
</li>
<li>
<p>Specify realm id as a value of the <code class="command">parentId</code> attribute.</p>
</li>
<li>
<p>Specify <code class="command">kerberos</code> as the value of the <code class="command">providerId</code> attribute, and <code class="command">org.keycloak.storage.UserStorageProvider</code> as the value of the <code class="command">providerType</code> attribute.</p>
</li>
<li>
<p>For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create components -r demorealm -s parentId=demorealmId -s id=demokerberos -s name=demokerberos -s providerId=kerberos -s providerType=org.keycloak.storage.UserStorageProvider -s 'config.priority=["0"]' -s 'config.debug=["false"]' -s 'config.allowPasswordAuthentication=["true"]' -s 'config.editMode=["UNSYNCED"]' -s 'config.updateProfileFirstLogin=["true"]' -s 'config.allowKerberosAuthentication=["true"]' -s 'config.kerberosRealm=["KEYCLOAK.ORG"]' -s 'config.keyTab=["http.keytab"]' -s 'config.serverPrincipal=["HTTP/localhost@KEYCLOAK.ORG"]' -s 'config.cachePolicy=["DEFAULT"]'</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="configuring-an-ldap-user-storage-provider" class="discrete">Configuring an LDAP user storage provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the <code class="command">create</code> command against the <code class="filename">components</code> endpoint.</p>
</li>
<li>
<p>Specify <code class="command">ldap</code> as a value of the <code class="command">providerId</code> attribute, and <code class="command">org.keycloak.storage.UserStorageProvider</code> as the value of the <code class="command">providerType</code> attribute.</p>
</li>
<li>
<p>Provide the realm ID as the value of the <code class="command">parentId</code> attribute.</p>
</li>
<li>
<p>Use the following example to create a Kerberos-integrated LDAP provider.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create components -r demorealm -s name=kerberos-ldap-provider -s providerId=ldap -s providerType=org.keycloak.storage.UserStorageProvider -s parentId=3d9c572b-8f33-483f-98a6-8bb421667867  -s 'config.priority=["1"]' -s 'config.fullSyncPeriod=["-1"]' -s 'config.changedSyncPeriod=["-1"]' -s 'config.cachePolicy=["DEFAULT"]' -s config.evictionDay=[] -s config.evictionHour=[] -s config.evictionMinute=[] -s config.maxLifespan=[] -s 'config.batchSizeForSync=["1000"]' -s 'config.editMode=["WRITABLE"]' -s 'config.syncRegistrations=["false"]' -s 'config.vendor=["other"]' -s 'config.usernameLDAPAttribute=["uid"]' -s 'config.rdnLDAPAttribute=["uid"]' -s 'config.uuidLDAPAttribute=["entryUUID"]' -s 'config.userObjectClasses=["inetOrgPerson, organizationalPerson"]' -s 'config.connectionUrl=["ldap://localhost:10389"]'  -s 'config.usersDn=["ou=People,dc=keycloak,dc=org"]' -s 'config.authType=["simple"]' -s 'config.bindDn=["uid=admin,ou=system"]' -s 'config.bindCredential=["secret"]' -s 'config.searchScope=["1"]' -s 'config.useTruststoreSpi=["ldapsOnly"]' -s 'config.connectionPooling=["true"]' -s 'config.pagination=["true"]' -s 'config.allowKerberosAuthentication=["true"]' -s 'config.serverPrincipal=["HTTP/localhost@KEYCLOAK.ORG"]' -s 'config.keyTab=["http.keytab"]' -s 'config.kerberosRealm=["KEYCLOAK.ORG"]' -s 'config.debug=["true"]' -s 'config.useKerberosForPasswordAuthentication=["true"]'</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="removing-a-user-storage-provider-instance" class="discrete">Removing a user storage provider instance</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the storage provider instance&#8217;s <code class="command">id</code> attribute to compose an endpoint URI, such as <code class="filename">components/ID</code>.</p>
</li>
<li>
<p>Run the <code class="command">delete</code> command against this endpoint.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh delete components/3d9c572b-8f33-483f-98a6-8bb421667867 -r demorealm</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="triggering-synchronization-of-all-users-for-a-specific-user-storage-provider" class="discrete">Triggering synchronization of all users for a specific user storage provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the storage provider&#8217;s <code class="command">id</code> attribute to compose an endpoint URI, such as <code class="filename">user-storage/ID_OF_USER_STORAGE_INSTANCE/sync</code>.</p>
</li>
<li>
<p>Add the <code class="command">action=triggerFullSync</code> query parameter and run the <code class="command">create</code> command.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create user-storage/b7c63d02-b62a-4fc1-977c-947d6a09e1ea/sync?action=triggerFullSync</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="triggering-synchronization-of-changed-users-for-a-specific-user-storage-provider" class="discrete">Triggering synchronization of changed users for a specific user storage provider</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the storage provider&#8217;s <code class="command">id</code> attribute to compose an endpoint URI, such as <code class="filename">user-storage/ID_OF_USER_STORAGE_INSTANCE/sync</code>.</p>
</li>
<li>
<p>Add the <code class="command">action=triggerChangedUsersSync</code> query parameter and run the <code class="command">create</code> command.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create user-storage/b7c63d02-b62a-4fc1-977c-947d6a09e1ea/sync?action=triggerChangedUsersSync</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="test-ldap-user-storage-connectivity" class="discrete">Test LDAP user storage connectivity</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the <code class="command">get</code> command on the <code class="filename">testLDAPConnection</code> endpoint.</p>
</li>
<li>
<p>Provide query parameters <code class="command">bindCredential</code>, <code class="command">bindDn</code>, <code class="command">connectionUrl</code>, and <code class="command">useTruststoreSpi</code>, and then set the <code class="command">action</code> query parameter to <code class="command">testConnection</code>.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create testLDAPConnection -s action=testConnection -s bindCredential=secret -s bindDn=uid=admin,ou=system -s connectionUrl=ldap://localhost:10389 -s useTruststoreSpi=ldapsOnly</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="test-ldap-user-storage-authentication" class="discrete">Test LDAP user storage authentication</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the <code class="command">get</code> command on the <code class="filename">testLDAPConnection</code> endpoint.</p>
</li>
<li>
<p>Provide the query parameters <code class="command">bindCredential</code>, <code class="command">bindDn</code>, <code class="command">connectionUrl</code>, and <code class="command">useTruststoreSpi</code>, and then set the <code class="command">action</code> query parameter to <code class="command">testAuthentication</code>.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create testLDAPConnection -s action=testAuthentication -s bindCredential=secret -s bindDn=uid=admin,ou=system -s connectionUrl=ldap://localhost:10389 -s useTruststoreSpi=ldapsOnly</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="adding-mappers"><a class="anchor" href="#adding-mappers"></a>Adding mappers</h3>
<h4 id="adding-a-hardcoded-role-ldap-mapper" class="discrete">Adding a hardcoded role LDAP mapper</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the <code class="command">create</code> command on the <code class="filename">components</code> endpoint.</p>
</li>
<li>
<p>Set the <code class="command">providerType</code> attribute to <code class="filename">org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>.</p>
</li>
<li>
<p>Set the <code class="command">parentId</code> attribute to the ID of the LDAP provider instance.</p>
</li>
<li>
<p>Set the <code class="command">providerId</code> attribute to <code class="command">hardcoded-ldap-role-mapper</code>. Make sure to provide a value of <code class="command">role</code> configuration parameter.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create components -r demorealm -s name=hardcoded-ldap-role-mapper -s providerId=hardcoded-ldap-role-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea -s 'config.role=["realm-management.create-client"]'</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="adding-an-ms-active-directory-mapper" class="discrete">Adding an MS Active Directory mapper</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the <code class="command">create</code> command on the <code class="filename">components</code> endpoint.</p>
</li>
<li>
<p>Set the <code class="command">providerType</code> attribute to <code class="filename">org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>.</p>
</li>
<li>
<p>Set the <code class="command">parentId</code> attribute to the ID of the LDAP provider instance.</p>
</li>
<li>
<p>Set the <code class="command">providerId</code> attribute to <code class="filename">msad-user-account-control-mapper</code>.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create components -r demorealm -s name=msad-user-account-control-mapper -s providerId=msad-user-account-control-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="adding-a-user-attribute-ldap-mapper" class="discrete">Adding a user attribute LDAP mapper</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the <code class="command">create</code> command on the <code class="filename">components</code> endpoint.</p>
</li>
<li>
<p>Set the <code class="command">providerType</code> attribute to <code class="filename">org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>.</p>
</li>
<li>
<p>Set the <code class="command">parentId</code> attribute to the ID of the LDAP provider instance.</p>
</li>
<li>
<p>Set the <code class="command">providerId</code> attribute to <code class="filename">user-attribute-ldap-mapper</code>.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create components -r demorealm -s name=user-attribute-ldap-mapper -s providerId=user-attribute-ldap-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea -s 'config."user.model.attribute"=["email"]' -s 'config."ldap.attribute"=["mail"]' -s 'config."read.only"=["false"]' -s 'config."always.read.value.from.ldap"=["false"]' -s 'config."is.mandatory.in.ldap"=["false"]'</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="adding-a-group-ldap-mapper" class="discrete">Adding a group LDAP mapper</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the <code class="command">create</code> command on the <code class="filename">components</code> endpoint.</p>
</li>
<li>
<p>Set the <code class="command">providerType</code> attribute to <code class="filename">org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>.</p>
</li>
<li>
<p>Set the <code class="command">parentId</code> attribute to the ID of the LDAP provider instance.</p>
</li>
<li>
<p>Set the <code class="command">providerId</code> attribute to <code class="filename">group-ldap-mapper</code>.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create components -r demorealm -s name=group-ldap-mapper -s providerId=group-ldap-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea -s 'config."groups.dn"=[]' -s 'config."group.name.ldap.attribute"=["cn"]' -s 'config."group.object.classes"=["groupOfNames"]' -s 'config."preserve.group.inheritance"=["true"]' -s 'config."membership.ldap.attribute"=["member"]' -s 'config."membership.attribute.type"=["DN"]' -s 'config."groups.ldap.filter"=[]' -s 'config.mode=["LDAP_ONLY"]' -s 'config."user.roles.retrieve.strategy"=["LOAD_GROUPS_BY_MEMBER_ATTRIBUTE"]' -s 'config."mapped.group.attributes"=["admins-group"]' -s 'config."drop.non.existing.groups.during.sync"=["false"]' -s 'config.roles=["admins"]' -s 'config.groups=["admins-group"]' -s 'config.group=[]' -s 'config.preserve=["true"]' -s 'config.membership=["member"]'</pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="adding-a-full-name-ldap-mapper" class="discrete">Adding a full name LDAP mapper</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the <code class="command">create</code> command on the <code class="filename">components</code> endpoint.</p>
</li>
<li>
<p>Set the <code class="command">providerType</code> attribute to <code class="filename">org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>.</p>
</li>
<li>
<p>Set the <code class="command">parentId</code> attribute to the ID of the LDAP provider instance.</p>
</li>
<li>
<p>Set the <code class="command">providerId</code> attribute to <code class="filename">full-name-ldap-mapper</code>.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh create components -r demorealm -s name=full-name-ldap-mapper -s providerId=full-name-ldap-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea -s 'config."ldap.full.name.attribute"=["cn"]' -s 'config."read.only"=["false"]' -s 'config."write.only"=["true"]'</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="authentication-operations"><a class="anchor" href="#authentication-operations"></a>Authentication operations</h3>
<h4 id="setting-a-password-policy" class="discrete">Setting a password policy</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set the realm&#8217;s <code class="command">passwordPolicy</code> attribute to an enumeration expression that includes the specific policy provider ID and optional configuration.</p>
</li>
<li>
<p>Use the following example to set a password policy to default values. The default values include:</p>
<div class="ulist">
<ul>
<li>
<p>27,500 hashing iterations</p>
</li>
<li>
<p>at least one special character</p>
</li>
<li>
<p>at least one uppercase character</p>
</li>
<li>
<p>at least one digit character</p>
</li>
<li>
<p>not be equal to a user&#8217;s <code class="filename">username</code></p>
</li>
<li>
<p>be at least eight characters long</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update realms/demorealm -s 'passwordPolicy="hashIterations and specialChars and upperCase and digits and notUsername and length"'</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If you want to use values different from defaults, pass the configuration in brackets.</p>
</li>
<li>
<p>Use the following example to set a password policy to:</p>
<div class="ulist">
<ul>
<li>
<p>25,000 hash iterations</p>
</li>
<li>
<p>at least two special characters</p>
</li>
<li>
<p>at least two uppercase characters</p>
</li>
<li>
<p>at least two lowercase characters</p>
</li>
<li>
<p>at least two digits</p>
</li>
<li>
<p>be at least nine characters long</p>
</li>
<li>
<p>not be equal to a user&#8217;s <code class="filename">username</code></p>
</li>
<li>
<p>not repeat for at least four changes back</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh update realms/demorealm -s 'passwordPolicy="hashIterations(25000) and specialChars(2) and upperCase(2) and lowerCase(2) and digits(2) and length(9) and notUsername and passwordHistory(4)"'</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<h4 id="getting-the-current-password-policy" class="discrete">Getting the current password policy</h4>
<div class="paragraph">
<p>Get the current realm configuration and filter everything but the <code class="command">passwordPolicy</code> attribute.</p>
</div>
<div class="paragraph">
<p>Use the following example to display <code class="command">passwordPolicy</code> for <code class="filename">demorealm</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get realms/demorealm --fields passwordPolicy</pre>
</div>
</div>
<h4 id="listing-authentication-flows" class="discrete">Listing authentication flows</h4>
<div class="paragraph">
<p>Run the <code class="command">get</code> command on the <code class="filename">authentication/flows</code> endpoint.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get authentication/flows -r demorealm</pre>
</div>
</div>
<h4 id="getting-a-specific-authentication-flow" class="discrete">Getting a specific authentication flow</h4>
<div class="paragraph">
<p>Run the <code class="command">get</code> command on the <code class="filename">authentication/flows/FLOW_ID</code> endpoint.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get authentication/flows/febfd772-e1a1-42fb-b8ae-00c0566fafb8 -r demorealm</pre>
</div>
</div>
<h4 id="listing-executions-for-a-flow" class="discrete">Listing executions for a flow</h4>
<div class="paragraph">
<p>Run the <code class="command">get</code> command on the <code class="filename">authentication/flows/FLOW_ALIAS/executions</code> endpoint.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm.sh get authentication/flows/Copy%20of%20browser/executions -r demorealm</pre>
</div>
</div>
<h4 id="adding-configuration-to-an-execution" class="discrete">Adding configuration to an execution</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get execution for a flow, and take note of its ID</p>
</li>
<li>
<p>Run the <code class="command">create</code> command on the <code class="filename">authentication/executions/{executionId}/config</code> endpoint.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm create "authentication/executions/a3147129-c402-4760-86d9-3f2345e401c7/config" -r examplerealm -b '{"config":{"x509-cert-auth.mapping-source-selection":"Match SubjectDN using regular expression","x509-cert-auth.regular-expression":"(.*?)(?:$)","x509-cert-auth.mapper-selection":"Custom Attribute Mapper","x509-cert-auth.mapper-selection.user-attribute-name":"usercertificate","x509-cert-auth.crl-checking-enabled":"","x509-cert-auth.crldp-checking-enabled":false,"x509-cert-auth.crl-relative-path":"crl.pem","x509-cert-auth.ocsp-checking-enabled":"","x509-cert-auth.ocsp-responder-uri":"","x509-cert-auth.keyusage":"","x509-cert-auth.extendedkeyusage":"","x509-cert-auth.confirmation-page-disallowed":""},"alias":"my_otp_config"}'</pre>
</div>
</div>
<h4 id="getting-configuration-for-an-execution" class="discrete">Getting configuration for an execution</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get execution for a flow, and get its <code class="filename">authenticationConfig</code> attribute, containing the config ID.</p>
</li>
<li>
<p>Run the <code class="command">get</code> command on the <code class="filename">authentication/config/ID</code> endpoint.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm get "authentication/config/dd91611a-d25c-421a-87e2-227c18421833" -r examplerealm</pre>
</div>
</div>
<h4 id="updating-configuration-for-an-execution" class="discrete">Updating configuration for an execution</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get execution for a flow, and get its <code class="filename">authenticationConfig</code> attribute, containing the config ID.</p>
</li>
<li>
<p>Run the <code class="command">update</code> command on the <code class="filename">authentication/config/ID</code> endpoint.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm update "authentication/config/dd91611a-d25c-421a-87e2-227c18421833" -r examplerealm -b '{"id":"dd91611a-d25c-421a-87e2-227c18421833","alias":"my_otp_config","config":{"x509-cert-auth.extendedkeyusage":"","x509-cert-auth.mapper-selection.user-attribute-name":"usercertificate","x509-cert-auth.ocsp-responder-uri":"","x509-cert-auth.regular-expression":"(.*?)(?:$)","x509-cert-auth.crl-checking-enabled":"true","x509-cert-auth.confirmation-page-disallowed":"","x509-cert-auth.keyusage":"","x509-cert-auth.mapper-selection":"Custom Attribute Mapper","x509-cert-auth.crl-relative-path":"crl.pem","x509-cert-auth.crldp-checking-enabled":"false","x509-cert-auth.mapping-source-selection":"Match SubjectDN using regular expression","x509-cert-auth.ocsp-checking-enabled":""}}'</pre>
</div>
</div>
<h4 id="deleting-configuration-for-an-execution" class="discrete">Deleting configuration for an execution</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get execution for a flow, and get its <code class="filename">authenticationConfig</code> attribute, containing the config ID.</p>
</li>
<li>
<p>Run the <code class="command">delete</code> command on the <code class="filename">authentication/config/ID</code> endpoint.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcadm delete "authentication/config/dd91611a-d25c-421a-87e2-227c18421833" -r examplerealm</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-03-01 08:19:32 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.js"></script>

<script>
    var oldtoc = document.getElementById('toctitle').nextElementSibling;
    var newtoc = document.createElement('div');
    newtoc.setAttribute('id', 'tocbot');
    newtoc.setAttribute('class', 'js-toc');
    oldtoc.parentNode.replaceChild(newtoc, oldtoc);
    tocbot.init({ contentSelector: '#content',
        headingSelector: 'h2, h3, h4',
        smoothScroll: false
    });
    var handleTocOnResize = function() {
        var width = window.innerWidth
                    || document.documentElement.clientWidth
                    || document.body.clientWidth;
        if (width < 768) {
            tocbot.refresh({
                contentSelector: '#content',
                headingSelector: 'h2, h3, h4',
                collapseDepth: 6,
                activeLinkClass: 'ignoreactive',
                throttleTimeout: 1000,
                smoothScroll: false
            });
        }
        else {
            tocbot.refresh({
                contentSelector: '#content',
                headingSelector: 'h2, h3, h4',
                smoothScroll: false
            });
        }
    };
    window.addEventListener('resize', handleTocOnResize);
    handleTocOnResize();
</script>
</body>
</html>